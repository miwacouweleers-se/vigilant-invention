<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Create New Inventory - Prototype</title>
  
  <!-- Vertex Design System (path from repo root for GitHub Pages) -->
  <link rel="stylesheet" href="../../style.css">
  
  <!-- App Shell Styles -->
  <link rel="stylesheet" href="styles.css">
  
  <!-- Font Awesome Pro Kit -->
  <script src="https://kit.fontawesome.com/e1f0748a31.js" crossorigin="anonymous"></script>
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  
  <style>
    /* ============================================== */
    /* GHG Calculation Engine - Futuristic Light Theme */
    /* ============================================== */
    
    :root {
      /* Background Colors */
      --ghg-bg: #FAFBFC;
      --ghg-surface: #FFFFFF;
      --ghg-surface-elevated: #F1F5F9;
      --ghg-surface-hover: #E2E8F0;
      
      /* Border Colors */
      --ghg-border: #E2E8F0;
      --ghg-border-strong: #CBD5E1;
      
      /* Brand - Electric Cyan (Futuristic) */
      --ghg-primary: #06B6D4;
      --ghg-primary-dark: #0891B2;
      --ghg-primary-light: #CFFAFE;
      --ghg-primary-glow: rgba(6, 182, 212, 0.15);
      
      /* Scope Colors */
      --ghg-scope-1: #F59E0B;
      --ghg-scope-1-light: #FEF3C7;
      --ghg-scope-2: #8B5CF6;
      --ghg-scope-2-light: #EDE9FE;
      --ghg-scope-3: #10B981;
      --ghg-scope-3-light: #D1FAE5;
      
      /* Semantic */
      --ghg-success: #22C55E;
      --ghg-success-light: #DCFCE7;
      --ghg-warning: #F97316;
      --ghg-warning-light: #FFEDD5;
      --ghg-danger: #EF4444;
      --ghg-danger-light: #FEE2E2;
      --ghg-info: #3B82F6;
      --ghg-info-light: #DBEAFE;
      
      /* Text */
      --ghg-text: #0F172A;
      --ghg-text-secondary: #64748B;
      --ghg-text-muted: #94A3B8;
      
      /* Typography */
      --font-display: 'Space Grotesk', sans-serif;
      --font-sans: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
      --font-mono: 'JetBrains Mono', monospace;
    }
    
    /* Override base fonts */
    body {
      font-family: var(--font-sans);
      background: var(--ghg-bg);
    }
    
    /* ============================================== */
    /* Page Header                                    */
    /* ============================================== */
    
    .page-header {
      background: var(--ghg-surface);
      border-bottom: 1px solid var(--ghg-border);
      padding: 20px 32px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .page-header-left {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .page-breadcrumb {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: var(--ghg-text-secondary);
    }
    
    .page-breadcrumb a {
      color: var(--ghg-text-secondary);
      text-decoration: none;
      transition: color 0.15s ease;
    }
    
    .page-breadcrumb a:hover {
      color: var(--ghg-primary-dark);
    }
    
    .page-title {
      font-family: var(--font-display);
      font-size: 28px;
      font-weight: 700;
      color: var(--ghg-text);
      margin: 0;
      letter-spacing: -0.02em;
    }
    
    .page-subtitle {
      font-size: 14px;
      color: var(--ghg-text-secondary);
      margin-top: 4px;
    }
    
    .page-header-actions {
      display: flex;
      gap: 12px;
    }
    
    /* ============================================== */
    /* Buttons                                        */
    /* ============================================== */
    
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 18px;
      font-size: 14px;
      font-weight: 500;
      font-family: var(--font-sans);
      border-radius: 8px;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .btn-primary {
      background: var(--ghg-primary);
      color: white;
      box-shadow: 0 2px 8px var(--ghg-primary-glow);
    }
    
    .btn-primary:hover {
      background: var(--ghg-primary-dark);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px var(--ghg-primary-glow);
    }
    
    .btn-secondary {
      background: var(--ghg-surface);
      color: var(--ghg-text);
      border: 1px solid var(--ghg-border);
    }
    
    .btn-secondary:hover {
      background: var(--ghg-surface-elevated);
      border-color: var(--ghg-border-strong);
    }
    
    .btn-ghost {
      background: transparent;
      color: var(--ghg-text-secondary);
    }
    
    .btn-ghost:hover {
      background: var(--ghg-surface-elevated);
      color: var(--ghg-text);
    }
    
    .btn-danger {
      background: var(--ghg-danger);
      color: white;
    }
    
    .btn-danger:hover {
      background: #DC2626;
    }
    
    .btn-sm {
      padding: 6px 12px;
      font-size: 13px;
    }
    
    .btn-lg {
      padding: 14px 24px;
      font-size: 16px;
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    /* ============================================== */
    /* Content Container                              */
    /* ============================================== */
    
    .content-container {
      padding: 24px 32px;
      max-width: 1600px;
    }
    
    /* ============================================== */
    /* Cards                                          */
    /* ============================================== */
    
    .card {
      background: var(--ghg-surface);
      border: 1px solid var(--ghg-border);
      border-radius: 12px;
      overflow: hidden;
    }
    
    .card-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--ghg-border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .card-title {
      font-family: var(--font-display);
      font-size: 16px;
      font-weight: 600;
      color: var(--ghg-text);
      margin: 0;
    }
    
    .card-body {
      padding: 20px;
    }
    
    /* ============================================== */
    /* Inventory Status Header                        */
    /* ============================================== */
    
    .inventory-status-header {
      background: var(--ghg-surface);
      border: 1px solid var(--ghg-border);
      border-radius: 12px;
      padding: 20px 24px;
      margin-bottom: 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .inventory-status-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    .inventory-icon-large {
      width: 56px;
      height: 56px;
      background: var(--ghg-primary-light);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--ghg-primary-dark);
      font-size: 24px;
    }
    
    .inventory-info h2 {
      font-family: var(--font-display);
      font-size: 20px;
      font-weight: 600;
      color: var(--ghg-text);
      margin: 0 0 4px 0;
    }
    
    .inventory-meta-row {
      display: flex;
      gap: 20px;
      font-size: 13px;
      color: var(--ghg-text-secondary);
    }
    
    .inventory-meta-row span {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    /* ============================================== */
    /* Stats Cards                                    */
    /* ============================================== */
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }
    
    .stat-card {
      background: var(--ghg-surface);
      border: 1px solid var(--ghg-border);
      border-radius: 12px;
      padding: 20px;
      position: relative;
      overflow: hidden;
    }
    
    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--ghg-border);
    }
    
    .stat-card.scope-1::before { background: var(--ghg-scope-1); }
    .stat-card.scope-2::before { background: var(--ghg-scope-2); }
    .stat-card.scope-3::before { background: var(--ghg-scope-3); }
    .stat-card.total::before { background: var(--ghg-primary); }
    
    .stat-label {
      font-size: 12px;
      font-weight: 500;
      color: var(--ghg-text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
    }
    
    .stat-value {
      font-family: var(--font-mono);
      font-size: 28px;
      font-weight: 600;
      color: var(--ghg-text);
      line-height: 1.2;
    }
    
    .stat-unit {
      font-size: 14px;
      font-weight: 400;
      color: var(--ghg-text-secondary);
      margin-left: 4px;
    }
    
    .stat-change {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      margin-top: 8px;
    }
    
    .stat-change.positive { color: var(--ghg-success); }
    .stat-change.negative { color: var(--ghg-danger); }
    
    /* ============================================== */
    /* Tabs Navigation                                */
    /* ============================================== */
    
    .tabs-container {
      background: var(--ghg-surface);
      border: 1px solid var(--ghg-border);
      border-radius: 12px;
      margin-bottom: 24px;
    }
    
    .tabs {
      display: flex;
      border-bottom: 1px solid var(--ghg-border);
      padding: 0 20px;
    }
    
    .tab {
      padding: 16px 20px;
      font-size: 14px;
      font-weight: 500;
      color: var(--ghg-text-secondary);
      background: none;
      border: none;
      cursor: pointer;
      position: relative;
      transition: all 0.15s ease;
    }
    
    .tab:hover {
      color: var(--ghg-text);
    }
    
    .tab.active {
      color: var(--ghg-primary-dark);
    }
    
    .tab.active::after {
      content: '';
      position: absolute;
      bottom: -1px;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--ghg-primary);
    }
    
    .tab-content {
      display: none;
      padding: 24px;
    }
    
    .tab-content.active {
      display: block;
    }
    
    /* ============================================== */
    /* Scope Breakdown Visualization                  */
    /* ============================================== */
    
    .scope-bar {
      display: flex;
      height: 16px;
      border-radius: 8px;
      overflow: hidden;
      margin: 16px 0;
      background: var(--ghg-surface-elevated);
    }
    
    .scope-bar-segment {
      transition: width 0.5s ease;
      position: relative;
    }
    
    .scope-bar-segment.scope-1 { background: var(--ghg-scope-1); }
    .scope-bar-segment.scope-2 { background: var(--ghg-scope-2); }
    .scope-bar-segment.scope-3 { background: var(--ghg-scope-3); }
    
    .scope-legend {
      display: flex;
      gap: 24px;
      margin-top: 12px;
    }
    
    .scope-legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: var(--ghg-text-secondary);
    }
    
    .scope-legend-dot {
      width: 12px;
      height: 12px;
      border-radius: 3px;
    }
    
    .scope-legend-dot.scope-1 { background: var(--ghg-scope-1); }
    .scope-legend-dot.scope-2 { background: var(--ghg-scope-2); }
    .scope-legend-dot.scope-3 { background: var(--ghg-scope-3); }
    
    /* ============================================== */
    /* Data Table                                     */
    /* ============================================== */
    
    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    
    .data-table th {
      text-align: left;
      padding: 12px 16px;
      background: var(--ghg-surface-elevated);
      font-weight: 600;
      color: var(--ghg-text);
      border-bottom: 1px solid var(--ghg-border);
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .data-table td {
      padding: 14px 16px;
      border-bottom: 1px solid var(--ghg-border);
      color: var(--ghg-text);
    }
    
    .data-table tr:hover td {
      background: var(--ghg-surface-elevated);
    }
    
    .data-table .numeric {
      font-family: var(--font-mono);
      text-align: right;
    }
    
    /* ============================================== */
    /* Sortable Columns                               */
    /* ============================================== */
    
    .data-table th.sortable {
      cursor: pointer;
      user-select: none;
      position: relative;
    }
    
    .data-table th.sortable:hover {
      background: var(--ghg-surface-hover);
    }
    
    .data-table th.sortable .sort-icon {
      transition: opacity 0.2s;
    }
    
    .data-table th.sortable.sorted-asc .sort-icon::before {
      content: "\f0de"; /* fa-arrow-up */
      opacity: 1;
    }
    
    .data-table th.sortable.sorted-desc .sort-icon::before {
      content: "\f0dd"; /* fa-arrow-down */
      opacity: 1;
    }
    
    /* ============================================== */
    /* Breakdown View Styles                          */
    /* ============================================== */
    
    .breakdown-toolbar {
      background: var(--ghg-surface);
      padding: 12px;
      border-radius: 8px;
      border: 1px solid var(--ghg-border);
    }
    
    .search-input-wrapper {
      position: relative;
    }
    
    .breakdown-summary {
      background: var(--ghg-surface-elevated);
      border-radius: 8px;
    }
    
    .breakdown-group-header {
      background: var(--ghg-surface-elevated);
      font-weight: 600;
      cursor: pointer;
    }
    
    .breakdown-group-header:hover {
      background: var(--ghg-surface-hover);
    }
    
    .breakdown-group-header .group-toggle {
      margin-right: 8px;
      transition: transform 0.2s;
    }
    
    .breakdown-group-header.collapsed .group-toggle {
      transform: rotate(-90deg);
    }
    
    .breakdown-group-row {
      padding-left: 32px;
    }
    
    .breakdown-loading {
      text-align: center;
      padding: 48px;
      color: var(--ghg-text-muted);
    }
    
    .breakdown-loading i {
      font-size: 24px;
      margin-bottom: 12px;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    .breakdown-pagination button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    /* ============================================== */
    /* Expandable Rows                                */
    /* ============================================== */
    
    .expandable-row {
      cursor: pointer;
    }
    
    .expandable-row:hover td {
      background: var(--ghg-primary-light);
    }
    
    .expand-icon {
      transition: transform 0.2s ease;
      color: var(--ghg-text-muted);
    }
    
    .expandable-row.expanded .expand-icon {
      transform: rotate(90deg);
      color: var(--ghg-primary);
    }
    
    .expanded-content {
      display: none;
    }
    
    .expandable-row.expanded + .expanded-content {
      display: table-row;
    }
    
    .expanded-inner {
      padding: 20px 24px;
      background: var(--ghg-surface-elevated);
    }
    
    .view-activity-link:hover {
      background: var(--ghg-primary) !important;
      color: white !important;
    }
    
    /* ============================================== */
    /* Expandable Rows                                */
    /* ============================================== */
    
    .expandable-row {
      cursor: pointer;
      transition: background-color 0.15s ease;
    }
    
    .expandable-row:hover {
      background-color: var(--ghg-surface-elevated);
    }
    
    .expandable-row .expand-icon {
      transition: transform 0.2s ease;
      color: var(--ghg-text-muted);
    }
    
    .expandable-row.expanded .expand-icon {
      transform: rotate(90deg);
    }
    
    .expanded-content {
      display: none !important;
    }
    
    .expandable-row.expanded + .expanded-content {
      display: table-row !important;
    }
    
    /* ============================================== */
    /* Lineage Panel                                  */
    /* ============================================== */
    
    .lineage-panel {
      background: var(--ghg-surface);
      border: 1px solid var(--ghg-border);
      border-radius: 8px;
      overflow: hidden;
    }
    
    .lineage-header {
      background: var(--ghg-primary-light);
      padding: 16px 20px;
      border-bottom: 1px solid var(--ghg-border);
    }
    
    .lineage-header h4 {
      font-family: var(--font-display);
      font-size: 14px;
      font-weight: 600;
      color: var(--ghg-primary-dark);
      margin: 0 0 4px 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .lineage-header p {
      font-size: 12px;
      color: var(--ghg-text-secondary);
      margin: 0;
    }
    
    .lineage-section {
      padding: 16px 20px;
      border-bottom: 1px solid var(--ghg-border);
    }
    
    .lineage-section:last-child {
      border-bottom: none;
    }
    
    .lineage-section-title {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--ghg-text-secondary);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .lineage-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }
    
    .lineage-item {
      background: var(--ghg-surface-elevated);
      padding: 10px 12px;
      border-radius: 6px;
    }
    
    .lineage-item-label {
      font-size: 11px;
      color: var(--ghg-text-muted);
      margin-bottom: 2px;
    }
    
    .lineage-item-value {
      font-size: 13px;
      font-weight: 500;
      color: var(--ghg-text);
    }
    
    .lineage-item-value.mono {
      font-family: var(--font-mono);
    }
    
    .lineage-calculation {
      background: var(--ghg-surface-elevated);
      padding: 12px 16px;
      border-radius: 6px;
      font-family: var(--font-mono);
      font-size: 13px;
      color: var(--ghg-text);
    }
    
    .lineage-validation {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .lineage-check {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: var(--ghg-text);
    }
    
    .lineage-check i {
      color: var(--ghg-success);
    }
    
    /* ============================================== */
    /* Badges                                         */
    /* ============================================== */
    
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      font-size: 12px;
      font-weight: 500;
      border-radius: 6px;
    }
    
    .badge-success {
      background: var(--ghg-success-light);
      color: #166534;
    }
    
    .badge-warning {
      background: var(--ghg-warning-light);
      color: #9A3412;
    }
    
    .badge-danger {
      background: var(--ghg-danger-light);
      color: #991B1B;
    }
    
    .badge-info {
      background: var(--ghg-info-light);
      color: #1E40AF;
    }
    
    .badge-neutral {
      background: var(--ghg-surface-elevated);
      color: var(--ghg-text-secondary);
    }
    
    .badge-scope-1 {
      background: var(--ghg-scope-1-light);
      color: #92400E;
    }
    
    .badge-scope-2 {
      background: var(--ghg-scope-2-light);
      color: #5B21B6;
    }
    
    .badge-scope-3 {
      background: var(--ghg-scope-3-light);
      color: #065F46;
    }
    
    /* ============================================== */
    /* Modals                                         */
    /* ============================================== */
    
    .modal-backdrop {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.6);
      backdrop-filter: blur(4px);
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.2s ease;
    }
    
    .modal-backdrop.open {
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 1;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--ghg-surface);
      border-radius: 16px;
      max-width: 600px;
      width: 90%;
      max-height: 90vh;
      overflow: hidden;
      flex-direction: column;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      z-index: 1001;
    }
    
    .modal.open {
      display: flex;
    }
    
    .modal-lg {
      max-width: 900px;
    }
    
    .modal-xl {
      max-width: 1100px;
    }
    
    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--ghg-border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .modal-title {
      font-family: var(--font-display);
      font-size: 20px;
      font-weight: 600;
      color: var(--ghg-text);
      margin: 0;
    }
    
    .modal-close {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: none;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      color: var(--ghg-text-secondary);
      font-size: 18px;
      transition: all 0.15s ease;
    }
    
    .modal-close:hover {
      background: var(--ghg-surface-elevated);
      color: var(--ghg-text);
    }
    
    .modal-body {
      padding: 24px;
      overflow-y: auto;
      flex: 1;
    }
    
    .modal-footer {
      padding: 16px 24px;
      border-top: 1px solid var(--ghg-border);
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }
    
    /* ============================================== */
    /* Calculation Progress                           */
    /* ============================================== */
    
    .calc-progress {
      text-align: center;
      padding: 40px 20px;
    }
    
    .calc-progress-ring {
      width: 100px;
      height: 100px;
      margin: 0 auto 24px;
      position: relative;
    }
    
    .calc-progress-ring svg {
      transform: rotate(-90deg);
    }
    
    .calc-progress-ring circle {
      fill: none;
      stroke-width: 6;
    }
    
    .calc-progress-ring .bg {
      stroke: var(--ghg-surface-elevated);
    }
    
    .calc-progress-ring .progress {
      stroke: var(--ghg-primary);
      stroke-linecap: round;
      transition: stroke-dashoffset 0.5s ease;
    }
    
    .calc-progress-percent {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-family: var(--font-mono);
      font-size: 24px;
      font-weight: 600;
      color: var(--ghg-text);
    }
    
    .calc-progress-title {
      font-family: var(--font-display);
      font-size: 20px;
      font-weight: 600;
      color: var(--ghg-text);
      margin-bottom: 8px;
    }
    
    .calc-progress-step {
      font-size: 14px;
      color: var(--ghg-text-secondary);
      margin-bottom: 24px;
    }
    
    .calc-steps {
      display: flex;
      flex-direction: column;
      gap: 12px;
      text-align: left;
      max-width: 400px;
      margin: 0 auto;
    }
    
    .calc-step-item {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 14px;
      color: var(--ghg-text-muted);
      padding: 10px 16px;
      background: var(--ghg-surface-elevated);
      border-radius: 8px;
      transition: all 0.2s ease;
    }
    
    .calc-step-item.active {
      background: var(--ghg-primary-light);
      color: var(--ghg-primary-dark);
    }
    
    .calc-step-item.completed {
      color: var(--ghg-success);
    }
    
    .calc-step-item i {
      width: 20px;
      text-align: center;
    }
    
    /* ============================================== */
    /* Form Elements                                  */
    /* ============================================== */
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: var(--ghg-text);
      margin-bottom: 6px;
    }
    
    .form-input,
    .form-select {
      width: 100%;
      padding: 10px 14px;
      font-size: 14px;
      font-family: var(--font-sans);
      border: 1px solid var(--ghg-border);
      border-radius: 8px;
      background: var(--ghg-surface);
      color: var(--ghg-text);
      transition: all 0.15s ease;
    }
    
    .form-input:focus,
    .form-select:focus {
      outline: none;
      border-color: var(--ghg-primary);
      box-shadow: 0 0 0 3px var(--ghg-primary-light);
    }
    
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    
    /* Option Groups */
    .option-group {
      background: var(--ghg-surface-elevated);
      border: 1px solid var(--ghg-border);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
    }
    
    .option-group-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--ghg-text);
      margin-bottom: 12px;
    }
    
    .option-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 10px;
      cursor: pointer;
      border-radius: 6px;
      transition: background 0.15s ease;
    }
    
    .option-item:hover {
      background: var(--ghg-surface);
    }
    
    .option-item input[type="radio"],
    .option-item input[type="checkbox"] {
      margin-top: 2px;
      accent-color: var(--ghg-primary);
    }
    
    .option-label {
      font-size: 14px;
      font-weight: 500;
      color: var(--ghg-text);
    }
    
    .option-desc {
      font-size: 12px;
      color: var(--ghg-text-secondary);
      margin-top: 2px;
    }
    
    /* ============================================== */
    /* Info Box                                       */
    /* ============================================== */
    
    .info-box {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 14px 16px;
      background: var(--ghg-info-light);
      border-radius: 8px;
      font-size: 13px;
      color: #1E40AF;
    }
    
    .info-box.warning {
      background: var(--ghg-warning-light);
      color: #9A3412;
    }
    
    .info-box.success {
      background: var(--ghg-success-light);
      color: #166534;
    }
    
    .info-box i {
      font-size: 16px;
      flex-shrink: 0;
      margin-top: 1px;
    }
    
    /* ============================================== */
    /* Wizard Stepper                                 */
    /* ============================================== */
    
    .wizard-stepper {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 32px;
      padding: 0 20px;
    }
    
    .wizard-step {
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--ghg-text-muted);
    }
    
    .wizard-step.active {
      color: var(--ghg-primary-dark);
    }
    
    .wizard-step.completed {
      color: var(--ghg-success);
    }
    
    .step-circle {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 14px;
      background: var(--ghg-surface-elevated);
      border: 2px solid var(--ghg-border);
      transition: all 0.2s ease;
    }
    
    .wizard-step.active .step-circle {
      background: var(--ghg-primary);
      border-color: var(--ghg-primary);
      color: white;
      box-shadow: 0 0 0 4px var(--ghg-primary-light);
    }
    
    .wizard-step.completed .step-circle {
      background: var(--ghg-success);
      border-color: var(--ghg-success);
      color: white;
    }
    
    .step-label {
      font-size: 13px;
      font-weight: 500;
    }
    
    .step-connector {
      width: 48px;
      height: 2px;
      background: var(--ghg-border);
      margin: 0 12px;
    }
    
    .wizard-step.completed + .step-connector {
      background: var(--ghg-success);
    }
    
    .wizard-step-content {
      display: none;
    }
    
    .wizard-step-content.active {
      display: block;
    }
    
    .wizard-step-content h3 {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 16px;
      color: var(--ghg-text);
    }

    /* Step 2: Calculation Method cards */
    .calc-method-cards {
      display: grid;
      gap: 14px;
      margin-top: 12px;
    }

    .calc-method-card {
      background: var(--ghg-surface);
      border: 1px solid var(--ghg-border);
      border-radius: 10px;
      padding: 14px 16px;
      transition: border-color 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
    }

    .calc-method-card:hover {
      border-color: var(--ghg-border-strong);
      background: #FCFDFE;
    }

    .calc-method-card.selected {
      border-color: var(--ghg-primary);
      box-shadow: 0 0 0 3px var(--ghg-primary-light);
      background: #F9FEFF;
    }

    .calc-method-card .card-header {
      padding: 0;
      border-bottom: none;
      display: grid;
      grid-template-columns: auto minmax(0, 1fr) auto auto;
      align-items: center;
      gap: 10px;
    }

    .calc-method-card .card-header input[type="radio"] {
      margin: 0;
      accent-color: var(--ghg-primary);
      width: 14px;
      height: 14px;
    }

    .calc-method-card .method-title {
      font-size: 15px;
      font-weight: 600;
      color: var(--ghg-text);
      line-height: 1.3;
    }

    .calc-method-card .version-badge {
      font-size: 12px;
      font-weight: 600;
      color: var(--ghg-text-secondary);
      background: var(--ghg-surface-elevated);
      border: 1px solid var(--ghg-border);
      border-radius: 999px;
      padding: 3px 10px;
      white-space: nowrap;
    }

    .calc-method-card .status-badge {
      width: auto;
      height: auto;
      border-radius: 999px;
      padding: 3px 10px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      white-space: nowrap;
    }

    .calc-method-card .status-badge.active {
      background: var(--ghg-success-light);
      color: #166534;
      border: 1px solid #BBF7D0;
    }

    .calc-method-card .card-meta {
      margin-top: 10px;
      font-size: 12px;
      color: var(--ghg-text-secondary);
    }

    .calc-method-card .method-details {
      margin-top: 10px;
      border-top: 1px solid var(--ghg-border);
      padding-top: 8px;
    }

    .calc-method-card .method-details summary {
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      color: var(--ghg-text-secondary);
      user-select: none;
    }

    .calc-method-card .method-details summary:hover {
      color: var(--ghg-primary-dark);
    }

    .calc-method-card .pillars-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 8px;
      margin-top: 10px;
    }

    .calc-method-card .pillar {
      background: var(--ghg-surface-elevated);
      border: 1px solid var(--ghg-border);
      border-radius: 8px;
      padding: 10px 12px;
    }

    .calc-method-card .pillar-title {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--ghg-text-muted);
      margin-bottom: 4px;
    }

    .calc-method-card .pillar-value {
      font-size: 13px;
      color: var(--ghg-text);
      line-height: 1.35;
    }

    @media (max-width: 800px) {
      .calc-method-card .card-header {
        grid-template-columns: auto minmax(0, 1fr);
      }

      .calc-method-card .version-badge,
      .calc-method-card .status-badge {
        justify-self: start;
      }
    }
    
    /* Entity Selection Tree for Org Boundary */
    .entity-selection-tree {
      border: 1px solid var(--ghg-border);
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 16px;
    }
    
    .entity-selection-header {
      background: var(--ghg-surface-elevated);
      padding: 12px 16px;
      border-bottom: 1px solid var(--ghg-border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .entity-selection-header label {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
      cursor: pointer;
    }
    
    .entity-selection-children {
      padding-left: 24px;
    }
    
    .entity-selection-item {
      padding: 10px 16px;
      border-bottom: 1px solid var(--ghg-border-light);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .entity-selection-item:last-child {
      border-bottom: none;
    }
    
    .entity-selection-item label {
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
    }
    
    .entity-selection-item .entity-type {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 4px;
      background: var(--ghg-surface-elevated);
      color: var(--ghg-text-muted);
    }
    
    .entity-selection-item .data-status {
      font-size: 12px;
      color: var(--ghg-success);
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .entity-selection-item .data-status.no-data {
      color: var(--ghg-text-muted);
    }
    
    /* Activity Category Selection */
    .activity-scope-section {
      margin-bottom: 24px;
    }
    
    .activity-scope-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }
    
    .activity-scope-header h4 {
      font-size: 14px;
      font-weight: 600;
      margin: 0;
    }
    
    .scope-badge {
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
    }
    
    .scope-badge.scope-1 {
      background: #FEE2E2;
      color: #991B1B;
    }
    
    .scope-badge.scope-2 {
      background: #DBEAFE;
      color: #1E40AF;
    }
    
    .scope-badge.scope-3 {
      background: #E0E7FF;
      color: #3730A3;
    }
    
    .activity-category-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
    }
    
    .activity-category-item {
      padding: 12px;
      border: 1px solid var(--ghg-border);
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      transition: all 0.15s ease;
    }
    
    .activity-category-item:hover {
      border-color: var(--ghg-primary);
      background: var(--ghg-primary-light);
    }
    
    .activity-category-item.selected {
      border-color: var(--ghg-primary);
      background: var(--ghg-primary-light);
    }
    
    .activity-category-item input[type="checkbox"] {
      margin: 0;
    }
    
    .activity-category-info {
      flex: 1;
    }
    
    .activity-category-name {
      font-size: 13px;
      font-weight: 500;
    }
    
    .activity-category-count {
      font-size: 11px;
      color: var(--ghg-text-muted);
    }
    
    /* Review Summary */
    .review-section {
      margin-bottom: 20px;
    }
    
    .review-section-title {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--ghg-text-muted);
      margin-bottom: 8px;
    }
    
    .review-card {
      background: var(--ghg-surface-elevated);
      border: 1px solid var(--ghg-border);
      border-radius: 8px;
      padding: 16px;
    }
    
    .review-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }
    
    .review-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .review-item-label {
      font-size: 12px;
      color: var(--ghg-text-muted);
    }
    
    .review-item-value {
      font-size: 14px;
      font-weight: 500;
    }
    
    .review-entities-list {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    
    .review-entity-tag {
      padding: 4px 10px;
      background: var(--ghg-primary-light);
      color: var(--ghg-primary-dark);
      border-radius: 4px;
      font-size: 12px;
    }
    
    .review-activities-summary {
      display: flex;
      gap: 16px;
    }
    
    .review-scope-summary {
      flex: 1;
      padding: 12px;
      border-radius: 6px;
      text-align: center;
    }
    
    .review-scope-summary.scope-1 {
      background: #FEE2E2;
    }
    
    .review-scope-summary.scope-2 {
      background: #DBEAFE;
    }
    
    .review-scope-summary.scope-3 {
      background: #E0E7FF;
    }
    
    .review-scope-count {
      font-size: 20px;
      font-weight: 700;
    }
    
    .review-scope-label {
      font-size: 11px;
      color: var(--ghg-text-muted);
    }
    
    /* ============================================== */
    /* Entity Tree                                    */
    /* ============================================== */
    
    .entity-tree {
      background: var(--ghg-surface-elevated);
      border: 1px solid var(--ghg-border);
      border-radius: 8px;
      padding: 16px;
    }
    
    .tree-item {
      padding: 6px 0;
    }
    
    .tree-item-row {
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      padding: 8px;
      border-radius: 6px;
      transition: background 0.15s ease;
    }
    
    .tree-item-row:hover {
      background: var(--ghg-surface);
    }
    
    .tree-children {
      margin-left: 28px;
      border-left: 2px solid var(--ghg-border);
      padding-left: 16px;
    }
    
    .tree-icon {
      color: var(--ghg-text-muted);
      width: 18px;
    }
    
    /* ============================================== */
    /* Lock Warning                                   */
    /* ============================================== */
    
    .lock-warning {
      background: var(--ghg-warning-light);
      border: 1px solid var(--ghg-warning);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 20px;
    }
    
    .lock-warning h4 {
      font-size: 14px;
      font-weight: 600;
      color: #9A3412;
      margin: 0 0 8px 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .lock-warning p {
      font-size: 13px;
      color: #9A3412;
      margin: 0;
      line-height: 1.6;
    }
    
    .lock-warning ul {
      margin: 8px 0 0 20px;
      font-size: 13px;
      color: #9A3412;
    }
    
    .confirm-checkbox {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 16px;
      font-size: 14px;
      color: var(--ghg-text);
      cursor: pointer;
    }
    
    /* ============================================== */
    /* Toast Notifications                            */
    /* ============================================== */
    
    .toast-container {
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 2000;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .toast {
      background: var(--ghg-text);
      color: white;
      padding: 14px 20px;
      border-radius: 10px;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 12px;
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2);
      animation: slideInRight 0.3s ease;
    }
    
    .toast.success {
      background: var(--ghg-success);
    }
    
    .toast.error {
      background: var(--ghg-danger);
    }
    
    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    /* ============================================== */
    /* View Switching                                 */
    /* ============================================== */
    
    .view {
      display: none;
    }
    
    .view.active {
      display: block;
    }
    
    /* ============================================== */
    /* Inventory List                                 */
    /* ============================================== */
    
    .inventory-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .inventory-card {
      background: var(--ghg-surface);
      border: 1px solid var(--ghg-border);
      border-radius: 12px;
      padding: 20px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .inventory-card:hover {
      border-color: var(--ghg-primary);
      box-shadow: 0 4px 16px var(--ghg-primary-glow);
      transform: translateY(-2px);
    }
    
    .inventory-card-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    .inventory-icon {
      width: 48px;
      height: 48px;
      background: var(--ghg-primary-light);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--ghg-primary-dark);
      font-size: 20px;
    }
    
    .inventory-info h3 {
      font-family: var(--font-display);
      font-size: 16px;
      font-weight: 600;
      color: var(--ghg-text);
      margin: 0 0 4px 0;
    }
    
    .inventory-card-meta {
      font-size: 13px;
      color: var(--ghg-text-secondary);
    }
    
    .inventory-card-right {
      display: flex;
      align-items: center;
      gap: 24px;
    }
    
    .inventory-stat {
      text-align: right;
    }
    
    .inventory-stat-value {
      font-family: var(--font-mono);
      font-size: 20px;
      font-weight: 600;
      color: var(--ghg-text);
    }
    
    .inventory-stat-label {
      font-size: 12px;
      color: var(--ghg-text-secondary);
    }
    
    /* ============================================== */
    /* Search Bar                                     */
    /* ============================================== */
    
    .search-bar {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
    }
    
    .search-input-wrapper {
      position: relative;
      flex: 1;
      max-width: 400px;
    }
    
    .search-input-wrapper i {
      position: absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--ghg-text-muted);
    }
    
    .search-input-wrapper input {
      padding-left: 40px;
    }
    
    /* ============================================== */
    /* Dual Scope 2 Display                           */
    /* ============================================== */
    
    .dual-scope-card {
      background: var(--ghg-scope-2-light);
      border: 1px solid rgba(139, 92, 246, 0.3);
      border-radius: 8px;
      padding: 16px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    
    .dual-scope-item {
      background: var(--ghg-surface);
      border-radius: 6px;
      padding: 12px;
    }
    
    .dual-scope-label {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--ghg-text-secondary);
      margin-bottom: 4px;
    }
    
    .dual-scope-value {
      font-family: var(--font-mono);
      font-size: 20px;
      font-weight: 600;
      color: var(--ghg-scope-2);
    }
    
    .dual-scope-note {
      font-size: 11px;
      color: var(--ghg-text-muted);
      margin-top: 4px;
    }
    
    /* ============================================== */
    /* Matrix Table                                   */
    /* ============================================== */
    
    .matrix-container {
      overflow-x: auto;
    }
    
    .matrix-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    
    .matrix-table th,
    .matrix-table td {
      padding: 12px 16px;
      text-align: center;
      border: 1px solid var(--ghg-border);
    }
    
    .matrix-table th {
      background: var(--ghg-surface-elevated);
      font-weight: 600;
      color: var(--ghg-text);
      white-space: nowrap;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }
    
    .matrix-table th:first-child {
      text-align: left;
      min-width: 180px;
    }
    
    .matrix-table td:first-child {
      text-align: left;
      font-weight: 500;
      background: var(--ghg-surface-elevated);
    }
    
    .matrix-cell {
      cursor: pointer;
      transition: all 0.15s ease;
    }
    
    .matrix-cell:hover {
      background: var(--ghg-primary-light);
    }
    
    .status-ready {
      color: var(--ghg-success);
    }
    
    .status-needs-config {
      color: var(--ghg-warning);
    }
    
    .status-na {
      color: var(--ghg-text-muted);
    }
    
    .matrix-legend {
      display: flex;
      gap: 24px;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--ghg-border);
      font-size: 13px;
      color: var(--ghg-text-secondary);
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    /* ============================================== */
    /* Inventory Wizard Additions                     */
    /* ============================================== */

    #view-create-inventory .content-container {
      max-width: 1600px;
    }

    #view-create-inventory .card {
      overflow: visible;
    }

    #view-create-inventory .card-body {
      padding: 24px 28px;
    }

    /* When on step 3, use full width */
    #view-create-inventory .card-body:has(.operational-boundary-step) {
      padding: 20px 24px;
    }

    /* Operational Boundary Unified Step */
    .operational-boundary-step {
      flex-direction: column;
      gap: 0;
    }

    .operational-boundary-step.active {
      display: flex;
    }

    /* Method Banner - Redesigned for Decoupled Architecture */
    .op-method-banner {
      background: linear-gradient(135deg, var(--ghg-surface) 0%, var(--ghg-surface-elevated) 100%);
      border: 1px solid var(--ghg-border);
      border-radius: 10px;
      padding: 16px 20px;
      margin-bottom: 16px;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .method-banner-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      flex-wrap: wrap;
    }

    .method-banner-left {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .method-banner-label {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--ghg-text-muted);
    }

    .method-select-wrapper {
      position: relative;
      display: inline-flex;
      align-items: center;
    }

    .method-select {
      padding: 10px 40px 10px 14px;
      font-size: 14px;
      font-weight: 600;
      font-family: var(--font-sans);
      color: var(--ghg-text);
      background: var(--ghg-surface);
      border: 1px solid var(--ghg-border);
      border-radius: 8px;
      cursor: pointer;
      appearance: none;
      min-width: 280px;
      transition: all 0.15s ease;
    }

    .method-select:hover {
      border-color: var(--ghg-border-strong);
    }

    .method-select:focus {
      outline: none;
      border-color: var(--ghg-primary);
      box-shadow: 0 0 0 3px var(--ghg-primary-light);
    }

    .method-select-wrapper::after {
      content: '\f107';
      font-family: 'Font Awesome 6 Pro';
      font-weight: 300;
      position: absolute;
      right: 14px;
      color: var(--ghg-text-muted);
      pointer-events: none;
    }

    .method-link {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      color: var(--ghg-primary);
      text-decoration: none;
      transition: color 0.15s ease;
    }

    .method-link:hover {
      color: var(--ghg-primary-dark);
      text-decoration: underline;
    }

    .method-link i {
      font-size: 11px;
    }

    .method-summary {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      padding-top: 14px;
      border-top: 1px solid var(--ghg-border);
    }

    .method-summary .summary-item {
      font-size: 12px;
      color: var(--ghg-text-secondary);
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 5px 10px;
      background: var(--ghg-surface);
      border: 1px solid var(--ghg-border);
      border-radius: 6px;
    }

    .method-summary .summary-item i {
      color: var(--ghg-text-muted);
      font-size: 11px;
    }

    .method-summary .summary-item.highlight {
      background: var(--ghg-primary-light);
      border-color: var(--ghg-primary);
      color: var(--ghg-primary-dark);
    }

    .method-summary .summary-item.highlight i {
      color: var(--ghg-primary);
    }

    /* Coverage Strip */
    .op-coverage-strip {
      display: flex;
      align-items: center;
      gap: 24px;
      padding: 12px 18px;
      background: var(--ghg-surface);
      border: 1px solid var(--ghg-border);
      border-radius: 10px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .op-coverage-strip .coverage-stat {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .op-coverage-strip .coverage-stat .stat-value {
      font-size: 18px;
      font-weight: 700;
      color: var(--ghg-text);
    }

    .op-coverage-strip .coverage-stat.highlight .stat-value {
      color: var(--ghg-primary);
    }

    .op-coverage-strip .coverage-stat.warning .stat-value {
      color: var(--ghg-warning);
    }

    .op-coverage-strip .coverage-stat .stat-label {
      font-size: 11px;
      color: var(--ghg-text-muted);
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .op-coverage-strip .btn {
      margin-left: auto;
    }

    /* Activities Table */
    .op-activities-table-wrap {
      overflow-x: auto;
      border: 1px solid var(--ghg-border);
      border-radius: 10px;
      background: var(--ghg-surface);
    }

    .op-activities-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    .op-activities-table thead {
      background: var(--ghg-surface-elevated);
    }

    .op-activities-table th {
      padding: 10px 12px;
      text-align: left;
      font-weight: 600;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      color: var(--ghg-text-muted);
      border-bottom: 1px solid var(--ghg-border);
      white-space: nowrap;
    }

    .op-activities-table th.col-select { width: 40px; text-align: center; }
    .op-activities-table th.col-scope { width: 60px; }
    .op-activities-table th.col-activity { min-width: 180px; }
    .op-activities-table th.col-records { width: 80px; text-align: right; }
    .op-activities-table th.col-coverage { width: 140px; }
    .op-activities-table th.col-ef { min-width: 200px; }
    .op-activities-table th.col-override { width: 130px; }

    .op-activities-table td {
      padding: 12px;
      border-bottom: 1px solid var(--ghg-border-light);
      vertical-align: top;
    }

    .op-activities-table tr:last-child td {
      border-bottom: none;
    }

    .op-activities-table tbody tr {
      transition: background-color 0.15s ease;
    }

    .op-activities-table tbody tr:hover {
      background-color: var(--ghg-surface-elevated);
    }

    .op-activities-table .scope-row.inactive {
      opacity: 0.55;
      background: var(--ghg-surface-elevated);
    }

    .op-activities-table .scope-row.inactive:hover {
      opacity: 0.8;
    }

    .op-activities-table td:first-child {
      text-align: center;
      vertical-align: middle;
    }

    .op-activities-table .activity-checkbox {
      width: 16px;
      height: 16px;
      accent-color: var(--ghg-primary);
    }

    .op-activities-table .activity-name {
      font-weight: 600;
      color: var(--ghg-text);
      margin-bottom: 2px;
    }

    .op-activities-table .activity-path {
      font-size: 11px;
      color: var(--ghg-text-muted);
    }

    .op-activities-table td.numeric {
      text-align: right;
      font-variant-numeric: tabular-nums;
      color: var(--ghg-text-secondary);
      vertical-align: middle;
    }

    /* Coverage cell */
    .op-activities-table .coverage-cell {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .op-activities-table .mini-bar {
      flex: 1;
      height: 6px;
      background: var(--ghg-border-light);
      border-radius: 3px;
      overflow: hidden;
      min-width: 60px;
    }

    .op-activities-table .mini-fill {
      height: 100%;
      background: var(--ghg-primary);
      border-radius: 3px;
      transition: width 0.3s ease;
    }

    .op-activities-table .coverage-pct {
      font-weight: 600;
      font-size: 12px;
      min-width: 36px;
      text-align: right;
    }

    .op-activities-table .coverage-pct.good { color: var(--ghg-success); }
    .op-activities-table .coverage-pct.medium { color: var(--ghg-warning); }
    .op-activities-table .coverage-pct.low { color: var(--ghg-danger); }

    /* EF cell */
    .op-activities-table .ef-cell {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 4px;
    }

    .op-activities-table .ef-cell:last-child {
      margin-bottom: 0;
    }

    .op-activities-table .ef-cell.muted {
      opacity: 0.6;
    }

    .op-activities-table .ef-badge {
      display: inline-block;
      padding: 3px 8px;
      background: var(--ghg-primary-light);
      color: var(--ghg-primary-dark);
      font-size: 11px;
      font-weight: 500;
      border-radius: 4px;
      white-space: nowrap;
    }

    .op-activities-table .ef-regions {
      font-size: 10px;
      color: var(--ghg-text-muted);
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    /* Override select */
    .op-activities-table .override-select {
      font-size: 12px;
      padding: 5px 8px;
      border: 1px solid var(--ghg-border);
      border-radius: 6px;
      background: var(--ghg-surface);
      color: var(--ghg-text);
      cursor: pointer;
      min-width: 100px;
    }

    .op-activities-table .override-select:hover {
      border-color: var(--ghg-border-strong);
    }

    .op-activities-table .override-select:focus {
      outline: none;
      border-color: var(--ghg-primary);
      box-shadow: 0 0 0 2px var(--ghg-primary-light);
    }

    /* Entities column */
    .op-activities-table th.col-entities { width: 130px; }
    .op-activities-table th.col-action { width: 50px; }

    .op-activities-table .entity-count {
      white-space: nowrap;
    }

    .op-activities-table .gap-count {
      font-size: 11px;
      color: var(--ghg-warning);
      font-weight: 500;
    }

    .op-activities-table .gap-count.good {
      color: var(--ghg-success);
    }

    .op-activities-table .coverage-hint {
      font-size: 10px;
      color: var(--ghg-text-muted);
      cursor: help;
      margin-left: 4px;
    }

    .op-activities-table .action-cell {
      text-align: center;
      vertical-align: middle;
    }

    .op-activities-table .btn-detail {
      width: 32px;
      height: 32px;
      border: 1px solid var(--ghg-border);
      background: var(--ghg-surface);
      border-radius: 6px;
      color: var(--ghg-text-muted);
      cursor: pointer;
      transition: all 0.15s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .op-activities-table .btn-detail:hover {
      background: var(--ghg-primary-light);
      border-color: var(--ghg-primary);
      color: var(--ghg-primary);
    }

    /* Activity Flyout */
    .activity-flyout {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 1100;
      display: none;
    }

    .activity-flyout.open {
      display: block;
    }

    .flyout-backdrop {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.3);
      animation: fadeIn 0.2s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .flyout-panel {
      position: absolute;
      top: 0;
      right: 0;
      bottom: 0;
      width: 520px;
      max-width: 100%;
      background: var(--ghg-surface);
      box-shadow: -4px 0 24px rgba(0, 0, 0, 0.12);
      display: flex;
      flex-direction: column;
      animation: slideIn 0.25s ease;
    }

    @keyframes slideIn {
      from { transform: translateX(100%); }
      to { transform: translateX(0); }
    }

    .flyout-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 24px;
      border-bottom: 1px solid var(--ghg-border);
      background: var(--ghg-surface-elevated);
    }

    .flyout-title-group {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .flyout-scope-badge {
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
    }

    .flyout-scope-badge.scope-1 {
      background: var(--ghg-scope-1-light);
      color: var(--ghg-scope-1);
    }

    .flyout-scope-badge.scope-2 {
      background: var(--ghg-scope-2-light);
      color: var(--ghg-scope-2);
    }

    .flyout-scope-badge.scope-3 {
      background: var(--ghg-scope-3-light);
      color: var(--ghg-scope-3);
    }

    .flyout-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--ghg-text);
      margin: 0;
    }

    .flyout-close {
      width: 36px;
      height: 36px;
      border: none;
      background: transparent;
      border-radius: 8px;
      color: var(--ghg-text-muted);
      cursor: pointer;
      font-size: 18px;
      transition: all 0.15s ease;
    }

    .flyout-close:hover {
      background: var(--ghg-surface);
      color: var(--ghg-text);
    }

    .flyout-body {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
    }

    .flyout-stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-bottom: 24px;
    }

    .flyout-stat {
      background: var(--ghg-surface-elevated);
      border: 1px solid var(--ghg-border);
      border-radius: 10px;
      padding: 14px;
      text-align: center;
    }

    .flyout-stat .stat-value {
      display: block;
      font-size: 22px;
      font-weight: 700;
      color: var(--ghg-text);
      line-height: 1;
      margin-bottom: 4px;
    }

    .flyout-stat .stat-label {
      font-size: 11px;
      color: var(--ghg-text-muted);
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .flyout-stat.warning .stat-value {
      color: var(--ghg-warning);
    }

    .flyout-stat.highlight .stat-value {
      color: var(--ghg-primary);
    }

    .flyout-section {
      margin-bottom: 24px;
    }

    .flyout-section-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--ghg-text);
      margin: 0 0 12px 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .flyout-section-title .count-badge {
      background: var(--ghg-warning-light, #FEF3C7);
      color: var(--ghg-warning);
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 10px;
    }

    /* Regional Breakdown */
    .flyout-region-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .flyout-region-row {
      display: grid;
      grid-template-columns: 140px 1fr 50px;
      align-items: center;
      gap: 12px;
      padding: 10px 12px;
      background: var(--ghg-surface-elevated);
      border-radius: 8px;
    }

    .flyout-region-row .region-info {
      display: flex;
      flex-direction: column;
    }

    .flyout-region-row .region-name {
      font-size: 13px;
      font-weight: 600;
      color: var(--ghg-text);
    }

    .flyout-region-row .region-detail {
      font-size: 11px;
      color: var(--ghg-text-muted);
    }

    .flyout-region-row .region-bar {
      height: 8px;
      background: var(--ghg-border-light);
      border-radius: 4px;
      overflow: hidden;
    }

    .flyout-region-row .region-fill {
      height: 100%;
      background: var(--ghg-primary);
      border-radius: 4px;
    }

    .flyout-region-row .region-pct {
      font-size: 13px;
      font-weight: 600;
      text-align: right;
    }

    .flyout-region-row .region-pct.good { color: var(--ghg-success); }
    .flyout-region-row .region-pct.medium { color: var(--ghg-warning); }
    .flyout-region-row .region-pct.low { color: var(--ghg-danger); }

    /* EF Table in Flyout */
    .flyout-ef-table {
      border: 1px solid var(--ghg-border);
      border-radius: 8px;
      overflow: hidden;
    }

    .flyout-ef-table .ef-row {
      display: grid;
      grid-template-columns: 100px 1fr 80px;
      padding: 10px 14px;
      font-size: 13px;
      border-bottom: 1px solid var(--ghg-border-light);
    }

    .flyout-ef-table .ef-row:last-child {
      border-bottom: none;
    }

    .flyout-ef-table .ef-row.header {
      background: var(--ghg-surface-elevated);
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      color: var(--ghg-text-muted);
    }

    .flyout-ef-table .ef-badge {
      display: inline-block;
      padding: 3px 8px;
      background: var(--ghg-primary-light);
      color: var(--ghg-primary-dark);
      font-size: 11px;
      font-weight: 500;
      border-radius: 4px;
    }

    /* Missing List */
    .flyout-missing-list {
      border: 1px solid var(--ghg-border);
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 12px;
    }

    .missing-entity {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 14px;
      font-size: 13px;
      border-bottom: 1px solid var(--ghg-border-light);
    }

    .missing-entity:last-child {
      border-bottom: none;
    }

    .missing-entity .entity-name {
      color: var(--ghg-text);
    }

    .missing-entity .entity-region {
      font-size: 11px;
      color: var(--ghg-text-muted);
      background: var(--ghg-surface-elevated);
      padding: 3px 8px;
      border-radius: 4px;
    }

    .flyout-more-btn {
      width: 100%;
      justify-content: center;
    }

    @media (max-width: 600px) {
      .flyout-panel {
        width: 100%;
      }

      .flyout-stats {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    /* Selection Summary */
    .op-selection-summary {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 12px;
      padding: 14px 18px;
      margin-top: 16px;
      background: var(--ghg-surface-elevated);
      border: 1px solid var(--ghg-border);
      border-radius: 10px;
    }

    .op-selection-summary .summary-left {
      display: flex;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
    }

    .op-selection-summary .selected-count {
      font-size: 14px;
      color: var(--ghg-text);
    }

    .op-selection-summary .scope-breakdown {
      display: flex;
      gap: 8px;
    }

    .op-selection-summary .scope-chip {
      display: inline-block;
      padding: 4px 10px;
      font-size: 11px;
      font-weight: 600;
      border-radius: 999px;
    }

    .op-selection-summary .scope-chip.scope-1 {
      background: var(--ghg-scope-1-light);
      color: var(--ghg-scope-1);
    }

    .op-selection-summary .scope-chip.scope-2 {
      background: var(--ghg-scope-2-light);
      color: var(--ghg-scope-2);
    }

    .op-selection-summary .scope-chip.scope-3 {
      background: var(--ghg-scope-3-light);
      color: var(--ghg-scope-3);
    }

    .op-selection-summary .summary-right {
      display: flex;
      align-items: center;
    }

    .op-selection-summary .override-note {
      font-size: 12px;
      color: var(--ghg-text-muted);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .op-selection-summary .override-note i {
      font-size: 11px;
    }

    /* Activity Filter Bar */
    .activity-filter-bar {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 18px;
      background: var(--ghg-surface);
      border: 1px solid var(--ghg-border);
      border-radius: 10px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .activity-filter-bar .filter-pills {
      display: flex;
      gap: 6px;
    }

    .activity-filter-bar .filter-pill {
      padding: 7px 14px;
      font-size: 13px;
      font-weight: 500;
      color: var(--ghg-text-secondary);
      background: var(--ghg-surface-elevated);
      border: 1px solid var(--ghg-border);
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .activity-filter-bar .filter-pill:hover {
      border-color: var(--ghg-border-strong);
      color: var(--ghg-text);
    }

    .activity-filter-bar .filter-pill.active {
      background: var(--ghg-primary);
      border-color: var(--ghg-primary);
      color: white;
    }

    .activity-filter-bar .filter-pill .pill-count {
      margin-left: 6px;
      padding: 2px 6px;
      font-size: 11px;
      font-weight: 600;
      background: rgba(255,255,255,0.2);
      border-radius: 10px;
    }

    .activity-filter-bar .filter-pill:not(.active) .pill-count {
      background: var(--ghg-surface);
    }

    .activity-filter-bar .filter-search {
      position: relative;
      flex: 1;
      min-width: 200px;
      max-width: 280px;
    }

    .activity-filter-bar .filter-search i {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--ghg-text-muted);
      font-size: 14px;
    }

    .activity-filter-bar .filter-search input {
      width: 100%;
      padding: 9px 12px 9px 36px;
      font-size: 13px;
      font-family: var(--font-sans);
      border: 1px solid var(--ghg-border);
      border-radius: 8px;
      background: var(--ghg-surface);
      color: var(--ghg-text);
      transition: border-color 0.15s ease;
    }

    .activity-filter-bar .filter-search input:focus {
      outline: none;
      border-color: var(--ghg-primary);
    }

    .activity-filter-bar .filter-search input::placeholder {
      color: var(--ghg-text-muted);
    }

    .activity-filter-bar .filter-actions {
      display: flex;
      gap: 8px;
      margin-left: auto;
    }

    .activity-filter-bar .btn-add-activity {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 9px 16px;
      font-size: 13px;
      font-weight: 600;
      font-family: var(--font-sans);
      color: white;
      background: var(--ghg-primary);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .activity-filter-bar .btn-add-activity:hover {
      background: var(--ghg-primary-dark);
    }

    .activity-filter-status {
      width: 100%;
      padding-top: 10px;
      margin-top: 10px;
      border-top: 1px solid var(--ghg-border);
      font-size: 12px;
      color: var(--ghg-text-muted);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .activity-filter-status .clear-filter {
      color: var(--ghg-primary);
      cursor: pointer;
      text-decoration: none;
    }

    .activity-filter-status .clear-filter:hover {
      text-decoration: underline;
    }

    /* Add Activity Modal */
    .add-activity-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1100;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s ease;
    }

    .add-activity-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .add-activity-modal {
      background: var(--ghg-surface);
      border-radius: 16px;
      width: 90%;
      max-width: 900px;
      max-height: 85vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      transform: translateY(20px);
      transition: transform 0.2s ease;
    }

    .add-activity-overlay.active .add-activity-modal {
      transform: translateY(0);
    }

    .add-activity-modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 24px;
      border-bottom: 1px solid var(--ghg-border);
    }

    .add-activity-modal-header h3 {
      font-family: var(--font-display);
      font-size: 18px;
      font-weight: 600;
      margin: 0;
    }

    .add-activity-modal-header .close-btn {
      width: 36px;
      height: 36px;
      border: none;
      background: transparent;
      border-radius: 8px;
      cursor: pointer;
      color: var(--ghg-text-muted);
      transition: all 0.15s ease;
    }

    .add-activity-modal-header .close-btn:hover {
      background: var(--ghg-surface-elevated);
      color: var(--ghg-text);
    }

    .add-activity-modal-search {
      padding: 16px 24px;
      border-bottom: 1px solid var(--ghg-border);
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .add-activity-search-input {
      position: relative;
      flex: 1;
      min-width: 200px;
    }

    .add-activity-search-input i {
      position: absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--ghg-text-muted);
    }

    .add-activity-search-input input {
      width: 100%;
      padding: 11px 14px 11px 40px;
      font-size: 14px;
      font-family: var(--font-sans);
      border: 1px solid var(--ghg-border);
      border-radius: 8px;
      background: var(--ghg-surface);
      color: var(--ghg-text);
    }

    .add-activity-search-input input:focus {
      outline: none;
      border-color: var(--ghg-primary);
    }

    .add-activity-scope-filter {
      display: flex;
      gap: 6px;
    }

    .add-activity-scope-filter .scope-btn {
      padding: 10px 14px;
      font-size: 13px;
      font-weight: 500;
      border: 1px solid var(--ghg-border);
      background: var(--ghg-surface);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.15s ease;
      color: var(--ghg-text-secondary);
    }

    .add-activity-scope-filter .scope-btn:hover {
      border-color: var(--ghg-border-strong);
    }

    .add-activity-scope-filter .scope-btn.active {
      background: var(--ghg-primary);
      border-color: var(--ghg-primary);
      color: white;
    }

    .add-activity-modal-body {
      flex: 1;
      overflow-y: auto;
      padding: 16px 24px;
    }

    .activity-catalog-section {
      margin-bottom: 24px;
    }

    .activity-catalog-section:last-child {
      margin-bottom: 0;
    }

    .activity-catalog-section-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--ghg-text-muted);
    }

    .activity-catalog-section-header::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--ghg-border);
    }

    .activity-catalog-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 12px;
    }

    .activity-catalog-card {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 14px;
      border: 1px solid var(--ghg-border);
      border-radius: 10px;
      background: var(--ghg-surface);
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .activity-catalog-card:hover {
      border-color: var(--ghg-primary);
      background: var(--ghg-primary-light);
    }

    .activity-catalog-card.selected {
      border-color: var(--ghg-primary);
      background: var(--ghg-primary-light);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .activity-catalog-card.has-data {
      border-left: 3px solid var(--ghg-success);
    }

    .activity-catalog-card .card-checkbox {
      width: 20px;
      height: 20px;
      border: 2px solid var(--ghg-border-strong);
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      margin-top: 2px;
    }

    .activity-catalog-card.selected .card-checkbox {
      background: var(--ghg-primary);
      border-color: var(--ghg-primary);
      color: white;
    }

    .activity-catalog-card .card-checkbox i {
      font-size: 12px;
      opacity: 0;
    }

    .activity-catalog-card.selected .card-checkbox i {
      opacity: 1;
    }

    .activity-catalog-card .card-content {
      flex: 1;
      min-width: 0;
    }

    .activity-catalog-card .card-title {
      font-weight: 600;
      font-size: 14px;
      color: var(--ghg-text);
      margin-bottom: 4px;
    }

    .activity-catalog-card .card-meta {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: var(--ghg-text-muted);
    }

    .activity-catalog-card .card-meta .has-data-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      background: var(--ghg-success-light);
      color: var(--ghg-success);
      border-radius: 10px;
      font-size: 11px;
      font-weight: 500;
    }

    .activity-catalog-card .card-meta .no-data-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      background: var(--ghg-surface-elevated);
      color: var(--ghg-text-muted);
      border-radius: 10px;
      font-size: 11px;
    }

    .activity-catalog-card .card-description {
      font-size: 12px;
      color: var(--ghg-text-secondary);
      margin-top: 6px;
      line-height: 1.4;
    }

    .add-activity-modal-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 24px;
      border-top: 1px solid var(--ghg-border);
      background: var(--ghg-surface-elevated);
    }

    .add-activity-modal-footer .selection-summary {
      font-size: 14px;
      color: var(--ghg-text-secondary);
    }

    .add-activity-modal-footer .selection-summary strong {
      color: var(--ghg-text);
    }

    .add-activity-modal-footer .footer-actions {
      display: flex;
      gap: 8px;
    }

    /* Remove Confirmation Modal */
    .remove-confirm-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1200;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s ease;
    }

    .remove-confirm-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .remove-confirm-modal {
      background: var(--ghg-surface);
      border-radius: 12px;
      width: 90%;
      max-width: 420px;
      padding: 24px;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    }

    .remove-confirm-modal h4 {
      font-family: var(--font-display);
      font-size: 16px;
      font-weight: 600;
      margin: 0 0 12px 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .remove-confirm-modal h4 i {
      color: var(--ghg-warning);
    }

    .remove-confirm-modal p {
      font-size: 14px;
      color: var(--ghg-text-secondary);
      line-height: 1.5;
      margin: 0 0 20px 0;
    }

    .remove-confirm-modal .warning-box {
      padding: 12px;
      background: var(--ghg-warning-light);
      border-radius: 8px;
      font-size: 13px;
      color: var(--ghg-warning);
      margin-bottom: 20px;
      display: flex;
      align-items: flex-start;
      gap: 10px;
    }

    .remove-confirm-modal .warning-box i {
      margin-top: 2px;
    }

    .remove-confirm-modal .confirm-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    .remove-confirm-modal .btn-danger {
      background: var(--ghg-danger);
      border-color: var(--ghg-danger);
      color: white;
    }

    .remove-confirm-modal .btn-danger:hover {
      background: #DC2626;
    }

    /* Activity Hierarchy Table - Decoupled Architecture */
    .activity-hierarchy {
      border: 1px solid var(--ghg-border);
      border-radius: 10px;
      background: var(--ghg-surface);
      overflow: hidden;
    }

    .activity-hierarchy-header {
      display: grid;
      grid-template-columns: 50px 180px 90px 80px 90px 90px 100px 160px 90px 50px;
      gap: 0;
      padding: 12px 16px;
      background: var(--ghg-surface-elevated);
      border-bottom: 1px solid var(--ghg-border);
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      color: var(--ghg-text-muted);
    }

    .activity-hierarchy-header span {
      display: flex;
      align-items: center;
    }

    .activity-hierarchy-header .col-select { justify-content: center; }
    .activity-hierarchy-header .col-entities,
    .activity-hierarchy-header .col-records,
    .activity-hierarchy-header .col-selected { justify-content: flex-end; }

    /* Activity Row */
    .activity-row {
      border-bottom: 1px solid var(--ghg-border);
    }

    .activity-row:last-child {
      border-bottom: none;
    }

    .activity-row-main {
      display: grid;
      grid-template-columns: 50px 180px 90px 80px 90px 90px 100px 160px 90px 50px;
      gap: 0;
      padding: 14px 16px;
      align-items: center;
      cursor: pointer;
      transition: background 0.15s ease;
    }

    .activity-row-main:hover {
      background: var(--ghg-surface-elevated);
    }

    .activity-row.inactive .activity-row-main {
      opacity: 0.55;
      background: var(--ghg-surface-elevated);
    }

    .activity-row.inactive .activity-row-main:hover {
      opacity: 0.8;
    }

    .activity-row .expand-toggle {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      border-radius: 6px;
      color: var(--ghg-text-muted);
      transition: all 0.15s ease;
    }

    .activity-row .expand-toggle:hover {
      background: var(--ghg-surface-elevated);
      color: var(--ghg-primary);
    }

    .activity-row .expand-toggle i {
      font-size: 12px;
      transition: transform 0.2s ease;
    }

    .activity-row.expanded .expand-toggle i {
      transform: rotate(90deg);
    }

    .activity-row .activity-info {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .activity-row .activity-name {
      font-weight: 600;
      color: var(--ghg-text);
      font-size: 14px;
    }

    .activity-row .activity-path {
      font-size: 11px;
      color: var(--ghg-text-muted);
    }

    .activity-row .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
    }

    .activity-row .status-badge.ready {
      background: var(--ghg-success-light);
      color: #166534;
    }

    .activity-row .status-badge.issues {
      background: var(--ghg-warning-light);
      color: #9A3412;
    }

    .activity-row .status-badge.needs-data {
      background: var(--ghg-danger-light);
      color: #991B1B;
    }

    .activity-row .col-value {
      font-size: 13px;
      color: var(--ghg-text);
      font-variant-numeric: tabular-nums;
    }

    .activity-row .col-value.right {
      text-align: right;
    }

    .activity-row .col-value.selected-count {
      font-weight: 600;
      color: var(--ghg-primary);
    }

    .activity-row .ef-readonly {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .activity-row .ef-readonly-item {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
    }

    .activity-row .ef-readonly-badge {
      display: inline-block;
      padding: 3px 8px;
      background: var(--ghg-primary-light);
      color: var(--ghg-primary-dark);
      font-size: 11px;
      font-weight: 500;
      border-radius: 4px;
    }

    .activity-row .ef-readonly-region {
      font-size: 10px;
      color: var(--ghg-text-muted);
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .activity-row .ef-link {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      color: var(--ghg-primary);
      text-decoration: none;
      margin-top: 4px;
    }

    .activity-row .ef-link:hover {
      text-decoration: underline;
    }

    .activity-row .btn-expand-detail {
      width: 32px;
      height: 32px;
      border: 1px solid var(--ghg-border);
      background: var(--ghg-surface);
      border-radius: 6px;
      color: var(--ghg-text-muted);
      cursor: pointer;
      transition: all 0.15s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .activity-row .btn-expand-detail:hover {
      background: var(--ghg-primary-light);
      border-color: var(--ghg-primary);
      color: var(--ghg-primary);
    }

    /* Remove Activity Button */
    .activity-row .btn-remove-activity {
      width: 32px;
      height: 32px;
      border: 1px solid transparent;
      background: transparent;
      border-radius: 6px;
      color: var(--ghg-text-muted);
      cursor: pointer;
      transition: all 0.15s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
    }

    .activity-row-main:hover .btn-remove-activity {
      opacity: 1;
    }

    .activity-row .btn-remove-activity:hover {
      background: var(--ghg-danger-light);
      border-color: var(--ghg-danger);
      color: var(--ghg-danger);
    }

    /* Pending Data State */
    .activity-row .status-badge.pending {
      background: var(--ghg-info-light);
      color: #1D4ED8;
    }

    .activity-row.pending-data {
      background: linear-gradient(90deg, rgba(59, 130, 246, 0.05) 0%, transparent 100%);
    }

    .activity-row.pending-data .activity-row-main {
      border-left: 3px solid var(--ghg-primary);
      margin-left: -3px;
      padding-left: 19px;
    }

    .activity-row .pending-data-indicator {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--ghg-text-muted);
    }

    .activity-row .pending-data-indicator i {
      font-size: 11px;
      color: var(--ghg-primary);
    }

    .activity-row .pending-data-indicator .pending-tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      background: var(--ghg-info-light);
      color: #1D4ED8;
      border-radius: 10px;
      font-size: 11px;
      font-weight: 500;
    }

    /* Newly added activity highlight */
    .activity-row.newly-added {
      animation: fadeInRow 0.3s ease;
    }

    @keyframes fadeInRow {
      from {
        opacity: 0;
        background: rgba(59, 130, 246, 0.1);
      }
      to {
        opacity: 1;
        background: transparent;
      }
    }

    /* Region Expansion */
    .activity-regions {
      display: none;
      background: var(--ghg-surface-elevated);
      border-top: 1px solid var(--ghg-border);
    }

    .activity-row.expanded .activity-regions {
      display: block;
    }

    .region-row {
      display: grid;
      grid-template-columns: 50px 180px 90px 80px 90px 90px 100px 160px 90px 50px;
      gap: 0;
      padding: 12px 16px;
      padding-left: 66px;
      align-items: center;
      border-bottom: 1px solid var(--ghg-border);
      transition: background 0.15s ease;
    }

    .region-row:last-child {
      border-bottom: none;
    }

    .region-row:hover {
      background: rgba(0, 0, 0, 0.02);
    }

    .region-row .region-select {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .region-row .region-checkbox {
      width: 16px;
      height: 16px;
      accent-color: var(--ghg-primary);
    }

    .region-row .region-info {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .region-row .region-name {
      font-weight: 500;
      color: var(--ghg-text);
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .region-row .region-name i {
      color: var(--ghg-text-muted);
      font-size: 12px;
    }

    .region-row .region-detail {
      font-size: 11px;
      color: var(--ghg-text-muted);
    }

    .region-row .region-status {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      font-weight: 500;
    }

    .region-row .region-status.ready {
      color: var(--ghg-success);
    }

    .region-row .region-status.issues {
      color: var(--ghg-warning);
    }

    .region-row .region-status.needs-data {
      color: var(--ghg-danger);
    }

    .region-row .col-value {
      font-size: 13px;
      color: var(--ghg-text-secondary);
      font-variant-numeric: tabular-nums;
    }

    .region-row .col-value.right {
      text-align: right;
    }

    .region-row .ef-readonly-badge {
      display: inline-block;
      padding: 3px 8px;
      background: var(--ghg-surface);
      color: var(--ghg-text-secondary);
      font-size: 11px;
      font-weight: 500;
      border-radius: 4px;
      border: 1px solid var(--ghg-border);
    }

    /* Updated Selection Summary for Decoupled Architecture */
    .op-selection-summary .method-coverage {
      display: flex;
      align-items: center;
      gap: 16px;
      padding-left: 16px;
      border-left: 1px solid var(--ghg-border);
      margin-left: 16px;
    }

    .op-selection-summary .coverage-item {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .op-selection-summary .coverage-item .coverage-value {
      font-size: 14px;
      font-weight: 700;
      color: var(--ghg-success);
    }

    .op-selection-summary .coverage-item .coverage-label {
      font-size: 10px;
      color: var(--ghg-text-muted);
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .op-selection-summary .method-link {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--ghg-primary);
      text-decoration: none;
    }

    .op-selection-summary .method-link:hover {
      text-decoration: underline;
    }

    /* Widen step 3 content */
    .operational-boundary-step.active {
      max-width: none !important;
    }

    #view-create-inventory .wizard-step-content[data-step="3"] {
      max-width: none;
    }

    /* Emission factor preferences (Step 4) */
    #view-create-inventory .wizard-step-content[data-step="4"] {
      max-width: none;
    }
    .ef-prefs-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 24px;
      margin-bottom: 12px;
    }
    .ef-prefs-header h3 { margin: 0 0 8px 0; }
    .ef-prefs-desc {
      color: var(--ghg-text-secondary);
      font-size: 14px;
      margin-bottom: 20px;
      max-width: 720px;
    }
    .ef-prefs-category {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 24px;
    }
    .ef-prefs-category .form-select { width: 220px; }
    .ef-prefs-section {
      margin-bottom: 28px;
    }
    .ef-prefs-section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 8px 16px;
      margin-bottom: 12px;
    }
    .ef-prefs-section-title {
      font-family: var(--font-display);
      font-size: 15px;
      font-weight: 600;
      color: var(--ghg-text);
      margin: 0;
    }
    .ef-prefs-section-link {
      font-size: 13px;
      color: var(--ghg-primary-dark);
      text-decoration: none;
      display: inline-block;
    }
    .ef-prefs-section-link:hover { text-decoration: underline; }
    .ef-prefs-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
      border: 1px solid var(--ghg-border);
      border-radius: 8px;
      overflow: hidden;
      table-layout: fixed;
    }
    .ef-prefs-table th:nth-child(1),
    .ef-prefs-table td:nth-child(1) { width: 18%; }
    .ef-prefs-table th:nth-child(2),
    .ef-prefs-table td:nth-child(2) { width: 48%; }
    .ef-prefs-table th:nth-child(3),
    .ef-prefs-table td:nth-child(3) { width: 22%; }
    .ef-prefs-table th:nth-child(4),
    .ef-prefs-table td:nth-child(4) { width: 12%; min-width: 100px; text-align: center; }
    .ef-prefs-table th {
      text-align: left;
      padding: 10px 14px;
      background: var(--ghg-surface-elevated);
      font-weight: 600;
      color: var(--ghg-text);
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }
    .ef-prefs-table th:nth-child(4) { text-align: center; }
    .ef-prefs-table td {
      padding: 12px 14px;
      border-top: 1px solid var(--ghg-border);
      color: var(--ghg-text);
    }
    .ef-prefs-table td:nth-child(4) { text-align: center; vertical-align: middle; }
    .ef-prefs-table tr:hover td { background: var(--ghg-surface-elevated); }
    .ef-prefs-table .geo-cell {
      display: flex;
      align-items: center;
      gap: 6px;
      background: transparent;
    }
    .ef-prefs-table .geo-info {
      color: var(--ghg-text-muted);
      cursor: help;
      font-size: 12px;
      background: none !important;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 1em;
      padding: 0;
      border: none;
      -webkit-font-smoothing: antialiased;
    }
    .toggle-switch {
      position: relative;
      display: inline-flex;
      width: 48px;
      height: 26px;
      background: #94a3b8;
      border: 2px solid #64748b;
      border-radius: 13px;
      cursor: pointer;
      transition: background 0.2s ease, border-color 0.2s ease;
      flex-shrink: 0;
    }
    .toggle-switch.on {
      background: var(--ghg-success);
      border-color: #15803d;
    }
    .toggle-switch-knob {
      position: absolute;
      top: 2px;
      left: 2px;
      width: 18px;
      height: 18px;
      background: white;
      border-radius: 50%;
      box-shadow: 0 2px 4px rgba(0,0,0,0.25);
      transition: transform 0.2s ease;
      pointer-events: none;
    }
    .toggle-switch.on .toggle-switch-knob { transform: translateX(26px); }
    .toggle-switch-input { position: absolute; opacity: 0; width: 0; height: 0; }
    /* Vendors published: tooltip when only one can be on */
    .ef-vendors-toggle-wrap {
      position: relative;
      display: inline-block;
    }
    .ef-vendors-one-only-tooltip {
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      margin-bottom: 8px;
      padding: 8px 12px;
      background: var(--ghg-text);
      color: #fff;
      font-size: 12px;
      line-height: 1.35;
      border-radius: 6px;
      white-space: normal;
      max-width: 220px;
      text-align: center;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.2s ease, visibility 0.2s ease;
      pointer-events: none;
      z-index: 20;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .ef-vendors-toggle-wrap.show-tooltip .ef-vendors-one-only-tooltip {
      opacity: 1;
      visibility: visible;
    }
    /* Global tooltip (body-level) so it is never clipped by overflow */
    #ef-vendors-global-tooltip {
      position: fixed;
      left: 0;
      top: 0;
      padding: 10px 16px;
      background: var(--ghg-text);
      color: #fff;
      font-size: 13px;
      line-height: 1.4;
      border-radius: 8px;
      white-space: normal;
      width: 280px;
      max-width: min(320px, calc(100vw - 24px));
      text-align: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 10000;
      pointer-events: none;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.2s ease, visibility 0.2s ease;
    }
    #ef-vendors-global-tooltip.visible {
      opacity: 1;
      visibility: visible;
    }
    .ef-prefs-category-content { display: block; }
    .ef-prefs-category-content.hidden { display: none !important; }
    .ef-drag-handle {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 20px;
      min-width: 20px;
      max-width: 20px;
      height: 20px;
      padding: 0;
      cursor: grab;
      color: var(--ghg-text-muted);
      font-size: 12px;
      flex-shrink: 0;
      line-height: 1;
      overflow: hidden;
    }
    .ef-drag-handle i {
      display: block;
      line-height: 1;
      width: 1em;
      height: 1em;
      font-size: 12px;
    }
    .ef-drag-handle:active { cursor: grabbing; }
    .ef-prefs-grid-cell-draggable { cursor: grab; }
    .ef-prefs-grid-cell-draggable:active { cursor: grabbing; }
    .ef-drag-image-row {
      position: fixed;
      left: -9999px;
      top: 0;
      display: grid;
      grid-template-columns: 42fr 28fr 12fr;
      width: 380px;
      font-size: 14px;
      color: var(--ghg-text);
      background: var(--ghg-surface);
      border: 1px solid var(--ghg-border);
      border-radius: 8px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
      overflow: hidden;
    }
    .ef-drag-image-row .ef-prefs-grid-cell {
      padding: 12px 14px;
      border: none;
      display: flex;
      align-items: center;
      min-width: 0;
      background: var(--ghg-surface);
    }
    .ef-drag-image-row .ef-prefs-grid-cell:nth-child(3) { text-align: center; }
    .ef-ef-set-cell {
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 0;
      overflow: hidden;
    }
    .ef-ef-set-cell .ef-drag-handle {
      flex-shrink: 0;
    }
    .ef-ef-set-cell .ef-ef-set-name {
      flex: 1;
      min-width: 0;
    }
    .ef-geo-merged {
      border-top: none;
      background: var(--ghg-surface);
      vertical-align: top;
    }
    /* Remove borders between rows that share the same geography */
    .ef-prefs-table-draggable tr:has(td.ef-geo-merged) td {
      border-top: none;
    }
    .ef-prefs-table-draggable th:nth-child(1),
    .ef-prefs-table-draggable td:nth-child(1) { width: 18%; }
    .ef-prefs-table-draggable th:nth-child(2),
    .ef-prefs-table-draggable td:nth-child(2) { width: 42%; min-width: 0; }
    .ef-prefs-table-draggable th:nth-child(3),
    .ef-prefs-table-draggable td:nth-child(3) { width: 28%; }
    .ef-prefs-table-draggable th:nth-child(4),
    .ef-prefs-table-draggable td:nth-child(4) { width: 12%; min-width: 100px; text-align: center; }
    .ef-prefs-table-draggable tr[draggable="true"] td { vertical-align: middle; }
    .ef-prefs-table-draggable tr.drag-over td { background: var(--ghg-primary-light) !important; }
    /* CSS Grid version (no table = no white band) for Country-published */
    .ef-prefs-grid {
      display: grid;
      grid-template-columns: 18% 42% 28% 12%;
      width: 100%;
      font-size: 14px;
      border: 1px solid var(--ghg-border);
      border-radius: 8px;
      overflow: hidden;
      background: var(--ghg-surface);
    }
    .ef-prefs-grid-header,
    .ef-prefs-grid-body { display: contents; }
    .ef-prefs-grid-row { display: contents; }
    .ef-prefs-grid-header .ef-prefs-grid-cell {
      padding: 10px 14px;
      background: var(--ghg-surface-elevated);
      font-weight: 600;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--ghg-text);
    }
    .ef-prefs-grid-header .ef-prefs-grid-cell:nth-child(4) { text-align: center; }
    .ef-prefs-grid-body .ef-prefs-grid-cell {
      padding: 12px 14px;
      border-top: 1px solid var(--ghg-border);
      color: var(--ghg-text);
      background: var(--ghg-surface);
      min-width: 0;
    }
    .ef-prefs-grid-body .ef-prefs-grid-row:hover .ef-prefs-grid-cell { background: var(--ghg-surface-elevated); }
    .ef-prefs-grid-body .ef-prefs-grid-row.drag-over .ef-prefs-grid-cell:nth-child(1) { background: var(--ghg-surface) !important; }
    .ef-prefs-grid-body .ef-prefs-grid-row.drag-over .ef-prefs-grid-cell:nth-child(n+2) { background: var(--ghg-primary-light) !important; }
    .ef-prefs-grid-body .ef-prefs-grid-row:has(.ef-geo-merged) .ef-prefs-grid-cell { border-top: none; }
    .ef-prefs-grid-body .ef-prefs-grid-cell:nth-child(4) { text-align: center; vertical-align: middle; }
    .ef-prefs-grid-body .ef-prefs-grid-row .ef-prefs-grid-cell { display: flex; align-items: center; }
    .ef-prefs-grid-body .ef-prefs-grid-cell.ef-geo-merged { background: var(--ghg-surface); }

    /* ========================================
       Operational Boundary View Toggle
       ======================================== */
    .op-view-controls {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 16px;
    }

    .op-view-toggle {
      display: flex;
      gap: 4px;
      background: var(--ghg-surface-elevated);
      padding: 4px;
      border-radius: 8px;
      border: 1px solid var(--ghg-border);
    }

    .op-view-toggle .view-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      font-size: 13px;
      font-weight: 500;
      color: var(--ghg-text-secondary);
      background: transparent;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .op-view-toggle .view-btn:hover {
      color: var(--ghg-text);
      background: var(--ghg-surface);
    }

    .op-view-toggle .view-btn.active {
      color: var(--ghg-primary);
      background: var(--ghg-surface);
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }

    .op-view-toggle .view-btn i {
      font-size: 14px;
    }

    .op-view-controls .filter-actions {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .op-view-controls .btn-add-activity {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      font-size: 13px;
      font-weight: 500;
      color: var(--ghg-text);
      background: var(--ghg-surface);
      border: 1px solid var(--ghg-border);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .op-view-controls .btn-add-activity:hover {
      background: var(--ghg-surface-elevated);
      border-color: var(--ghg-primary);
      color: var(--ghg-primary);
    }

    /* Activity Config View & Matrix View */
    .op-config-view,
    .op-matrix-view {
      display: none;
    }

    .op-config-view.active,
    .op-matrix-view.active {
      display: block;
    }

    /* ========================================
       Activity Configuration Table
       ======================================== */
    .activity-config-table {
      border: 1px solid var(--ghg-border);
      border-radius: 10px;
      background: var(--ghg-surface);
      overflow: hidden;
    }

    .activity-config-header {
      display: grid;
      grid-template-columns: 40px 1fr 60px 180px 80px 80px 90px 40px;
      gap: 16px;
      padding: 12px 16px;
      background: var(--ghg-surface-elevated);
      border-bottom: 1px solid var(--ghg-border);
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      color: var(--ghg-text-muted);
    }

    .activity-config-header span {
      display: flex;
      align-items: center;
    }

    .activity-config-header .col-entities,
    .activity-config-header .col-records {
      justify-content: flex-end;
    }

    .activity-config-row {
      display: grid;
      grid-template-columns: 40px 1fr 60px 180px 80px 80px 90px 40px;
      gap: 16px;
      padding: 12px 16px;
      align-items: center;
      border-bottom: 1px solid var(--ghg-border);
      transition: background 0.15s ease;
    }

    .activity-config-row:last-child {
      border-bottom: none;
    }

    .activity-config-row:hover {
      background: var(--ghg-surface-elevated);
    }

    .activity-config-row.excluded {
      opacity: 0.5;
      background: var(--ghg-surface-elevated);
    }

    .activity-config-row .activity-checkbox {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .activity-config-row .activity-checkbox input {
      width: 18px;
      height: 18px;
      accent-color: var(--ghg-primary);
      cursor: pointer;
    }

    .activity-config-row .activity-info {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .activity-config-row .activity-name {
      font-weight: 600;
      font-size: 14px;
      color: var(--ghg-text);
    }

    .activity-config-row .activity-type {
      font-size: 12px;
      color: var(--ghg-text-muted);
    }

    .activity-config-row .scope-badge {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      white-space: nowrap;
    }

    .activity-config-row .calc-method-select {
      width: 100%;
      max-width: 180px;
      padding: 6px 10px;
      font-size: 12px;
      border: 1px solid var(--ghg-border);
      border-radius: 6px;
      background: var(--ghg-surface);
      color: var(--ghg-text);
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23666' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 8px center;
      padding-right: 28px;
    }

    .activity-config-row .calc-method-select:focus {
      outline: none;
      border-color: var(--ghg-primary);
    }

    .activity-config-row .col-value {
      font-size: 13px;
      color: var(--ghg-text);
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    .activity-config-row .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      font-size: 11px;
      font-weight: 500;
      white-space: nowrap;
      border-radius: 12px;
    }

    .activity-config-row .status-badge.ready {
      background: #DCFCE7;
      color: #15803D;
    }

    .activity-config-row .status-badge.issues {
      background: #FEF3C7;
      color: #B45309;
    }

    .activity-config-row .status-badge.needs-data {
      background: #FEE2E2;
      color: #DC2626;
    }

    .activity-config-row .btn-remove {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      background: transparent;
      border: none;
      border-radius: 6px;
      color: var(--ghg-text-muted);
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .activity-config-row .btn-remove:hover {
      background: #FEE2E2;
      color: #DC2626;
    }

    /* ========================================
       Entity-Activity Matrix (Entities  Activities)
       ======================================== */
    .entity-activity-matrix {
      border: 1px solid var(--ghg-border);
      border-radius: 10px;
      background: var(--ghg-surface);
      overflow: hidden;
    }

    .matrix-controls {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      background: var(--ghg-surface-elevated);
      border-bottom: 1px solid var(--ghg-border);
      gap: 16px;
    }

    .matrix-search {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
      max-width: 300px;
    }

    .matrix-search i {
      color: var(--ghg-text-muted);
    }

    .matrix-search input {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid var(--ghg-border);
      border-radius: 6px;
      font-size: 13px;
      background: var(--ghg-surface);
    }

    .matrix-search input:focus {
      outline: none;
      border-color: var(--ghg-primary);
    }

    .matrix-filters {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .matrix-filter-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      font-size: 12px;
      background: var(--ghg-surface);
      border: 1px solid var(--ghg-border);
      border-radius: 6px;
      color: var(--ghg-text-secondary);
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .matrix-filter-btn:hover {
      background: var(--ghg-surface-elevated);
    }

    .matrix-filter-btn.active {
      background: var(--ghg-primary);
      border-color: var(--ghg-primary);
      color: white;
    }

    .matrix-header {
      display: grid;
      grid-template-columns: 40px 220px repeat(6, 1fr);
      gap: 0;
      padding: 0;
      background: var(--ghg-surface-elevated);
      border-bottom: 1px solid var(--ghg-border);
      position: sticky;
      top: 0;
      z-index: 5;
    }

    .matrix-header .col-checkbox {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 12px 8px;
    }

    .matrix-header .col-checkbox input {
      width: 16px;
      height: 16px;
      accent-color: var(--ghg-primary);
      cursor: pointer;
    }

    .matrix-header .col-entity {
      display: flex;
      align-items: center;
      padding: 12px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      color: var(--ghg-text-muted);
    }

    .matrix-header .activity-col {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      padding: 8px 4px;
      text-align: center;
      border-left: 1px solid var(--ghg-border);
    }

    .matrix-header .activity-col .activity-name {
      font-size: 10px;
      font-weight: 600;
      color: var(--ghg-text);
      line-height: 1.2;
    }

    .matrix-header .activity-col .scope-badge {
      font-size: 9px;
      padding: 2px 6px;
      border-radius: 3px;
      font-weight: 600;
    }

    .matrix-body {
      max-height: 450px;
      overflow-y: auto;
    }

    .matrix-group-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 16px;
      background: #F3F4F6;
      border-bottom: 1px solid var(--ghg-border);
      cursor: pointer;
      transition: background 0.15s ease;
    }

    .matrix-group-header:hover {
      background: #E5E7EB;
    }

    .matrix-group-header .group-toggle {
      color: var(--ghg-text-muted);
      transition: transform 0.2s ease;
    }

    .matrix-group-header.expanded .group-toggle {
      transform: rotate(90deg);
    }

    .matrix-group-header .group-icon {
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--ghg-surface);
      border-radius: 6px;
      color: var(--ghg-text-secondary);
    }

    .matrix-group-header .group-info {
      flex: 1;
    }

    .matrix-group-header .group-name {
      font-weight: 600;
      font-size: 13px;
      color: var(--ghg-text);
    }

    .matrix-group-header .group-count {
      font-size: 12px;
      color: var(--ghg-text-muted);
    }

    .matrix-group-header .group-checkbox {
      margin-left: auto;
    }

    .matrix-group-header .group-checkbox input {
      width: 16px;
      height: 16px;
      accent-color: var(--ghg-primary);
      cursor: pointer;
    }

    .matrix-group-rows {
      display: none;
    }

    .matrix-group-rows.expanded {
      display: block;
    }

    .matrix-row {
      display: grid;
      grid-template-columns: 40px 220px repeat(6, 1fr);
      gap: 0;
      padding: 0;
      border-bottom: 1px solid var(--ghg-border);
      transition: background 0.15s ease;
    }

    .matrix-row:last-child {
      border-bottom: none;
    }

    .matrix-row:hover {
      background: var(--ghg-surface-elevated);
    }

    .matrix-row .row-checkbox {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 10px 8px;
    }

    .matrix-row .row-checkbox input {
      width: 16px;
      height: 16px;
      accent-color: var(--ghg-primary);
      cursor: pointer;
    }

    .matrix-row .entity-cell {
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 2px;
      padding: 10px 12px;
    }

    .matrix-row .entity-cell .entity-name {
      font-weight: 500;
      font-size: 13px;
      color: var(--ghg-text);
    }

    .matrix-row .entity-cell .entity-meta {
      font-size: 11px;
      color: var(--ghg-text-muted);
    }

    .matrix-row .activity-cell {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 10px 8px;
      border-left: 1px solid var(--ghg-border);
    }

    .matrix-row .activity-cell input {
      width: 16px;
      height: 16px;
      accent-color: var(--ghg-primary);
      cursor: pointer;
    }

    .matrix-row .activity-cell.na {
      background: #F9FAFB;
    }

    .matrix-row .activity-cell.na input {
      opacity: 0.3;
      cursor: not-allowed;
    }

    .matrix-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      background: var(--ghg-surface-elevated);
      border-top: 1px solid var(--ghg-border);
      font-size: 12px;
      color: var(--ghg-text-secondary);
    }

    .matrix-footer .showing-info {
      color: var(--ghg-text-muted);
    }

    .matrix-footer .pagination {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .matrix-footer .pagination button {
      padding: 6px 12px;
      font-size: 12px;
      background: var(--ghg-surface);
      border: 1px solid var(--ghg-border);
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .matrix-footer .pagination button:hover:not(:disabled) {
      background: var(--ghg-surface-elevated);
    }

    .matrix-footer .pagination button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* ========================================
       Matrix Drill-Down Panel
       ======================================== */
    .matrix-drilldown-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.3);
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .matrix-drilldown-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .matrix-drilldown-panel {
      position: fixed;
      top: 0;
      right: -480px;
      width: 480px;
      height: 100vh;
      background: var(--ghg-surface);
      box-shadow: -4px 0 24px rgba(0,0,0,0.15);
      z-index: 1001;
      display: flex;
      flex-direction: column;
      transition: right 0.3s ease;
    }

    .matrix-drilldown-panel.active {
      right: 0;
    }

    .drilldown-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      border-bottom: 1px solid var(--ghg-border);
      background: var(--ghg-surface-elevated);
    }

    .drilldown-header .header-info {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .drilldown-header .header-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--ghg-text);
    }

    .drilldown-header .header-subtitle {
      font-size: 13px;
      color: var(--ghg-text-muted);
    }

    .drilldown-header .btn-close {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      background: transparent;
      border: none;
      border-radius: 6px;
      color: var(--ghg-text-muted);
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .drilldown-header .btn-close:hover {
      background: var(--ghg-surface);
      color: var(--ghg-text);
    }

    .drilldown-actions {
      display: flex;
      gap: 8px;
      padding: 12px 20px;
      border-bottom: 1px solid var(--ghg-border);
    }

    .drilldown-actions .btn-action {
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 500;
      background: var(--ghg-surface-elevated);
      border: 1px solid var(--ghg-border);
      border-radius: 6px;
      color: var(--ghg-text-secondary);
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .drilldown-actions .btn-action:hover {
      background: var(--ghg-surface);
      border-color: var(--ghg-primary);
      color: var(--ghg-primary);
    }

    .drilldown-content {
      flex: 1;
      overflow-y: auto;
      padding: 16px 20px;
    }

    .drilldown-group {
      margin-bottom: 16px;
    }

    .drilldown-group-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      background: var(--ghg-surface-elevated);
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.15s ease;
    }

    .drilldown-group-header:hover {
      background: #E2E8F0;
    }

    .drilldown-group-header .group-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .drilldown-group-header .group-checkbox {
      width: 16px;
      height: 16px;
      accent-color: var(--ghg-primary);
    }

    .drilldown-group-header .group-name {
      font-weight: 600;
      font-size: 13px;
      color: var(--ghg-text);
    }

    .drilldown-group-header .group-count {
      font-size: 13px;
      color: var(--ghg-text-secondary);
    }

    .drilldown-group-header .expand-icon {
      color: var(--ghg-text-muted);
      font-size: 12px;
      transition: transform 0.2s ease;
    }

    .drilldown-group.expanded .expand-icon {
      transform: rotate(90deg);
    }

    .drilldown-entities {
      display: none;
      padding: 8px 0 8px 28px;
    }

    .drilldown-group.expanded .drilldown-entities {
      display: block;
    }

    .drilldown-entity {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      border-radius: 6px;
      transition: background 0.15s ease;
    }

    .drilldown-entity:hover {
      background: var(--ghg-surface-elevated);
    }

    .drilldown-entity .entity-checkbox {
      width: 14px;
      height: 14px;
      accent-color: var(--ghg-primary);
    }

    .drilldown-entity .entity-name {
      font-size: 13px;
      color: var(--ghg-text);
    }

    .drilldown-entity .entity-code {
      font-size: 11px;
      color: var(--ghg-text-muted);
    }

    .drilldown-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      border-top: 1px solid var(--ghg-border);
      background: var(--ghg-surface-elevated);
    }

    .drilldown-footer .selection-summary {
      font-size: 13px;
      color: var(--ghg-text-secondary);
    }

    .drilldown-footer .selection-summary strong {
      color: var(--ghg-text);
    }

    .drilldown-footer .btn-apply {
      padding: 8px 16px;
      font-size: 13px;
      font-weight: 500;
      background: var(--ghg-primary);
      border: none;
      border-radius: 6px;
      color: white;
      cursor: pointer;
      transition: background 0.15s ease;
    }

    .drilldown-footer .btn-apply:hover {
      background: var(--ghg-primary-dark);
    }

    /* Responsive adjustments for Operational Boundary */
    @media (max-width: 1200px) {
      .op-method-banner {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .method-summary {
        width: 100%;
        padding-top: 10px;
        border-top: 1px solid var(--ghg-border-light);
        margin-top: 10px;
      }
      
      .op-coverage-strip {
        flex-wrap: wrap;
        gap: 16px;
      }
      
      .op-coverage-strip .btn {
        margin-left: 0;
        margin-top: 8px;
        width: 100%;
        justify-content: center;
      }
    }

    @media (max-width: 900px) {
      .op-activities-table th.col-ef,
      .op-activities-table td:nth-child(6) {
        display: none;
      }
      
      .op-activities-table th.col-override,
      .op-activities-table td:nth-child(7) {
        display: none;
      }
    }

    /* Scope row left border accent */
    .op-activities-table .scope-1-row td:first-child {
      border-left: 3px solid var(--ghg-scope-1);
    }
    
    .op-activities-table .scope-2-row td:first-child {
      border-left: 3px solid var(--ghg-scope-2);
    }
    
    .op-activities-table .scope-3-row td:first-child {
      border-left: 3px solid var(--ghg-scope-3);
    }

    /* ========================================
       Org Boundary Step - Redesigned
       ======================================== */
    .org-boundary-step {
      flex-direction: column;
      gap: 16px;
    }

    .org-boundary-step.active {
      display: flex;
    }

    /* Filter Bar */
    .org-filter-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      flex-wrap: wrap;
    }

    .filter-tabs {
      display: flex;
      gap: 4px;
      background: var(--ghg-surface-elevated);
      border: 1px solid var(--ghg-border);
      border-radius: 10px;
      padding: 4px;
    }

    .filter-tab {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      border: none;
      background: transparent;
      border-radius: 7px;
      font-size: 13px;
      color: var(--ghg-text-secondary);
      cursor: pointer;
      transition: all 0.15s ease;
      white-space: nowrap;
    }

    .filter-tab:hover {
      background: var(--ghg-surface);
      color: var(--ghg-text);
    }

    .filter-tab.active {
      background: var(--ghg-primary);
      color: white;
      font-weight: 500;
    }

    .filter-tab .tab-label {
      font-weight: inherit;
    }

    .filter-tab .tab-count {
      font-size: 11px;
      font-weight: 600;
      opacity: 0.85;
    }

    .filter-tab.active .tab-count {
      background: rgba(255,255,255,0.2);
      padding: 2px 6px;
      border-radius: 4px;
    }

    .filter-search {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 14px;
      background: var(--ghg-surface);
      border: 1px solid var(--ghg-border);
      border-radius: 10px;
      min-width: 260px;
    }

    .filter-search i {
      color: var(--ghg-text-muted);
      font-size: 14px;
    }

    .filter-search input {
      border: none;
      background: transparent;
      font-size: 14px;
      color: var(--ghg-text);
      width: 100%;
    }

    .filter-search input:focus {
      outline: none;
    }

    /* Region Cards */
    .org-region-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .region-card {
      background: var(--ghg-surface);
      border: 1px solid var(--ghg-border);
      border-radius: 12px;
      overflow: hidden;
      transition: box-shadow 0.15s ease, border-color 0.15s ease;
    }

    .region-card:hover {
      border-color: var(--ghg-border-strong);
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }

    .region-card-main {
      display: grid;
      grid-template-columns: auto auto 1fr auto auto;
      align-items: center;
      gap: 16px;
      padding: 16px 20px;
      cursor: pointer;
      transition: background 0.15s ease;
    }

    .region-card-main:hover {
      background: var(--ghg-surface-elevated);
    }

    .region-select {
      display: flex;
      align-items: center;
    }

    .region-checkbox {
      width: 18px;
      height: 18px;
      accent-color: var(--ghg-primary);
      cursor: pointer;
    }

    .region-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .region-icon.americas {
      background: linear-gradient(135deg, #E0F2FE 0%, #BAE6FD 100%);
      color: #0369A1;
    }

    .region-icon.emea {
      background: linear-gradient(135deg, #F0FDF4 0%, #BBF7D0 100%);
      color: #15803D;
    }

    .region-icon.apac {
      background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%);
      color: #B45309;
    }

    .region-info {
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-width: 0;
    }

    .region-name {
      font-size: 15px;
      font-weight: 600;
      color: var(--ghg-text);
    }

    .region-breakdown {
      font-size: 12px;
      color: var(--ghg-text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .region-stats {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .region-stats .stat {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
    }

    .region-stats .stat-value {
      font-size: 18px;
      font-weight: 700;
      color: var(--ghg-text);
    }

    .region-stats .stat-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      color: var(--ghg-text-muted);
    }

    .region-stats .stat-divider {
      width: 1px;
      height: 28px;
      background: var(--ghg-border);
    }

    .region-stats .coverage-stat {
      position: relative;
    }

    .region-stats .coverage-ring {
      width: 42px;
      height: 42px;
      border-radius: 50%;
      background: conic-gradient(
        var(--ghg-primary) calc(var(--coverage) * 1%),
        var(--ghg-border-light) calc(var(--coverage) * 1%)
      );
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .region-stats .coverage-ring::before {
      content: '';
      position: absolute;
      width: 32px;
      height: 32px;
      background: var(--ghg-surface);
      border-radius: 50%;
    }

    .region-stats .coverage-value {
      position: relative;
      font-size: 11px;
      font-weight: 700;
      color: var(--ghg-primary);
    }

    .region-expand {
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      color: var(--ghg-text-muted);
      transition: all 0.15s ease;
    }

    .region-expand i {
      transition: transform 0.2s ease;
    }

    .region-card.expanded .region-expand i {
      transform: rotate(180deg);
    }

    /* Region Children */
    .region-children {
      background: var(--ghg-surface-elevated);
      border-top: 1px solid var(--ghg-border);
      padding: 12px 20px 12px 94px;
      display: none;
    }

    .region-card.expanded .region-children {
      display: block;
    }

    .child-entity {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 0;
      border-bottom: 1px solid var(--ghg-border-light);
    }

    .child-entity:last-child {
      border-bottom: none;
    }

    .child-entity .node-checkbox {
      width: 16px;
      height: 16px;
      accent-color: var(--ghg-primary);
    }

    .child-entity .child-name {
      font-size: 13px;
      font-weight: 500;
      color: var(--ghg-text);
      flex: 1;
    }

    .child-entity .child-count {
      font-size: 12px;
      color: var(--ghg-text-secondary);
    }

    /* Selection Summary */
    .org-selection-summary {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 16px;
      padding: 16px 20px;
      background: var(--ghg-surface);
      border: 1px solid var(--ghg-border);
      border-radius: 12px;
    }

    .org-selection-summary .summary-stats {
      display: flex;
      align-items: center;
      gap: 32px;
    }

    .org-selection-summary .summary-stat {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .org-selection-summary .summary-stat .stat-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--ghg-text);
      line-height: 1;
    }

    .org-selection-summary .summary-stat.primary .stat-value {
      color: var(--ghg-primary);
    }

    .org-selection-summary .summary-stat.warning .stat-value {
      color: var(--ghg-warning);
    }

    .org-selection-summary .summary-stat .stat-label {
      font-size: 11px;
      color: var(--ghg-text-muted);
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    /* Responsive */
    @media (max-width: 900px) {
      .org-filter-bar {
        flex-direction: column;
        align-items: stretch;
      }

      .filter-tabs {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }

      .filter-search {
        min-width: 100%;
      }

      .region-card-main {
        grid-template-columns: auto auto 1fr auto;
        gap: 12px;
        padding: 14px 16px;
      }

      .region-stats {
        display: none;
      }

      .region-children {
        padding-left: 60px;
      }

      .org-selection-summary .summary-stats {
        gap: 20px;
      }

      .org-selection-summary .summary-stat .stat-value {
        font-size: 20px;
      }
    }

    /* ========================================
       Org Boundary View Toggle
       ======================================== */
    .org-view-controls {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .org-view-toggle {
      display: flex;
      gap: 4px;
      background: var(--ghg-surface-elevated);
      border: 1px solid var(--ghg-border);
      border-radius: 8px;
      padding: 4px;
    }

    .org-view-toggle .view-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      border: none;
      background: transparent;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      color: var(--ghg-text-secondary);
      cursor: pointer;
      transition: all 0.15s ease;
      font-family: var(--font-sans);
    }

    .org-view-toggle .view-btn:hover {
      background: var(--ghg-surface);
      color: var(--ghg-text);
    }

    .org-view-toggle .view-btn.active {
      background: var(--ghg-primary);
      color: white;
    }

    .org-view-toggle .view-btn i {
      font-size: 14px;
    }

    .org-view-right {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .org-search-input {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 9px 14px;
      background: var(--ghg-surface);
      border: 1px solid var(--ghg-border);
      border-radius: 8px;
      min-width: 220px;
    }

    .org-search-input i {
      color: var(--ghg-text-muted);
      font-size: 14px;
    }

    .org-search-input input {
      border: none;
      background: transparent;
      font-size: 13px;
      font-family: var(--font-sans);
      color: var(--ghg-text);
      width: 100%;
    }

    .org-search-input input:focus {
      outline: none;
    }

    .bulk-actions-dropdown {
      position: relative;
    }

    .bulk-actions-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 9px 14px;
      background: var(--ghg-surface);
      border: 1px solid var(--ghg-border);
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      font-family: var(--font-sans);
      color: var(--ghg-text);
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .bulk-actions-btn:hover {
      border-color: var(--ghg-border-strong);
    }

    .bulk-actions-menu {
      position: absolute;
      top: calc(100% + 4px);
      right: 0;
      background: var(--ghg-surface);
      border: 1px solid var(--ghg-border);
      border-radius: 10px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.12);
      min-width: 200px;
      z-index: 100;
      display: none;
      overflow: hidden;
    }

    .bulk-actions-menu.open {
      display: block;
    }

    .bulk-actions-menu .menu-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 14px;
      font-size: 13px;
      color: var(--ghg-text);
      cursor: pointer;
      transition: background 0.1s ease;
    }

    .bulk-actions-menu .menu-item:hover {
      background: var(--ghg-surface-elevated);
    }

    .bulk-actions-menu .menu-item i {
      width: 16px;
      color: var(--ghg-text-muted);
    }

    .bulk-actions-menu .menu-divider {
      height: 1px;
      background: var(--ghg-border);
      margin: 4px 0;
    }

    /* ========================================
       Org Boundary Detailed Table View
       ======================================== */
    .org-summary-view,
    .org-detail-view {
      display: none;
    }

    .org-summary-view.active,
    .org-detail-view.active {
      display: block;
    }

    .org-detail-table {
      border: 1px solid var(--ghg-border);
      border-radius: 12px;
      overflow: hidden;
      background: var(--ghg-surface);
    }

    .org-detail-table-header {
      display: grid;
      grid-template-columns: 1fr 70px 70px 80px 40px;
      gap: 0;
      padding: 8px 12px;
      background: var(--ghg-surface-elevated);
      border-bottom: 1px solid var(--ghg-border);
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      color: var(--ghg-text-muted);
    }

    .org-detail-table-header span {
      text-align: right;
    }

    .org-detail-table-header .col-name {
      text-align: left;
    }

    .org-detail-table-header span {
      display: flex;
      align-items: center;
    }

    .org-detail-table-header .col-name {
      justify-content: flex-start;
    }

    .org-detail-table-header .col-selected {
      justify-content: flex-start;
    }

    .org-detail-table-header .col-coverage {
      justify-content: flex-end;
    }
    
    .org-detail-table-header .col-status {
      justify-content: center;
    }

    /* Region Row (Level 1) */
    .detail-region-row {
      border-bottom: 1px solid var(--ghg-border);
    }

    .detail-region-row:last-child {
      border-bottom: none;
    }

    .detail-region-main {
      display: grid;
      grid-template-columns: 1fr 70px 70px 80px 40px;
      gap: 0;
      padding: 8px 12px;
      align-items: center;
      cursor: pointer;
      transition: background 0.15s ease;
      background: var(--ghg-surface);
    }

    .detail-region-main:hover {
      background: var(--ghg-surface-elevated);
    }

    .detail-region-row.expanded > .detail-region-main {
      background: var(--ghg-surface-elevated);
      border-bottom: 1px solid var(--ghg-border);
    }

    .detail-region-main .region-name-col {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .detail-region-main .region-toggle {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 18px;
      color: var(--ghg-text-muted);
    }

    .detail-region-main .region-toggle i {
      font-size: 10px;
      transition: transform 0.2s ease;
    }

    .detail-region-row.expanded > .detail-region-main .region-toggle i {
      transform: rotate(90deg);
    }

    .detail-region-main .region-activities,
    .detail-region-main .region-records {
      font-size: 12px;
      color: var(--ghg-text-secondary);
      text-align: right;
    }

    .detail-region-main .region-selected {
      font-size: 12px;
      color: var(--ghg-text-secondary);
      text-align: right;
    }

    .detail-region-main .region-coverage {
      display: none;
    }

    .detail-region-main .region-checkbox {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .detail-region-main .region-icon {
      display: none;
    }

    .detail-region-main .region-name {
      font-weight: 600;
      font-size: 13px;
      color: var(--ghg-text);
    }

    .detail-region-main .region-count {
      font-size: 12px;
      color: var(--ghg-text-muted);
    }

    .detail-region-main .coverage-bar-sm,
    .detail-region-main .coverage-pct {
      display: none;
    }

    .detail-region-main .region-checkbox input {
      width: 16px;
      height: 16px;
      accent-color: var(--ghg-primary);
      cursor: pointer;
    }

    /* Entity Type Group (Level 2) */
    .detail-region-children {
      display: none;
      background: var(--ghg-surface);
    }

    .detail-region-row.expanded > .detail-region-children {
      display: block;
    }

    .detail-type-row {
      border-bottom: 1px solid var(--ghg-border);
    }

    .detail-type-row:last-child {
      border-bottom: none;
    }

    .detail-type-main {
      display: grid;
      grid-template-columns: 1fr 70px 70px 80px 40px;
      gap: 0;
      padding: 6px 12px;
      padding-left: 28px;
      align-items: center;
      cursor: pointer;
      transition: background 0.15s ease;
      background: var(--ghg-surface);
    }

    .detail-type-main .type-name-col {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .detail-type-main .type-activities,
    .detail-type-main .type-records {
      font-size: 12px;
      color: var(--ghg-text-secondary);
      text-align: right;
    }

    .detail-type-main .type-selected {
      font-size: 12px;
      color: var(--ghg-text-secondary);
      text-align: right;
    }

    .detail-type-main .type-coverage {
      display: none;
    }

    .detail-type-main .type-checkbox {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .detail-type-main:hover {
      background: var(--ghg-surface-elevated);
    }

    .detail-type-row.expanded > .detail-type-main {
      border-bottom: 1px solid var(--ghg-border);
    }

    .detail-type-main .type-toggle {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 18px;
      color: var(--ghg-text-muted);
    }

    .detail-type-main .type-toggle i {
      font-size: 10px;
      transition: transform 0.2s ease;
    }

    .detail-type-row.expanded > .detail-type-main .type-toggle i {
      transform: rotate(90deg);
    }

    .detail-type-main .type-info {
      display: none;
    }

    .detail-type-main .type-icon {
      display: none;
    }

    .detail-type-main .type-name {
      font-weight: 500;
      font-size: 13px;
      color: var(--ghg-text);
    }

    .detail-type-main .type-count {
      font-size: 12px;
      color: var(--ghg-text-muted);
    }

    .detail-type-main .type-checkbox input {
      width: 16px;
      height: 16px;
      accent-color: var(--ghg-primary);
      cursor: pointer;
    }

    /* Entity Row (Level 3) */
    .detail-type-children {
      display: none;
    }

    .detail-type-row.expanded > .detail-type-children {
      display: block;
    }

    .detail-entity-row {
      display: flex;
      align-items: center;
      gap: 0;
      padding: 4px 12px;
      padding-left: 52px;
      border-bottom: 1px solid var(--ghg-border);
      transition: background 0.1s ease;
    }

    .detail-entity-row:last-child {
      border-bottom: none;
    }

    .detail-entity-row:hover {
      background: var(--ghg-primary-light);
    }

    .detail-entity-row .entity-checkbox {
      display: flex;
      align-items: center;
      margin-right: 8px;
    }

    .detail-entity-row .entity-checkbox input {
      width: 14px;
      height: 14px;
      accent-color: var(--ghg-primary);
      cursor: pointer;
    }

    .detail-entity-row .entity-info {
      display: flex;
      flex-direction: column;
      gap: 0;
      flex: 1;
    }

    .detail-entity-row .entity-name {
      font-size: 12px;
      color: var(--ghg-text);
    }

    .detail-entity-row .entity-code {
      font-size: 10px;
      color: var(--ghg-text-muted);
    }

    .detail-entity-row .entity-coverage,
    .detail-entity-row .entity-status,
    .detail-entity-row .coverage-bar-xs,
    .detail-entity-row .status-dot,
    .detail-entity-row > span:empty {
      display: none;
    }

    .detail-entity-row.excluded {
      opacity: 0.5;
      background: var(--ghg-surface-elevated);
    }

    .detail-entity-row.excluded .entity-name {
      text-decoration: line-through;
    }

    /* Total row for detailed view */
    .org-detail-total {
      display: grid;
      grid-template-columns: 1fr 70px 70px 80px 40px;
      gap: 0;
      padding: 10px 12px;
      align-items: center;
      background: var(--ghg-surface-elevated);
      border-top: 2px solid var(--ghg-border);
      font-weight: 600;
    }

    .org-detail-total .total-name-col {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .org-detail-total .total-label {
      font-size: 13px;
      color: var(--ghg-text);
    }

    .org-detail-total .total-count {
      font-size: 12px;
      color: var(--ghg-text-muted);
      font-weight: 500;
    }

    .org-detail-total .total-activities,
    .org-detail-total .total-records,
    .org-detail-total .total-selected {
      font-size: 12px;
      color: var(--ghg-text);
      text-align: right;
    }

    .org-detail-total .total-checkbox {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .org-detail-total .total-checkbox input {
      width: 16px;
      height: 16px;
      accent-color: var(--ghg-primary);
      cursor: pointer;
    }

    /* Summary footer for detailed view */
    .org-detail-summary {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 16px;
      background: var(--ghg-surface-elevated);
      border-top: 1px solid var(--ghg-border);
      font-size: 13px;
      color: var(--ghg-text-secondary);
    }

    .org-detail-summary strong {
      color: var(--ghg-text);
      font-weight: 600;
    }

    .org-detail-summary .excluded-count {
      color: var(--ghg-warning);
    }
    
    .coverage-overall-banner {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-bottom: 16px;
    }
    
    .coverage-overall-banner .banner-stat {
      background: var(--ghg-surface-elevated);
      border: 1px solid var(--ghg-border);
      border-radius: 10px;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .coverage-overall-banner .banner-stat.primary {
      border-color: var(--ghg-primary);
      background: var(--ghg-primary-light);
    }
    
    .coverage-overall-banner .banner-stat.warning {
      border-color: var(--ghg-warning);
      background: var(--ghg-warning-light);
    }
    
    .coverage-activity-cards {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    .activity-coverage-card {
      border: 1px solid var(--ghg-border);
      border-radius: 10px;
      padding: 12px;
      background: white;
    }
    
    .activity-coverage-card .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .activity-coverage-card .coverage-percent {
      font-weight: 600;
      font-size: 13px;
    }
    
    .coverage-percent.good {
      color: var(--ghg-success);
    }
    
    .coverage-percent.medium {
      color: var(--ghg-warning);
    }
    
    .coverage-bar {
      height: 8px;
      background: var(--ghg-surface-elevated);
      border-radius: 999px;
      overflow: hidden;
      margin-bottom: 8px;
    }
    
    .coverage-fill {
      height: 100%;
      background: var(--ghg-success);
    }
    
    .coverage-details {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      font-size: 12px;
      color: var(--ghg-text-muted);
      margin-bottom: 10px;
    }
    
    .detail-item.warning {
      color: var(--ghg-warning);
    }
    
    .regional-breakdown {
      border-top: 1px dashed var(--ghg-border);
      padding-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 8px;
    }
    
    .region-row {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: var(--ghg-text-muted);
    }
    
    .coverage-gaps-alert {
      margin-top: 16px;
      padding: 12px;
      border-radius: 10px;
      background: var(--ghg-warning-light);
      border: 1px solid var(--ghg-warning);
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .ef-info-banner {
      display: flex;
      gap: 12px;
      padding: 12px;
      border-radius: 10px;
      background: var(--ghg-info-light);
      border: 1px solid var(--ghg-info);
      color: var(--ghg-text-secondary);
      margin-bottom: 16px;
    }
    
    .ef-info-banner i {
      color: var(--ghg-info);
    }
    
    .ef-summary-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-bottom: 16px;
    }
    
    .ef-summary-stats .stat-item {
      background: var(--ghg-surface-elevated);
      border: 1px solid var(--ghg-border);
      border-radius: 10px;
      padding: 10px 12px;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    
    .ef-summary-groups {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    .ef-scope-group .scope-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }
    
    .ef-mapping-table table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    
    .ef-mapping-table th,
    .ef-mapping-table td {
      text-align: left;
      padding: 8px 10px;
      border-top: 1px solid var(--ghg-border);
    }
    
    .ef-mapping-table thead th {
      background: var(--ghg-surface-elevated);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.4px;
      color: var(--ghg-text-muted);
    }
    
    .ef-dataset-badge {
      background: var(--ghg-primary-light);
      color: var(--ghg-primary-dark);
      padding: 2px 6px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
    }
    
    .ef-mapping-table .activity-cell {
      font-weight: 600;
      color: var(--ghg-text);
    }
    
    .modal.modal-lg {
      max-width: 860px;
    }
    
    .modal-search input {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid var(--ghg-border);
      border-radius: 8px;
      font-size: 13px;
      margin-bottom: 10px;
    }
    
    .modal-filter-row {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
    }
    
    .filter-pill {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--ghg-border);
      font-size: 11px;
      color: var(--ghg-text-muted);
      cursor: pointer;
    }
    
    .filter-pill.active {
      background: var(--ghg-primary-light);
      color: var(--ghg-primary-dark);
      border-color: var(--ghg-primary);
    }
    
    .entity-list,
    .entity-coverage-list {
      border: 1px solid var(--ghg-border);
      border-radius: 10px;
      overflow: hidden;
    }
    
    .list-header,
    .list-row {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr;
      gap: 8px;
      padding: 10px 12px;
      font-size: 12px;
    }
    
    .entity-coverage-list .list-header,
    .entity-coverage-list .list-row {
      grid-template-columns: 2fr 1fr 1fr 0.7fr;
    }
    
    .list-header {
      background: var(--ghg-surface-elevated);
      font-weight: 600;
      color: var(--ghg-text-muted);
      text-transform: uppercase;
      font-size: 10px;
      letter-spacing: 0.4px;
    }
    
    .list-body .list-row {
      border-top: 1px solid var(--ghg-border);
    }
    
    .list-pagination {
      padding: 10px 12px;
      font-size: 12px;
      color: var(--ghg-text-muted);
      background: var(--ghg-surface-elevated);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .coverage-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
    }
    
    .coverage-tabs .tab {
      border: 1px solid var(--ghg-border);
      background: var(--ghg-surface);
      padding: 6px 10px;
      border-radius: 8px;
      font-size: 12px;
      cursor: pointer;
    }
    
    .coverage-tabs .tab.active {
      background: var(--ghg-primary-light);
      border-color: var(--ghg-primary);
      color: var(--ghg-primary-dark);
      font-weight: 600;
    }
    
    .status-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 20px;
      height: 20px;
      border-radius: 999px;
      font-size: 10px;
    }
    
    .status-badge.good {
      background: var(--ghg-success-light);
      color: var(--ghg-success);
    }
    
    .status-badge.missing {
      background: var(--ghg-warning-light);
      color: var(--ghg-warning);
    }
    
    .ef-id {
      font-family: var(--font-mono);
      font-size: 11px;
      color: var(--ghg-text-secondary);
    }
    
    @media (max-width: 900px) {
      .coverage-overall-banner {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .ef-summary-stats {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    /* ============================================== */
    /* EF SELECTION & REVIEW STYLES                   */
    /* ============================================== */
    
    .ef-redesign-container {
      padding: 0;
    }
    
    .ef-redesign-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 20px;
      padding: 20px 24px;
      background: var(--ghg-surface);
      border: 1px solid var(--ghg-border);
      border-radius: 12px;
    }
    
    .ef-header-left {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .ef-header-title-row {
      display: flex;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
    }
    
    .ef-header-title {
      font-family: var(--font-display);
      font-size: 22px;
      font-weight: 600;
      color: var(--ghg-text);
      margin: 0;
    }
    
    .ef-method-badge {
      display: flex;
      align-items: center;
      gap: 8px;
      background: var(--ghg-surface-elevated);
      border: 1px solid var(--ghg-border);
      border-radius: 8px;
      padding: 6px 12px;
      font-size: 13px;
      color: var(--ghg-text-secondary);
    }
    
    .ef-method-badge select {
      border: none;
      background: transparent;
      font-size: 13px;
      color: var(--ghg-text);
      font-weight: 500;
      cursor: pointer;
      padding-right: 16px;
    }
    
    .ef-method-badge select:focus {
      outline: none;
    }
    
    .ef-inventory-selector {
      display: flex;
      align-items: center;
      gap: 10px;
      background: var(--ghg-primary-light);
      border: 1px solid var(--ghg-primary);
      border-radius: 8px;
      padding: 8px 14px;
      font-size: 13px;
      color: var(--ghg-primary);
    }
    
    .ef-inventory-selector i {
      font-size: 16px;
    }
    
    .ef-inventory-selector select {
      border: none;
      background: transparent;
      font-size: 13px;
      color: var(--ghg-primary-dark);
      font-weight: 600;
      cursor: pointer;
      padding-right: 16px;
    }
    
    .ef-inventory-selector select:focus {
      outline: none;
    }
    
    .ef-stats-row {
      display: flex;
      gap: 24px;
      flex-wrap: wrap;
    }
    
    .ef-stat-item {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    
    .ef-stat-value {
      font-size: 18px;
      font-weight: 600;
      color: var(--ghg-text);
    }
    
    .ef-stat-value.success { color: var(--ghg-success); }
    .ef-stat-value.primary { color: var(--ghg-primary); }
    .ef-stat-value.warning { color: var(--ghg-warning); }
    
    .ef-stat-label {
      font-size: 12px;
      color: var(--ghg-text-muted);
    }
    
    .ef-header-actions {
      display: flex;
      gap: 8px;
      flex-shrink: 0;
    }
    
    /* Review Queue Hero */
    .review-queue-hero {
      background: var(--ghg-surface);
      border: 1px solid var(--ghg-border);
      border-radius: 12px;
      padding: 18px 24px;
      margin-bottom: 20px;
    }
    
    .review-queue-hero-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .review-queue-hero-title {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .review-queue-hero-title i {
      font-size: 20px;
      color: var(--ghg-warning);
    }
    
    .review-queue-hero-title h3 {
      font-family: var(--font-display);
      font-size: 16px;
      font-weight: 600;
      margin: 0;
      color: var(--ghg-text);
    }
    
    .review-queue-hero-title .review-count {
      font-size: 13px;
      color: var(--ghg-text-muted);
      font-weight: 400;
    }
    
    .review-queue-hero-link {
      font-size: 13px;
      color: var(--ghg-primary);
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .review-queue-hero-link:hover {
      text-decoration: underline;
    }
    
    .review-queue-issues {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }
    
    .issue-card {
      background: var(--ghg-surface-elevated);
      border: 1px solid var(--ghg-border);
      border-radius: 10px;
      padding: 14px 16px;
      cursor: pointer;
      transition: all 0.15s ease;
    }
    
    .issue-card:hover {
      border-color: var(--ghg-border-strong);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
    }
    
    .issue-card-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 6px;
    }
    
    .issue-card-icon {
      width: 28px;
      height: 28px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }
    
    .issue-card-icon.warning {
      background: var(--ghg-warning-light);
      color: var(--ghg-warning);
    }
    
    .issue-card-icon.error {
      background: var(--ghg-danger-light);
      color: var(--ghg-danger);
    }
    
    .issue-card-icon.info {
      background: var(--ghg-info-light);
      color: var(--ghg-info);
    }
    
    .issue-card-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--ghg-text);
      flex: 1;
    }
    
    .issue-card-count {
      font-size: 14px;
      font-weight: 700;
    }
    
    .issue-card-count.warning { color: var(--ghg-warning); }
    .issue-card-count.error { color: var(--ghg-danger); }
    .issue-card-count.info { color: var(--ghg-info); }
    
    .issue-card-desc {
      font-size: 12px;
      color: var(--ghg-text-muted);
      margin: 0;
      line-height: 1.4;
    }
    
    /* EF Main Card */
    .ef-main-card {
      background: var(--ghg-surface);
      border: 1px solid var(--ghg-border);
      border-radius: 12px;
      overflow: hidden;
    }
    
    .ef-card-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--ghg-border);
    }
    
    .ef-card-header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 14px;
      flex-wrap: wrap;
      gap: 12px;
    }
    
    .ef-content-tabs {
      display: flex;
      gap: 4px;
      background: var(--ghg-surface-elevated);
      border-radius: 8px;
      padding: 4px;
    }
    
    .ef-content-tab {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      font-size: 13px;
      font-weight: 500;
      color: var(--ghg-text-secondary);
      background: transparent;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.15s ease;
    }
    
    .ef-content-tab:hover {
      color: var(--ghg-text);
      background: var(--ghg-surface);
    }
    
    .ef-content-tab.active {
      color: var(--ghg-primary);
      background: var(--ghg-surface);
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    
    .ef-status-pills {
      display: flex;
      gap: 12px;
    }
    
    .ef-status-pill {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--ghg-text-secondary);
    }
    
    .ef-status-pill-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }
    
    .ef-status-pill-dot.complete { background: var(--ghg-success); }
    .ef-status-pill-dot.in-progress { background: var(--ghg-info); }
    .ef-status-pill-dot.needs-attention { background: var(--ghg-warning); }
    
    .ef-status-pill-count {
      font-weight: 600;
      color: var(--ghg-text);
    }
    
    .ef-filter-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .ef-search-box {
      position: relative;
      flex: 1;
      min-width: 200px;
    }
    
    .ef-search-box i {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--ghg-text-muted);
      font-size: 14px;
    }
    
    .ef-search-box input {
      width: 100%;
      padding: 8px 12px 8px 36px;
      border: 1px solid var(--ghg-border);
      border-radius: 8px;
      font-size: 13px;
      background: var(--ghg-surface-elevated);
    }
    
    .ef-search-box input:focus {
      outline: none;
      border-color: var(--ghg-primary);
      box-shadow: 0 0 0 3px var(--ghg-primary-glow);
    }
    
    /* EF Dense Table */
    .ef-dense-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .ef-dense-table th {
      padding: 12px 16px;
      text-align: left;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--ghg-text-muted);
      background: var(--ghg-surface-elevated);
      border-bottom: 1px solid var(--ghg-border);
      white-space: nowrap;
    }
    
    .ef-dense-table th.sortable {
      cursor: pointer;
      user-select: none;
    }
    
    .ef-dense-table th.sortable:hover {
      color: var(--ghg-text);
    }
    
    .ef-dense-table th .sort-icon {
      margin-left: 4px;
      opacity: 0.4;
    }
    
    .ef-dense-table th.sorted .sort-icon {
      opacity: 1;
      color: var(--ghg-primary);
    }
    
    .ef-dense-table td {
      padding: 12px 16px;
      font-size: 13px;
      color: var(--ghg-text);
      border-bottom: 1px solid var(--ghg-border);
      vertical-align: middle;
    }
    
    .ef-dense-table tbody tr {
      cursor: pointer;
      transition: background 0.1s ease;
    }
    
    .ef-dense-table tbody tr:hover {
      background: var(--ghg-surface-hover);
    }
    
    .ef-dense-table tbody tr:last-child td {
      border-bottom: none;
    }
    
    .entity-name-cell {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .entity-flag {
      font-size: 16px;
    }
    
    .entity-name-info h5 {
      font-size: 13px;
      font-weight: 600;
      color: var(--ghg-text);
      margin: 0 0 2px 0;
    }
    
    .entity-name-info span {
      font-size: 11px;
      color: var(--ghg-text-muted);
    }
    
    /* EF Table Views */
    .ef-category-view {
      display: none;
    }
    
    .ef-category-view.active {
      display: block;
    }
    
    .ef-entity-view {
      display: none;
    }
    
    .ef-entity-view.active {
      display: block;
    }
    
    /* Coverage Mini Bar */
    .coverage-cell {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .coverage-bar-mini {
      width: 60px;
      height: 6px;
      background: var(--ghg-surface-elevated);
      border-radius: 3px;
      overflow: hidden;
    }
    
    .coverage-bar-mini-fill {
      height: 100%;
      border-radius: 3px;
      transition: width 0.3s ease;
    }
    
    .coverage-bar-mini-fill.high { background: var(--ghg-success); }
    .coverage-bar-mini-fill.medium { background: var(--ghg-warning); }
    .coverage-bar-mini-fill.low { background: var(--ghg-danger); }
    
    .coverage-percent {
      font-size: 12px;
      font-weight: 600;
    }
    
    .coverage-percent.high { color: var(--ghg-success); }
    .coverage-percent.medium { color: var(--ghg-warning); }
    .coverage-percent.low { color: var(--ghg-danger); }
    
    /* Issue Pills */
    .issue-pills-cell {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
    }
    
    .issue-pill {
      font-size: 10px;
      padding: 3px 6px;
      border-radius: 4px;
      font-weight: 500;
      white-space: nowrap;
    }
    
    .issue-pill.geographic {
      background: var(--ghg-warning-light);
      color: var(--ghg-warning);
    }
    
    .issue-pill.outdated {
      background: var(--ghg-danger-light);
      color: var(--ghg-danger);
    }
    
    .issue-pill.specificity {
      background: var(--ghg-info-light);
      color: var(--ghg-info);
    }
    
    /* Status Icons */
    .status-icon {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }
    
    .status-icon.complete {
      background: var(--ghg-success-light);
      color: var(--ghg-success);
    }
    
    .status-icon.in-progress {
      background: var(--ghg-info-light);
      color: var(--ghg-info);
    }
    
    .status-icon.needs-attention {
      background: var(--ghg-warning-light);
      color: var(--ghg-warning);
    }
    
    /* EF Table Footer */
    .ef-table-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 20px;
      background: var(--ghg-surface-elevated);
      border-top: 1px solid var(--ghg-border);
    }
    
    .ef-table-footer-info {
      font-size: 12px;
      color: var(--ghg-text-muted);
    }
    
    .ef-table-pagination {
      display: flex;
      gap: 8px;
    }
    
    .ef-table-pagination button {
      padding: 6px 12px;
      font-size: 12px;
      border: 1px solid var(--ghg-border);
      background: var(--ghg-surface);
      border-radius: 6px;
      cursor: pointer;
    }
    
    .ef-table-pagination button:hover:not(:disabled) {
      background: var(--ghg-surface-hover);
      border-color: var(--ghg-border-strong);
    }
    
    .ef-table-pagination button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    /* EF Mapping Layout (for hidden views) */
    .ef-mapping-layout {
      display: flex;
      gap: 24px;
    }
    
    .ef-mapping-main {
      flex: 1;
    }
    
    .ef-mapping-view {
      display: none;
    }
    
    .ef-mapping-view.active {
      display: block;
    }
    
    /* Drilldown Header */
    .drilldown-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 16px;
    }
    
    .drilldown-title {
      font-family: var(--font-display);
      font-size: 20px;
      font-weight: 600;
      color: var(--ghg-text);
      margin: 0;
    }
    
    .drilldown-subtitle {
      font-size: 13px;
      color: var(--ghg-text-secondary);
      margin: 4px 0 0 0;
    }
    
    /* Rules Table */
    .rules-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .rules-table th {
      padding: 12px 16px;
      text-align: left;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--ghg-text-muted);
      background: var(--ghg-surface-elevated);
      border-bottom: 1px solid var(--ghg-border);
    }
    
    .rules-table td {
      padding: 14px 16px;
      font-size: 13px;
      border-bottom: 1px solid var(--ghg-border);
      vertical-align: middle;
    }
    
    .rules-table tbody tr {
      cursor: pointer;
      transition: background 0.1s ease;
    }
    
    .rules-table tbody tr:hover {
      background: var(--ghg-surface-hover);
    }
    
    .rule-priority {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      background: var(--ghg-surface-elevated);
      border: 1px solid var(--ghg-border);
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      color: var(--ghg-text);
    }
    
    .rule-name {
      font-weight: 500;
      color: var(--ghg-text);
    }
    
    .rule-name small {
      display: block;
      font-size: 11px;
      color: var(--ghg-text-muted);
      font-weight: 400;
      margin-top: 2px;
    }
    
    .rule-condition {
      font-family: var(--font-mono);
      font-size: 11px;
      background: var(--ghg-surface-elevated);
      padding: 4px 8px;
      border-radius: 4px;
      color: var(--ghg-text-secondary);
    }
    
    .rule-matches {
      font-weight: 600;
      color: var(--ghg-text);
    }
    
    .rule-status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      font-weight: 500;
    }
    
    .rule-status-badge i {
      font-size: 6px;
    }
    
    .rule-status-badge.active {
      color: var(--ghg-success);
    }
    
    .rule-status-badge.draft {
      color: var(--ghg-text-muted);
    }
    
    /* Flag Badges */
    .flag-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 6px;
      font-weight: 500;
    }
    
    .flag-badge.geographic {
      background: var(--ghg-warning-light);
      color: var(--ghg-warning);
    }
    
    .flag-badge.outdated {
      background: var(--ghg-danger-light);
      color: var(--ghg-danger);
    }
    
    .flag-badge.specificity {
      background: var(--ghg-info-light);
      color: var(--ghg-info);
    }
    
    /* Specificity Score */
    .specificity-score {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 24px;
      font-size: 12px;
      font-weight: 600;
      border-radius: 4px;
    }
    
    .specificity-score.high {
      background: var(--ghg-success-light);
      color: var(--ghg-success);
    }
    
    .specificity-score.medium {
      background: var(--ghg-warning-light);
      color: var(--ghg-warning);
    }
    
    .specificity-score.low {
      background: var(--ghg-danger-light);
      color: var(--ghg-danger);
    }
    
    /* Data Card */
    .data-card {
      background: var(--ghg-surface);
      border: 1px solid var(--ghg-border);
      border-radius: 10px;
      overflow: hidden;
    }
    
    /* Entity Records Drawer */
    .entity-records-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.4);
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
      z-index: 999;
    }
    
    .entity-records-backdrop.visible {
      opacity: 1;
      visibility: visible;
    }
    
    .entity-records-drawer {
      position: fixed;
      top: 0;
      right: -900px;
      width: 900px;
      max-width: 90vw;
      height: 100vh;
      background: var(--ghg-surface);
      box-shadow: -4px 0 24px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      transition: right 0.3s ease;
      display: flex;
      flex-direction: column;
    }
    
    .entity-records-drawer.open {
      right: 0;
    }
    
    .entity-records-drawer-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--ghg-border);
      background: var(--ghg-surface-elevated);
    }
    
    .entity-records-drawer-header-top {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 16px;
    }
    
    .entity-records-drawer-title {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .entity-records-drawer-title h2 {
      font-family: var(--font-display);
      font-size: 18px;
      font-weight: 600;
      margin: 0;
    }
    
    .entity-records-drawer-title p {
      font-size: 13px;
      color: var(--ghg-text-secondary);
      margin: 4px 0 0 0;
    }
    
    .entity-records-drawer-close {
      width: 32px;
      height: 32px;
      border: none;
      background: transparent;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      color: var(--ghg-text-muted);
      transition: all 0.15s ease;
    }
    
    .entity-records-drawer-close:hover {
      background: var(--ghg-surface);
      color: var(--ghg-text);
    }
    
    .entity-records-drawer-stats {
      display: flex;
      gap: 24px;
    }
    
    .entity-records-stat {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    
    .entity-records-stat-value {
      font-size: 18px;
      font-weight: 600;
    }
    
    .entity-records-stat-label {
      font-size: 11px;
      color: var(--ghg-text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .entity-records-drawer-body {
      flex: 1;
      display: flex;
      overflow: hidden;
    }
    
    /* Records List Panel */
    .records-list-panel {
      width: 320px;
      border-right: 1px solid var(--ghg-border);
      display: flex;
      flex-direction: column;
      background: var(--ghg-surface-elevated);
    }
    
    .records-list-header {
      padding: 14px;
      border-bottom: 1px solid var(--ghg-border);
    }
    
    .records-list-search {
      position: relative;
    }
    
    .records-list-search i {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--ghg-text-muted);
      font-size: 13px;
    }
    
    .records-list-search input {
      width: 100%;
      padding: 8px 10px 8px 32px;
      border: 1px solid var(--ghg-border);
      border-radius: 6px;
      font-size: 12px;
      background: var(--ghg-surface);
    }
    
    .records-list-content {
      flex: 1;
      overflow-y: auto;
    }
    
    .records-list-footer {
      padding: 10px 14px;
      font-size: 11px;
      color: var(--ghg-text-muted);
      border-top: 1px solid var(--ghg-border);
      text-align: center;
    }
    
    /* Record List Item */
    .record-list-item {
      padding: 12px 14px;
      border-bottom: 1px solid var(--ghg-border);
      cursor: pointer;
      transition: background 0.1s ease;
    }
    
    .record-list-item:hover {
      background: var(--ghg-surface-hover);
    }
    
    .record-list-item.selected {
      background: var(--ghg-primary-light);
      border-left: 3px solid var(--ghg-primary);
    }
    
    .record-list-item-title {
      font-size: 13px;
      font-weight: 500;
      color: var(--ghg-text);
      margin-bottom: 4px;
    }
    
    .record-list-item-meta {
      font-size: 11px;
      color: var(--ghg-text-muted);
    }
    
    .record-list-item-status {
      display: flex;
      gap: 6px;
      margin-top: 6px;
    }
    
    .record-badge {
      display: inline-block;
      font-size: 10px;
      font-weight: 500;
      padding: 2px 8px;
      border-radius: 4px;
      margin-top: 6px;
    }
    
    .record-badge.mapped {
      background: var(--ghg-success-light);
      color: var(--ghg-success);
    }
    
    .record-badge.flagged {
      background: var(--ghg-warning-light);
      color: #b45309;
    }
    
    .record-badge.unmapped {
      background: var(--ghg-danger-light);
      color: var(--ghg-danger);
    }
    
    .record-badge.override {
      background: #f3e8ff;
      color: #7c3aed;
    }
    
    /* Record Detail Panel */
    .record-detail-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      background: var(--ghg-surface);
    }
    
    .record-detail-empty {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: var(--ghg-text-muted);
      text-align: center;
      gap: 12px;
    }
    
    .record-detail-empty i {
      font-size: 32px;
      opacity: 0.5;
    }
    
    .record-detail-wrapper {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .record-detail-scroll {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }
    
    .record-detail-header {
      margin-bottom: 16px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--ghg-border);
    }
    
    .record-detail-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--ghg-text);
      margin: 0 0 6px 0;
    }
    
    .record-detail-meta {
      display: flex;
      gap: 6px;
      font-size: 12px;
      color: var(--ghg-text-muted);
      margin-bottom: 10px;
    }
    
    .record-detail-badges {
      display: flex;
      gap: 8px;
    }
    
    .record-detail-badges .status-badge {
      font-size: 11px;
      padding: 3px 10px;
      border-radius: 4px;
      font-weight: 500;
    }
    
    .record-detail-badges .status-badge.mapped {
      background: var(--ghg-success-light);
      color: var(--ghg-success);
    }
    
    .record-detail-badges .status-badge.flagged {
      background: var(--ghg-warning-light);
      color: var(--ghg-warning);
    }
    
    .record-detail-badges .status-badge.unmapped {
      background: var(--ghg-danger-light);
      color: var(--ghg-danger);
    }
    
    .record-detail-badges .data-path-badge {
      font-size: 11px;
      padding: 3px 10px;
      border-radius: 4px;
      background: var(--ghg-surface-elevated);
      color: var(--ghg-text-secondary);
      border: 1px solid var(--ghg-border);
    }
    
    /* Detail Cards */
    .detail-card {
      background: var(--ghg-surface-elevated);
      border: 1px solid var(--ghg-border);
      border-radius: 8px;
      margin-bottom: 12px;
      overflow: hidden;
    }
    
    .detail-card.compact {
      padding: 12px 14px;
    }
    
    .detail-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 14px;
      background: var(--ghg-surface);
      border-bottom: 1px solid var(--ghg-border);
    }
    
    .detail-card.compact .detail-card-header {
      padding: 0;
      background: transparent;
      border-bottom: none;
      margin-bottom: 8px;
    }
    
    .detail-card-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--ghg-text-secondary);
    }
    
    .detail-card-badge {
      font-size: 10px;
      padding: 2px 8px;
      border-radius: 4px;
      background: var(--ghg-surface-elevated);
      color: var(--ghg-text-muted);
      border: 1px solid var(--ghg-border);
    }
    
    .detail-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .detail-table tr {
      border-bottom: 1px solid var(--ghg-border);
    }
    
    .detail-table tr:last-child {
      border-bottom: none;
    }
    
    .detail-table td {
      padding: 8px 14px;
      font-size: 12px;
    }
    
    .detail-table .detail-label {
      color: var(--ghg-text-muted);
      width: 40%;
    }
    
    .detail-table .detail-value {
      color: var(--ghg-text);
      font-weight: 500;
      text-align: right;
    }
    
    .detail-table .detail-value.mono {
      font-family: var(--font-mono);
    }
    
    .detail-table .detail-value.primary {
      color: var(--ghg-primary);
    }
    
    /* Record Detail Actions - Fixed at Bottom */
    .record-detail-actions {
      padding: 12px 20px;
      border-top: 1px solid var(--ghg-border);
      display: flex;
      gap: 10px;
      background: var(--ghg-surface);
      flex-shrink: 0;
    }
    
    .record-detail-actions .btn {
      flex: 1;
      justify-content: center;
      padding: 10px 16px;
      font-size: 13px;
      font-weight: 500;
    }
    
    .record-detail-actions .btn-primary {
      background: #00b8a9;
      border-color: #00b8a9;
      color: white;
    }
    
    .record-detail-actions .btn-primary:hover {
      background: #00a396;
    }
    
    /* Why Selected Box */
    .why-selected-box {
      background: #f0f9ff;
      border: 1px solid #bae6fd;
      border-left: 3px solid #0ea5e9;
      border-radius: 8px;
      padding: 12px 14px;
      margin-bottom: 12px;
    }
    
    .why-selected-header {
      font-size: 12px;
      font-weight: 600;
      color: #0284c7;
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 8px;
    }
    
    .why-selected-reasons {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .why-selected-item {
      display: flex;
      align-items: flex-start;
      gap: 6px;
      font-size: 11px;
      color: var(--ghg-text);
      line-height: 1.4;
    }
    
    .why-selected-item i {
      margin-top: 2px;
      flex-shrink: 0;
      font-size: 12px;
    }
    
    .why-selected-item.success i { color: var(--ghg-success); }
    .why-selected-item.warning i { color: var(--ghg-warning); }
    .why-selected-item.error i { color: var(--ghg-danger); }
    
    /* Specificity Gauge */
    .specificity-gauge {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .specificity-gauge-bar {
      flex: 1;
      height: 8px;
      background: var(--ghg-border);
      border-radius: 4px;
      overflow: hidden;
    }
    
    .specificity-gauge-fill {
      height: 100%;
      background: linear-gradient(90deg, #10b981 0%, #0ea5e9 100%);
      border-radius: 4px;
      transition: width 0.3s ease;
    }
    
    .specificity-gauge-value {
      font-family: var(--font-mono);
      font-size: 13px;
      font-weight: 600;
      color: var(--ghg-primary);
      min-width: 60px;
      text-align: right;
    }
    
    /* Audit Trail Mini */
    .audit-trail-mini {
      border: 1px solid var(--ghg-border);
      border-radius: 8px;
      overflow: hidden;
      background: var(--ghg-surface-elevated);
    }
    
    .audit-trail-mini-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 14px;
      background: var(--ghg-surface);
      cursor: pointer;
      transition: background 0.15s ease;
    }
    
    .audit-trail-mini-header:hover {
      background: var(--ghg-surface-hover);
    }
    
    .audit-trail-mini-title {
      font-size: 12px;
      font-weight: 500;
      color: var(--ghg-text-secondary);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .audit-trail-count {
      font-weight: 400;
      color: var(--ghg-text-muted);
    }
    
    .audit-trail-toggle {
      color: var(--ghg-text-muted);
      transition: transform 0.2s ease;
      font-size: 12px;
    }
    
    .audit-trail-mini.open .audit-trail-toggle {
      transform: rotate(180deg);
    }
    
    .audit-trail-mini-content {
      padding: 0 14px 10px;
      border-top: 1px solid var(--ghg-border);
    }
    
    .audit-item {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 8px 0;
      border-bottom: 1px solid var(--ghg-border);
      font-size: 11px;
    }
    
    .audit-item:last-child {
      border-bottom: none;
    }
    
    .audit-time {
      color: var(--ghg-text-muted);
      flex-shrink: 0;
      min-width: 100px;
    }
    
    .audit-event {
      color: var(--ghg-text-secondary);
    }
    
    /* Override Modal */
    .override-modal {
      max-width: 800px;
    }
    
    .override-context {
      background: var(--ghg-surface-elevated);
      border: 1px solid var(--ghg-border);
      border-radius: 10px;
      padding: 14px 18px;
      margin-bottom: 20px;
    }
    
    .override-context-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .override-context-title {
      font-size: 15px;
      font-weight: 600;
      color: var(--ghg-text);
    }
    
    .override-context-meta {
      font-size: 12px;
      color: var(--ghg-text-muted);
      margin-top: 4px;
    }
    
    .override-context-id {
      font-family: var(--font-mono);
      font-size: 11px;
      background: var(--ghg-primary-light);
      color: var(--ghg-primary-dark);
      padding: 4px 10px;
      border-radius: 4px;
    }
    
    /* Selection Comparison */
    .selection-comparison {
      display: flex;
      gap: 16px;
      align-items: stretch;
      margin-bottom: 20px;
    }
    
    .selection-box {
      flex: 1;
      background: var(--ghg-surface-elevated);
      border: 1px solid var(--ghg-border);
      border-radius: 10px;
      padding: 16px;
      position: relative;
    }
    
    .selection-box.system {
      border-color: var(--ghg-border-strong);
    }
    
    .selection-box.override.empty {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      border-style: dashed;
    }
    
    .selection-box-label {
      position: absolute;
      top: -10px;
      left: 12px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      background: var(--ghg-surface);
      padding: 2px 8px;
      border-radius: 4px;
      color: var(--ghg-text-muted);
    }
    
    .override-placeholder {
      text-align: center;
      color: var(--ghg-text-muted);
      font-size: 13px;
      line-height: 1.5;
    }
    
    .override-placeholder i {
      font-size: 24px;
      margin-bottom: 8px;
      opacity: 0.5;
    }
    
    .selection-ef-name {
      font-size: 15px;
      font-weight: 600;
      color: var(--ghg-text);
      margin-bottom: 4px;
    }
    
    .selection-ef-source {
      font-size: 12px;
      color: var(--ghg-text-secondary);
      margin-bottom: 8px;
    }
    
    .selection-ef-value {
      font-family: var(--font-mono);
      font-size: 14px;
      color: var(--ghg-primary);
      font-weight: 600;
      margin-bottom: 8px;
    }
    
    .selection-specificity {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .selection-specificity-label {
      font-size: 11px;
      color: var(--ghg-text-muted);
    }
    
    .selection-specificity-score {
      font-size: 12px;
      font-weight: 600;
      padding: 2px 6px;
      border-radius: 4px;
    }
    
    .selection-specificity-score.high {
      background: var(--ghg-success-light);
      color: var(--ghg-success);
    }
    
    .selection-specificity-score.medium {
      background: var(--ghg-warning-light);
      color: var(--ghg-warning);
    }
    
    .selection-arrow {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 8px;
      color: var(--ghg-text-muted);
    }
    
    .selection-arrow-btn {
      font-size: 11px;
      padding: 4px 10px;
      background: var(--ghg-surface);
      border: 1px solid var(--ghg-border);
      border-radius: 4px;
      cursor: pointer;
    }
    
    .selection-arrow-btn:hover {
      background: var(--ghg-surface-elevated);
    }
    
    /* Alternatives Section */
    .alternatives-section {
      margin-bottom: 20px;
    }
    
    .alternatives-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--ghg-text);
      margin-bottom: 12px;
    }
    
    .alternatives-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }
    
    .alternative-card {
      background: var(--ghg-surface-elevated);
      border: 1px solid var(--ghg-border);
      border-radius: 8px;
      padding: 12px;
      cursor: pointer;
      transition: all 0.15s ease;
    }
    
    .alternative-card:hover {
      border-color: var(--ghg-primary);
      background: var(--ghg-primary-light);
    }
    
    .alternative-card.selected {
      border-color: var(--ghg-primary);
      background: var(--ghg-primary-light);
      box-shadow: 0 0 0 2px var(--ghg-primary-glow);
    }
    
    .alternative-ef-name {
      font-size: 13px;
      font-weight: 600;
      color: var(--ghg-text);
      margin-bottom: 2px;
    }
    
    .alternative-ef-source {
      font-size: 11px;
      color: var(--ghg-text-muted);
      margin-bottom: 6px;
    }
    
    .alternative-ef-value {
      font-family: var(--font-mono);
      font-size: 12px;
      color: var(--ghg-primary);
      margin-bottom: 4px;
    }
    
    .alternative-specificity {
      font-size: 11px;
      color: var(--ghg-text-secondary);
      display: flex;
      justify-content: space-between;
    }
    
    .alternative-specificity .improvement {
      color: var(--ghg-success);
      font-weight: 500;
    }
    
    /* Override Reason Section */
    .override-reason-section {
      margin-top: 16px;
    }
    
    .override-reason-section label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 8px;
      color: var(--ghg-text);
    }
    
    .override-reason-select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--ghg-border);
      border-radius: 8px;
      font-size: 13px;
      margin-bottom: 10px;
    }
    
    .override-reason-textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--ghg-border);
      border-radius: 8px;
      font-size: 13px;
      min-height: 60px;
      resize: vertical;
    }
    
    /* Override Level Section */
    .override-level-section {
      margin-top: 16px;
      padding: 16px;
      background: var(--ghg-surface-elevated);
      border-radius: 10px;
    }
    
    .override-level-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      font-weight: 600;
      color: var(--ghg-text);
      margin-bottom: 12px;
    }
    
    .override-level-options {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .override-level-option {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 10px 12px;
      background: var(--ghg-surface);
      border: 1px solid var(--ghg-border);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.15s ease;
    }
    
    .override-level-option:hover {
      border-color: var(--ghg-primary);
    }
    
    .override-level-option input[type="radio"] {
      margin-top: 2px;
    }
    
    .override-level-option-label {
      font-size: 13px;
      font-weight: 500;
      color: var(--ghg-text);
    }
    
    .override-level-option-desc {
      font-size: 11px;
      color: var(--ghg-text-muted);
      margin-top: 2px;
    }
    
    /* ============================================== */
    /* EF Assignment Modal                            */
    /* ============================================== */
    
    .assign-activity-context {
      background: var(--ghg-surface-elevated);
      border: 1px solid var(--ghg-border);
      border-radius: 8px;
      padding: 14px 16px;
      margin-bottom: 20px;
    }
    
    .assign-context-label {
      font-size: 12px;
      color: var(--ghg-text-muted);
      margin-bottom: 4px;
    }
    
    .assign-context-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--ghg-text);
    }
    
    .assign-context-meta {
      font-size: 12px;
      color: var(--ghg-text-muted);
      margin-top: 4px;
    }
    
    .assign-search-section {
      margin-bottom: 16px;
    }
    
    .assign-section-label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: var(--ghg-text);
      margin-bottom: 8px;
    }
    
    .assign-search-input {
      position: relative;
    }
    
    .assign-search-input input {
      width: 100%;
      padding: 10px 14px;
      border: 1px solid var(--ghg-border);
      border-radius: 8px;
      font-size: 13px;
      background: var(--ghg-surface);
    }
    
    .assign-search-input input:focus {
      outline: none;
      border-color: var(--ghg-primary);
      box-shadow: 0 0 0 3px var(--ghg-primary-glow);
    }
    
    .assign-search-input input::placeholder {
      color: var(--ghg-text-muted);
    }
    
    .assign-options-section {
      margin-bottom: 16px;
    }
    
    .assign-options-list {
      border: 1px solid var(--ghg-border);
      border-radius: 8px;
      max-height: 240px;
      overflow-y: auto;
    }
    
    .assign-option {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 14px;
      border-bottom: 1px solid var(--ghg-border);
      cursor: pointer;
      transition: background 0.1s ease;
    }
    
    .assign-option:last-child {
      border-bottom: none;
    }
    
    .assign-option:hover {
      background: var(--ghg-surface-hover);
    }
    
    .assign-option.selected {
      background: var(--ghg-primary-light);
      border-left: 3px solid var(--ghg-primary);
    }
    
    .assign-option-main {
      flex: 1;
    }
    
    .assign-option-id {
      font-family: var(--font-mono);
      font-size: 13px;
      font-weight: 600;
      color: var(--ghg-text);
    }
    
    .assign-option-desc {
      font-size: 12px;
      color: var(--ghg-text-secondary);
      margin-top: 2px;
    }
    
    .assign-option-meta {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-shrink: 0;
    }
    
    .assign-datapath-badge {
      font-size: 10px;
      font-weight: 600;
      padding: 3px 8px;
      border-radius: 4px;
      text-transform: uppercase;
    }
    
    .assign-datapath-badge.spend {
      background: #dbeafe;
      color: #1d4ed8;
    }
    
    .assign-datapath-badge.activity {
      background: #dcfce7;
      color: #15803d;
    }
    
    .assign-datapath-badge.hybrid {
      background: #fef3c7;
      color: #b45309;
    }
    
    .assign-option-ef {
      font-size: 11px;
      color: var(--ghg-text-muted);
    }
    
    .assign-constraints-box {
      background: #eff6ff;
      border: 1px solid #bfdbfe;
      border-radius: 8px;
      padding: 14px 16px;
      margin-bottom: 16px;
    }
    
    .assign-constraints-header {
      font-size: 12px;
      font-weight: 600;
      color: #1d4ed8;
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
    }
    
    .assign-constraints-list {
      margin: 0;
      padding-left: 20px;
      font-size: 12px;
      color: var(--ghg-text-secondary);
      line-height: 1.6;
    }
    
    .assign-constraints-list li {
      margin-bottom: 4px;
    }
    
    .assign-constraints-list li:last-child {
      margin-bottom: 0;
    }
    
    .assign-memory-checkbox {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 12px 14px;
      background: var(--ghg-surface-elevated);
      border-radius: 8px;
    }
    
    .assign-memory-checkbox input[type="checkbox"] {
      width: 18px;
      height: 18px;
      margin-top: 2px;
      cursor: pointer;
      accent-color: var(--ghg-primary);
    }
    
    .assign-memory-checkbox label {
      font-size: 13px;
      color: var(--ghg-text-secondary);
      cursor: pointer;
      line-height: 1.4;
    }
    
    @media (max-width: 768px) {
      .review-queue-issues {
        grid-template-columns: 1fr;
      }
      
      .alternatives-grid {
        grid-template-columns: 1fr;
      }
      
      .selection-comparison {
        flex-direction: column;
      }
      
      .entity-records-drawer {
        width: 100%;
        max-width: none;
      }
    }
    
    /* ============================================== */
    /* EF SUMMARY DASHBOARD (Tab View)                */
    /* ============================================== */
    
    .ef-summary-dashboard {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    .ef-coverage-hero {
      background: linear-gradient(135deg, var(--ghg-surface) 0%, var(--ghg-surface-elevated) 100%);
      border: 1px solid var(--ghg-border);
      border-radius: 16px;
      padding: 28px 32px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 32px;
    }
    
    .ef-coverage-hero-main {
      display: flex;
      align-items: center;
      gap: 32px;
    }
    
    .ef-coverage-circle {
      position: relative;
      width: 120px;
      height: 120px;
      flex-shrink: 0;
    }
    
    .ef-coverage-circle svg {
      width: 100%;
      height: 100%;
    }
    
    .ef-coverage-value {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
    }
    
    .ef-coverage-percent {
      display: block;
      font-family: var(--font-display);
      font-size: 26px;
      font-weight: 700;
      color: var(--ghg-success);
    }
    
    .ef-coverage-label {
      font-size: 11px;
      color: var(--ghg-text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .ef-coverage-breakdown {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .ef-coverage-stat {
      display: flex;
      align-items: baseline;
      gap: 8px;
    }
    
    .ef-coverage-stat-value {
      font-size: 20px;
      font-weight: 700;
    }
    
    .ef-coverage-stat-value.success { color: var(--ghg-success); }
    .ef-coverage-stat-value.warning { color: var(--ghg-warning); }
    .ef-coverage-stat-value.error { color: var(--ghg-danger); }
    
    .ef-coverage-stat-label {
      font-size: 13px;
      color: var(--ghg-text-secondary);
    }
    
    .ef-coverage-hero-actions {
      display: flex;
      flex-direction: column;
      gap: 12px;
      align-items: flex-end;
    }
    
    .ef-kpi-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
    }
    
    .ef-kpi-card {
      background: var(--ghg-surface);
      border: 1px solid var(--ghg-border);
      border-radius: 12px;
      padding: 16px 20px;
      display: flex;
      align-items: flex-start;
      gap: 14px;
    }
    
    .ef-kpi-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      flex-shrink: 0;
    }
    
    .ef-kpi-icon.success {
      background: var(--ghg-success-light);
      color: var(--ghg-success);
    }
    
    .ef-kpi-icon.primary {
      background: var(--ghg-primary-light);
      color: var(--ghg-primary);
    }
    
    .ef-kpi-icon.warning {
      background: var(--ghg-warning-light);
      color: var(--ghg-warning);
    }
    
    .ef-kpi-content {
      display: flex;
      flex-direction: column;
      gap: 2px;
      flex: 1;
    }
    
    .ef-kpi-value {
      font-size: 22px;
      font-weight: 700;
    }
    
    .ef-kpi-value.success { color: var(--ghg-success); }
    .ef-kpi-value.primary { color: var(--ghg-primary); }
    .ef-kpi-value.warning { color: var(--ghg-warning); }
    
    .ef-kpi-label {
      font-size: 12px;
      color: var(--ghg-text-secondary);
    }
    
    .ef-kpi-trend {
      font-size: 11px;
      color: var(--ghg-text-muted);
      margin-top: 4px;
    }
    
    .ef-kpi-trend.up {
      color: var(--ghg-success);
    }
    
    .ef-quick-actions {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .ef-quick-action {
      background: var(--ghg-surface);
      border: 1px solid var(--ghg-border);
      border-radius: 12px;
      padding: 16px 20px;
      display: flex;
      align-items: center;
      gap: 16px;
      cursor: pointer;
      transition: all 0.15s ease;
    }
    
    .ef-quick-action:hover {
      border-color: var(--ghg-primary);
      background: var(--ghg-primary-light);
      transform: translateX(4px);
    }
    
    .ef-quick-action-icon {
      width: 44px;
      height: 44px;
      background: var(--ghg-surface-elevated);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: var(--ghg-primary);
      flex-shrink: 0;
    }
    
    .ef-quick-action:hover .ef-quick-action-icon {
      background: var(--ghg-primary);
      color: white;
    }
    
    .ef-quick-action-content {
      flex: 1;
    }
    
    .ef-quick-action-content h4 {
      font-size: 14px;
      font-weight: 600;
      color: var(--ghg-text);
      margin: 0 0 4px 0;
    }
    
    .ef-quick-action-content p {
      font-size: 12px;
      color: var(--ghg-text-secondary);
      margin: 0;
    }
    
    .ef-quick-action-badge {
      font-size: 11px;
      background: var(--ghg-surface-elevated);
      padding: 4px 10px;
      border-radius: 6px;
      color: var(--ghg-text-secondary);
    }
    
    .ef-quick-action > i:last-child {
      color: var(--ghg-text-muted);
      font-size: 14px;
    }
    
    /* EF Full Page Stats Banner */
    .ef-page-stats-banner {
      display: flex;
      gap: 24px;
      background: var(--ghg-surface);
      border: 1px solid var(--ghg-border);
      border-radius: 12px;
      padding: 16px 24px;
      margin-bottom: 20px;
    }
    
    .ef-page-stat {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    
    .ef-page-stat-value {
      font-size: 20px;
      font-weight: 700;
    }
    
    .ef-page-stat-value.success { color: var(--ghg-success); }
    .ef-page-stat-value.warning { color: var(--ghg-warning); }
    .ef-page-stat-value.error { color: var(--ghg-danger); }
    .ef-page-stat-value.primary { color: var(--ghg-primary); }
    
    .ef-page-stat-label {
      font-size: 11px;
      color: var(--ghg-text-muted);
    }
    
    .ef-review-view {
      display: none;
    }
    
    .ef-review-view.active {
      display: block;
    }
    
    @media (max-width: 1200px) {
      .ef-kpi-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    @media (max-width: 768px) {
      .ef-coverage-hero {
        flex-direction: column;
        align-items: stretch;
      }
      
      .ef-coverage-hero-main {
        flex-direction: column;
        align-items: center;
        text-align: center;
      }
      
      .ef-kpi-grid {
        grid-template-columns: 1fr;
      }
      
      .ef-page-stats-banner {
        flex-wrap: wrap;
      }
    }
  </style>
</head>
<body>
  <!-- App Shell Container -->
  <div class="app-shell">
    
    <!-- Icon Sidebar -->
    <aside class="icon-sidebar">
      <div class="sidebar-top">
        <button class="sidebar-item menu-toggle" title="Menu">
          <i class="fa-light fa-arrow-right-to-line"></i>
          <span class="sidebar-label">Menu</span>
        </button>
        
        <button class="sidebar-item" data-section="home" title="Home">
          <i class="fa-light fa-home"></i>
          <span class="sidebar-label">Home</span>
        </button>
        
        <button class="sidebar-item" data-section="collect" title="Collect">
          <i class="fa-light fa-database"></i>
          <span class="sidebar-label">Collect</span>
        </button>
        
        <button class="sidebar-item active" data-section="monitor" title="Monitor">
          <i class="fa-light fa-chart-line-up"></i>
          <span class="sidebar-label">Monitor</span>
        </button>
        
        <button class="sidebar-item" data-section="reports" title="Reports">
          <i class="fa-light fa-file-lines"></i>
          <span class="sidebar-label">Reports</span>
        </button>
        
        <button class="sidebar-item" data-section="settings" title="Settings">
          <i class="fa-light fa-sliders"></i>
          <span class="sidebar-label">Settings</span>
        </button>
      </div>
      
      <div class="sidebar-bottom">
        <div class="sidebar-logo">
          <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="16" cy="16" r="14" stroke="#06B6D4" stroke-width="2" fill="none"/>
            <path d="M10 16 L14 20 L22 12" stroke="#06B6D4" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
      </div>
    </aside>
    
    <!-- Submenu Panel -->
    <aside class="submenu-panel collapsed" id="submenuPanel">
      <div class="submenu-content hidden" data-section="home">
        <h2 class="submenu-title">Home</h2>
        <nav class="submenu-nav">
          <a href="#" class="submenu-item active">Dashboard</a>
        </nav>
      </div>
      
      <div class="submenu-content hidden" data-section="collect">
        <h2 class="submenu-title">Data Collection</h2>
        <nav class="submenu-nav">
          <a href="../../../platform/prototypes/activity-data-upload/index.html" class="submenu-item">Data Campaigns</a>
          <a href="../../../platform/prototypes/activity-data-upload/index.html#upload" class="submenu-item">Upload Data</a>
          <a href="../../../platform/prototypes/activity-data-upload/index.html#records" class="submenu-item">Activity Records</a>
          <a href="../../../platform/prototypes/activity-normalization-mapping/index.html" class="submenu-item">Activity Mapping</a>
        </nav>
      </div>
      
      <div class="submenu-content hidden" data-section="monitor">
        <h2 class="submenu-title">GHG Monitoring</h2>
        <nav class="submenu-nav">
          <a href="#" class="submenu-item active" data-view="inventory-list">Inventory List</a>
          <a href="../../../platform/prototypes/calculation-method/index.html" class="submenu-item">Calculation Methods</a>
          <a href="#" class="submenu-item" data-view="ef-library">EF Library</a>
          <a href="#" class="submenu-item" data-view="ef-selection-review">EF Selection</a>
        </nav>
      </div>
      
      <div class="submenu-content hidden" data-section="reports">
        <h2 class="submenu-title">Reports</h2>
        <nav class="submenu-nav">
          <a href="#" class="submenu-item">Report Builder</a>
          <a href="#" class="submenu-item">Templates</a>
        </nav>
      </div>
      
      <div class="submenu-content hidden" data-section="settings">
        <h2 class="submenu-title">Settings</h2>
        <nav class="submenu-nav">
          <a href="#" class="submenu-item">Organization</a>
          <a href="#" class="submenu-item">Users</a>
        </nav>
      </div>
    </aside>
    
    <!-- Main Content Area -->
    <div class="main-wrapper">
      <header class="app-header">
        <div class="header-left">
          <i class="fa-light fa-leaf header-app-icon"></i>
          <span class="header-app-name">Create New Inventory</span>
        </div>
        
        <div class="header-right">
          <button class="header-icon-btn" title="Notifications">
            <i class="fa-light fa-bell"></i>
          </button>
          <button class="header-icon-btn" title="Apps">
            <i class="fa-solid fa-grid"></i>
          </button>
          <button class="header-icon-btn" title="Help">
            <i class="fa-light fa-circle-question"></i>
          </button>
          <button class="header-avatar" title="User Menu">
            <img src="https://ui-avatars.com/api/?name=Sarah+Chen&background=06B6D4&color=fff&size=32" alt="User Avatar">
          </button>
        </div>
      </header>
      
      <main class="content-area">
        <!-- PROTOTYPE BANNER -->
        <div class="prototype-banner">
           PROTOTYPE - Create New Inventory - Built with Cursor
        </div>
        
        <!-- ============================================== -->
        <!-- VIEW 1: INVENTORY LIST                         -->
        <!-- ============================================== -->
        <div id="view-inventory-list" class="view active">
          <div class="page-header">
            <div class="page-header-left">
              <div class="page-breadcrumb">
                <a href="#">Monitor</a>
                <i class="fa-light fa-chevron-right"></i>
                <span>GHG Inventories</span>
              </div>
              <h1 class="page-title">GHG Inventories</h1>
              <p class="page-subtitle">Create, calculate, and manage your emissions inventories</p>
            </div>
            <div class="page-header-actions">
              <button class="btn btn-primary" onclick="openCreateInventoryModal()">
                <i class="fa-light fa-plus"></i>
                Create Inventory
              </button>
            </div>
          </div>
          
          <div class="content-container">
            <div class="search-bar">
              <div class="search-input-wrapper">
                <i class="fa-light fa-search"></i>
                <input type="text" class="form-input" placeholder="Search inventories..." id="inventory-search">
              </div>
              <button class="btn btn-secondary">
                <i class="fa-light fa-filter"></i>
                Filter
              </button>
            </div>
            
            <div class="inventory-list">
              <!-- Calculated Inventory -->
              <div class="inventory-card" onclick="viewInventoryResults('q4-2025')">
                <div class="inventory-card-left">
                  <div class="inventory-icon">
                    <i class="fa-light fa-calculator"></i>
                  </div>
                  <div class="inventory-info">
                    <h3>Q4 2025 Corporate Inventory</h3>
                    <div class="inventory-card-meta">
                      <span>Oct 1 - Dec 31, 2025</span>  
                      <span>GHG Protocol</span>  
                      <span>4 entities</span>
                    </div>
                  </div>
                </div>
                <div class="inventory-card-right">
                  <div class="inventory-stat">
                    <div class="inventory-stat-value">1,061.9</div>
                    <div class="inventory-stat-label">tCOe Total</div>
                  </div>
                  <span class="badge badge-success">
                    <i class="fa-light fa-check-circle"></i>
                    Calculated
                  </span>
                  <i class="fa-light fa-chevron-right" style="color: var(--ghg-text-muted);"></i>
                </div>
              </div>
              
              <!-- Locked Inventory -->
              <div class="inventory-card" onclick="viewInventoryResults('q3-2025')">
                <div class="inventory-card-left">
                  <div class="inventory-icon" style="background: var(--ghg-success-light); color: #166534;">
                    <i class="fa-light fa-lock"></i>
                  </div>
                  <div class="inventory-info">
                    <h3>Q3 2025 Corporate Inventory</h3>
                    <div class="inventory-card-meta">
                      <span>Jul 1 - Sep 30, 2025</span>  
                      <span>GHG Protocol</span>  
                      <span>4 entities</span>
                    </div>
                  </div>
                </div>
                <div class="inventory-card-right">
                  <div class="inventory-stat">
                    <div class="inventory-stat-value">987.3</div>
                    <div class="inventory-stat-label">tCOe Total</div>
                  </div>
                  <span class="badge badge-success">
                    <i class="fa-light fa-lock"></i>
                    Locked
                  </span>
                  <i class="fa-light fa-chevron-right" style="color: var(--ghg-text-muted);"></i>
                </div>
              </div>
              
              <!-- Draft Inventory -->
              <div class="inventory-card" onclick="openCreateInventoryModal()">
                <div class="inventory-card-left">
                  <div class="inventory-icon" style="background: var(--ghg-warning-light); color: #9A3412;">
                    <i class="fa-light fa-pencil"></i>
                  </div>
                  <div class="inventory-info">
                    <h3>FY 2025 Annual Report</h3>
                    <div class="inventory-card-meta">
                      <span>Jan 1 - Dec 31, 2025</span>  
                      <span>GHG Protocol</span>  
                      <span>4 entities</span>
                    </div>
                  </div>
                </div>
                <div class="inventory-card-right">
                  <div class="inventory-stat">
                    <div class="inventory-stat-value"></div>
                    <div class="inventory-stat-label">Not calculated</div>
                  </div>
                  <span class="badge badge-warning">
                    <i class="fa-light fa-clock"></i>
                    Draft
                  </span>
                  <i class="fa-light fa-chevron-right" style="color: var(--ghg-text-muted);"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- ============================================== -->
        <!-- VIEW 2: INVENTORY RESULTS                      -->
        <!-- ============================================== -->
        <div id="view-inventory-results" class="view">
          <div class="page-header">
            <div class="page-header-left">
              <div class="page-breadcrumb">
                <a href="#" onclick="switchView('inventory-list'); return false;">Monitor</a>
                <i class="fa-light fa-chevron-right"></i>
                <a href="#" onclick="switchView('inventory-list'); return false;">GHG Inventories</a>
                <i class="fa-light fa-chevron-right"></i>
                <span>Q4 2025 Corporate Inventory</span>
              </div>
              <h1 class="page-title">Q4 2025 Corporate Inventory</h1>
            </div>
            <div class="page-header-actions">
              <button class="btn btn-secondary">
                <i class="fa-light fa-arrow-rotate-right"></i>
                Recalculate
              </button>
              <button class="btn btn-secondary">
                <i class="fa-light fa-download"></i>
                Export
              </button>
              <button class="btn btn-primary" onclick="openLockModal()">
                <i class="fa-light fa-lock"></i>
                Lock Inventory
              </button>
            </div>
          </div>
          
          <div class="content-container">
            <!-- Inventory Status Header -->
            <div class="inventory-status-header">
              <div class="inventory-status-left">
                <div class="inventory-icon-large">
                  <i class="fa-light fa-calculator"></i>
                </div>
                <div class="inventory-info">
                  <h2>Q4 2025 Corporate Inventory</h2>
                  <div class="inventory-meta-row">
                    <span><i class="fa-light fa-calendar"></i> Oct 1 - Dec 31, 2025</span>
                    <span><i class="fa-light fa-book"></i> GHG Protocol Corporate Standard</span>
                    <span><i class="fa-light fa-sitemap"></i> Financial Control</span>
                    <span><i class="fa-light fa-building"></i> 4 entities</span>
                  </div>
                </div>
              </div>
              <div style="display: flex; align-items: center; gap: 12px;">
                <div style="display: flex; align-items: center; gap: 8px;">
                  <label style="font-size: 13px; color: var(--ghg-text-secondary); white-space: nowrap;">Compare with:</label>
                  <select class="form-select" id="period-comparison-select" style="width: 180px;">
                    <option value="none">No Comparison</option>
                    <option value="q3-2025" selected>Q3 2025 (Previous)</option>
                    <option value="q4-2024">Q4 2024 (YoY)</option>
                    <option value="q3-2024">Q3 2024</option>
                  </select>
                </div>
                <span class="badge badge-success" style="font-size: 14px; padding: 8px 16px;">
                  <i class="fa-light fa-check-circle"></i>
                  Calculation Complete
                </span>
              </div>
            </div>
            
            <!-- Stats Grid -->
            <div class="stats-grid">
              <div class="stat-card total">
                <div class="stat-label">Total Emissions</div>
                <div class="stat-value">1,061.9<span class="stat-unit">tCOe</span></div>
                <div class="stat-change positive" id="stat-total-change">
                  <i class="fa-light fa-arrow-down"></i>
                  5.4% from Q3 2025
                </div>
              </div>
              <div class="stat-card scope-1">
                <div class="stat-label">Scope 1 - Direct</div>
                <div class="stat-value">124.6<span class="stat-unit">tCOe</span></div>
                <div class="stat-change" id="stat-scope1-change">
                  <span style="color: var(--ghg-text-muted);">11.7% of total</span>  <span style="color: #DC2626;"> +5.3%</span>
                </div>
              </div>
              <div class="stat-card scope-2">
                <div class="stat-label">Scope 2 - Indirect (Energy)</div>
                <div class="stat-value">45.2<span class="stat-unit">tCOe</span></div>
                <div class="stat-change" id="stat-scope2-change">
                  <span style="color: var(--ghg-text-muted);">4.3% of total</span>  <span style="color: #DC2626;"> +4.9%</span>
                </div>
              </div>
              <div class="stat-card scope-3">
                <div class="stat-label">Scope 3 - Value Chain</div>
                <div class="stat-value">892.1<span class="stat-unit">tCOe</span></div>
                <div class="stat-change" id="stat-scope3-change">
                  <span style="color: var(--ghg-text-muted);">84.0% of total</span>  <span style="color: #DC2626;"> +5.3%</span>
                </div>
              </div>
            </div>
            
            <!-- Tabs Container -->
            <div class="tabs-container">
              <div class="tabs">
                <button class="tab active" data-tab="overview">Overview</button>
                <button class="tab" data-tab="breakdown">Detailed Breakdown</button>
                <button class="tab" data-tab="lineage">Calculation Lineage</button>
                <button class="tab" data-tab="ef-selection">EF Selection & Review</button>
              </div>
              
              <!-- Tab: Overview -->
              <div class="tab-content active" id="tab-overview">
                <!-- Data Quality Card (Collapsible) -->
                <div style="background: linear-gradient(135deg, #059669 0%, #10B981 100%); border-radius: 12px; padding: 20px; margin-bottom: 24px; border: 2px solid #059669;">
                  <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px; cursor: pointer;" onclick="toggleQualityCard()">
                    <div style="flex: 1;">
                      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                        <i class="fa-light fa-badge-check" style="font-size: 20px; color: white;"></i>
                        <h3 style="font-family: var(--font-display); font-size: 18px; font-weight: 600; color: white; margin: 0;">Data Quality Score</h3>
                        <i class="fa-light fa-chevron-down" id="quality-card-toggle" style="color: white; margin-left: auto; transition: transform 0.2s;"></i>
                      </div>
                      <p style="color: rgba(255,255,255,0.9); font-size: 13px; margin: 0;">Based on data completeness, source quality, and validation status</p>
                    </div>
                    <div style="text-align: right;">
                      <div style="font-size: 36px; font-weight: 700; color: white; line-height: 1;">87</div>
                      <div style="color: rgba(255,255,255,0.9); font-size: 13px; font-weight: 500;">out of 100</div>
                    </div>
                  </div>
                  <div id="quality-card-details" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                      <i class="fa-light fa-check-circle" style="color: white; font-size: 16px;"></i>
                      <span style="color: rgba(255,255,255,0.95); font-size: 13px;">892 of 920 records complete (97%)</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                      <i class="fa-light fa-check-circle" style="color: white; font-size: 16px;"></i>
                      <span style="color: rgba(255,255,255,0.95); font-size: 13px;">All emission factors current (<12 mo)</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                      <i class="fa-light fa-triangle-exclamation" style="color: #FEF3C7; font-size: 16px;"></i>
                      <span style="color: rgba(255,255,255,0.95); font-size: 13px;">156 records using spend-based estimates (17%)</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                      <i class="fa-light fa-triangle-exclamation" style="color: #FEF3C7; font-size: 16px;"></i>
                      <span style="color: rgba(255,255,255,0.95); font-size: 13px;">28 high-emission records pending review</span>
                    </div>
                  </div>
                </div>
                
                <!-- Scope Visualization -->
                <h3 style="font-family: var(--font-display); font-size: 16px; font-weight: 600; margin-bottom: 16px;">Emissions by Scope</h3>
                <div class="scope-bar">
                  <div class="scope-bar-segment scope-1" style="width: 11.7%;"></div>
                  <div class="scope-bar-segment scope-2" style="width: 4.3%;"></div>
                  <div class="scope-bar-segment scope-3" style="width: 84%;"></div>
                </div>
                <div class="scope-legend">
                  <div class="scope-legend-item">
                    <div class="scope-legend-dot scope-1"></div>
                    <span>Scope 1: 124.6 tCOe (11.7%)</span>
                  </div>
                  <div class="scope-legend-item">
                    <div class="scope-legend-dot scope-2"></div>
                    <span>Scope 2: 45.2 tCOe (4.3%)</span>
                  </div>
                  <div class="scope-legend-item">
                    <div class="scope-legend-dot scope-3"></div>
                    <span>Scope 3: 892.1 tCOe (84.0%)</span>
                  </div>
                </div>
                
                <!-- Dual Scope 2 Reporting -->
                <h3 style="font-family: var(--font-display); font-size: 16px; font-weight: 600; margin: 32px 0 16px;">Scope 2 Dual Reporting</h3>
                <div class="dual-scope-card">
                  <div class="dual-scope-item">
                    <div class="dual-scope-label">Location-Based</div>
                    <div class="dual-scope-value">45.2 tCOe</div>
                    <div class="dual-scope-note">Uses grid-average emission factors</div>
                  </div>
                  <div class="dual-scope-item">
                    <div class="dual-scope-label">Market-Based</div>
                    <div class="dual-scope-value">38.1 tCOe</div>
                    <div class="dual-scope-note">Accounts for RECs and supplier contracts</div>
                  </div>
                </div>
                <div class="info-box success" style="margin-top: 16px;">
                  <i class="fa-light fa-leaf"></i>
                  <div>
                    <strong>Market-based emissions are 15.7% lower</strong> than location-based due to renewable energy certificates (RECs) applied to 30% of purchased electricity.
                  </div>
                </div>
                
                <!-- Summary Table -->
                <h3 style="font-family: var(--font-display); font-size: 16px; font-weight: 600; margin: 32px 0 16px;">Emissions Summary by Scope & Category</h3>
                <table class="data-table">
                  <thead>
                    <tr>
                      <th>Scope</th>
                      <th>Category</th>
                      <th class="numeric">Emissions (tCOe)</th>
                      <th class="numeric">% of Total</th>
                      <th class="numeric">Records</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td><span class="badge badge-scope-1">Scope 1</span></td>
                      <td>Stationary Combustion (Natural Gas)</td>
                      <td class="numeric">78.2</td>
                      <td class="numeric">7.4%</td>
                      <td class="numeric">48</td>
                    </tr>
                    <tr>
                      <td><span class="badge badge-scope-1">Scope 1</span></td>
                      <td>Mobile Combustion (Company Fleet)</td>
                      <td class="numeric">42.4</td>
                      <td class="numeric">4.0%</td>
                      <td class="numeric">24</td>
                    </tr>
                    <tr>
                      <td><span class="badge badge-scope-1">Scope 1</span></td>
                      <td>Fugitive Emissions</td>
                      <td class="numeric">4.0</td>
                      <td class="numeric">0.4%</td>
                      <td class="numeric">4</td>
                    </tr>
                    <tr>
                      <td><span class="badge badge-scope-2">Scope 2</span></td>
                      <td>Purchased Electricity (Location-Based)</td>
                      <td class="numeric">42.1</td>
                      <td class="numeric">4.0%</td>
                      <td class="numeric">48</td>
                    </tr>
                    <tr>
                      <td><span class="badge badge-scope-2">Scope 2</span></td>
                      <td>Purchased Heat/Steam</td>
                      <td class="numeric">3.1</td>
                      <td class="numeric">0.3%</td>
                      <td class="numeric">12</td>
                    </tr>
                    <tr>
                      <td><span class="badge badge-scope-3">Scope 3</span></td>
                      <td>Cat 1: Purchased Goods & Services</td>
                      <td class="numeric">412.0</td>
                      <td class="numeric">38.8%</td>
                      <td class="numeric">156</td>
                    </tr>
                    <tr>
                      <td><span class="badge badge-scope-3">Scope 3</span></td>
                      <td>Cat 3: Fuel & Energy Related Activities</td>
                      <td class="numeric">28.5</td>
                      <td class="numeric">2.7%</td>
                      <td class="numeric">72</td>
                    </tr>
                    <tr>
                      <td><span class="badge badge-scope-3">Scope 3</span></td>
                      <td>Cat 4: Upstream Transportation</td>
                      <td class="numeric">186.4</td>
                      <td class="numeric">17.6%</td>
                      <td class="numeric">48</td>
                    </tr>
                    <tr>
                      <td><span class="badge badge-scope-3">Scope 3</span></td>
                      <td>Cat 5: Waste Generated in Operations</td>
                      <td class="numeric">24.8</td>
                      <td class="numeric">2.3%</td>
                      <td class="numeric">36</td>
                    </tr>
                    <tr>
                      <td><span class="badge badge-scope-3">Scope 3</span></td>
                      <td>Cat 6: Business Travel</td>
                      <td class="numeric">89.2</td>
                      <td class="numeric">8.4%</td>
                      <td class="numeric">84</td>
                    </tr>
                    <tr>
                      <td><span class="badge badge-scope-3">Scope 3</span></td>
                      <td>Cat 7: Employee Commuting</td>
                      <td class="numeric">151.2</td>
                      <td class="numeric">14.2%</td>
                      <td class="numeric">96</td>
                    </tr>
                  </tbody>
                </table>
              </div>
              
              <!-- Tab: Detailed Breakdown -->
              <div class="tab-content" id="tab-breakdown">
                <h3 style="font-family: var(--font-display); font-size: 16px; font-weight: 600; margin-bottom: 16px;">Emissions by Entity  Activity</h3>
                <p style="color: var(--ghg-text-secondary); font-size: 14px; margin-bottom: 20px;">
                  Click any row to view complete calculation lineage including activity data, emission factors, and methodology.
                </p>
                
                <!-- Filter Toolbar -->
                <div class="breakdown-toolbar" style="display: flex; gap: 8px; margin-bottom: 16px; align-items: center; flex-wrap: wrap; background: var(--ghg-surface); padding: 12px; border-radius: 8px; border: 1px solid var(--ghg-border);">
                  <!-- Search -->
                  <div class="search-input-wrapper" style="width: 240px; position: relative;">
                    <i class="fa-light fa-search" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--ghg-text-muted); z-index: 1;"></i>
                    <input 
                      type="text" 
                      class="form-input" 
                      placeholder="Search entities, activities..." 
                      id="breakdown-search"
                      style="padding-left: 36px; width: 100%;"
                    >
                  </div>
                  
                  <!-- Entity Filter -->
                  <select class="form-select" id="breakdown-entity-filter" style="width: 140px;">
                    <option value="all">All Entities</option>
                    <option value="hq-building">HQ Building</option>
                    <option value="manufacturing">Manufacturing</option>
                    <option value="distribution">Distribution</option>
                    <option value="all-entities">All Entities</option>
                  </select>
                  
                  <!-- Scope Filter -->
                  <select class="form-select" id="breakdown-scope-filter" style="width: 120px;">
                    <option value="all">All Scopes</option>
                    <option value="1">Scope 1</option>
                    <option value="2">Scope 2</option>
                    <option value="3">Scope 3</option>
                  </select>
                  
                  <!-- Category Filter (shown only when Scope 3 selected) -->
                  <select class="form-select" id="breakdown-category-filter" style="width: 140px; display: none;">
                    <option value="all">All Categories</option>
                    <option value="1">3.1 Purchased Goods</option>
                    <option value="2">3.2 Capital Goods</option>
                    <option value="3">3.3 T&D Losses</option>
                    <option value="4">3.4 Upstream Transport</option>
                    <option value="5">3.5 Waste</option>
                    <option value="6">3.6 Business Travel</option>
                    <option value="7">3.7 Employee Commuting</option>
                    <option value="8">3.8 Upstream Leased Assets</option>
                    <option value="9">3.9 Downstream Transport</option>
                    <option value="10">3.10 Processing of Products</option>
                    <option value="11">3.11 Use of Products</option>
                    <option value="12">3.12 End-of-Life</option>
                    <option value="13">3.13 Downstream Leased Assets</option>
                    <option value="14">3.14 Franchises</option>
                    <option value="15">3.15 Investments</option>
                  </select>
                  
                  <!-- Emission Range Filter -->
                  <select class="form-select" id="breakdown-emission-filter" style="width: 140px;">
                    <option value="all">All Emissions</option>
                    <option value="high">High (>100 tCOe)</option>
                    <option value="medium">Medium (10-100 tCOe)</option>
                    <option value="low">Low (<10 tCOe)</option>
                  </select>
                  
                  <!-- Quality Filter -->
                  <select class="form-select" id="breakdown-quality-filter" style="width: 120px;">
                    <option value="all">All Quality</option>
                    <option value="High">High</option>
                    <option value="Medium">Medium</option>
                    <option value="Low">Low</option>
                  </select>
                  
                  <!-- Group By -->
                  <div class="toggle-group" style="display: flex; align-items: center; gap: 8px;">
                    <label style="font-size: 13px; color: var(--ghg-text-secondary); white-space: nowrap;">Group by:</label>
                    <select class="form-select" id="breakdown-group-by" style="width: 100px;">
                      <option value="none">None</option>
                      <option value="entity">Entity</option>
                      <option value="scope">Scope</option>
                      <option value="category">Category</option>
                    </select>
                  </div>
                  
                  <!-- Clear Filters Button -->
                  <button class="btn btn-ghost btn-sm" id="breakdown-clear-filters" style="white-space: nowrap;">
                    <i class="fa-light fa-times"></i> Clear
                  </button>
                </div>
                
                <!-- Summary Bar -->
                <div class="breakdown-summary" style="display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; background: var(--ghg-surface-elevated); border-radius: 8px; margin-bottom: 16px; font-size: 13px;">
                  <div style="color: var(--ghg-text-secondary);">
                    Showing <strong id="breakdown-showing-count" style="color: var(--ghg-text-primary);">0</strong> of 
                    <strong id="breakdown-total-count" style="color: var(--ghg-text-primary);">0</strong> emission records
                  </div>
                  <div style="display: flex; gap: 24px;">
                    <div>
                      <span style="color: var(--ghg-text-secondary);">Total:</span>
                      <strong id="breakdown-total-emissions" style="color: var(--ghg-text-primary); margin-left: 8px;">0.0</strong>
                      <span style="color: var(--ghg-text-muted); margin-left: 4px;">tCOe</span>
                    </div>
                    <div>
                      <span style="color: var(--ghg-text-secondary);">Avg:</span>
                      <strong id="breakdown-avg-emissions" style="color: var(--ghg-text-primary); margin-left: 8px;">0.0</strong>
                      <span style="color: var(--ghg-text-muted); margin-left: 4px;">tCOe</span>
                    </div>
                  </div>
                </div>
                
                <table class="data-table" id="breakdown-table">
                  <thead>
                    <tr>
                      <th style="width: 40px;"></th>
                      <th class="sortable" data-sort="entity">
                        Entity
                        <i class="fa-light fa-sort sort-icon" style="margin-left: 4px; opacity: 0.3;"></i>
                      </th>
                      <th class="sortable" data-sort="activity">
                        Activity
                        <i class="fa-light fa-sort sort-icon" style="margin-left: 4px; opacity: 0.3;"></i>
                      </th>
                      <th class="sortable" data-sort="scope">
                        Scope
                        <i class="fa-light fa-sort sort-icon" style="margin-left: 4px; opacity: 0.3;"></i>
                      </th>
                      <th class="numeric sortable" data-sort="activityData">
                        Activity Data
                        <i class="fa-light fa-sort sort-icon" style="margin-left: 4px; opacity: 0.3;"></i>
                      </th>
                      <th class="numeric sortable sort-desc" data-sort="tco2e">
                        tCOe
                        <i class="fa-light fa-sort sort-icon" style="margin-left: 4px;"></i>
                      </th>
                      <th class="sortable" data-sort="efSource">
                        EF Source
                        <i class="fa-light fa-sort sort-icon" style="margin-left: 4px; opacity: 0.3;"></i>
                      </th>
                      <th class="sortable" data-sort="quality">
                        Quality
                        <i class="fa-light fa-sort sort-icon" style="margin-left: 4px; opacity: 0.3;"></i>
                      </th>
                    </tr>
                  </thead>
                  <tbody id="breakdown-tbody">
                  </tbody>
                </table>
                
                <!-- Pagination -->
                <div class="breakdown-pagination" style="display: flex; justify-content: space-between; align-items: center; padding: 16px; border-top: 1px solid var(--ghg-border);">
                  <div style="font-size: 13px; color: var(--ghg-text-secondary);">
                    Page <strong id="breakdown-current-page">1</strong> of <strong id="breakdown-total-pages">1</strong>
                  </div>
                  <div style="display: flex; gap: 8px;">
                    <button class="btn btn-ghost btn-sm" id="breakdown-prev-page" disabled>
                      <i class="fa-light fa-chevron-left"></i> Previous
                    </button>
                    <button class="btn btn-ghost btn-sm" id="breakdown-next-page">
                      Next <i class="fa-light fa-chevron-right"></i>
                    </button>
                  </div>
                </div>
              </div>
              
              <!-- Tab: Calculation Lineage -->
              <div class="tab-content" id="tab-lineage">
                <h3 style="font-family: var(--font-display); font-size: 16px; font-weight: 600; margin-bottom: 16px;">Audit Trail & Traceability</h3>
                <p style="color: var(--ghg-text-secondary); font-size: 14px; margin-bottom: 20px;">
                  Complete calculation logs for external auditor verification. Every emission record traces back to source data, emission factor, and methodology.
                </p>
                
                <div class="info-box" style="margin-bottom: 24px;">
                  <i class="fa-light fa-shield-check"></i>
                  <div>
                    <strong>Audit-Ready Status:</strong> All 628 emission records in this inventory have complete lineage documentation including inputs, conversions, EF source, boundary decisions, and calculation steps.
                  </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 24px;">
                  <div class="stat-card">
                    <div class="stat-label">Total Records</div>
                    <div class="stat-value">628</div>
                  </div>
                  <div class="stat-card">
                    <div class="stat-label">EF Sources Used</div>
                    <div class="stat-value">4</div>
                  </div>
                  <div class="stat-card">
                    <div class="stat-label">Calculation Methods</div>
                    <div class="stat-value">3</div>
                  </div>
                </div>
                
                <h4 style="font-size: 14px; font-weight: 600; margin-bottom: 12px;">Emission Factor Sources</h4>
                <table class="data-table" style="margin-bottom: 24px;">
                  <thead>
                    <tr>
                      <th>Source</th>
                      <th>Version</th>
                      <th>Categories Covered</th>
                      <th class="numeric">Records Using</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td>eGRID (EPA)</td>
                      <td>2024</td>
                      <td>Purchased Electricity</td>
                      <td class="numeric">192</td>
                    </tr>
                    <tr>
                      <td>EPA GHG Emission Factor Hub</td>
                      <td>2024</td>
                      <td>Stationary & Mobile Combustion</td>
                      <td class="numeric">144</td>
                    </tr>
                    <tr>
                      <td>EEIO (EPA)</td>
                      <td>2024</td>
                      <td>Purchased Goods & Services</td>
                      <td class="numeric">156</td>
                    </tr>
                    <tr>
                      <td>DEFRA</td>
                      <td>2024</td>
                      <td>Business Travel, Commuting</td>
                      <td class="numeric">136</td>
                    </tr>
                  </tbody>
                </table>
                
                <h4 style="font-size: 14px; font-weight: 600; margin-bottom: 12px;">Calculation Methods Applied</h4>
                <table class="data-table">
                  <thead>
                    <tr>
                      <th>Method</th>
                      <th>Description</th>
                      <th class="numeric">Records</th>
                      <th class="numeric">% Coverage</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td>Activity-Based</td>
                      <td>Activity  Emission Factor (measured data)</td>
                      <td class="numeric">336</td>
                      <td class="numeric">53.5%</td>
                    </tr>
                    <tr>
                      <td>Spend-Based</td>
                      <td>Spend  EEIO Factor (economic input-output)</td>
                      <td class="numeric">156</td>
                      <td class="numeric">24.8%</td>
                    </tr>
                    <tr>
                      <td>Distance-Based</td>
                      <td>Distance  Mode Factor (travel/transport)</td>
                      <td class="numeric">136</td>
                      <td class="numeric">21.7%</td>
                    </tr>
                  </tbody>
                </table>
              </div>
              
              <!-- Tab: EF Selection & Review (Summary Dashboard) -->
              <div class="tab-content" id="tab-ef-selection">
                <div class="ef-summary-dashboard">
                  
                  <!-- Overall Coverage Progress -->
                  <div class="ef-coverage-hero">
                    <div class="ef-coverage-hero-main">
                      <div class="ef-coverage-circle">
                        <svg viewBox="0 0 100 100">
                          <circle cx="50" cy="50" r="45" fill="none" stroke="var(--ghg-surface-elevated)" stroke-width="10"/>
                          <circle cx="50" cy="50" r="45" fill="none" stroke="var(--ghg-success)" stroke-width="10" 
                            stroke-dasharray="254" stroke-dashoffset="10" 
                            transform="rotate(-90 50 50)" stroke-linecap="round"/>
                        </svg>
                        <div class="ef-coverage-value">
                          <span class="ef-coverage-percent">96.2%</span>
                          <span class="ef-coverage-label">EF Coverage</span>
                        </div>
                      </div>
                      <div class="ef-coverage-breakdown">
                        <div class="ef-coverage-stat">
                          <span class="ef-coverage-stat-value success">1,206,234</span>
                          <span class="ef-coverage-stat-label">Records with EF assigned</span>
                        </div>
                        <div class="ef-coverage-stat">
                          <span class="ef-coverage-stat-value warning">15,402</span>
                          <span class="ef-coverage-stat-label">Flagged for review</span>
                        </div>
                        <div class="ef-coverage-stat">
                          <span class="ef-coverage-stat-value error">32,598</span>
                          <span class="ef-coverage-stat-label">Unmapped / Missing EF</span>
                        </div>
                      </div>
                    </div>
                    <div class="ef-coverage-hero-actions">
                      <button class="btn btn-primary" onclick="switchView('ef-selection-review')">
                        <i class="fa-light fa-scale-balanced"></i> Open EF Selection & Review
                      </button>
                    </div>
                  </div>
                  
                  <!-- KPI Stats Row -->
                  <div class="ef-kpi-grid">
                    <div class="ef-kpi-card">
                      <div class="ef-kpi-icon success"><i class="fa-light fa-bullseye"></i></div>
                      <div class="ef-kpi-content">
                        <span class="ef-kpi-value success">76.4</span>
                        <span class="ef-kpi-label">Avg Specificity Score</span>
                      </div>
                      <span class="ef-kpi-trend up">+3.2 from last period</span>
                    </div>
                    <div class="ef-kpi-card">
                      <div class="ef-kpi-icon primary"><i class="fa-light fa-location-dot"></i></div>
                      <div class="ef-kpi-content">
                        <span class="ef-kpi-value primary">84.2%</span>
                        <span class="ef-kpi-label">Geographic Match Rate</span>
                      </div>
                      <span class="ef-kpi-trend">Country-specific EFs applied</span>
                    </div>
                    <div class="ef-kpi-card">
                      <div class="ef-kpi-icon success"><i class="fa-light fa-calendar-check"></i></div>
                      <div class="ef-kpi-content">
                        <span class="ef-kpi-value success">92.1%</span>
                        <span class="ef-kpi-label">Dataset Freshness</span>
                      </div>
                      <span class="ef-kpi-trend">Using 2024+ datasets</span>
                    </div>
                    <div class="ef-kpi-card">
                      <div class="ef-kpi-icon warning"><i class="fa-light fa-arrow-right-arrow-left"></i></div>
                      <div class="ef-kpi-content">
                        <span class="ef-kpi-value warning">0.11%</span>
                        <span class="ef-kpi-label">Manual Override Rate</span>
                      </div>
                      <span class="ef-kpi-trend">142 of 1.25M records</span>
                    </div>
                  </div>
                  
                  <!-- Review Queue Hero Callout -->
                  <div class="review-queue-hero">
                    <div class="review-queue-hero-header">
                      <div class="review-queue-hero-title">
                        <i class="fa-light fa-flag"></i>
                        <h3>Review Queue</h3>
                        <span class="review-count">15,402 selections require attention</span>
                      </div>
                      <button class="btn btn-primary btn-sm" onclick="switchView('ef-selection-review')">
                        Review All <i class="fa-light fa-arrow-right"></i>
                      </button>
                    </div>
                    <div class="review-queue-issues">
                      <div class="issue-card" onclick="switchView('ef-selection-review')">
                        <div class="issue-card-header">
                          <div class="issue-card-icon warning">
                            <i class="fa-light fa-location-dot"></i>
                          </div>
                          <span class="issue-card-title">Geographic Mismatch</span>
                          <span class="issue-card-count warning">5,230</span>
                        </div>
                        <p class="issue-card-desc">Non-local EFs applied to local activities</p>
                      </div>
                      <div class="issue-card" onclick="switchView('ef-selection-review')">
                        <div class="issue-card-header">
                          <div class="issue-card-icon error">
                            <i class="fa-light fa-clock"></i>
                          </div>
                          <span class="issue-card-title">Outdated Factors</span>
                          <span class="issue-card-count error">3,890</span>
                        </div>
                        <p class="issue-card-desc">Using pre-2023 factors (DEFRA 2022, ADEME 2021)</p>
                      </div>
                      <div class="issue-card" onclick="switchView('ef-selection-review')">
                        <div class="issue-card-header">
                          <div class="issue-card-icon info">
                            <i class="fa-light fa-bullseye"></i>
                          </div>
                          <span class="issue-card-title">Low Specificity</span>
                          <span class="issue-card-count info">6,282</span>
                        </div>
                        <p class="issue-card-desc">Generic/average EFs where more specific available</p>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Quick Actions -->
                  <div class="ef-quick-actions">
                    <div class="ef-quick-action" onclick="switchView('ef-selection-review')">
                      <div class="ef-quick-action-icon"><i class="fa-light fa-building"></i></div>
                      <div class="ef-quick-action-content">
                        <h4>Review by Entity</h4>
                        <p>Drill into EF selections for each organizational entity</p>
                      </div>
                      <i class="fa-light fa-chevron-right"></i>
                    </div>
                    <div class="ef-quick-action" onclick="switchView('ef-selection-review')">
                      <div class="ef-quick-action-icon"><i class="fa-light fa-layer-group"></i></div>
                      <div class="ef-quick-action-content">
                        <h4>Review by Category</h4>
                        <p>Examine emission factors across scope categories</p>
                      </div>
                      <i class="fa-light fa-chevron-right"></i>
                    </div>
                    <div class="ef-quick-action" onclick="switchView('ef-selection-review')">
                      <div class="ef-quick-action-icon"><i class="fa-light fa-sliders"></i></div>
                      <div class="ef-quick-action-content">
                        <h4>Manage Override Rules</h4>
                        <p>Configure rules that automatically override system selections</p>
                      </div>
                      <span class="ef-quick-action-badge">8 active rules</span>
                      <i class="fa-light fa-chevron-right"></i>
                    </div>
                  </div>
                  
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- ============================================== -->
        <!-- VIEW 3: CALCULATION METHODS                    -->
        <!-- ============================================== -->
        <div id="view-calc-methods" class="view">
          <div class="page-header">
            <div class="page-header-left">
              <div class="page-breadcrumb">
                <a href="#">Monitor</a>
                <i class="fa-light fa-chevron-right"></i>
                <span>Calculation Methods</span>
              </div>
              <h1 class="page-title">Calculation Methods</h1>
              <p class="page-subtitle">Configure how emissions are calculated for each entity  activity combination</p>
            </div>
            <div class="page-header-actions">
              <button class="btn btn-secondary">
                <i class="fa-light fa-copy"></i>
                Copy Configuration
              </button>
              <button class="btn btn-primary">
                <i class="fa-light fa-plus"></i>
                Configure Method
              </button>
            </div>
          </div>
          
          <div class="content-container">
            <div class="info-box" style="margin-bottom: 24px;">
              <i class="fa-light fa-lightbulb"></i>
              <div>
                <strong>Configuration drives calculation:</strong> Each entity  activity combination requires a configured calculation method, emission factor assignment, and boundary rules before it can be included in inventory calculations.
              </div>
            </div>
            
            <div class="card">
              <div class="card-header">
                <h2 class="card-title">Configuration Matrix</h2>
              </div>
              <div class="card-body">
                <div class="matrix-container">
                  <table class="matrix-table">
                    <thead>
                      <tr>
                        <th>Entity</th>
                        <th>Electricity</th>
                        <th>Natural Gas</th>
                        <th>Fleet Vehicles</th>
                        <th>Waste</th>
                        <th>Business Travel</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td>HQ Building</td>
                        <td class="matrix-cell status-ready"><i class="fa-solid fa-check-circle"></i></td>
                        <td class="matrix-cell status-ready"><i class="fa-solid fa-check-circle"></i></td>
                        <td class="matrix-cell status-na"></td>
                        <td class="matrix-cell status-needs-config"><i class="fa-solid fa-exclamation-circle"></i></td>
                        <td class="matrix-cell status-ready"><i class="fa-solid fa-check-circle"></i></td>
                      </tr>
                      <tr>
                        <td>Manufacturing</td>
                        <td class="matrix-cell status-ready"><i class="fa-solid fa-check-circle"></i></td>
                        <td class="matrix-cell status-ready"><i class="fa-solid fa-check-circle"></i></td>
                        <td class="matrix-cell status-ready"><i class="fa-solid fa-check-circle"></i></td>
                        <td class="matrix-cell status-ready"><i class="fa-solid fa-check-circle"></i></td>
                        <td class="matrix-cell status-ready"><i class="fa-solid fa-check-circle"></i></td>
                      </tr>
                      <tr>
                        <td>Distribution</td>
                        <td class="matrix-cell status-ready"><i class="fa-solid fa-check-circle"></i></td>
                        <td class="matrix-cell status-na"></td>
                        <td class="matrix-cell status-ready"><i class="fa-solid fa-check-circle"></i></td>
                        <td class="matrix-cell status-needs-config"><i class="fa-solid fa-exclamation-circle"></i></td>
                        <td class="matrix-cell status-ready"><i class="fa-solid fa-check-circle"></i></td>
                      </tr>
                      <tr>
                        <td>Retail Ops</td>
                        <td class="matrix-cell status-ready"><i class="fa-solid fa-check-circle"></i></td>
                        <td class="matrix-cell status-na"></td>
                        <td class="matrix-cell status-na"></td>
                        <td class="matrix-cell status-ready"><i class="fa-solid fa-check-circle"></i></td>
                        <td class="matrix-cell status-ready"><i class="fa-solid fa-check-circle"></i></td>
                      </tr>
                    </tbody>
                  </table>
                </div>
                
                <div class="matrix-legend">
                  <div class="legend-item">
                    <i class="fa-solid fa-check-circle status-ready"></i>
                    <span>Configured</span>
                  </div>
                  <div class="legend-item">
                    <i class="fa-solid fa-exclamation-circle status-needs-config"></i>
                    <span>Needs Configuration (2)</span>
                  </div>
                  <div class="legend-item">
                    <span class="status-na"></span>
                    <span>Not Applicable</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- ============================================== -->
        <!-- VIEW 4: EF LIBRARY                             -->
        <!-- ============================================== -->
        <div id="view-ef-library" class="view">
          <div class="page-header">
            <div class="page-header-left">
              <div class="page-breadcrumb">
                <a href="#">Monitor</a>
                <i class="fa-light fa-chevron-right"></i>
                <span>EF Library</span>
              </div>
              <h1 class="page-title">Emission Factor Library</h1>
              <p class="page-subtitle">Browse and manage emission factors from authoritative sources</p>
            </div>
          </div>
          
          <div class="content-container">
            <div class="search-bar">
              <div class="search-input-wrapper">
                <i class="fa-light fa-search"></i>
                <input type="text" class="form-input" placeholder="Search emission factors...">
              </div>
              <select class="form-select" style="width: 180px;">
                <option>All Sources</option>
                <option>EPA</option>
                <option>eGRID</option>
                <option>DEFRA</option>
                <option>EEIO</option>
              </select>
            </div>
            
            <div class="card">
              <div class="card-body" style="padding: 0;">
                <table class="data-table">
                  <thead>
                    <tr>
                      <th>Name</th>
                      <th>Source</th>
                      <th>Category</th>
                      <th>Region</th>
                      <th class="numeric">Factor</th>
                      <th>Unit</th>
                      <th>Year</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td>eGRID RFCW Electricity</td>
                      <td><span class="badge badge-neutral">eGRID</span></td>
                      <td>Electricity</td>
                      <td>RFC West (OH, WV, PA)</td>
                      <td class="numeric">0.364</td>
                      <td>kg COe/kWh</td>
                      <td>2024</td>
                    </tr>
                    <tr>
                      <td>Natural Gas - Stationary</td>
                      <td><span class="badge badge-neutral">EPA</span></td>
                      <td>Stationary Combustion</td>
                      <td>United States</td>
                      <td class="numeric">5.31</td>
                      <td>kg COe/therm</td>
                      <td>2024</td>
                    </tr>
                    <tr>
                      <td>Gasoline - Mobile</td>
                      <td><span class="badge badge-neutral">EPA</span></td>
                      <td>Mobile Combustion</td>
                      <td>United States</td>
                      <td class="numeric">8.89</td>
                      <td>kg COe/gallon</td>
                      <td>2024</td>
                    </tr>
                    <tr>
                      <td>Diesel - Mobile</td>
                      <td><span class="badge badge-neutral">EPA</span></td>
                      <td>Mobile Combustion</td>
                      <td>United States</td>
                      <td class="numeric">10.21</td>
                      <td>kg COe/gallon</td>
                      <td>2024</td>
                    </tr>
                    <tr>
                      <td>Air Travel - Short Haul</td>
                      <td><span class="badge badge-neutral">DEFRA</span></td>
                      <td>Business Travel</td>
                      <td>Global</td>
                      <td class="numeric">0.255</td>
                      <td>kg COe/km</td>
                      <td>2024</td>
                    </tr>
                    <tr>
                      <td>EEIO - Manufacturing</td>
                      <td><span class="badge badge-neutral">EEIO</span></td>
                      <td>Purchased Goods</td>
                      <td>United States</td>
                      <td class="numeric">0.42</td>
                      <td>kg COe/$</td>
                      <td>2024</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        
        <!-- ============================================== -->
        <!-- VIEW 5: EF SELECTION & REVIEW (Full Page)      -->
        <!-- ============================================== -->
        <div id="view-ef-selection-review" class="view">
          <div class="page-header">
            <div class="page-header-left">
              <div class="page-breadcrumb">
                <a href="#" onclick="switchView('inventory-list'); return false;">Monitor</a>
                <i class="fa-light fa-chevron-right"></i>
                <span>EF Selection & Review</span>
              </div>
              <h1 class="page-title">EF Selection & Review</h1>
              <p class="page-subtitle">Review and manage emission factor assignments across all entities and activities</p>
            </div>
            <div class="page-header-actions">
              <div class="ef-inventory-selector">
                <i class="fa-light fa-cube"></i>
                <select id="efInventorySelectorFull" onchange="switchEFInventory(this.value)">
                  <option value="inv-q4-2025" selected>Q4 2025 Corporate Inventory</option>
                  <option value="inv-q3-2025">Q3 2025 Corporate Inventory</option>
                  <option value="inv-fy-2024">FY 2024 Annual Report</option>
                  <option value="inv-csrd-2024">CSRD 2024 Disclosure</option>
                </select>
              </div>
              <button class="btn btn-secondary" onclick="showEFFullPageView('rules')">
                <i class="fa-light fa-sliders"></i> Override Rules
              </button>
              <button class="btn btn-primary">
                <i class="fa-light fa-check-double"></i> Bulk Actions
              </button>
            </div>
          </div>
          
          <div class="content-container" style="max-width: none; padding: 24px;">
            <!-- Stats Banner -->
            <div class="ef-page-stats-banner">
              <div class="ef-page-stat">
                <span class="ef-page-stat-value success">1,206,234</span>
                <span class="ef-page-stat-label">Records Mapped</span>
              </div>
              <div class="ef-page-stat">
                <span class="ef-page-stat-value warning">15,402</span>
                <span class="ef-page-stat-label">Flagged for Review</span>
              </div>
              <div class="ef-page-stat">
                <span class="ef-page-stat-value error">32,598</span>
                <span class="ef-page-stat-label">Unmapped</span>
              </div>
              <div class="ef-page-stat">
                <span class="ef-page-stat-value primary">76.4</span>
                <span class="ef-page-stat-label">Avg Specificity</span>
              </div>
              <div class="ef-page-stat">
                <span class="ef-page-stat-value primary">84.2%</span>
                <span class="ef-page-stat-label">Geo Match</span>
              </div>
              <div class="ef-page-stat">
                <span class="ef-page-stat-value success">92.1%</span>
                <span class="ef-page-stat-label">Dataset Fresh</span>
              </div>
            </div>
            
            <!-- Main Content Card with Tabs -->
            <div class="ef-main-card">
              <div class="ef-card-header">
                <div class="ef-card-header-top">
                  <div class="ef-content-tabs">
                    <button class="ef-content-tab active" onclick="switchEFContentTab('entity')">
                      <i class="fa-light fa-building"></i> By Entity
                    </button>
                    <button class="ef-content-tab" onclick="switchEFContentTab('category')">
                      <i class="fa-light fa-layer-group"></i> By Category
                    </button>
                    <button class="ef-content-tab" onclick="showEFFullPageView('review-queue')">
                      <i class="fa-light fa-flag"></i> Review Queue
                      <span style="background: var(--ghg-warning); color: white; font-size: 10px; padding: 2px 6px; border-radius: 10px; margin-left: 6px;">15,402</span>
                    </button>
                  </div>
                  <div class="ef-status-pills">
                    <div class="ef-status-pill">
                      <span class="ef-status-pill-dot complete"></span>
                      <span class="ef-status-pill-count">98</span> complete
                    </div>
                    <div class="ef-status-pill">
                      <span class="ef-status-pill-dot in-progress"></span>
                      <span class="ef-status-pill-count">17</span> in progress
                    </div>
                    <div class="ef-status-pill">
                      <span class="ef-status-pill-dot needs-attention"></span>
                      <span class="ef-status-pill-count">12</span> needs attention
                    </div>
                  </div>
                </div>
                <div class="ef-filter-row">
                  <div class="ef-search-box">
                    <i class="fa-light fa-search"></i>
                    <input type="text" placeholder="Search entities..." id="efEntitySearchFull" oninput="filterEntityTableFull()">
                  </div>
                  <select class="filter-select" id="efRegionFilterFull" onchange="filterEntityTableFull()">
                    <option value="">All Regions</option>
                    <option value="EU">Europe (68)</option>
                    <option value="Americas">Americas (32)</option>
                    <option value="Asia-Pacific">Asia-Pacific (21)</option>
                    <option value="MEA">Middle East & Africa (6)</option>
                  </select>
                  <select class="filter-select" id="efTypeFilterFull" onchange="filterEntityTableFull()">
                    <option value="">All Types</option>
                    <option value="Headquarters">Headquarters (4)</option>
                    <option value="Regional Office">Offices (58)</option>
                    <option value="Manufacturing">Manufacturing (23)</option>
                    <option value="Warehouse">Warehouses (42)</option>
                  </select>
                  <select class="filter-select" id="efStatusFilterFull" onchange="filterEntityTableFull()">
                    <option value="">All Statuses</option>
                    <option value="complete">Complete</option>
                    <option value="in-progress">In Progress</option>
                    <option value="needs-attention">Needs Attention</option>
                  </select>
                </div>
              </div>
              
              <!-- Entity Table View -->
              <div id="ef-entity-table-view-full" class="ef-entity-view active">
                <table class="ef-dense-table" id="efEntityTableFull">
                  <thead>
                    <tr>
                      <th class="sortable" onclick="sortEntityTableFull('name')">Entity <i class="fa-light fa-sort sort-icon"></i></th>
                      <th class="sortable" onclick="sortEntityTableFull('region')">Region <i class="fa-light fa-sort sort-icon"></i></th>
                      <th class="sortable" onclick="sortEntityTableFull('type')">Type <i class="fa-light fa-sort sort-icon"></i></th>
                      <th class="sortable" onclick="sortEntityTableFull('activities')">Activities <i class="fa-light fa-sort sort-icon"></i></th>
                      <th class="sortable" onclick="sortEntityTableFull('records')">Records <i class="fa-light fa-sort sort-icon"></i></th>
                      <th class="sortable" onclick="sortEntityTableFull('coverage')">EF Coverage <i class="fa-light fa-sort sort-icon"></i></th>
                      <th>Issues</th>
                      <th class="sortable" onclick="sortEntityTableFull('status')">Status <i class="fa-light fa-sort sort-icon"></i></th>
                    </tr>
                  </thead>
                  <tbody id="efEntityTableBodyFull">
                    <!-- Rows populated by JavaScript -->
                  </tbody>
                </table>
              </div>
              
              <!-- Category Table View (hidden by default) -->
              <div id="ef-category-table-view-full" class="ef-category-view">
                <table class="ef-dense-table">
                  <thead>
                    <tr>
                      <th>Category</th>
                      <th>Records</th>
                      <th>Coverage</th>
                      <th>Entities</th>
                      <th>Issues</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr onclick="drillDownToCategory('scope1')" style="cursor: pointer;">
                      <td><div class="entity-name-cell"><div class="entity-name-info"><h5>Scope 1 - Direct Emissions</h5><span>Stationary, Mobile, Fugitive, Process</span></div></div></td>
                      <td>156,000</td>
                      <td><div class="coverage-cell"><div class="coverage-bar-mini"><div class="coverage-bar-mini-fill high" style="width: 99%;"></div></div><span class="coverage-percent high">99%</span></div></td>
                      <td>48</td>
                      <td><span style="color: var(--ghg-text-muted);"></span></td>
                      <td><span class="status-icon complete"><i class="fa-light fa-check"></i></span></td>
                    </tr>
                    <tr onclick="drillDownToCategory('scope2')" style="cursor: pointer;">
                      <td><div class="entity-name-cell"><div class="entity-name-info"><h5>Scope 2 - Indirect Energy</h5><span>Electricity, Steam, Heating, Cooling</span></div></div></td>
                      <td>234,000</td>
                      <td><div class="coverage-cell"><div class="coverage-bar-mini"><div class="coverage-bar-mini-fill high" style="width: 98%;"></div></div><span class="coverage-percent high">98%</span></div></td>
                      <td>48</td>
                      <td><span style="color: var(--ghg-text-muted);"></span></td>
                      <td><span class="status-icon complete"><i class="fa-light fa-check"></i></span></td>
                    </tr>
                    <tr onclick="drillDownToCategory('scope3-1')" style="cursor: pointer;">
                      <td><div class="entity-name-cell"><div class="entity-name-info"><h5>Scope 3.1 - Purchased Goods & Services</h5><span>Materials, components, services</span></div></div></td>
                      <td>412,000</td>
                      <td><div class="coverage-cell"><div class="coverage-bar-mini"><div class="coverage-bar-mini-fill medium" style="width: 87%;"></div></div><span class="coverage-percent medium">87%</span></div></td>
                      <td>45</td>
                      <td><div class="issue-pills-cell"><span class="issue-pill specificity">Spec (2.1K)</span></div></td>
                      <td><span class="status-icon in-progress"><i class="fa-light fa-hourglass-half"></i></span></td>
                    </tr>
                    <tr onclick="drillDownToCategory('scope3-6')" style="cursor: pointer;">
                      <td><div class="entity-name-cell"><div class="entity-name-info"><h5>Scope 3.6 - Business Travel</h5><span>Air, rail, hotel, car rental</span></div></div></td>
                      <td>189,000</td>
                      <td><div class="coverage-cell"><div class="coverage-bar-mini"><div class="coverage-bar-mini-fill low" style="width: 76%;"></div></div><span class="coverage-percent low">76%</span></div></td>
                      <td>42</td>
                      <td><div class="issue-pills-cell"><span class="issue-pill geographic">Geo (1.8K)</span><span class="issue-pill outdated">Old (920)</span></div></td>
                      <td><span class="status-icon needs-attention"><i class="fa-light fa-triangle-exclamation"></i></span></td>
                    </tr>
                    <tr onclick="drillDownToCategory('scope3-7')" style="cursor: pointer;">
                      <td><div class="entity-name-cell"><div class="entity-name-info"><h5>Scope 3.7 - Employee Commute</h5><span>Commuting, working from home</span></div></div></td>
                      <td>145,000</td>
                      <td><div class="coverage-cell"><div class="coverage-bar-mini"><div class="coverage-bar-mini-fill high" style="width: 91%;"></div></div><span class="coverage-percent high">91%</span></div></td>
                      <td>48</td>
                      <td><span style="color: var(--ghg-text-muted);"></span></td>
                      <td><span class="status-icon complete"><i class="fa-light fa-check"></i></span></td>
                    </tr>
                    <tr onclick="drillDownToCategory('scope3-9')" style="cursor: pointer;">
                      <td><div class="entity-name-cell"><div class="entity-name-info"><h5>Scope 3.9 - Downstream Transport</h5><span>Product distribution, logistics</span></div></div></td>
                      <td>134,234</td>
                      <td><div class="coverage-cell"><div class="coverage-bar-mini"><div class="coverage-bar-mini-fill medium" style="width: 82%;"></div></div><span class="coverage-percent medium">82%</span></div></td>
                      <td>38</td>
                      <td><div class="issue-pills-cell"><span class="issue-pill specificity">Spec (1.4K)</span></div></td>
                      <td><span class="status-icon in-progress"><i class="fa-light fa-hourglass-half"></i></span></td>
                    </tr>
                  </tbody>
                </table>
              </div>
              
              <!-- Review Queue View (hidden by default) -->
              <div id="ef-review-queue-view-full" class="ef-review-view">
                <div style="padding: 20px;">
                  <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <select class="filter-select">
                      <option>All Flag Types</option>
                      <option>Geographic Mismatch (5,230)</option>
                      <option>Outdated Factor (3,890)</option>
                      <option>Low Specificity (6,282)</option>
                    </select>
                    <select class="filter-select">
                      <option>All Entities</option>
                      <option>Paris HQ</option>
                      <option>Berlin Factory</option>
                      <option>NYC Branch</option>
                    </select>
                    <button class="btn btn-secondary btn-sm" style="margin-left: auto;">
                      <i class="fa-light fa-download"></i> Export
                    </button>
                    <button class="btn btn-primary btn-sm">
                      <i class="fa-light fa-check-double"></i> Bulk Approve Selected
                    </button>
                  </div>
                  <table class="data-table">
                    <thead>
                      <tr>
                        <th style="width: 40px;"><input type="checkbox"></th>
                        <th>Entity</th>
                        <th>Activity</th>
                        <th>Current EF</th>
                        <th>Flag Type</th>
                        <th>Specificity</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr onclick="openOverrideModal('sel-1', 'Diesel - Fleet Vehicles', 'FUEL_DIESEL_MOBILE', '3.29 kg COe/L')">
                        <td><input type="checkbox" onclick="event.stopPropagation()"></td>
                        <td>Paris HQ</td>
                        <td>Diesel - Fleet Vehicles</td>
                        <td>DEFRA 2024  3.29 kg/L</td>
                        <td><span class="flag-badge geographic"><i class="fa-light fa-location-dot"></i> Geographic</span></td>
                        <td><span class="specificity-score medium">72</span></td>
                        <td><button class="btn btn-ghost btn-sm btn-icon"><i class="fa-light fa-arrow-right"></i></button></td>
                      </tr>
                      <tr onclick="openOverrideModal('sel-2', 'Natural Gas - Heating', 'FUEL_NG_STATIONARY', '2.02 kg COe/m')">
                        <td><input type="checkbox" onclick="event.stopPropagation()"></td>
                        <td>Berlin Factory</td>
                        <td>Natural Gas - Heating</td>
                        <td>DEFRA 2022  2.02 kg/m</td>
                        <td><span class="flag-badge outdated"><i class="fa-light fa-clock"></i> Outdated</span></td>
                        <td><span class="specificity-score low">58</span></td>
                        <td><button class="btn btn-ghost btn-sm btn-icon"><i class="fa-light fa-arrow-right"></i></button></td>
                      </tr>
                      <tr onclick="openOverrideModal('sel-3', 'Office Supplies', 'GOODS_OFFICE_MIXED', '0.76 kg COe/$')">
                        <td><input type="checkbox" onclick="event.stopPropagation()"></td>
                        <td>NYC Branch</td>
                        <td>Purchased Goods - Office Supplies</td>
                        <td>EPA EEIO  0.76 kg/$</td>
                        <td><span class="flag-badge specificity"><i class="fa-light fa-bullseye"></i> Low Specificity</span></td>
                        <td><span class="specificity-score low">45</span></td>
                        <td><button class="btn btn-ghost btn-sm btn-icon"><i class="fa-light fa-arrow-right"></i></button></td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
              
              <!-- Table Footer -->
              <div class="ef-table-footer">
                <span class="ef-table-footer-info" id="efTableInfoFull">Showing 127 of 127 entities</span>
                <div class="ef-table-pagination">
                  <button disabled><i class="fa-light fa-chevron-left"></i> Previous</button>
                  <button disabled>Next <i class="fa-light fa-chevron-right"></i></button>
                </div>
              </div>
            </div>
          </div>
        </div>
        
  <!-- Create Inventory Full Page -->
  <div id="view-create-inventory" class="view">
    <div class="page-header">
      <div class="page-header-left">
        <div class="page-breadcrumb">
          <a href="#">Monitor</a>
          <i class="fa-light fa-chevron-right"></i>
          <span>Create Inventory</span>
        </div>
        <h1 class="page-title">Create New Inventory</h1>
        <p class="page-subtitle">Define organizational and operational boundaries in one guided flow.</p>
      </div>
      <div class="page-header-actions">
        <button class="btn btn-secondary" onclick="closeCreateInventoryModal()">
          <i class="fa-light fa-arrow-left"></i>
          Back to Inventory List
        </button>
      </div>
    </div>
    <div class="content-container">
      <div class="card">
      <div class="card-body">
        <!-- Wizard Stepper -->
        <div class="wizard-stepper" id="inventory-wizard-stepper">
          <div class="wizard-step active" data-step="1">
            <div class="step-circle">1</div>
            <span class="step-label">Overview</span>
          </div>
          <div class="step-connector"></div>
          <div class="wizard-step" data-step="2">
            <div class="step-circle">2</div>
            <span class="step-label">Org Boundary</span>
          </div>
          <div class="step-connector"></div>
          <div class="wizard-step" data-step="3">
            <div class="step-circle">3</div>
            <span class="step-label">Operational Boundary</span>
          </div>
          <div class="step-connector"></div>
          <div class="wizard-step" data-step="4">
            <div class="step-circle">4</div>
            <span class="step-label">Emission Factor Sets</span>
          </div>
          <div class="step-connector"></div>
          <div class="wizard-step" data-step="5">
            <div class="step-circle">5</div>
            <span class="step-label">Review</span>
          </div>
        </div>
        
        <!-- Step 1: Overview -->
        <div class="wizard-step-content active" data-step="1">
          <div class="form-group">
            <label class="form-label">Inventory Name</label>
            <input type="text" class="form-input" id="inventory-name" value="Q4 2025 Corporate Inventory" placeholder="Enter inventory name">
          </div>
          
          <div class="form-group">
            <label class="form-label">GHG Framework</label>
            <select class="form-select" id="inventory-framework">
              <option selected>GHG Protocol Corporate Standard</option>
              <option disabled>Bilan Carbone (Coming Soon)</option>
              <option disabled>ISO 14064-1 (Coming Soon)</option>
            </select>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">GWP Version</label>
              <select class="form-select" id="inventory-gwp">
                <option value="ar6-100">AR6 100-year GWP (IPCC 2021)</option>
                <option value="ar5-100" selected>AR5 100-year GWP (IPCC 2014)</option>
                <option value="ar4-100">AR4 100-year GWP (IPCC 2007)</option>
                <option value="ar6-20">AR6 20-year GWP (IPCC 2021)</option>
                <option value="ar5-20">AR5 20-year GWP (IPCC 2014)</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Gases Covered</label>
              <select class="form-select" id="inventory-gases">
                <option value="kyoto-7" selected>Kyoto 7 GHGs (CO, CH, NO, HFCs, PFCs, SF, NF)</option>
                <option value="kyoto-6">Kyoto 6 GHGs (CO, CH, NO, HFCs, PFCs, SF)</option>
                <option value="co2-only">CO Only</option>
                <option value="co2-ch4-n2o">CO, CH, NO</option>
                <option value="all-ghgs">All GHGs (Including F-gases)</option>
              </select>
            </div>
          </div>
          
          <div class="option-group">
            <div class="option-group-title">Consolidation Approach</div>
            <label class="option-item">
              <input type="radio" name="consolidation" value="operational">
              <div>
                <div class="option-label">Operational Control</div>
                <div class="option-desc">Include 100% of emissions from operations you control</div>
              </div>
            </label>
            <label class="option-item">
              <input type="radio" name="consolidation" value="financial" checked>
              <div>
                <div class="option-label">Financial Control</div>
                <div class="option-desc">Include 100% of emissions from operations you financially control</div>
              </div>
            </label>
            <label class="option-item">
              <input type="radio" name="consolidation" value="equity">
              <div>
                <div class="option-label">Equity Share</div>
                <div class="option-desc">Include emissions proportional to your equity stake</div>
              </div>
            </label>
          </div>
        </div>
        
        <!-- Step 2: Org Boundary -->
        <div class="wizard-step-content org-boundary-step" data-step="2">
          <!-- View Toggle Controls -->
          <div class="org-view-controls">
            <div class="org-view-toggle">
              <button class="view-btn active" data-view="summary" onclick="toggleOrgView('summary')">
                <i class="fa-light fa-grid-2"></i>
                Summary
              </button>
              <button class="view-btn" data-view="detail" onclick="toggleOrgView('detail')">
                <i class="fa-light fa-table-list"></i>
                Detailed Table
              </button>
            </div>
            <div class="org-view-right">
              <div class="org-search-input">
                <i class="fa-light fa-search"></i>
                <input type="text" placeholder="Search entities..." id="org-entity-search" oninput="searchOrgEntities(this.value)">
              </div>
              <div class="bulk-actions-dropdown">
                <button class="bulk-actions-btn" onclick="toggleBulkActionsMenu()">
                  <i class="fa-light fa-layer-group"></i>
                  Bulk Actions
                  <i class="fa-light fa-chevron-down"></i>
                </button>
                <div class="bulk-actions-menu" id="bulk-actions-menu">
                  <div class="menu-item" onclick="bulkSelectAll()">
                    <i class="fa-light fa-check-double"></i>
                    Select All Visible
                  </div>
                  <div class="menu-item" onclick="bulkDeselectAll()">
                    <i class="fa-light fa-times"></i>
                    Deselect All Visible
                  </div>
                  <div class="menu-divider"></div>
                  <div class="menu-item" onclick="bulkSelectByType('offices')">
                    <i class="fa-light fa-building"></i>
                    Select Offices Only
                  </div>
                  <div class="menu-item" onclick="bulkSelectByType('warehouses')">
                    <i class="fa-light fa-warehouse"></i>
                    Select Warehouses Only
                  </div>
                  <div class="menu-item" onclick="bulkSelectByType('factories')">
                    <i class="fa-light fa-industry"></i>
                    Select Factories Only
                  </div>
                  <div class="menu-divider"></div>
                  <div class="menu-item" onclick="bulkInvertSelection()">
                    <i class="fa-light fa-rotate"></i>
                    Invert Selection
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Selection Summary -->
          <div class="org-selection-summary">
            <div class="summary-stats">
              <div class="summary-stat primary">
                <span class="stat-value" id="selected-entity-count">1,241</span>
                <span class="stat-label">Entities Selected</span>
              </div>
              <div class="summary-stat">
                <span class="stat-value">32</span>
                <span class="stat-label">Activities</span>
              </div>
              <div class="summary-stat">
                <span class="stat-value">20,770</span>
                <span class="stat-label">Records</span>
              </div>
            </div>
          </div>

          <!-- Summary View (Region Cards) -->
          <div class="org-summary-view active" id="org-summary-view">
            <div class="org-region-list">
            <div class="region-card" data-region="americas">
              <div class="region-card-main" onclick="toggleHierarchy(this)">
                <div class="region-select">
                  <input type="checkbox" checked class="region-checkbox" onclick="event.stopPropagation(); toggleRegion(this)">
                </div>
                <div class="region-icon americas">
                  <i class="fa-light fa-earth-americas"></i>
                </div>
                <div class="region-info">
                  <div class="region-name">Americas</div>
                  <div class="region-breakdown">US Manufacturing, Canada Operations, Latin America</div>
                </div>
                <div class="region-stats">
                  <div class="stat">
                    <span class="stat-value">534</span>
                    <span class="stat-label">entities</span>
                  </div>
                  <div class="stat-divider"></div>
                  <div class="stat coverage-stat">
                    <div class="coverage-ring" style="--coverage: 98;">
                      <span class="coverage-value">98%</span>
                    </div>
                    <span class="stat-label">data</span>
                  </div>
                </div>
                <div class="region-expand">
                  <i class="fa-light fa-chevron-down"></i>
                </div>
              </div>
              <div class="region-children" style="display: none;">
                <div class="child-entity">
                  <input type="checkbox" checked class="node-checkbox">
                  <span class="child-name">US Manufacturing</span>
                  <span class="child-count">127 facilities</span>
                </div>
                <div class="child-entity">
                  <input type="checkbox" checked class="node-checkbox">
                  <span class="child-name">Canada Operations</span>
                  <span class="child-count">89 facilities</span>
                </div>
                <div class="child-entity">
                  <input type="checkbox" checked class="node-checkbox">
                  <span class="child-name">Latin America</span>
                  <span class="child-count">318 facilities</span>
                </div>
              </div>
            </div>

            <div class="region-card" data-region="emea">
              <div class="region-card-main" onclick="toggleHierarchy(this)">
                <div class="region-select">
                  <input type="checkbox" checked class="region-checkbox" onclick="event.stopPropagation(); toggleRegion(this)">
                </div>
                <div class="region-icon emea">
                  <i class="fa-light fa-earth-europe"></i>
                </div>
                <div class="region-info">
                  <div class="region-name">EMEA</div>
                  <div class="region-breakdown">EU Operations, UK & Ireland, Middle East & Africa</div>
                </div>
                <div class="region-stats">
                  <div class="stat">
                    <span class="stat-value">489</span>
                    <span class="stat-label">entities</span>
                  </div>
                  <div class="stat-divider"></div>
                  <div class="stat coverage-stat">
                    <div class="coverage-ring" style="--coverage: 94;">
                      <span class="coverage-value">94%</span>
                    </div>
                    <span class="stat-label">data</span>
                  </div>
                </div>
                <div class="region-expand">
                  <i class="fa-light fa-chevron-down"></i>
                </div>
              </div>
              <div class="region-children" style="display: none;">
                <div class="child-entity">
                  <input type="checkbox" checked class="node-checkbox">
                  <span class="child-name">EU Operations</span>
                  <span class="child-count">214 facilities</span>
                </div>
                <div class="child-entity">
                  <input type="checkbox" checked class="node-checkbox">
                  <span class="child-name">UK & Ireland</span>
                  <span class="child-count">76 facilities</span>
                </div>
                <div class="child-entity">
                  <input type="checkbox" checked class="node-checkbox">
                  <span class="child-name">Middle East & Africa</span>
                  <span class="child-count">199 facilities</span>
                </div>
              </div>
            </div>

            <div class="region-card" data-region="apac">
              <div class="region-card-main" onclick="toggleHierarchy(this)">
                <div class="region-select">
                  <input type="checkbox" checked class="region-checkbox" onclick="event.stopPropagation(); toggleRegion(this)">
                </div>
                <div class="region-icon apac">
                  <i class="fa-light fa-earth-asia"></i>
                </div>
                <div class="region-info">
                  <div class="region-name">APAC</div>
                  <div class="region-breakdown">Japan Operations, Australia & NZ, Southeast Asia</div>
                </div>
                <div class="region-stats">
                  <div class="stat">
                    <span class="stat-value">224</span>
                    <span class="stat-label">entities</span>
                  </div>
                  <div class="stat-divider"></div>
                  <div class="stat coverage-stat">
                    <div class="coverage-ring" style="--coverage: 91;">
                      <span class="coverage-value">91%</span>
                    </div>
                    <span class="stat-label">data</span>
                  </div>
                </div>
                <div class="region-expand">
                  <i class="fa-light fa-chevron-down"></i>
                </div>
              </div>
              <div class="region-children" style="display: none;">
                <div class="child-entity">
                  <input type="checkbox" checked class="node-checkbox">
                  <span class="child-name">Japan Operations</span>
                  <span class="child-count">48 facilities</span>
                </div>
                <div class="child-entity">
                  <input type="checkbox" checked class="node-checkbox">
                  <span class="child-name">Australia & NZ</span>
                  <span class="child-count">32 facilities</span>
                </div>
                <div class="child-entity">
                  <input type="checkbox" checked class="node-checkbox">
                  <span class="child-name">Southeast Asia</span>
                  <span class="child-count">144 facilities</span>
                </div>
              </div>
            </div>
            </div>
          </div>

          <!-- Detailed Table View -->
          <div class="org-detail-view" id="org-detail-view">
            <div class="org-detail-table">
              <!-- Header -->
              <div class="org-detail-table-header">
                <span class="col-name">Entity</span>
                <span class="col-activities">Activities</span>
                <span class="col-records">Records</span>
                <span class="col-selected">Selected</span>
                <span class="col-checkbox"></span>
              </div>

              <!-- Americas Region -->
              <div class="detail-region-row expanded" data-region="americas">
                <div class="detail-region-main" onclick="toggleDetailRegion(this)">
                  <div class="region-name-col">
                    <span class="region-toggle"><i class="fa-light fa-chevron-right"></i></span>
                    <span class="region-name">Americas</span>
                    <span class="region-count">(534)</span>
                  </div>
                  <span class="region-activities">12</span>
                  <span class="region-records">8,420</span>
                  <span class="region-selected">534 / 534</span>
                  <div class="region-checkbox">
                    <input type="checkbox" checked onclick="event.stopPropagation(); toggleDetailRegionSelect(this)">
                  </div>
                </div>
                <div class="detail-region-children">
                  <!-- Offices -->
                  <div class="detail-type-row expanded" data-type="offices">
                    <div class="detail-type-main" onclick="toggleDetailType(this)">
                      <div class="type-name-col">
                        <span class="type-toggle"><i class="fa-light fa-chevron-right"></i></span>
                        <span class="type-name">Offices</span>
                        <span class="type-count">(127)</span>
                      </div>
                      <span class="type-activities">8</span>
                      <span class="type-records">2,156</span>
                      <span class="type-selected">127 / 127</span>
                      <div class="type-checkbox">
                        <input type="checkbox" checked onclick="event.stopPropagation(); toggleDetailTypeSelect(this)">
                      </div>
                    </div>
                    <div class="detail-type-children">
                      <div class="detail-entity-row" data-entity="boston-hq-a">
                        <div class="entity-checkbox"><input type="checkbox" checked onclick="toggleDetailEntitySelect(this)"></div>
                        <div class="entity-info">
                          <span class="entity-name">Boston HQ  Building A</span>
                          <span class="entity-code">US-BOS-001  Office  North America</span>
                        </div>
                        <span></span>
                        <div class="entity-coverage">
                          <div class="coverage-bar-xs"><div class="fill good" style="width: 100%;"></div></div>
                          <span style="font-size: 11px;">100%</span>
                        </div>
                        <div class="entity-status"><div class="status-dot has-data"></div></div>
                      </div>
                      <div class="detail-entity-row" data-entity="boston-hq-b">
                        <div class="entity-checkbox"><input type="checkbox" checked onclick="toggleDetailEntitySelect(this)"></div>
                        <div class="entity-info">
                          <span class="entity-name">Boston HQ  Building B</span>
                          <span class="entity-code">US-BOS-002  Office  North America</span>
                        </div>
                        <span></span>
                        <div class="entity-coverage">
                          <div class="coverage-bar-xs"><div class="fill good" style="width: 100%;"></div></div>
                          <span style="font-size: 11px;">100%</span>
                        </div>
                        <div class="entity-status"><div class="status-dot has-data"></div></div>
                      </div>
                      <div class="detail-entity-row" data-entity="denver-regional">
                        <div class="entity-checkbox"><input type="checkbox" checked onclick="toggleDetailEntitySelect(this)"></div>
                        <div class="entity-info">
                          <span class="entity-name">Denver Regional Office</span>
                          <span class="entity-code">US-DEN-001  Office  North America</span>
                        </div>
                        <span></span>
                        <div class="entity-coverage">
                          <div class="coverage-bar-xs"><div class="fill good" style="width: 100%;"></div></div>
                          <span style="font-size: 11px;">100%</span>
                        </div>
                        <div class="entity-status"><div class="status-dot has-data"></div></div>
                      </div>
                      <div class="detail-entity-row excluded" data-entity="seattle-tech">
                        <div class="entity-checkbox"><input type="checkbox" onclick="toggleDetailEntitySelect(this)"></div>
                        <div class="entity-info">
                          <span class="entity-name">Seattle Tech Campus</span>
                          <span class="entity-code">US-SEA-001  Office  North America</span>
                        </div>
                        <span></span>
                        <div class="entity-coverage">
                          <div class="coverage-bar-xs"><div class="fill warning" style="width: 45%;"></div></div>
                          <span style="font-size: 11px;">45%</span>
                        </div>
                        <div class="entity-status"><div class="status-dot missing"></div></div>
                      </div>
                      <div class="detail-entity-row" data-entity="toronto-office">
                        <div class="entity-checkbox"><input type="checkbox" checked onclick="toggleDetailEntitySelect(this)"></div>
                        <div class="entity-info">
                          <span class="entity-name">Toronto Office</span>
                          <span class="entity-code">CA-TOR-001  Office  North America</span>
                        </div>
                        <span></span>
                        <div class="entity-coverage">
                          <div class="coverage-bar-xs"><div class="fill good" style="width: 100%;"></div></div>
                          <span style="font-size: 11px;">100%</span>
                        </div>
                        <div class="entity-status"><div class="status-dot has-data"></div></div>
                      </div>
                      <div class="detail-entity-row" data-entity="mexico-city">
                        <div class="entity-checkbox"><input type="checkbox" checked onclick="toggleDetailEntitySelect(this)"></div>
                        <div class="entity-info">
                          <span class="entity-name">Mexico City Office</span>
                          <span class="entity-code">MX-MEX-001  Office  Latin America</span>
                        </div>
                        <span></span>
                        <div class="entity-coverage">
                          <div class="coverage-bar-xs"><div class="fill good" style="width: 92%;"></div></div>
                          <span style="font-size: 11px;">92%</span>
                        </div>
                        <div class="entity-status"><div class="status-dot has-data"></div></div>
                      </div>
                    </div>
                  </div>
                  <!-- Warehouses -->
                  <div class="detail-type-row" data-type="warehouses">
                    <div class="detail-type-main" onclick="toggleDetailType(this)">
                      <div class="type-name-col">
                        <span class="type-toggle"><i class="fa-light fa-chevron-right"></i></span>
                        <span class="type-name">Warehouses</span>
                        <span class="type-count">(89)</span>
                      </div>
                      <span class="type-activities">6</span>
                      <span class="type-records">1,890</span>
                      <span class="type-selected">89 / 89</span>
                      <div class="type-checkbox">
                        <input type="checkbox" checked onclick="event.stopPropagation(); toggleDetailTypeSelect(this)">
                      </div>
                    </div>
                    <div class="detail-type-children">
                      <div class="detail-entity-row" data-entity="chicago-dc">
                        <div class="entity-checkbox"><input type="checkbox" checked onclick="toggleDetailEntitySelect(this)"></div>
                        <div class="entity-info">
                          <span class="entity-name">Chicago Distribution Center</span>
                          <span class="entity-code">US-CHI-W01  Warehouse  North America</span>
                        </div>
                        <span></span>
                        <div class="entity-coverage">
                          <div class="coverage-bar-xs"><div class="fill good" style="width: 100%;"></div></div>
                          <span style="font-size: 11px;">100%</span>
                        </div>
                        <div class="entity-status"><div class="status-dot has-data"></div></div>
                      </div>
                      <div class="detail-entity-row" data-entity="la-warehouse">
                        <div class="entity-checkbox"><input type="checkbox" checked onclick="toggleDetailEntitySelect(this)"></div>
                        <div class="entity-info">
                          <span class="entity-name">Los Angeles Warehouse</span>
                          <span class="entity-code">US-LAX-W01  Warehouse  North America</span>
                        </div>
                        <span></span>
                        <div class="entity-coverage">
                          <div class="coverage-bar-xs"><div class="fill good" style="width: 100%;"></div></div>
                          <span style="font-size: 11px;">100%</span>
                        </div>
                        <div class="entity-status"><div class="status-dot has-data"></div></div>
                      </div>
                      <div class="detail-entity-row" data-entity="miami-hub">
                        <div class="entity-checkbox"><input type="checkbox" checked onclick="toggleDetailEntitySelect(this)"></div>
                        <div class="entity-info">
                          <span class="entity-name">Miami Distribution Hub</span>
                          <span class="entity-code">US-MIA-W01  Warehouse  North America</span>
                        </div>
                        <span></span>
                        <div class="entity-coverage">
                          <div class="coverage-bar-xs"><div class="fill warning" style="width: 78%;"></div></div>
                          <span style="font-size: 11px;">78%</span>
                        </div>
                        <div class="entity-status"><div class="status-dot has-data"></div></div>
                      </div>
                    </div>
                  </div>
                  <!-- Factories -->
                  <div class="detail-type-row" data-type="factories">
                    <div class="detail-type-main" onclick="toggleDetailType(this)">
                      <div class="type-name-col">
                        <span class="type-toggle"><i class="fa-light fa-chevron-right"></i></span>
                        <span class="type-name">Factories</span>
                        <span class="type-count">(318)</span>
                      </div>
                      <span class="type-activities">10</span>
                      <span class="type-records">4,374</span>
                      <span class="type-selected">315 / 318</span>
                      <div class="type-checkbox">
                        <input type="checkbox" checked onclick="event.stopPropagation(); toggleDetailTypeSelect(this)">
                      </div>
                    </div>
                    <div class="detail-type-children">
                      <div class="detail-entity-row" data-entity="austin-plant">
                        <div class="entity-checkbox"><input type="checkbox" checked onclick="toggleDetailEntitySelect(this)"></div>
                        <div class="entity-info">
                          <span class="entity-name">Austin Manufacturing Plant</span>
                          <span class="entity-code">US-AUS-F01  Factory  North America</span>
                        </div>
                        <span></span>
                        <div class="entity-coverage">
                          <div class="coverage-bar-xs"><div class="fill good" style="width: 100%;"></div></div>
                          <span style="font-size: 11px;">100%</span>
                        </div>
                        <div class="entity-status"><div class="status-dot has-data"></div></div>
                      </div>
                      <div class="detail-entity-row" data-entity="detroit-assembly">
                        <div class="entity-checkbox"><input type="checkbox" checked onclick="toggleDetailEntitySelect(this)"></div>
                        <div class="entity-info">
                          <span class="entity-name">Detroit Assembly Plant</span>
                          <span class="entity-code">US-DET-F01  Factory  North America</span>
                        </div>
                        <span></span>
                        <div class="entity-coverage">
                          <div class="coverage-bar-xs"><div class="fill good" style="width: 100%;"></div></div>
                          <span style="font-size: 11px;">100%</span>
                        </div>
                        <div class="entity-status"><div class="status-dot has-data"></div></div>
                      </div>
                      <div class="detail-entity-row" data-entity="monterrey-factory">
                        <div class="entity-checkbox"><input type="checkbox" checked onclick="toggleDetailEntitySelect(this)"></div>
                        <div class="entity-info">
                          <span class="entity-name">Monterrey Factory</span>
                          <span class="entity-code">MX-MTY-F01  Factory  Latin America</span>
                        </div>
                        <span></span>
                        <div class="entity-coverage">
                          <div class="coverage-bar-xs"><div class="fill good" style="width: 95%;"></div></div>
                          <span style="font-size: 11px;">95%</span>
                        </div>
                        <div class="entity-status"><div class="status-dot has-data"></div></div>
                      </div>
                      <div class="detail-entity-row excluded" data-entity="sao-paulo-plant">
                        <div class="entity-checkbox"><input type="checkbox" onclick="toggleDetailEntitySelect(this)"></div>
                        <div class="entity-info">
                          <span class="entity-name">So Paulo Plant</span>
                          <span class="entity-code">BR-SAO-F01  Factory  Latin America</span>
                        </div>
                        <span></span>
                        <div class="entity-coverage">
                          <div class="coverage-bar-xs"><div class="fill danger" style="width: 23%;"></div></div>
                          <span style="font-size: 11px;">23%</span>
                        </div>
                        <div class="entity-status"><div class="status-dot missing"></div></div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- EMEA Region -->
              <div class="detail-region-row" data-region="emea">
                <div class="detail-region-main" onclick="toggleDetailRegion(this)">
                  <div class="region-name-col">
                    <span class="region-toggle"><i class="fa-light fa-chevron-right"></i></span>
                    <span class="region-name">EMEA</span>
                    <span class="region-count">(489)</span>
                  </div>
                  <span class="region-activities">11</span>
                  <span class="region-records">7,230</span>
                  <span class="region-selected">487 / 489</span>
                  <div class="region-checkbox">
                    <input type="checkbox" checked onclick="event.stopPropagation(); toggleDetailRegionSelect(this)">
                  </div>
                </div>
                <div class="detail-region-children">
                  <div class="detail-type-row" data-type="offices">
                    <div class="detail-type-main" onclick="toggleDetailType(this)">
                      <div class="type-name-col">
                        <span class="type-toggle"><i class="fa-light fa-chevron-right"></i></span>
                        <span class="type-name">Offices</span>
                        <span class="type-count">(156)</span>
                      </div>
                      <span class="type-activities">7</span>
                      <span class="type-records">2,340</span>
                      <span class="type-selected">156 / 156</span>
                      <div class="type-checkbox">
                        <input type="checkbox" checked onclick="event.stopPropagation(); toggleDetailTypeSelect(this)">
                      </div>
                    </div>
                    <div class="detail-type-children"></div>
                  </div>
                  <div class="detail-type-row" data-type="warehouses">
                    <div class="detail-type-main" onclick="toggleDetailType(this)">
                      <div class="type-name-col">
                        <span class="type-toggle"><i class="fa-light fa-chevron-right"></i></span>
                        <span class="type-name">Warehouses</span>
                        <span class="type-count">(112)</span>
                      </div>
                      <span class="type-activities">5</span>
                      <span class="type-records">1,680</span>
                      <span class="type-selected">112 / 112</span>
                      <div class="type-checkbox">
                        <input type="checkbox" checked onclick="event.stopPropagation(); toggleDetailTypeSelect(this)">
                      </div>
                    </div>
                    <div class="detail-type-children"></div>
                  </div>
                  <div class="detail-type-row" data-type="factories">
                    <div class="detail-type-main" onclick="toggleDetailType(this)">
                      <div class="type-name-col">
                        <span class="type-toggle"><i class="fa-light fa-chevron-right"></i></span>
                        <span class="type-name">Factories</span>
                        <span class="type-count">(221)</span>
                      </div>
                      <span class="type-activities">9</span>
                      <span class="type-records">3,210</span>
                      <span class="type-selected">219 / 221</span>
                      <div class="type-checkbox">
                        <input type="checkbox" checked onclick="event.stopPropagation(); toggleDetailTypeSelect(this)">
                      </div>
                    </div>
                    <div class="detail-type-children"></div>
                  </div>
                </div>
              </div>

              <!-- APAC Region -->
              <div class="detail-region-row" data-region="apac">
                <div class="detail-region-main" onclick="toggleDetailRegion(this)">
                  <div class="region-name-col">
                    <span class="region-toggle"><i class="fa-light fa-chevron-right"></i></span>
                    <span class="region-name">APAC</span>
                    <span class="region-count">(224)</span>
                  </div>
                  <span class="region-activities">9</span>
                  <span class="region-records">5,120</span>
                  <span class="region-selected">220 / 224</span>
                  <div class="region-checkbox">
                    <input type="checkbox" checked onclick="event.stopPropagation(); toggleDetailRegionSelect(this)">
                  </div>
                </div>
                <div class="detail-region-children">
                  <div class="detail-type-row" data-type="offices">
                    <div class="detail-type-main" onclick="toggleDetailType(this)">
                      <div class="type-name-col">
                        <span class="type-toggle"><i class="fa-light fa-chevron-right"></i></span>
                        <span class="type-name">Offices</span>
                        <span class="type-count">(68)</span>
                      </div>
                      <span class="type-activities">6</span>
                      <span class="type-records">1,428</span>
                      <span class="type-selected">68 / 68</span>
                      <div class="type-checkbox">
                        <input type="checkbox" checked onclick="event.stopPropagation(); toggleDetailTypeSelect(this)">
                      </div>
                    </div>
                    <div class="detail-type-children"></div>
                  </div>
                  <div class="detail-type-row" data-type="warehouses">
                    <div class="detail-type-main" onclick="toggleDetailType(this)">
                      <div class="type-name-col">
                        <span class="type-toggle"><i class="fa-light fa-chevron-right"></i></span>
                        <span class="type-name">Warehouses</span>
                        <span class="type-count">(54)</span>
                      </div>
                      <span class="type-activities">4</span>
                      <span class="type-records">972</span>
                      <span class="type-selected">54 / 54</span>
                      <div class="type-checkbox">
                        <input type="checkbox" checked onclick="event.stopPropagation(); toggleDetailTypeSelect(this)">
                      </div>
                    </div>
                    <div class="detail-type-children"></div>
                  </div>
                  <div class="detail-type-row" data-type="factories">
                    <div class="detail-type-main" onclick="toggleDetailType(this)">
                      <div class="type-name-col">
                        <span class="type-toggle"><i class="fa-light fa-chevron-right"></i></span>
                        <span class="type-name">Factories</span>
                        <span class="type-count">(102)</span>
                      </div>
                      <span class="type-activities">7</span>
                      <span class="type-records">2,720</span>
                      <span class="type-selected">98 / 102</span>
                      <div class="type-checkbox">
                        <input type="checkbox" checked onclick="event.stopPropagation(); toggleDetailTypeSelect(this)">
                      </div>
                    </div>
                    <div class="detail-type-children"></div>
                  </div>
                </div>
              </div>

              <!-- Total Row -->
              <div class="org-detail-total">
                <div class="total-name-col">
                  <span class="total-label">Total</span>
                  <span class="total-count">(1,247)</span>
                </div>
                <span class="total-activities">32</span>
                <span class="total-records">20,770</span>
                <span class="total-selected">1,241 / 1,247</span>
                <div class="total-checkbox">
                  <input type="checkbox" checked onclick="toggleAllEntities(this)">
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Step 3: Operational Boundary - Unified View -->
        <div class="wizard-step-content operational-boundary-step" data-step="3">
          <!-- Summary Statistics -->
          <div class="op-coverage-strip">
            <div class="coverage-stat highlight">
              <span class="stat-value">94.2%</span>
              <span class="stat-label">Avg Data Coverage</span>
            </div>
            <div class="coverage-stat">
              <span class="stat-value">1,247</span>
              <span class="stat-label">Total Entities</span>
            </div>
            <div class="coverage-stat warning">
              <span class="stat-value">72</span>
              <span class="stat-label">With Gaps</span>
            </div>
            <div class="coverage-stat">
              <span class="stat-value">10,084</span>
              <span class="stat-label">Total Records</span>
            </div>
            <button class="btn btn-sm btn-ghost" onclick="openGapsModal()">
              <i class="fa-light fa-exclamation-triangle"></i> Review All Gaps
            </button>
          </div>

          <!-- View Toggle Controls -->
          <div class="op-view-controls">
            <div class="op-view-toggle">
              <button class="view-btn active" data-view="config" onclick="toggleOpView('config')">
                <i class="fa-light fa-sliders"></i>
                Activity Config
              </button>
              <button class="view-btn" data-view="matrix" onclick="toggleOpView('matrix')">
                <i class="fa-light fa-table-cells"></i>
                Entity Matrix
              </button>
            </div>
            <div class="filter-actions">
              <button class="btn-add-activity" onclick="openAddActivityModal()">
                <i class="fa-light fa-plus"></i>
                Add Activity
              </button>
            </div>
          </div>

          <!-- Activity Configuration View (Default) -->
          <div class="op-config-view active" id="op-config-view">
            <div class="activity-config-table">
              <!-- Header -->
              <div class="activity-config-header">
                <span class="col-checkbox"></span>
                <span class="col-activity">Activity</span>
                <span class="col-scope">Scope</span>
                <span class="col-method">Calc Method</span>
                <span class="col-entities">Entities</span>
                <span class="col-records">Records</span>
                <span class="col-status">Status</span>
                <span class="col-remove"></span>
              </div>

              <!-- Stationary Combustion -->
              <div class="activity-config-row" data-activity="stationary-combustion">
                <div class="activity-checkbox">
                  <input type="checkbox" checked onchange="toggleActivityConfig(this)">
                </div>
                <div class="activity-info">
                  <span class="activity-name">Stationary Combustion</span>
                  <span class="activity-type">Activity-Based</span>
                </div>
                <span class="scope-badge scope-1">S1</span>
                <select class="calc-method-select" onchange="updateActivityMethod(this)">
                  <option value="ra-standard" selected>RA+ Standard v2.1</option>
                  <option value="ghg-corporate">GHG Protocol v3.1</option>
                  <option value="iso-14064">ISO 14064-1 v2.0</option>
                </select>
                <span class="col-value">1,222</span>
                <span class="col-value">847</span>
                <span class="status-badge ready"><i class="fa-light fa-check"></i> Ready</span>
                <button class="btn-remove" onclick="removeActivityConfig('stationary-combustion')">
                  <i class="fa-light fa-times"></i>
                </button>
              </div>

              <!-- Mobile Combustion -->
              <div class="activity-config-row" data-activity="mobile-combustion">
                <div class="activity-checkbox">
                  <input type="checkbox" checked onchange="toggleActivityConfig(this)">
                </div>
                <div class="activity-info">
                  <span class="activity-name">Mobile Combustion</span>
                  <span class="activity-type">Activity-Based (Fuel)</span>
                </div>
                <span class="scope-badge scope-1">S1</span>
                <select class="calc-method-select" onchange="updateActivityMethod(this)">
                  <option value="ra-standard" selected>RA+ Standard v2.1</option>
                  <option value="ghg-corporate">GHG Protocol v3.1</option>
                  <option value="iso-14064">ISO 14064-1 v2.0</option>
                </select>
                <span class="col-value">1,197</span>
                <span class="col-value">1,234</span>
                <span class="status-badge ready"><i class="fa-light fa-check"></i> Ready</span>
                <button class="btn-remove" onclick="removeActivityConfig('mobile-combustion')">
                  <i class="fa-light fa-times"></i>
                </button>
              </div>

              <!-- Fugitive Emissions -->
              <div class="activity-config-row" data-activity="fugitive-emissions">
                <div class="activity-checkbox">
                  <input type="checkbox" checked onchange="toggleActivityConfig(this)">
                </div>
                <div class="activity-info">
                  <span class="activity-name">Fugitive Emissions</span>
                  <span class="activity-type">Activity-Based</span>
                </div>
                <span class="scope-badge scope-1">S1</span>
                <select class="calc-method-select" onchange="updateActivityMethod(this)">
                  <option value="ra-standard" selected>RA+ Standard v2.1</option>
                  <option value="ghg-corporate">GHG Protocol v3.1</option>
                  <option value="iso-14064">ISO 14064-1 v2.0</option>
                </select>
                <span class="col-value">561</span>
                <span class="col-value">156</span>
                <span class="status-badge needs-data"><i class="fa-light fa-triangle-exclamation"></i> Needs Data</span>
                <button class="btn-remove" onclick="removeActivityConfig('fugitive-emissions')">
                  <i class="fa-light fa-times"></i>
                </button>
              </div>

              <!-- Purchased Electricity -->
              <div class="activity-config-row" data-activity="purchased-electricity">
                <div class="activity-checkbox">
                  <input type="checkbox" checked onchange="toggleActivityConfig(this)">
                </div>
                <div class="activity-info">
                  <span class="activity-name">Purchased Electricity</span>
                  <span class="activity-type">Location-Based</span>
                </div>
                <span class="scope-badge scope-2">S2</span>
                <select class="calc-method-select" onchange="updateActivityMethod(this)">
                  <option value="ra-standard">RA+ Standard v2.1</option>
                  <option value="ghg-corporate" selected>GHG Protocol v3.1</option>
                  <option value="iso-14064">ISO 14064-1 v2.0</option>
                </select>
                <span class="col-value">1,189</span>
                <span class="col-value">2,156</span>
                <span class="status-badge issues"><i class="fa-light fa-exclamation"></i> Issues</span>
                <button class="btn-remove" onclick="removeActivityConfig('purchased-electricity')">
                  <i class="fa-light fa-times"></i>
                </button>
              </div>

              <!-- Purchased Steam -->
              <div class="activity-config-row" data-activity="purchased-steam">
                <div class="activity-checkbox">
                  <input type="checkbox" checked onchange="toggleActivityConfig(this)">
                </div>
                <div class="activity-info">
                  <span class="activity-name">Purchased Steam & Heat</span>
                  <span class="activity-type">Location-Based</span>
                </div>
                <span class="scope-badge scope-2">S2</span>
                <select class="calc-method-select" onchange="updateActivityMethod(this)">
                  <option value="ra-standard">RA+ Standard v2.1</option>
                  <option value="ghg-corporate" selected>GHG Protocol v3.1</option>
                  <option value="iso-14064">ISO 14064-1 v2.0</option>
                </select>
                <span class="col-value">847</span>
                <span class="col-value">423</span>
                <span class="status-badge ready"><i class="fa-light fa-check"></i> Ready</span>
                <button class="btn-remove" onclick="removeActivityConfig('purchased-steam')">
                  <i class="fa-light fa-times"></i>
                </button>
              </div>

              <!-- Business Travel -->
              <div class="activity-config-row" data-activity="business-travel">
                <div class="activity-checkbox">
                  <input type="checkbox" checked onchange="toggleActivityConfig(this)">
                </div>
                <div class="activity-info">
                  <span class="activity-name">Business Travel</span>
                  <span class="activity-type">Distance-Based</span>
                </div>
                <span class="scope-badge scope-3">S3</span>
                <select class="calc-method-select" onchange="updateActivityMethod(this)">
                  <option value="ra-standard" selected>RA+ Standard v2.1</option>
                  <option value="ghg-corporate">GHG Protocol v3.1</option>
                  <option value="spend-based">Spend-Based</option>
                </select>
                <span class="col-value">1,122</span>
                <span class="col-value">3,847</span>
                <span class="status-badge ready"><i class="fa-light fa-check"></i> Ready</span>
                <button class="btn-remove" onclick="removeActivityConfig('business-travel')">
                  <i class="fa-light fa-times"></i>
                </button>
              </div>

              <!-- Employee Commuting -->
              <div class="activity-config-row" data-activity="employee-commuting">
                <div class="activity-checkbox">
                  <input type="checkbox" checked onchange="toggleActivityConfig(this)">
                </div>
                <div class="activity-info">
                  <span class="activity-name">Employee Commuting</span>
                  <span class="activity-type">Survey-Based</span>
                </div>
                <span class="scope-badge scope-3">S3</span>
                <select class="calc-method-select" onchange="updateActivityMethod(this)">
                  <option value="ra-standard" selected>RA+ Standard v2.1</option>
                  <option value="ghg-corporate">GHG Protocol v3.1</option>
                  <option value="average-data">Average Data</option>
                </select>
                <span class="col-value">1,089</span>
                <span class="col-value">1,456</span>
                <span class="status-badge issues"><i class="fa-light fa-exclamation"></i> Issues</span>
                <button class="btn-remove" onclick="removeActivityConfig('employee-commuting')">
                  <i class="fa-light fa-times"></i>
                </button>
              </div>

              <!-- Purchased Goods -->
              <div class="activity-config-row excluded" data-activity="purchased-goods">
                <div class="activity-checkbox">
                  <input type="checkbox" onchange="toggleActivityConfig(this)">
                </div>
                <div class="activity-info">
                  <span class="activity-name">Purchased Goods & Services</span>
                  <span class="activity-type">Spend-Based (EEIO)</span>
                </div>
                <span class="scope-badge scope-3">S3</span>
                <select class="calc-method-select" onchange="updateActivityMethod(this)" disabled>
                  <option value="spend-based" selected>Spend-Based</option>
                  <option value="hybrid">Hybrid Method</option>
                </select>
                <span class="col-value">1,147</span>
                <span class="col-value">4,203</span>
                <span class="status-badge issues"><i class="fa-light fa-exclamation"></i> Issues</span>
                <button class="btn-remove" onclick="removeActivityConfig('purchased-goods')">
                  <i class="fa-light fa-times"></i>
                </button>
              </div>

              <!-- Waste Generated -->
              <div class="activity-config-row excluded" data-activity="waste-generated">
                <div class="activity-checkbox">
                  <input type="checkbox" onchange="toggleActivityConfig(this)">
                </div>
                <div class="activity-info">
                  <span class="activity-name">Waste Generated</span>
                  <span class="activity-type">Activity-Based (Waste)</span>
                </div>
                <span class="scope-badge scope-3">S3</span>
                <select class="calc-method-select" onchange="updateActivityMethod(this)" disabled>
                  <option value="ra-standard" selected>RA+ Standard v2.1</option>
                  <option value="ghg-corporate">GHG Protocol v3.1</option>
                </select>
                <span class="col-value">424</span>
                <span class="col-value">234</span>
                <span class="status-badge needs-data"><i class="fa-light fa-triangle-exclamation"></i> Needs Data</span>
                <button class="btn-remove" onclick="removeActivityConfig('waste-generated')">
                  <i class="fa-light fa-times"></i>
                </button>
              </div>
            </div>
          </div>

          <!-- Entity-Activity Matrix View -->
          <div class="op-matrix-view" id="op-matrix-view">
            <div class="entity-activity-matrix">
              <!-- Controls Bar -->
              <div class="matrix-controls">
                <div class="matrix-search">
                  <i class="fa-light fa-search"></i>
                  <input type="text" placeholder="Search entities..." oninput="filterMatrixEntities(this.value)">
                </div>
                <div class="matrix-filters">
                  <button class="matrix-filter-btn active" onclick="filterMatrixByType('all')">All</button>
                  <button class="matrix-filter-btn" onclick="filterMatrixByType('office')"><i class="fa-light fa-building"></i> Offices</button>
                  <button class="matrix-filter-btn" onclick="filterMatrixByType('warehouse')"><i class="fa-light fa-warehouse"></i> Warehouses</button>
                  <button class="matrix-filter-btn" onclick="filterMatrixByType('factory')"><i class="fa-light fa-industry"></i> Factories</button>
                </div>
              </div>

              <!-- Header - Activities as Columns -->
              <div class="matrix-header">
                <div class="col-checkbox">
                  <input type="checkbox" checked onclick="toggleAllMatrixRows(this)" title="Select all">
                </div>
                <span class="col-entity">Entity</span>
                <div class="activity-col">
                  <span class="activity-name">Stationary Combustion</span>
                  <span class="scope-badge scope-1">S1</span>
                </div>
                <div class="activity-col">
                  <span class="activity-name">Mobile Combustion</span>
                  <span class="scope-badge scope-1">S1</span>
                </div>
                <div class="activity-col">
                  <span class="activity-name">Purchased Electricity</span>
                  <span class="scope-badge scope-2">S2</span>
                </div>
                <div class="activity-col">
                  <span class="activity-name">Purchased Steam</span>
                  <span class="scope-badge scope-2">S2</span>
                </div>
                <div class="activity-col">
                  <span class="activity-name">Business Travel</span>
                  <span class="scope-badge scope-3">S3</span>
                </div>
                <div class="activity-col">
                  <span class="activity-name">Employee Commuting</span>
                  <span class="scope-badge scope-3">S3</span>
                </div>
              </div>

              <!-- Body - Entity Rows grouped by Region -->
              <div class="matrix-body">
                <!-- Americas Group -->
                <div class="matrix-group-header expanded" onclick="toggleMatrixGroup(this)">
                  <span class="group-toggle"><i class="fa-light fa-chevron-right"></i></span>
                  <div class="group-icon"><i class="fa-light fa-earth-americas"></i></div>
                  <div class="group-info">
                    <span class="group-name">Americas</span>
                    <span class="group-count">534 entities</span>
                  </div>
                  <div class="group-checkbox">
                    <input type="checkbox" checked onclick="event.stopPropagation(); toggleMatrixGroupSelect(this)">
                  </div>
                </div>
                <div class="matrix-group-rows expanded">
                  <div class="matrix-row" data-entity="us-hq-001" data-type="office">
                    <div class="row-checkbox"><input type="checkbox" checked></div>
                    <div class="entity-cell">
                      <span class="entity-name">US Headquarters - New York</span>
                      <span class="entity-meta">Office  New York, NY</span>
                    </div>
                    <div class="activity-cell"><input type="checkbox" checked></div>
                    <div class="activity-cell"><input type="checkbox" checked></div>
                    <div class="activity-cell"><input type="checkbox" checked></div>
                    <div class="activity-cell"><input type="checkbox" checked></div>
                    <div class="activity-cell"><input type="checkbox" checked></div>
                    <div class="activity-cell"><input type="checkbox" checked></div>
                  </div>
                  <div class="matrix-row" data-entity="us-factory-001" data-type="factory">
                    <div class="row-checkbox"><input type="checkbox" checked></div>
                    <div class="entity-cell">
                      <span class="entity-name">Detroit Manufacturing Plant</span>
                      <span class="entity-meta">Factory  Detroit, MI</span>
                    </div>
                    <div class="activity-cell"><input type="checkbox" checked></div>
                    <div class="activity-cell"><input type="checkbox" checked></div>
                    <div class="activity-cell"><input type="checkbox" checked></div>
                    <div class="activity-cell"><input type="checkbox" checked></div>
                    <div class="activity-cell"><input type="checkbox" checked></div>
                    <div class="activity-cell"><input type="checkbox" checked></div>
                  </div>
                  <div class="matrix-row" data-entity="us-warehouse-001" data-type="warehouse">
                    <div class="row-checkbox"><input type="checkbox" checked></div>
                    <div class="entity-cell">
                      <span class="entity-name">Chicago Distribution Center</span>
                      <span class="entity-meta">Warehouse  Chicago, IL</span>
                    </div>
                    <div class="activity-cell"><input type="checkbox" checked></div>
                    <div class="activity-cell"><input type="checkbox" checked></div>
                    <div class="activity-cell"><input type="checkbox" checked></div>
                    <div class="activity-cell na"><input type="checkbox" disabled></div>
                    <div class="activity-cell"><input type="checkbox" checked></div>
                    <div class="activity-cell"><input type="checkbox" checked></div>
                  </div>
                  <div class="matrix-row" data-entity="ca-office-001" data-type="office">
                    <div class="row-checkbox"><input type="checkbox" checked></div>
                    <div class="entity-cell">
                      <span class="entity-name">Toronto Regional Office</span>
                      <span class="entity-meta">Office  Toronto, ON</span>
                    </div>
                    <div class="activity-cell"><input type="checkbox" checked></div>
                    <div class="activity-cell"><input type="checkbox" checked></div>
                    <div class="activity-cell"><input type="checkbox" checked></div>
                    <div class="activity-cell"><input type="checkbox"></div>
                    <div class="activity-cell"><input type="checkbox" checked></div>
                    <div class="activity-cell"><input type="checkbox" checked></div>
                  </div>
                  <div class="matrix-row" data-entity="mx-factory-001" data-type="factory">
                    <div class="row-checkbox"><input type="checkbox" checked></div>
                    <div class="entity-cell">
                      <span class="entity-name">Monterrey Assembly Plant</span>
                      <span class="entity-meta">Factory  Monterrey, MX</span>
                    </div>
                    <div class="activity-cell"><input type="checkbox" checked></div>
                    <div class="activity-cell"><input type="checkbox" checked></div>
                    <div class="activity-cell"><input type="checkbox" checked></div>
                    <div class="activity-cell"><input type="checkbox" checked></div>
                    <div class="activity-cell"><input type="checkbox"></div>
                    <div class="activity-cell"><input type="checkbox"></div>
                  </div>
                </div>

                <!-- EMEA Group -->
                <div class="matrix-group-header" onclick="toggleMatrixGroup(this)">
                  <span class="group-toggle"><i class="fa-light fa-chevron-right"></i></span>
                  <div class="group-icon"><i class="fa-light fa-earth-europe"></i></div>
                  <div class="group-info">
                    <span class="group-name">EMEA</span>
                    <span class="group-count">489 entities</span>
                  </div>
                  <div class="group-checkbox">
                    <input type="checkbox" checked onclick="event.stopPropagation(); toggleMatrixGroupSelect(this)">
                  </div>
                </div>
                <div class="matrix-group-rows">
                  <div class="matrix-row" data-entity="uk-hq-001" data-type="office">
                    <div class="row-checkbox"><input type="checkbox" checked></div>
                    <div class="entity-cell">
                      <span class="entity-name">London Headquarters</span>
                      <span class="entity-meta">Office  London, UK</span>
                    </div>
                    <div class="activity-cell"><input type="checkbox" checked></div>
                    <div class="activity-cell"><input type="checkbox" checked></div>
                    <div class="activity-cell"><input type="checkbox" checked></div>
                    <div class="activity-cell"><input type="checkbox" checked></div>
                    <div class="activity-cell"><input type="checkbox" checked></div>
                    <div class="activity-cell"><input type="checkbox" checked></div>
                  </div>
                  <div class="matrix-row" data-entity="de-factory-001" data-type="factory">
                    <div class="row-checkbox"><input type="checkbox" checked></div>
                    <div class="entity-cell">
                      <span class="entity-name">Frankfurt Manufacturing</span>
                      <span class="entity-meta">Factory  Frankfurt, DE</span>
                    </div>
                    <div class="activity-cell"><input type="checkbox" checked></div>
                    <div class="activity-cell"><input type="checkbox" checked></div>
                    <div class="activity-cell"><input type="checkbox" checked></div>
                    <div class="activity-cell"><input type="checkbox" checked></div>
                    <div class="activity-cell"><input type="checkbox" checked></div>
                    <div class="activity-cell"><input type="checkbox" checked></div>
                  </div>
                  <div class="matrix-row" data-entity="fr-warehouse-001" data-type="warehouse">
                    <div class="row-checkbox"><input type="checkbox" checked></div>
                    <div class="entity-cell">
                      <span class="entity-name">Paris Distribution Hub</span>
                      <span class="entity-meta">Warehouse  Paris, FR</span>
                    </div>
                    <div class="activity-cell"><input type="checkbox" checked></div>
                    <div class="activity-cell"><input type="checkbox" checked></div>
                    <div class="activity-cell"><input type="checkbox" checked></div>
                    <div class="activity-cell na"><input type="checkbox" disabled></div>
                    <div class="activity-cell"><input type="checkbox" checked></div>
                    <div class="activity-cell"><input type="checkbox"></div>
                  </div>
                </div>

                <!-- APAC Group -->
                <div class="matrix-group-header" onclick="toggleMatrixGroup(this)">
                  <span class="group-toggle"><i class="fa-light fa-chevron-right"></i></span>
                  <div class="group-icon"><i class="fa-light fa-earth-asia"></i></div>
                  <div class="group-info">
                    <span class="group-name">APAC</span>
                    <span class="group-count">224 entities</span>
                  </div>
                  <div class="group-checkbox">
                    <input type="checkbox" checked onclick="event.stopPropagation(); toggleMatrixGroupSelect(this)">
                  </div>
                </div>
                <div class="matrix-group-rows">
                  <div class="matrix-row" data-entity="jp-hq-001" data-type="office">
                    <div class="row-checkbox"><input type="checkbox" checked></div>
                    <div class="entity-cell">
                      <span class="entity-name">Tokyo Regional HQ</span>
                      <span class="entity-meta">Office  Tokyo, JP</span>
                    </div>
                    <div class="activity-cell"><input type="checkbox" checked></div>
                    <div class="activity-cell"><input type="checkbox" checked></div>
                    <div class="activity-cell"><input type="checkbox" checked></div>
                    <div class="activity-cell"><input type="checkbox" checked></div>
                    <div class="activity-cell"><input type="checkbox" checked></div>
                    <div class="activity-cell"><input type="checkbox" checked></div>
                  </div>
                  <div class="matrix-row" data-entity="cn-factory-001" data-type="factory">
                    <div class="row-checkbox"><input type="checkbox" checked></div>
                    <div class="entity-cell">
                      <span class="entity-name">Shanghai Manufacturing</span>
                      <span class="entity-meta">Factory  Shanghai, CN</span>
                    </div>
                    <div class="activity-cell"><input type="checkbox" checked></div>
                    <div class="activity-cell"><input type="checkbox" checked></div>
                    <div class="activity-cell"><input type="checkbox" checked></div>
                    <div class="activity-cell"><input type="checkbox" checked></div>
                    <div class="activity-cell"><input type="checkbox"></div>
                    <div class="activity-cell"><input type="checkbox"></div>
                  </div>
                  <div class="matrix-row" data-entity="au-warehouse-001" data-type="warehouse">
                    <div class="row-checkbox"><input type="checkbox" checked></div>
                    <div class="entity-cell">
                      <span class="entity-name">Sydney Distribution Center</span>
                      <span class="entity-meta">Warehouse  Sydney, AU</span>
                    </div>
                    <div class="activity-cell"><input type="checkbox" checked></div>
                    <div class="activity-cell"><input type="checkbox" checked></div>
                    <div class="activity-cell"><input type="checkbox" checked></div>
                    <div class="activity-cell na"><input type="checkbox" disabled></div>
                    <div class="activity-cell"><input type="checkbox" checked></div>
                    <div class="activity-cell"><input type="checkbox" checked></div>
                  </div>
                </div>
              </div>

              <!-- Footer -->
              <div class="matrix-footer">
                <span class="showing-info">Showing 11 of 1,247 entities</span>
                <div class="pagination">
                  <button disabled><i class="fa-light fa-chevron-left"></i> Previous</button>
                  <span>Page 1 of 125</span>
                  <button>Next <i class="fa-light fa-chevron-right"></i></button>
                </div>
              </div>
            </div>
          </div>

          <!-- Matrix Drill-Down Panel -->
          <div class="matrix-drilldown-overlay" id="matrix-drilldown-overlay" onclick="closeMatrixDrilldown()"></div>
          <div class="matrix-drilldown-panel" id="matrix-drilldown-panel">
            <div class="drilldown-header">
              <div class="header-info">
                <span class="header-title" id="drilldown-title">Stationary Combustion  Americas</span>
                <span class="header-subtitle" id="drilldown-subtitle">529 of 534 entities selected</span>
              </div>
              <button class="btn-close" onclick="closeMatrixDrilldown()">
                <i class="fa-light fa-times"></i>
              </button>
            </div>
            <div class="drilldown-actions">
              <button class="btn-action" onclick="drilldownSelectAll()">Select All</button>
              <button class="btn-action" onclick="drilldownDeselectAll()">Deselect All</button>
            </div>
            <div class="drilldown-content">
              <!-- Offices Group -->
              <div class="drilldown-group expanded">
                <div class="drilldown-group-header" onclick="toggleDrilldownGroup(this)">
                  <div class="group-left">
                    <input type="checkbox" class="group-checkbox" checked onclick="event.stopPropagation(); toggleDrilldownGroupSelect(this)">
                    <span class="group-name">Offices</span>
                    <span class="group-count">127/127</span>
                  </div>
                  <i class="fa-light fa-chevron-right expand-icon"></i>
                </div>
                <div class="drilldown-entities">
                  <div class="drilldown-entity">
                    <input type="checkbox" class="entity-checkbox" checked>
                    <span class="entity-name">Boston HQ  Building A</span>
                    <span class="entity-code">US-BOS-001</span>
                  </div>
                  <div class="drilldown-entity">
                    <input type="checkbox" class="entity-checkbox" checked>
                    <span class="entity-name">Boston HQ  Building B</span>
                    <span class="entity-code">US-BOS-002</span>
                  </div>
                  <div class="drilldown-entity">
                    <input type="checkbox" class="entity-checkbox" checked>
                    <span class="entity-name">Denver Regional Office</span>
                    <span class="entity-code">US-DEN-001</span>
                  </div>
                  <div class="drilldown-entity">
                    <input type="checkbox" class="entity-checkbox" checked>
                    <span class="entity-name">Seattle Tech Campus</span>
                    <span class="entity-code">US-SEA-001</span>
                  </div>
                </div>
              </div>

              <!-- Warehouses Group -->
              <div class="drilldown-group">
                <div class="drilldown-group-header" onclick="toggleDrilldownGroup(this)">
                  <div class="group-left">
                    <input type="checkbox" class="group-checkbox" checked onclick="event.stopPropagation(); toggleDrilldownGroupSelect(this)">
                    <span class="group-name">Warehouses</span>
                    <span class="group-count">89/89</span>
                  </div>
                  <i class="fa-light fa-chevron-right expand-icon"></i>
                </div>
                <div class="drilldown-entities">
                  <div class="drilldown-entity">
                    <input type="checkbox" class="entity-checkbox" checked>
                    <span class="entity-name">Chicago Distribution Center</span>
                    <span class="entity-code">US-CHI-W01</span>
                  </div>
                  <div class="drilldown-entity">
                    <input type="checkbox" class="entity-checkbox" checked>
                    <span class="entity-name">Los Angeles Warehouse</span>
                    <span class="entity-code">US-LAX-W01</span>
                  </div>
                </div>
              </div>

              <!-- Factories Group -->
              <div class="drilldown-group">
                <div class="drilldown-group-header" onclick="toggleDrilldownGroup(this)">
                  <div class="group-left">
                    <input type="checkbox" class="group-checkbox" onclick="event.stopPropagation(); toggleDrilldownGroupSelect(this)">
                    <span class="group-name">Factories</span>
                    <span class="group-count partial">313/318</span>
                  </div>
                  <i class="fa-light fa-chevron-right expand-icon"></i>
                </div>
                <div class="drilldown-entities">
                  <div class="drilldown-entity">
                    <input type="checkbox" class="entity-checkbox" checked>
                    <span class="entity-name">Detroit Assembly Plant</span>
                    <span class="entity-code">US-DET-F01</span>
                  </div>
                  <div class="drilldown-entity">
                    <input type="checkbox" class="entity-checkbox">
                    <span class="entity-name">Houston Processing Facility</span>
                    <span class="entity-code">US-HOU-F01</span>
                  </div>
                  <div class="drilldown-entity">
                    <input type="checkbox" class="entity-checkbox" checked>
                    <span class="entity-name">Phoenix Manufacturing</span>
                    <span class="entity-code">US-PHX-F01</span>
                  </div>
                </div>
              </div>
            </div>
            <div class="drilldown-footer">
              <span class="selection-summary"><strong>529</strong> of <strong>534</strong> entities selected</span>
              <button class="btn-apply" onclick="applyDrilldownSelection()">Apply Changes</button>
            </div>
          </div>

          <!-- Selection Summary - Decoupled Architecture -->
          <div class="op-selection-summary">
            <div class="summary-left">
              <span class="selected-count"><strong>6,666</strong> entities  <strong>7</strong> activities = <strong>46,662</strong> combinations</span>
              <span class="scope-breakdown">
                <span class="scope-chip scope-1">2 Scope 1</span>
                <span class="scope-chip scope-2">2 Scope 2</span>
                <span class="scope-chip scope-3">3 Scope 3</span>
              </span>
            </div>
          </div>
        </div>


        <!-- Activity Detail Flyout -->
        <div class="activity-flyout" id="activity-flyout">
          <div class="flyout-backdrop" onclick="closeActivityFlyout()"></div>
          <div class="flyout-panel">
            <div class="flyout-header">
              <div class="flyout-title-group">
                <span class="flyout-scope-badge scope-1" id="flyout-scope">S1</span>
                <h3 class="flyout-title" id="flyout-title">Stationary Combustion</h3>
              </div>
              <button class="flyout-close" onclick="closeActivityFlyout()">
                <i class="fa-light fa-xmark"></i>
              </button>
            </div>
            
            <div class="flyout-body">
              <!-- Summary Stats -->
              <div class="flyout-stats">
                <div class="flyout-stat">
                  <span class="stat-value" id="flyout-entities">1,222</span>
                  <span class="stat-label">Entities with Data</span>
                </div>
                <div class="flyout-stat warning">
                  <span class="stat-value" id="flyout-gaps">25</span>
                  <span class="stat-label">Missing Data</span>
                </div>
                <div class="flyout-stat">
                  <span class="stat-value" id="flyout-records">847</span>
                  <span class="stat-label">Total Records</span>
                </div>
                <div class="flyout-stat highlight">
                  <span class="stat-value" id="flyout-coverage">98%</span>
                  <span class="stat-label">Data Coverage</span>
                </div>
              </div>

              <!-- Regional Breakdown -->
              <div class="flyout-section">
                <h4 class="flyout-section-title">Coverage by Region</h4>
                <div class="flyout-region-list">
                  <div class="flyout-region-row">
                    <div class="region-info">
                      <span class="region-name">Americas</span>
                      <span class="region-detail">529 of 534 entities</span>
                    </div>
                    <div class="region-bar">
                      <div class="region-fill" style="width: 99%"></div>
                    </div>
                    <span class="region-pct good">99%</span>
                  </div>
                  <div class="flyout-region-row">
                    <div class="region-info">
                      <span class="region-name">EMEA</span>
                      <span class="region-detail">474 of 489 entities</span>
                    </div>
                    <div class="region-bar">
                      <div class="region-fill" style="width: 97%"></div>
                    </div>
                    <span class="region-pct good">97%</span>
                  </div>
                  <div class="flyout-region-row">
                    <div class="region-info">
                      <span class="region-name">APAC</span>
                      <span class="region-detail">219 of 224 entities</span>
                    </div>
                    <div class="region-bar">
                      <div class="region-fill" style="width: 98%"></div>
                    </div>
                    <span class="region-pct good">98%</span>
                  </div>
                </div>
              </div>

              <!-- EF Mapping Details -->
              <div class="flyout-section">
                <h4 class="flyout-section-title">Emission Factor Mapping</h4>
                <div class="flyout-ef-table">
                  <div class="ef-row header">
                    <span>Region</span>
                    <span>EF Dataset</span>
                    <span>Entities</span>
                  </div>
                  <div class="ef-row">
                    <span>Americas</span>
                    <span class="ef-badge">EPA GHG Hub 2024</span>
                    <span>534</span>
                  </div>
                  <div class="ef-row">
                    <span>EMEA</span>
                    <span class="ef-badge">DEFRA 2024</span>
                    <span>489</span>
                  </div>
                  <div class="ef-row">
                    <span>APAC</span>
                    <span class="ef-badge">MOE Japan 2024</span>
                    <span>224</span>
                  </div>
                </div>
              </div>

              <!-- Missing Data Details -->
              <div class="flyout-section">
                <h4 class="flyout-section-title">Entities Missing Data <span class="count-badge">25</span></h4>
                <div class="flyout-missing-list">
                  <div class="missing-entity">
                    <span class="entity-name">Facility #127 - Detroit</span>
                    <span class="entity-region">Americas</span>
                  </div>
                  <div class="missing-entity">
                    <span class="entity-name">Warehouse - Birmingham</span>
                    <span class="entity-region">EMEA</span>
                  </div>
                  <div class="missing-entity">
                    <span class="entity-name">Office - Sydney CBD</span>
                    <span class="entity-region">APAC</span>
                  </div>
                  <div class="missing-entity">
                    <span class="entity-name">Distribution Center - Phoenix</span>
                    <span class="entity-region">Americas</span>
                  </div>
                  <div class="missing-entity">
                    <span class="entity-name">Manufacturing - Stuttgart</span>
                    <span class="entity-region">EMEA</span>
                  </div>
                </div>
                <button class="btn btn-sm btn-ghost flyout-more-btn">
                  View all 25 entities <i class="fa-light fa-arrow-right"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Step 4: Emission Factor Sets (Emission factor preferences) -->
        <div class="wizard-step-content" data-step="4">
          <div class="ef-prefs-header">
            <div>
              <h3>Emission factor preferences</h3>
              <p class="ef-prefs-desc">The system will find emission factors using the active sets in the order they are shown. The countries listed are where your entities are located.</p>
            </div>
            <button type="button" class="btn btn-secondary" onclick="revertEfPrefsToDefault()">Revert to default settings</button>
          </div>
          <div class="ef-prefs-category">
            <label class="form-label" style="margin: 0;">Category:</label>
            <select class="form-select" id="ef-prefs-category" onchange="switchEfPrefsCategory(this.value)">
              <option value="distance-based">Distance-based emissions</option>
              <option value="electric" selected>Electric power</option>
              <option value="stationary">Stationary combustion</option>
              <option value="fuels">Fuels</option>
              <option value="goods-services">Goods and services</option>
              <option value="heating-cooling">Purchased heating and cooling</option>
              <option value="refrigerants">Refrigerants and fugitive gases</option>
              <option value="spend-based">Spend-based activities</option>
              <option value="waste">Waste</option>
              <option value="well-to-tank">Well-to-tank and T&D loss factors</option>
            </select>
          </div>

          <!-- Content for Electric power (default) -->
          <div id="ef-prefs-content-electric" class="ef-prefs-category-content">
          <!-- 1. Vendors published -->
          <div class="ef-prefs-section">
            <div class="ef-prefs-section-header">
              <span class="ef-prefs-section-title">1. Vendors published</span>
              <a href="#" class="ef-prefs-section-link">Learn more about vendor published sets</a>
            </div>
            <table class="ef-prefs-table ef-prefs-table-vendors">
              <thead>
                <tr>
                  <th>Geography</th>
                  <th>Emission factor set</th>
                  <th>Coverage level</th>
                  <th>Use set for matching</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>Global</td>
                  <td>Vendor specific emission factors - Meets scope 2 criteria</td>
                  <td>Vendor</td>
                  <td><span class="ef-vendors-toggle-wrap" onmouseenter="efVendorsToggleWrapEnter(this)" onmouseleave="efVendorsToggleWrapLeave(this)"><label class="toggle-switch on" onclick="toggleEfSet(this, event)"><input type="checkbox" class="toggle-switch-input" checked><span class="toggle-switch-knob"></span></label><span class="ef-vendors-one-only-tooltip" role="tooltip">Only one of the options can be active at a time in this section.</span></span></td>
                </tr>
                <tr>
                  <td>Global</td>
                  <td>Vendor specific emission factors - All</td>
                  <td>Vendor</td>
                  <td><span class="ef-vendors-toggle-wrap" onmouseenter="efVendorsToggleWrapEnter(this)" onmouseleave="efVendorsToggleWrapLeave(this)"><label class="toggle-switch" onclick="toggleEfSet(this, event)"><input type="checkbox" class="toggle-switch-input"><span class="toggle-switch-knob"></span></label><span class="ef-vendors-one-only-tooltip" role="tooltip">Only one of the options can be active at a time in this section.</span></span></td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- 2. Residual Mixes -->
          <div class="ef-prefs-section">
            <div class="ef-prefs-section-header">
              <span class="ef-prefs-section-title">2. Residual Mixes</span>
            </div>
            <table class="ef-prefs-table">
              <thead>
                <tr>
                  <th>Geography</th>
                  <th>Emission factor set</th>
                  <th>Coverage level</th>
                  <th>Use set for matching</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>Europe</td>
                  <td>AIB EU REDISS</td>
                  <td>Country</td>
                  <td><label class="toggle-switch on" onclick="toggleEfSet(this, event)"><input type="checkbox" class="toggle-switch-input" checked><span class="toggle-switch-knob"></span></label></td>
                </tr>
                <tr>
                  <td>United States of America</td>
                  <td>eGRID US REDISS</td>
                  <td>eGRID subregion</td>
                  <td><label class="toggle-switch on" onclick="toggleEfSet(this, event)"><input type="checkbox" class="toggle-switch-input" checked><span class="toggle-switch-knob"></span></label></td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- 3. Country-published regional factors -->
          <div class="ef-prefs-section">
            <div class="ef-prefs-section-header">
              <span class="ef-prefs-section-title">3. Country-published regional factors</span>
            </div>
            <table class="ef-prefs-table">
              <thead>
                <tr>
                  <th>Geography</th>
                  <th>Emission factor set</th>
                  <th>Coverage level</th>
                  <th>Use set for matching</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>Argentina</td>
                  <td>Argentina - CAMMESA</td>
                  <td>Country</td>
                  <td><label class="toggle-switch" onclick="toggleEfSet(this, event)"><input type="checkbox" class="toggle-switch-input"><span class="toggle-switch-knob"></span></label></td>
                </tr>
                <tr>
                  <td>Australia</td>
                  <td>Australian Government National Greenhouse Account Factors (NGER &amp; NGA)</td>
                  <td>State and country</td>
                  <td><label class="toggle-switch on" onclick="toggleEfSet(this, event)"><input type="checkbox" class="toggle-switch-input" checked><span class="toggle-switch-knob"></span></label></td>
                </tr>
                <tr>
                  <td>Brazil</td>
                  <td>Brazilian GHG Protocol</td>
                  <td>Country</td>
                  <td><label class="toggle-switch on" onclick="toggleEfSet(this, event)"><input type="checkbox" class="toggle-switch-input" checked><span class="toggle-switch-knob"></span></label></td>
                </tr>
                <tr>
                  <td>Canada</td>
                  <td>Environment Canada</td>
                  <td>Province and country</td>
                  <td><label class="toggle-switch on" onclick="toggleEfSet(this, event)"><input type="checkbox" class="toggle-switch-input" checked><span class="toggle-switch-knob"></span></label></td>
                </tr>
                <tr>
                  <td>Chile</td>
                  <td>Chile - Ministry of Energy</td>
                  <td>Country</td>
                  <td><label class="toggle-switch on" onclick="toggleEfSet(this, event)"><input type="checkbox" class="toggle-switch-input" checked><span class="toggle-switch-knob"></span></label></td>
                </tr>
                <tr>
                  <td>Colombia</td>
                  <td>Colombia - IDEAM</td>
                  <td>Country</td>
                  <td><label class="toggle-switch on" onclick="toggleEfSet(this, event)"><input type="checkbox" class="toggle-switch-input" checked><span class="toggle-switch-knob"></span></label></td>
                </tr>
                <tr>
                  <td>Costa Rica</td>
                  <td>Costa Rica - MINAE</td>
                  <td>Country</td>
                  <td><label class="toggle-switch on" onclick="toggleEfSet(this, event)"><input type="checkbox" class="toggle-switch-input" checked><span class="toggle-switch-knob"></span></label></td>
                </tr>
                <tr>
                  <td>Ecuador</td>
                  <td>Ecuador - MAE</td>
                  <td>Country</td>
                  <td><label class="toggle-switch on" onclick="toggleEfSet(this, event)"><input type="checkbox" class="toggle-switch-input" checked><span class="toggle-switch-knob"></span></label></td>
                </tr>
                <tr>
                  <td>France</td>
                  <td>France - Base Carbone (ADEME)</td>
                  <td>Country</td>
                  <td><label class="toggle-switch on" onclick="toggleEfSet(this, event)"><input type="checkbox" class="toggle-switch-input" checked><span class="toggle-switch-knob"></span></label></td>
                </tr>
                <tr>
                  <td>Hong Kong</td>
                  <td>Hong Kong - EMSD</td>
                  <td>Country</td>
                  <td><label class="toggle-switch on" onclick="toggleEfSet(this, event)"><input type="checkbox" class="toggle-switch-input" checked><span class="toggle-switch-knob"></span></label></td>
                </tr>
                <tr>
                  <td>India</td>
                  <td>India - Central Electricity Authority</td>
                  <td>Grid region and country</td>
                  <td><label class="toggle-switch on" onclick="toggleEfSet(this, event)"><input type="checkbox" class="toggle-switch-input" checked><span class="toggle-switch-knob"></span></label></td>
                </tr>
                <tr>
                  <td>Macau</td>
                  <td>Macau - DSEC</td>
                  <td>Country</td>
                  <td><label class="toggle-switch on" onclick="toggleEfSet(this, event)"><input type="checkbox" class="toggle-switch-input" checked><span class="toggle-switch-knob"></span></label></td>
                </tr>
                <tr>
                  <td>Malaysia</td>
                  <td>Malaysia - SEDA</td>
                  <td>Country</td>
                  <td><label class="toggle-switch on" onclick="toggleEfSet(this, event)"><input type="checkbox" class="toggle-switch-input" checked><span class="toggle-switch-knob"></span></label></td>
                </tr>
                <tr>
                  <td>Mexico</td>
                  <td>Mexico - SEMARNAT</td>
                  <td>Country</td>
                  <td><label class="toggle-switch on" onclick="toggleEfSet(this, event)"><input type="checkbox" class="toggle-switch-input" checked><span class="toggle-switch-knob"></span></label></td>
                </tr>
                <tr>
                  <td>New Zealand</td>
                  <td>New Zealand - Ministry for the Environment</td>
                  <td>Country</td>
                  <td><label class="toggle-switch on" onclick="toggleEfSet(this, event)"><input type="checkbox" class="toggle-switch-input" checked><span class="toggle-switch-knob"></span></label></td>
                </tr>
                <tr>
                  <td>Panama</td>
                  <td>Panama - MiAmbiente</td>
                  <td>Country</td>
                  <td><label class="toggle-switch on" onclick="toggleEfSet(this, event)"><input type="checkbox" class="toggle-switch-input" checked><span class="toggle-switch-knob"></span></label></td>
                </tr>
                <tr>
                  <td>Republic of China</td>
                  <td>Republic of China - EPA</td>
                  <td>Country</td>
                  <td><label class="toggle-switch on" onclick="toggleEfSet(this, event)"><input type="checkbox" class="toggle-switch-input" checked><span class="toggle-switch-knob"></span></label></td>
                </tr>
                <tr>
                  <td>Singapore</td>
                  <td>Singapore - NEA</td>
                  <td>Country</td>
                  <td><label class="toggle-switch on" onclick="toggleEfSet(this, event)"><input type="checkbox" class="toggle-switch-input" checked><span class="toggle-switch-knob"></span></label></td>
                </tr>
                <tr>
                  <td>Spain</td>
                  <td>Spain - MITECO</td>
                  <td>Country</td>
                  <td><label class="toggle-switch on" onclick="toggleEfSet(this, event)"><input type="checkbox" class="toggle-switch-input" checked><span class="toggle-switch-knob"></span></label></td>
                </tr>
                <tr>
                  <td>Taiwan</td>
                  <td>Taiwan - Bureau of Energy</td>
                  <td>Country</td>
                  <td><label class="toggle-switch on" onclick="toggleEfSet(this, event)"><input type="checkbox" class="toggle-switch-input" checked><span class="toggle-switch-knob"></span></label></td>
                </tr>
                <tr>
                  <td>United Arab Emirates</td>
                  <td>UAE - Ministry of Energy</td>
                  <td>Country</td>
                  <td><label class="toggle-switch on" onclick="toggleEfSet(this, event)"><input type="checkbox" class="toggle-switch-input" checked><span class="toggle-switch-knob"></span></label></td>
                </tr>
                <tr>
                  <td>United Kingdom</td>
                  <td>UK - BEIS/DEFRA</td>
                  <td>Country</td>
                  <td><label class="toggle-switch on" onclick="toggleEfSet(this, event)"><input type="checkbox" class="toggle-switch-input" checked><span class="toggle-switch-knob"></span></label></td>
                </tr>
                <tr>
                  <td>United States of America</td>
                  <td>eGRID</td>
                  <td>eGRID subregion, state and country</td>
                  <td><label class="toggle-switch on" onclick="toggleEfSet(this, event)"><input type="checkbox" class="toggle-switch-input" checked><span class="toggle-switch-knob"></span></label></td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- 4. Published by international groups -->
          <div class="ef-prefs-section">
            <div class="ef-prefs-section-header">
              <span class="ef-prefs-section-title">4. Published by international groups</span>
            </div>
            <table class="ef-prefs-table">
              <thead>
                <tr>
                  <th>Geography</th>
                  <th>Emission factor set</th>
                  <th>Coverage level</th>
                  <th>Use set for matching</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>Europe</td>
                  <td>European Environment Agency (EEA)</td>
                  <td>Country</td>
                  <td><label class="toggle-switch on" onclick="toggleEfSet(this, event)"><input type="checkbox" class="toggle-switch-input" checked><span class="toggle-switch-knob"></span></label></td>
                </tr>
                <tr>
                  <td>Global</td>
                  <td>IEA</td>
                  <td>Country, region and world</td>
                  <td><label class="toggle-switch on" onclick="toggleEfSet(this, event)"><input type="checkbox" class="toggle-switch-input" checked><span class="toggle-switch-knob"></span></label></td>
                </tr>
              </tbody>
            </table>
          </div>
          </div>
          <!-- /ef-prefs-content-electric -->

          <!-- Content for Stationary combustion -->
          <div id="ef-prefs-content-stationary" class="ef-prefs-category-content" style="display: none;">
            <div class="ef-prefs-section">
              <div class="ef-prefs-section-header">
                <span class="ef-prefs-section-title">Country-published regional factors</span>
              </div>
              <div class="ef-prefs-grid" id="ef-prefs-country-grid">
                <div class="ef-prefs-grid-row ef-prefs-grid-header">
                  <div class="ef-prefs-grid-cell">Geography</div>
                  <div class="ef-prefs-grid-cell">Emission factor set</div>
                  <div class="ef-prefs-grid-cell">Coverage level</div>
                  <div class="ef-prefs-grid-cell">Use set for matching</div>
                </div>
                <div class="ef-prefs-grid-body" id="ef-prefs-grid-body">
                  <div class="ef-prefs-grid-row" data-geography="Australia">
                    <div class="ef-prefs-grid-cell">Australia</div>
                    <div class="ef-prefs-grid-cell ef-prefs-grid-cell-draggable" draggable="true"><div class="ef-ef-set-cell"><span class="ef-drag-handle"><i class="fa-solid fa-grip-vertical"></i></span><span class="ef-ef-set-name">Australian Government National Greenhouse Account Factors (NGER &amp; NGA)</span></div></div>
                    <div class="ef-prefs-grid-cell">State and country</div>
                    <div class="ef-prefs-grid-cell"><label class="toggle-switch on" onclick="toggleEfSet(this, event)"><input type="checkbox" class="toggle-switch-input" checked><span class="toggle-switch-knob"></span></label></div>
                  </div>
                  <div class="ef-prefs-grid-row" data-geography="Brazil">
                    <div class="ef-prefs-grid-cell">Brazil</div>
                    <div class="ef-prefs-grid-cell ef-prefs-grid-cell-draggable" draggable="true"><div class="ef-ef-set-cell"><span class="ef-drag-handle"><i class="fa-solid fa-grip-vertical"></i></span><span class="ef-ef-set-name">Brazilian GHG Protocol</span></div></div>
                    <div class="ef-prefs-grid-cell">Country</div>
                    <div class="ef-prefs-grid-cell"><label class="toggle-switch on" onclick="toggleEfSet(this, event)"><input type="checkbox" class="toggle-switch-input" checked><span class="toggle-switch-knob"></span></label></div>
                  </div>
                  <div class="ef-prefs-grid-row" data-geography="Canada">
                    <div class="ef-prefs-grid-cell">Canada</div>
                    <div class="ef-prefs-grid-cell ef-prefs-grid-cell-draggable" draggable="true"><div class="ef-ef-set-cell"><span class="ef-drag-handle"><i class="fa-solid fa-grip-vertical"></i></span><span class="ef-ef-set-name">Environment Canada</span></div></div>
                    <div class="ef-prefs-grid-cell">Country</div>
                    <div class="ef-prefs-grid-cell"><label class="toggle-switch on" onclick="toggleEfSet(this, event)"><input type="checkbox" class="toggle-switch-input" checked><span class="toggle-switch-knob"></span></label></div>
                  </div>
                  <div class="ef-prefs-grid-row" data-geography="Canada">
                    <div class="ef-prefs-grid-cell ef-geo-merged"></div>
                    <div class="ef-prefs-grid-cell ef-prefs-grid-cell-draggable" draggable="true"><div class="ef-ef-set-cell"><span class="ef-drag-handle"><i class="fa-solid fa-grip-vertical"></i></span><span class="ef-ef-set-name">Example Factor Set for Canada</span></div></div>
                    <div class="ef-prefs-grid-cell">Country</div>
                    <div class="ef-prefs-grid-cell"><label class="toggle-switch" onclick="toggleEfSet(this, event)"><input type="checkbox" class="toggle-switch-input"><span class="toggle-switch-knob"></span></label></div>
                  </div>
                  <div class="ef-prefs-grid-row" data-geography="Costa Rica">
                    <div class="ef-prefs-grid-cell">Costa Rica</div>
                    <div class="ef-prefs-grid-cell ef-prefs-grid-cell-draggable" draggable="true"><div class="ef-ef-set-cell"><span class="ef-drag-handle"><i class="fa-solid fa-grip-vertical"></i></span><span class="ef-ef-set-name">Costa Rica - Meteorological National Institute (IMN)</span></div></div>
                    <div class="ef-prefs-grid-cell">Country</div>
                    <div class="ef-prefs-grid-cell"><label class="toggle-switch on" onclick="toggleEfSet(this, event)"><input type="checkbox" class="toggle-switch-input" checked><span class="toggle-switch-knob"></span></label></div>
                  </div>
                  <div class="ef-prefs-grid-row" data-geography="France">
                    <div class="ef-prefs-grid-cell">France</div>
                    <div class="ef-prefs-grid-cell ef-prefs-grid-cell-draggable" draggable="true"><div class="ef-ef-set-cell"><span class="ef-drag-handle"><i class="fa-solid fa-grip-vertical"></i></span><span class="ef-ef-set-name">Base Carbone</span></div></div>
                    <div class="ef-prefs-grid-cell">Country</div>
                    <div class="ef-prefs-grid-cell"><label class="toggle-switch on" onclick="toggleEfSet(this, event)"><input type="checkbox" class="toggle-switch-input" checked><span class="toggle-switch-knob"></span></label></div>
                  </div>
                  <div class="ef-prefs-grid-row" data-geography="Mexico">
                    <div class="ef-prefs-grid-cell">Mexico</div>
                    <div class="ef-prefs-grid-cell ef-prefs-grid-cell-draggable" draggable="true"><div class="ef-ef-set-cell"><span class="ef-drag-handle"><i class="fa-solid fa-grip-vertical"></i></span><span class="ef-ef-set-name">Mxico - Secretariat of Natural Resources and Environment (SEMARNAT)</span></div></div>
                    <div class="ef-prefs-grid-cell">Country</div>
                    <div class="ef-prefs-grid-cell"><label class="toggle-switch" onclick="toggleEfSet(this, event)"><input type="checkbox" class="toggle-switch-input"><span class="toggle-switch-knob"></span></label></div>
                  </div>
                  <div class="ef-prefs-grid-row" data-geography="New Zealand">
                    <div class="ef-prefs-grid-cell">New Zealand</div>
                    <div class="ef-prefs-grid-cell ef-prefs-grid-cell-draggable" draggable="true"><div class="ef-ef-set-cell"><span class="ef-drag-handle"><i class="fa-solid fa-grip-vertical"></i></span><span class="ef-ef-set-name">New Zealand Ministry for the Environment. Measurement Emissions: A Guide for Organisations</span></div></div>
                    <div class="ef-prefs-grid-cell">Country</div>
                    <div class="ef-prefs-grid-cell"><label class="toggle-switch on" onclick="toggleEfSet(this, event)"><input type="checkbox" class="toggle-switch-input" checked><span class="toggle-switch-knob"></span></label></div>
                  </div>
                  <div class="ef-prefs-grid-row" data-geography="Panama">
                    <div class="ef-prefs-grid-cell">Panama</div>
                    <div class="ef-prefs-grid-cell ef-prefs-grid-cell-draggable" draggable="true"><div class="ef-ef-set-cell"><span class="ef-drag-handle"><i class="fa-solid fa-grip-vertical"></i></span><span class="ef-ef-set-name">Panama - Reduce your Footprint Program</span></div></div>
                    <div class="ef-prefs-grid-cell">Country</div>
                    <div class="ef-prefs-grid-cell"><label class="toggle-switch on" onclick="toggleEfSet(this, event)"><input type="checkbox" class="toggle-switch-input" checked><span class="toggle-switch-knob"></span></label></div>
                  </div>
                  <div class="ef-prefs-grid-row" data-geography="United Kingdom">
                    <div class="ef-prefs-grid-cell">United Kingdom</div>
                    <div class="ef-prefs-grid-cell ef-prefs-grid-cell-draggable" draggable="true"><div class="ef-ef-set-cell"><span class="ef-drag-handle"><i class="fa-solid fa-grip-vertical"></i></span><span class="ef-ef-set-name">DEFRA</span></div></div>
                    <div class="ef-prefs-grid-cell">Country</div>
                    <div class="ef-prefs-grid-cell"><label class="toggle-switch on" onclick="toggleEfSet(this, event)"><input type="checkbox" class="toggle-switch-input" checked><span class="toggle-switch-knob"></span></label></div>
                  </div>
                  <div class="ef-prefs-grid-row" data-geography="United States of America">
                    <div class="ef-prefs-grid-cell">United States of America</div>
                    <div class="ef-prefs-grid-cell ef-prefs-grid-cell-draggable" draggable="true"><div class="ef-ef-set-cell"><span class="ef-drag-handle"><i class="fa-solid fa-grip-vertical"></i></span><span class="ef-ef-set-name">EPA EF Hub</span></div></div>
                    <div class="ef-prefs-grid-cell">Country</div>
                    <div class="ef-prefs-grid-cell"><label class="toggle-switch on" onclick="toggleEfSet(this, event)"><input type="checkbox" class="toggle-switch-input" checked><span class="toggle-switch-knob"></span></label></div>
                  </div>
                  <div class="ef-prefs-grid-row" data-geography="United States of America">
                    <div class="ef-prefs-grid-cell ef-geo-merged"></div>
                    <div class="ef-prefs-grid-cell ef-prefs-grid-cell-draggable" draggable="true"><div class="ef-ef-set-cell"><span class="ef-drag-handle"><i class="fa-solid fa-grip-vertical"></i></span><span class="ef-ef-set-name">The Climate Registry</span></div></div>
                    <div class="ef-prefs-grid-cell">Country</div>
                    <div class="ef-prefs-grid-cell"><label class="toggle-switch on" onclick="toggleEfSet(this, event)"><input type="checkbox" class="toggle-switch-input" checked><span class="toggle-switch-knob"></span></label></div>
                  </div>
                  <div class="ef-prefs-grid-row" data-geography="United States of America">
                    <div class="ef-prefs-grid-cell ef-geo-merged"></div>
                    <div class="ef-prefs-grid-cell ef-prefs-grid-cell-draggable" draggable="true"><div class="ef-ef-set-cell"><span class="ef-drag-handle"><i class="fa-solid fa-grip-vertical"></i></span><span class="ef-ef-set-name">EPA MRR</span></div></div>
                    <div class="ef-prefs-grid-cell">Country</div>
                    <div class="ef-prefs-grid-cell"><label class="toggle-switch on" onclick="toggleEfSet(this, event)"><input type="checkbox" class="toggle-switch-input" checked><span class="toggle-switch-knob"></span></label></div>
                  </div>
                </div>
              </div>
            </div>
            <div class="ef-prefs-section">
              <div class="ef-prefs-section-header">
                <span class="ef-prefs-section-title">Published by international groups</span>
              </div>
              <table class="ef-prefs-table">
                <thead>
                  <tr>
                    <th>Geography</th>
                    <th>Emission factor set</th>
                    <th>Coverage level</th>
                    <th>Use set for matching</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>Global</td>
                    <td>IEA</td>
                    <td>Country</td>
                    <td><label class="toggle-switch on" onclick="toggleEfSet(this, event)"><input type="checkbox" class="toggle-switch-input" checked><span class="toggle-switch-knob"></span></label></td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="ef-prefs-section">
              <div class="ef-prefs-section-header">
                <span class="ef-prefs-section-title">Non-regional fallback</span>
              </div>
              <div class="form-group" style="max-width: 480px;">
                <label class="form-label">Fallback emission factor set</label>
                <select class="form-select" id="ef-fallback-stationary">
                  <option value="ipcc" selected>Intergovernmental Panel on Climate Change (IPCC)</option>
                  <option value="iea">IEA</option>
                  <option value="defra">DEFRA</option>
                </select>
              </div>
            </div>
          </div>
          <!-- /ef-prefs-content-stationary -->

        </div>
        
        <!-- Step 5: Review -->
        <div class="wizard-step-content" data-step="5">
          <h3>Review & Confirm</h3>
          <p style="color: var(--ghg-text-muted); font-size: 13px; margin-bottom: 20px;">
            Review your inventory configuration before creating.
          </p>
          
          <div class="review-section">
            <div class="review-section-title">Inventory Details</div>
            <div class="review-card">
              <div class="review-grid">
                <div class="review-item">
                  <span class="review-item-label">Inventory Name</span>
                  <span class="review-item-value" id="review-inventory-name">Q4 2025 Corporate Inventory</span>
                </div>
                <div class="review-item">
                  <span class="review-item-label">Framework</span>
                  <span class="review-item-value" id="review-framework">GHG Protocol Corporate Standard</span>
                </div>
                <div class="review-item">
                  <span class="review-item-label">Consolidation Approach</span>
                  <span class="review-item-value" id="review-consolidation">Financial Control</span>
                </div>
                <div class="review-item">
                  <span class="review-item-label">GWP Version</span>
                  <span class="review-item-value" id="review-gwp">AR5 100-year GWP (IPCC 2014)</span>
                </div>
                <div class="review-item">
                  <span class="review-item-label">Gases Covered</span>
                  <span class="review-item-value" id="review-gases">Kyoto 7 GHGs (CO, CH, NO, HFCs, PFCs, SF, NF)</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Organizational Boundary Summary -->
          <div class="review-section">
            <div class="review-section-title">Organizational Boundary</div>
            <div class="review-card">
              <div style="display: flex; gap: 32px; flex-wrap: wrap;">
                <div style="text-align: center; padding: 12px 24px; background: var(--ghg-surface-elevated); border-radius: 8px;">
                  <div style="font-size: 32px; font-weight: 700; color: var(--ghg-primary);">1,241</div>
                  <div style="font-size: 12px; color: var(--ghg-text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Entities Selected</div>
                </div>
                <div style="flex: 1; display: flex; flex-direction: column; gap: 8px; min-width: 280px;">
                  <div style="display: flex; align-items: center; gap: 12px; padding: 8px 12px; background: var(--ghg-surface-elevated); border-radius: 6px;">
                    <i class="fa-light fa-earth-americas" style="color: var(--ghg-primary);"></i>
                    <span style="font-weight: 500; flex: 1;">Americas</span>
                    <span style="font-size: 13px; color: var(--ghg-text-muted);">534 entities</span>
                  </div>
                  <div style="display: flex; align-items: center; gap: 12px; padding: 8px 12px; background: var(--ghg-surface-elevated); border-radius: 6px;">
                    <i class="fa-light fa-earth-europe" style="color: var(--ghg-info);"></i>
                    <span style="font-weight: 500; flex: 1;">EMEA</span>
                    <span style="font-size: 13px; color: var(--ghg-text-muted);">489 entities</span>
                  </div>
                  <div style="display: flex; align-items: center; gap: 12px; padding: 8px 12px; background: var(--ghg-surface-elevated); border-radius: 6px;">
                    <i class="fa-light fa-earth-asia" style="color: var(--ghg-success);"></i>
                    <span style="font-weight: 500; flex: 1;">APAC</span>
                    <span style="font-size: 13px; color: var(--ghg-text-muted);">224 entities</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="review-section">
            <div class="review-section-title">Operational Boundary - Activities & Calculation Methods</div>
            <div class="review-card" style="padding: 0;">
              <table style="width: 100%; font-size: 13px; border-collapse: collapse;">
                <thead>
                  <tr style="background: var(--ghg-surface-elevated);">
                    <th style="text-align: left; padding: 12px; font-weight: 600; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--ghg-text-muted);">Activity</th>
                    <th style="text-align: left; padding: 12px; font-weight: 600; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--ghg-text-muted);">Scope</th>
                    <th style="text-align: left; padding: 12px; font-weight: 600; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--ghg-text-muted);">Calc Method</th>
                    <th style="text-align: right; padding: 12px; font-weight: 600; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--ghg-text-muted);">Entities</th>
                    <th style="text-align: right; padding: 12px; font-weight: 600; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--ghg-text-muted);">Records</th>
                    <th style="text-align: center; padding: 12px; font-weight: 600; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--ghg-text-muted);">Status</th>
                  </tr>
                </thead>
                <tbody>
                  <tr style="border-top: 1px solid var(--ghg-border);">
                    <td style="padding: 12px; font-weight: 500;">Stationary Combustion</td>
                    <td style="padding: 12px;"><span class="badge badge-scope-1" style="font-size: 10px;">S1</span></td>
                    <td style="padding: 12px;"><span style="background: var(--ghg-surface-elevated); padding: 4px 10px; border-radius: 4px; font-size: 12px;">RA+ Standard v2.1</span></td>
                    <td style="padding: 12px; text-align: right;">1,222</td>
                    <td style="padding: 12px; text-align: right;">847</td>
                    <td style="padding: 12px; text-align: center;"><span style="color: #15803D;"><i class="fa-light fa-check-circle"></i></span></td>
                  </tr>
                  <tr style="border-top: 1px solid var(--ghg-border);">
                    <td style="padding: 12px; font-weight: 500;">Mobile Combustion</td>
                    <td style="padding: 12px;"><span class="badge badge-scope-1" style="font-size: 10px;">S1</span></td>
                    <td style="padding: 12px;"><span style="background: var(--ghg-surface-elevated); padding: 4px 10px; border-radius: 4px; font-size: 12px;">RA+ Standard v2.1</span></td>
                    <td style="padding: 12px; text-align: right;">1,197</td>
                    <td style="padding: 12px; text-align: right;">1,234</td>
                    <td style="padding: 12px; text-align: center;"><span style="color: #15803D;"><i class="fa-light fa-check-circle"></i></span></td>
                  </tr>
                  <tr style="border-top: 1px solid var(--ghg-border);">
                    <td style="padding: 12px; font-weight: 500;">Fugitive Emissions</td>
                    <td style="padding: 12px;"><span class="badge badge-scope-1" style="font-size: 10px;">S1</span></td>
                    <td style="padding: 12px;"><span style="background: var(--ghg-surface-elevated); padding: 4px 10px; border-radius: 4px; font-size: 12px;">RA+ Standard v2.1</span></td>
                    <td style="padding: 12px; text-align: right;">561</td>
                    <td style="padding: 12px; text-align: right;">156</td>
                    <td style="padding: 12px; text-align: center;"><span style="color: #DC2626;"><i class="fa-light fa-triangle-exclamation"></i></span></td>
                  </tr>
                  <tr style="border-top: 1px solid var(--ghg-border);">
                    <td style="padding: 12px; font-weight: 500;">Purchased Electricity</td>
                    <td style="padding: 12px;"><span class="badge badge-scope-2" style="font-size: 10px;">S2</span></td>
                    <td style="padding: 12px;"><span style="background: var(--ghg-surface-elevated); padding: 4px 10px; border-radius: 4px; font-size: 12px;">GHG Protocol v3.1</span></td>
                    <td style="padding: 12px; text-align: right;">1,189</td>
                    <td style="padding: 12px; text-align: right;">2,156</td>
                    <td style="padding: 12px; text-align: center;"><span style="color: #B45309;"><i class="fa-light fa-exclamation-circle"></i></span></td>
                  </tr>
                  <tr style="border-top: 1px solid var(--ghg-border);">
                    <td style="padding: 12px; font-weight: 500;">Purchased Steam & Heat</td>
                    <td style="padding: 12px;"><span class="badge badge-scope-2" style="font-size: 10px;">S2</span></td>
                    <td style="padding: 12px;"><span style="background: var(--ghg-surface-elevated); padding: 4px 10px; border-radius: 4px; font-size: 12px;">GHG Protocol v3.1</span></td>
                    <td style="padding: 12px; text-align: right;">847</td>
                    <td style="padding: 12px; text-align: right;">423</td>
                    <td style="padding: 12px; text-align: center;"><span style="color: #15803D;"><i class="fa-light fa-check-circle"></i></span></td>
                  </tr>
                  <tr style="border-top: 1px solid var(--ghg-border);">
                    <td style="padding: 12px; font-weight: 500;">Business Travel</td>
                    <td style="padding: 12px;"><span class="badge badge-scope-3" style="font-size: 10px;">S3</span></td>
                    <td style="padding: 12px;"><span style="background: var(--ghg-surface-elevated); padding: 4px 10px; border-radius: 4px; font-size: 12px;">RA+ Standard v2.1</span></td>
                    <td style="padding: 12px; text-align: right;">1,122</td>
                    <td style="padding: 12px; text-align: right;">3,847</td>
                    <td style="padding: 12px; text-align: center;"><span style="color: #15803D;"><i class="fa-light fa-check-circle"></i></span></td>
                  </tr>
                  <tr style="border-top: 1px solid var(--ghg-border);">
                    <td style="padding: 12px; font-weight: 500;">Employee Commuting</td>
                    <td style="padding: 12px;"><span class="badge badge-scope-3" style="font-size: 10px;">S3</span></td>
                    <td style="padding: 12px;"><span style="background: var(--ghg-surface-elevated); padding: 4px 10px; border-radius: 4px; font-size: 12px;">RA+ Standard v2.1</span></td>
                    <td style="padding: 12px; text-align: right;">1,089</td>
                    <td style="padding: 12px; text-align: right;">1,456</td>
                    <td style="padding: 12px; text-align: center;"><span style="color: #B45309;"><i class="fa-light fa-exclamation-circle"></i></span></td>
                  </tr>
                </tbody>
              </table>
              <div style="padding: 12px 16px; background: var(--ghg-surface-elevated); border-top: 1px solid var(--ghg-border); display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; gap: 20px; font-size: 13px;">
                  <span><strong>7</strong> activities selected</span>
                  <span style="color: var(--ghg-text-muted);"></span>
                  <span><span style="background: #FEE2E2; color: #991B1B; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 500; margin-right: 4px;">3</span> Scope 1</span>
                  <span><span style="background: #DBEAFE; color: #1E40AF; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 500; margin-right: 4px;">2</span> Scope 2</span>
                  <span><span style="background: #E0E7FF; color: #3730A3; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 500; margin-right: 4px;">2</span> Scope 3</span>
                </div>
                <div style="font-size: 13px; color: var(--ghg-text-muted);">
                  <strong>10,119</strong> total records
                </div>
              </div>
            </div>
          </div>
          
          <div class="review-section">
            <div class="review-section-title">Inventory Summary</div>
            <div class="review-card">
              <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; text-align: center;">
                <div style="padding: 16px; background: var(--ghg-surface-elevated); border-radius: 8px;">
                  <div style="font-size: 24px; font-weight: 700; color: var(--ghg-primary);">1,241</div>
                  <div style="font-size: 11px; color: var(--ghg-text-muted); text-transform: uppercase;">Entities</div>
                </div>
                <div style="padding: 16px; background: var(--ghg-surface-elevated); border-radius: 8px;">
                  <div style="font-size: 24px; font-weight: 700; color: var(--ghg-text);">7</div>
                  <div style="font-size: 11px; color: var(--ghg-text-muted); text-transform: uppercase;">Activities</div>
                </div>
                <div style="padding: 16px; background: var(--ghg-surface-elevated); border-radius: 8px;">
                  <div style="font-size: 24px; font-weight: 700; color: var(--ghg-success);">8,687</div>
                  <div style="font-size: 11px; color: var(--ghg-text-muted); text-transform: uppercase;">Combinations</div>
                </div>
                <div style="padding: 16px; background: var(--ghg-surface-elevated); border-radius: 8px;">
                  <div style="font-size: 24px; font-weight: 700; color: var(--ghg-info);">10,119</div>
                  <div style="font-size: 11px; color: var(--ghg-text-muted); text-transform: uppercase;">Records</div>
                </div>
              </div>
            </div>
          </div>
          
          <div style="padding: 16px; background: var(--ghg-success-light); border-radius: 8px; display: flex; align-items: flex-start; gap: 12px; margin-top: 8px;">
            <i class="fa-light fa-check-circle" style="color: var(--ghg-success); margin-top: 2px;"></i>
            <div>
              <div style="font-weight: 600; color: var(--ghg-success); margin-bottom: 4px;">Ready to Create</div>
              <div style="font-size: 13px; color: var(--ghg-text-muted);">
                All required fields are complete. Click "Create & Calculate" to generate your emissions inventory.
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer" id="inventory-wizard-footer">
        <button class="btn btn-secondary" onclick="closeCreateInventoryModal()">Cancel</button>
        <div style="display: flex; gap: 8px;">
          <button class="btn btn-secondary" id="wizard-back-btn" onclick="wizardPrevStep()" style="display: none;">
            <i class="fa-light fa-arrow-left"></i>
            Back
          </button>
          <button class="btn btn-primary" id="wizard-next-btn" onclick="wizardNextStep()">
            Next
            <i class="fa-light fa-arrow-right"></i>
          </button>
          <button class="btn btn-primary" id="wizard-create-btn" onclick="runCalculation()" style="display: none;">
            <i class="fa-light fa-calculator"></i>
            Create & Calculate
          </button>
        </div>
      </div>
      </div>
    </div>
  </div>
      </main>
    </div>
  </div>
  
  <!-- ============================================== -->
  <!-- MODALS                                         -->
  <!-- ============================================== -->
  
  <!-- Entity Details Modal -->
  <div class="modal-backdrop" id="entity-details-modal">
    <div class="modal modal-lg">
      <div class="modal-header">
        <h2 class="modal-title">Selected Entities (1,247)</h2>
        <button class="modal-close" onclick="closeEntityDetailsModal()">
          <i class="fa-light fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="modal-search">
          <input type="text" placeholder="Search entities...">
        </div>
        <div class="modal-filter-row">
          <span class="filter-pill active">All</span>
          <span class="filter-pill">Americas</span>
          <span class="filter-pill">EMEA</span>
          <span class="filter-pill">APAC</span>
        </div>
        <div class="entity-list">
          <div class="list-header">
            <span>Entity</span>
            <span>Region</span>
            <span>Type</span>
          </div>
          <div class="list-body">
            <div class="list-row">
              <span>Chicago Manufacturing Plant</span>
              <span>Americas</span>
              <span>Facility</span>
            </div>
            <div class="list-row">
              <span>Rotterdam Distribution Center</span>
              <span>EMEA</span>
              <span>Facility</span>
            </div>
            <div class="list-row">
              <span>Tokyo Office</span>
              <span>APAC</span>
              <span>Office</span>
            </div>
          </div>
          <div class="list-pagination">
            Showing 1-50 of 1,247  <button class="btn btn-sm btn-ghost">Load More</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Coverage Detail Modal -->
  <div class="modal-backdrop" id="coverage-detail-modal">
    <div class="modal modal-lg">
      <div class="modal-header">
        <h2 class="modal-title">Coverage Details</h2>
        <button class="modal-close" onclick="closeCoverageDetailModal()">
          <i class="fa-light fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="modal-search">
          <input type="text" placeholder="Search entities...">
        </div>
        <div class="coverage-tabs">
          <button class="tab active">All (1,247)</button>
          <button class="tab">With Data (1,222)</button>
          <button class="tab">Missing Data (25)</button>
        </div>
        <div class="entity-coverage-list">
          <div class="list-header">
            <span>Entity</span>
            <span>Region</span>
            <span>Records</span>
            <span>Status</span>
          </div>
          <div class="list-body">
            <div class="list-row">
              <span>Chicago Manufacturing Plant</span>
              <span>Americas</span>
              <span>1,234</span>
              <span class="status-badge good"><i class="fa-solid fa-check"></i></span>
            </div>
            <div class="list-row">
              <span>Tokyo Office</span>
              <span>APAC</span>
              <span>0</span>
              <span class="status-badge missing"><i class="fa-solid fa-minus"></i></span>
            </div>
          </div>
          <div class="list-pagination">
            Showing 1-50 of 1,247  <button class="btn btn-sm btn-ghost">Load More</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Gaps Modal -->
  <div class="modal-backdrop" id="gaps-modal">
    <div class="modal modal-lg">
      <div class="modal-header">
        <h2 class="modal-title">Entities Missing Data (72)</h2>
        <button class="modal-close" onclick="closeGapsModal()">
          <i class="fa-light fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="modal-search">
          <input type="text" placeholder="Search entities...">
        </div>
        <div class="entity-list">
          <div class="list-header">
            <span>Entity</span>
            <span>Region</span>
            <span>Missing Activities</span>
          </div>
          <div class="list-body">
            <div class="list-row">
              <span>Berlin Sales Office</span>
              <span>EMEA</span>
              <span>Business Travel</span>
            </div>
            <div class="list-row">
              <span>Osaka Warehouse</span>
              <span>APAC</span>
              <span>Stationary Combustion</span>
            </div>
          </div>
          <div class="list-pagination">
            Showing 1-50 of 72  <button class="btn btn-sm btn-ghost">Load More</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- EF Entity Detail Modal -->
  <div class="modal-backdrop" id="ef-entity-modal">
    <div class="modal modal-lg">
      <div class="modal-header">
        <h2 class="modal-title">EF Assignment Details</h2>
        <button class="modal-close" onclick="closeEFEntityModal()">
          <i class="fa-light fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="modal-search">
          <input type="text" placeholder="Search entities...">
        </div>
        <div class="entity-list">
          <div class="list-header">
            <span>Entity</span>
            <span>Location</span>
            <span>EF ID</span>
          </div>
          <div class="list-body">
            <div class="list-row">
              <span>Chicago Manufacturing Plant</span>
              <span>Illinois, US</span>
              <span class="ef-id">EF_FUEL_DSL_STAT_US_EPA2024</span>
            </div>
            <div class="list-row">
              <span>Detroit Assembly Facility</span>
              <span>Michigan, US</span>
              <span class="ef-id">EF_FUEL_DSL_STAT_US_EPA2024</span>
            </div>
          </div>
          <div class="list-pagination">
            Showing 1-50 of 534  <button class="btn btn-sm btn-ghost">Load More</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Lock Inventory Modal -->
  <div class="modal-backdrop" id="lock-inventory-modal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">Lock Inventory for Assurance</h2>
        <button class="modal-close" onclick="closeLockModal()">
          <i class="fa-light fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="lock-warning">
          <h4>
            <i class="fa-light fa-exclamation-triangle"></i>
            This action cannot be undone
          </h4>
          <p>Locking the inventory will:</p>
          <ul>
            <li>Make all emission records, calculations, and logs <strong>immutable</strong></li>
            <li>Freeze the calculation methods and emission factors used</li>
            <li>Create a timestamped audit trail for external verification</li>
            <li>Enable the inventory for official regulatory disclosure</li>
          </ul>
        </div>
        
        <label class="confirm-checkbox">
          <input type="checkbox" id="lock-confirm-checkbox" onchange="updateLockButton()">
          I confirm this inventory is ready for assurance and understand it cannot be modified after locking
        </label>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeLockModal()">Cancel</button>
        <button class="btn btn-danger" id="btn-confirm-lock" disabled onclick="lockInventory()">
          <i class="fa-light fa-lock"></i>
          Lock Inventory
        </button>
      </div>
    </div>
  </div>
  
  <!-- Calculation Progress Modal -->
  <div class="modal-backdrop" id="calc-progress-modal">
    <div class="modal" style="max-width: 500px;">
      <div class="modal-body">
        <div class="calc-progress">
          <div class="calc-progress-ring">
            <svg width="100" height="100">
              <circle class="bg" cx="50" cy="50" r="45"></circle>
              <circle class="progress" cx="50" cy="50" r="45" stroke-dasharray="283" stroke-dashoffset="85" id="progress-circle"></circle>
            </svg>
            <div class="calc-progress-percent" id="progress-percent">70%</div>
          </div>
          <div class="calc-progress-title">Calculating Emissions</div>
          <div class="calc-progress-step" id="progress-step">Applying emission factors...</div>
          
          <div class="calc-steps">
            <div class="calc-step-item completed" id="step-1">
              <i class="fa-solid fa-check-circle"></i>
              <span>Normalizing activity data</span>
            </div>
            <div class="calc-step-item completed" id="step-2">
              <i class="fa-solid fa-check-circle"></i>
              <span>Mapping emission factors</span>
            </div>
            <div class="calc-step-item active" id="step-3">
              <i class="fa-solid fa-spinner fa-spin"></i>
              <span>Executing calculations</span>
            </div>
            <div class="calc-step-item" id="step-4">
              <i class="fa-light fa-circle"></i>
              <span>Applying boundary logic</span>
            </div>
            <div class="calc-step-item" id="step-5">
              <i class="fa-light fa-circle"></i>
              <span>Aggregating results</span>
            </div>
            <div class="calc-step-item" id="step-6">
              <i class="fa-light fa-circle"></i>
              <span>Generating audit logs</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Add Activity Modal -->
  <div class="add-activity-overlay" id="add-activity-modal">
    <div class="add-activity-modal">
      <div class="add-activity-modal-header">
        <h3><i class="fa-light fa-plus-circle" style="margin-right: 10px; color: var(--ghg-primary);"></i>Add Activities to Inventory</h3>
        <button class="close-btn" onclick="closeAddActivityModal()">
          <i class="fa-light fa-times"></i>
        </button>
      </div>
      <div class="add-activity-modal-search">
        <div class="add-activity-search-input">
          <i class="fa-light fa-search"></i>
          <input type="text" placeholder="Search activities..." id="catalog-search" oninput="filterActivityCatalog(this.value)">
        </div>
        <div class="add-activity-scope-filter">
          <button class="scope-btn active" data-scope="all" onclick="filterCatalogByScope('all')">All</button>
          <button class="scope-btn" data-scope="1" onclick="filterCatalogByScope('1')">Scope 1</button>
          <button class="scope-btn" data-scope="2" onclick="filterCatalogByScope('2')">Scope 2</button>
          <button class="scope-btn" data-scope="3" onclick="filterCatalogByScope('3')">Scope 3</button>
        </div>
      </div>
      <div class="add-activity-modal-body">
        <!-- Scope 1 -->
        <div class="activity-catalog-section" data-scope="1">
          <div class="activity-catalog-section-header">
            <span class="scope-badge scope-1">Scope 1</span> Direct Emissions
          </div>
          <div class="activity-catalog-grid">
            <div class="activity-catalog-card has-data selected" data-activity="stationary-combustion" onclick="toggleCatalogCard(this)">
              <div class="card-checkbox"><i class="fa-solid fa-check"></i></div>
              <div class="card-content">
                <div class="card-title">Stationary Combustion</div>
                <div class="card-meta">
                  <span class="has-data-badge"><i class="fa-solid fa-database"></i> Has Data</span>
                  <span>847 records</span>
                </div>
                <div class="card-description">Emissions from boilers, furnaces, and other stationary equipment</div>
              </div>
            </div>
            <div class="activity-catalog-card has-data selected" data-activity="mobile-combustion" onclick="toggleCatalogCard(this)">
              <div class="card-checkbox"><i class="fa-solid fa-check"></i></div>
              <div class="card-content">
                <div class="card-title">Mobile Combustion</div>
                <div class="card-meta">
                  <span class="has-data-badge"><i class="fa-solid fa-database"></i> Has Data</span>
                  <span>1,234 records</span>
                </div>
                <div class="card-description">Fleet vehicles, company cars, and mobile equipment</div>
              </div>
            </div>
            <div class="activity-catalog-card has-data" data-activity="fugitive-emissions" onclick="toggleCatalogCard(this)">
              <div class="card-checkbox"><i class="fa-solid fa-check"></i></div>
              <div class="card-content">
                <div class="card-title">Fugitive Emissions</div>
                <div class="card-meta">
                  <span class="has-data-badge"><i class="fa-solid fa-database"></i> Has Data</span>
                  <span>156 records</span>
                </div>
                <div class="card-description">Refrigerant leaks, gas leaks from equipment</div>
              </div>
            </div>
            <div class="activity-catalog-card" data-activity="process-emissions" onclick="toggleCatalogCard(this)">
              <div class="card-checkbox"><i class="fa-solid fa-check"></i></div>
              <div class="card-content">
                <div class="card-title">Process Emissions</div>
                <div class="card-meta">
                  <span class="no-data-badge">No data yet</span>
                </div>
                <div class="card-description">Chemical reactions in manufacturing processes</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Scope 2 -->
        <div class="activity-catalog-section" data-scope="2">
          <div class="activity-catalog-section-header">
            <span class="scope-badge scope-2">Scope 2</span> Indirect Emissions - Energy
          </div>
          <div class="activity-catalog-grid">
            <div class="activity-catalog-card has-data selected" data-activity="purchased-electricity" onclick="toggleCatalogCard(this)">
              <div class="card-checkbox"><i class="fa-solid fa-check"></i></div>
              <div class="card-content">
                <div class="card-title">Purchased Electricity</div>
                <div class="card-meta">
                  <span class="has-data-badge"><i class="fa-solid fa-database"></i> Has Data</span>
                  <span>2,456 records</span>
                </div>
                <div class="card-description">Grid electricity consumption at all facilities</div>
              </div>
            </div>
            <div class="activity-catalog-card has-data" data-activity="purchased-heat" onclick="toggleCatalogCard(this)">
              <div class="card-checkbox"><i class="fa-solid fa-check"></i></div>
              <div class="card-content">
                <div class="card-title">Purchased Heat/Steam</div>
                <div class="card-meta">
                  <span class="has-data-badge"><i class="fa-solid fa-database"></i> Has Data</span>
                  <span>89 records</span>
                </div>
                <div class="card-description">District heating and purchased steam</div>
              </div>
            </div>
            <div class="activity-catalog-card" data-activity="purchased-cooling" onclick="toggleCatalogCard(this)">
              <div class="card-checkbox"><i class="fa-solid fa-check"></i></div>
              <div class="card-content">
                <div class="card-title">Purchased Cooling</div>
                <div class="card-meta">
                  <span class="no-data-badge">No data yet</span>
                </div>
                <div class="card-description">District cooling systems</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Scope 3 -->
        <div class="activity-catalog-section" data-scope="3">
          <div class="activity-catalog-section-header">
            <span class="scope-badge scope-3">Scope 3</span> Value Chain Emissions
          </div>
          <div class="activity-catalog-grid">
            <div class="activity-catalog-card has-data selected" data-activity="business-travel" onclick="toggleCatalogCard(this)">
              <div class="card-checkbox"><i class="fa-solid fa-check"></i></div>
              <div class="card-content">
                <div class="card-title">Business Travel</div>
                <div class="card-meta">
                  <span class="has-data-badge"><i class="fa-solid fa-database"></i> Has Data</span>
                  <span>3,891 records</span>
                </div>
                <div class="card-description">Cat 6: Air, rail, and car travel for business</div>
              </div>
            </div>
            <div class="activity-catalog-card has-data selected" data-activity="employee-commuting" onclick="toggleCatalogCard(this)">
              <div class="card-checkbox"><i class="fa-solid fa-check"></i></div>
              <div class="card-content">
                <div class="card-title">Employee Commuting</div>
                <div class="card-meta">
                  <span class="has-data-badge"><i class="fa-solid fa-database"></i> Has Data</span>
                  <span>1,567 records</span>
                </div>
                <div class="card-description">Cat 7: Employee travel to and from work</div>
              </div>
            </div>
            <div class="activity-catalog-card has-data" data-activity="purchased-goods" onclick="toggleCatalogCard(this)">
              <div class="card-checkbox"><i class="fa-solid fa-check"></i></div>
              <div class="card-content">
                <div class="card-title">Purchased Goods & Services</div>
                <div class="card-meta">
                  <span class="has-data-badge"><i class="fa-solid fa-database"></i> Has Data</span>
                  <span>4,203 records</span>
                </div>
                <div class="card-description">Cat 1: Spend-based upstream emissions</div>
              </div>
            </div>
            <div class="activity-catalog-card has-data" data-activity="upstream-transport" onclick="toggleCatalogCard(this)">
              <div class="card-checkbox"><i class="fa-solid fa-check"></i></div>
              <div class="card-content">
                <div class="card-title">Upstream Transportation</div>
                <div class="card-meta">
                  <span class="has-data-badge"><i class="fa-solid fa-database"></i> Has Data</span>
                  <span>892 records</span>
                </div>
                <div class="card-description">Cat 4: Inbound logistics and freight</div>
              </div>
            </div>
            <div class="activity-catalog-card has-data" data-activity="waste-generated" onclick="toggleCatalogCard(this)">
              <div class="card-checkbox"><i class="fa-solid fa-check"></i></div>
              <div class="card-content">
                <div class="card-title">Waste Generated</div>
                <div class="card-meta">
                  <span class="has-data-badge"><i class="fa-solid fa-database"></i> Has Data</span>
                  <span>234 records</span>
                </div>
                <div class="card-description">Cat 5: Waste disposal and treatment</div>
              </div>
            </div>
            <div class="activity-catalog-card" data-activity="downstream-transport" onclick="toggleCatalogCard(this)">
              <div class="card-checkbox"><i class="fa-solid fa-check"></i></div>
              <div class="card-content">
                <div class="card-title">Downstream Transportation</div>
                <div class="card-meta">
                  <span class="no-data-badge">No data yet</span>
                </div>
                <div class="card-description">Cat 9: Outbound logistics to customers</div>
              </div>
            </div>
            <div class="activity-catalog-card" data-activity="use-of-sold-products" onclick="toggleCatalogCard(this)">
              <div class="card-checkbox"><i class="fa-solid fa-check"></i></div>
              <div class="card-content">
                <div class="card-title">Use of Sold Products</div>
                <div class="card-meta">
                  <span class="no-data-badge">No data yet</span>
                </div>
                <div class="card-description">Cat 11: Customer use phase emissions</div>
              </div>
            </div>
            <div class="activity-catalog-card" data-activity="end-of-life" onclick="toggleCatalogCard(this)">
              <div class="card-checkbox"><i class="fa-solid fa-check"></i></div>
              <div class="card-content">
                <div class="card-title">End-of-Life Treatment</div>
                <div class="card-meta">
                  <span class="no-data-badge">No data yet</span>
                </div>
                <div class="card-description">Cat 12: Product disposal by customers</div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="add-activity-modal-footer">
        <div class="selection-summary">
          <strong id="catalog-selected-count">6</strong> activities selected
          (<span id="catalog-with-data-count">5</span> with data, <span id="catalog-no-data-count">1</span> pending data collection)
        </div>
        <div class="footer-actions">
          <button class="btn btn-secondary" onclick="closeAddActivityModal()">Cancel</button>
          <button class="btn btn-primary" onclick="confirmAddActivities()">
            <i class="fa-light fa-plus"></i>
            Add Selected Activities
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Remove Activity Confirmation Modal -->
  <div class="remove-confirm-overlay" id="remove-confirm-modal">
    <div class="remove-confirm-modal">
      <h4><i class="fa-light fa-exclamation-triangle"></i> Remove Activity?</h4>
      <p id="remove-confirm-text">Are you sure you want to remove <strong>Stationary Combustion</strong> from this inventory?</p>
      <div class="warning-box">
        <i class="fa-light fa-info-circle"></i>
        <span id="remove-warning-text">This will exclude 847 records from calculation. The data will remain in the system and can be added back later.</span>
      </div>
      <div class="confirm-actions">
        <button class="btn btn-secondary" onclick="closeRemoveConfirmModal()">Cancel</button>
        <button class="btn btn-danger" onclick="confirmRemoveActivity()">
          <i class="fa-light fa-trash"></i>
          Remove Activity
        </button>
      </div>
    </div>
  </div>

  <!-- Entity Records Drawer - Split Panel -->
  <div class="entity-records-backdrop" id="entityRecordsBackdrop" onclick="closeEntityRecordsDrawer()"></div>
  <div class="entity-records-drawer" id="entityRecordsDrawer">
    <div class="entity-records-drawer-header">
      <div class="entity-records-drawer-header-top">
        <div class="entity-records-drawer-title">
          <span class="entity-flag" id="entityDrawerFlag"></span>
          <div>
            <h2 id="entityDrawerTitle">Berlin Factory</h2>
            <p id="entityDrawerSubtitle">Germany  Manufacturing  312,000 records</p>
          </div>
        </div>
        <button class="entity-records-drawer-close" onclick="closeEntityRecordsDrawer()">
          <i class="fa-light fa-xmark"></i>
        </button>
      </div>
      <div class="entity-records-drawer-stats">
        <div class="entity-records-stat">
          <span class="entity-records-stat-value" id="entityDrawerCoverage">72%</span>
          <span class="entity-records-stat-label">Coverage</span>
        </div>
        <div class="entity-records-stat">
          <span class="entity-records-stat-value" id="entityDrawerMapped" style="color: var(--ghg-success);">224,640</span>
          <span class="entity-records-stat-label">Mapped</span>
        </div>
        <div class="entity-records-stat">
          <span class="entity-records-stat-value" id="entityDrawerFlagged" style="color: var(--ghg-warning);">21,300</span>
          <span class="entity-records-stat-label">Flagged</span>
        </div>
        <div class="entity-records-stat">
          <span class="entity-records-stat-value" id="entityDrawerUnmapped" style="color: var(--ghg-danger);">66,060</span>
          <span class="entity-records-stat-label">Unmapped</span>
        </div>
      </div>
    </div>
    
    <div class="entity-records-drawer-body">
      <!-- Left Panel: Records List -->
      <div class="records-list-panel">
        <div class="records-list-header">
          <div class="records-list-search">
            <i class="fa-light fa-search"></i>
            <input type="text" placeholder="Search activities..." id="recordsListSearch" oninput="filterRecordsList()">
          </div>
        </div>
        <div class="records-list-content" id="recordsListContent">
          <!-- Records populated by JavaScript -->
        </div>
        <div class="records-list-footer" id="recordsListFooter">
          Showing 10 of 312,000 records
        </div>
      </div>
      
      <!-- Right Panel: Record Detail -->
      <div class="record-detail-panel">
        <!-- Empty State -->
        <div class="record-detail-empty" id="recordDetailEmpty">
          <i class="fa-light fa-hand-pointer"></i>
          <p>Select a record to view details</p>
        </div>
        
        <!-- Detail Content (hidden by default) -->
        <div class="record-detail-wrapper" id="recordDetailContent" style="display: none;">
          <!-- Scrollable Content -->
          <div class="record-detail-scroll">
            <div class="record-detail-header">
              <h3 class="record-detail-title" id="recordDetailTitle">Diesel - Fleet Vehicles</h3>
              <div class="record-detail-meta">
                <span id="recordDetailEntity">Amsterdam Office</span>
                <span></span>
                <span id="recordDetailPeriod">Jan 2026</span>
                <span></span>
                <span id="recordDetailSource">Upload_Data.xlsx</span>
              </div>
              <div class="record-detail-badges">
                <span class="status-badge mapped" id="recordDetailStatus">Mapped</span>
                <span class="data-path-badge" id="recordDetailDataPath">Activity-based</span>
              </div>
            </div>
            
            <!-- Stage 1: Classification -->
            <div class="detail-card">
              <div class="detail-card-header">
                <span class="detail-card-title">Stage 1: Classification</span>
                <span class="detail-card-badge">Activity  Activity_ID</span>
              </div>
              <table class="detail-table">
                <tr>
                  <td class="detail-label">Raw Activity Label</td>
                  <td class="detail-value" id="detailRawLabel">Diesel - Fleet Vehicles</td>
                </tr>
                <tr>
                  <td class="detail-label">Sanitized Value</td>
                  <td class="detail-value mono" id="detailSanitizedValue">2,450 L</td>
                </tr>
                <tr>
                  <td class="detail-label">EF_ActivityID</td>
                  <td class="detail-value mono primary" id="detailActivityId">FUEL_DIESEL_MOBILE</td>
                </tr>
                <tr>
                  <td class="detail-label">Scope</td>
                  <td class="detail-value" id="detailScope">Scope 1 - Direct Emissions</td>
                </tr>
              </table>
            </div>
            
            <!-- Stage 2: EF Selection -->
            <div class="detail-card">
              <div class="detail-card-header">
                <span class="detail-card-title">Stage 2: EF Selection</span>
                <span class="detail-card-badge" id="detailSelectionBadge">System-Selected</span>
              </div>
              <table class="detail-table">
                <tr>
                  <td class="detail-label">Selected Factor</td>
                  <td class="detail-value" id="detailSelectedFactor">Diesel (100% mineral)</td>
                </tr>
                <tr>
                  <td class="detail-label">Dataset Source</td>
                  <td class="detail-value" id="detailDatasetSource">DEFRA 2024</td>
                </tr>
                <tr>
                  <td class="detail-label">Emission Factor</td>
                  <td class="detail-value mono primary" id="detailEFValue">3.29 kg COe/L</td>
                </tr>
                <tr>
                  <td class="detail-label">Lifecycle</td>
                  <td class="detail-value" id="detailLifecycle">WTT: 0.61 + TTW: 2.68 = 3.29</td>
                </tr>
              </table>
            </div>
            
            <!-- Why This Factor Was Selected -->
            <div class="why-selected-box" id="whySelectedBox">
              <div class="why-selected-header">
                <i class="fa-light fa-lightbulb"></i>
                Why This Factor Was Selected
              </div>
              <div class="why-selected-reasons" id="whySelectedReasons">
                <div class="why-selected-item success">
                  <i class="fa-light fa-check-circle"></i>
                  <span>Activity-based data path (rank 3/5 per method)</span>
                </div>
                <div class="why-selected-item warning">
                  <i class="fa-light fa-circle-half-stroke"></i>
                  <span>UK factors for France entity (partial geo match)</span>
                </div>
                <div class="why-selected-item success">
                  <i class="fa-light fa-check-circle"></i>
                  <span>2024 dataset (current year match)</span>
                </div>
              </div>
            </div>
            
            <!-- Specificity Score -->
            <div class="detail-card compact">
              <div class="detail-card-header">
                <span class="detail-card-title">Specificity Score</span>
              </div>
              <div class="specificity-gauge">
                <div class="specificity-gauge-bar">
                  <div class="specificity-gauge-fill" id="specificityGaugeFill" style="width: 78%;"></div>
                </div>
                <span class="specificity-gauge-value" id="specificityGaugeValue">78 / 100</span>
              </div>
            </div>
            
            <!-- Audit Trail -->
            <div class="audit-trail-mini">
              <div class="audit-trail-mini-header" onclick="toggleAuditTrail()">
                <span class="audit-trail-mini-title">
                  <i class="fa-light fa-clock-rotate-left"></i>
                  Audit Trail
                  <span class="audit-trail-count">(4 events)</span>
                </span>
                <i class="fa-light fa-chevron-down audit-trail-toggle" id="auditTrailToggle"></i>
              </div>
              <div class="audit-trail-mini-content" id="auditTrailContent" style="display: none;">
                <div class="audit-item">
                  <span class="audit-time">Feb 10, 2026 09:14</span>
                  <span class="audit-event">EF auto-selected by system</span>
                </div>
                <div class="audit-item">
                  <span class="audit-time">Feb 10, 2026 09:14</span>
                  <span class="audit-event">Activity ID mapped: FUEL_DIESEL_MOBILE</span>
                </div>
                <div class="audit-item">
                  <span class="audit-time">Feb 10, 2026 08:45</span>
                  <span class="audit-event">Record imported from Fleet_Data_Q1.xlsx</span>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Fixed Actions at Bottom -->
          <div class="record-detail-actions">
            <button class="btn btn-primary" onclick="openOverrideFromSelection(currentRecordId)">
              Override EF
            </button>
            <button class="btn btn-secondary" onclick="openEFAssignModal(currentRecordId)">
              Change Activity ID
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- EF Override Modal -->
  <div class="modal-backdrop hidden" id="overrideModalBackdrop" onclick="closeOverrideModal()"></div>
  <div class="modal override-modal hidden" id="overrideModal">
    <div class="modal-header">
      <h2><i class="fa-light fa-arrow-right-arrow-left"></i> Override EF Selection</h2>
      <button class="modal-close" onclick="closeOverrideModal()">
        <i class="fa-light fa-xmark"></i>
      </button>
    </div>
    <div class="modal-body">
      <!-- Activity Context -->
      <div class="override-context">
        <div class="override-context-header">
          <div>
            <div class="override-context-title" id="overrideActivityName">Diesel - Fleet Vehicles</div>
            <div class="override-context-meta">2,450 L | Paris HQ | Jan 2026</div>
          </div>
          <span class="override-context-id" id="overrideActivityId">FUEL_DIESEL_MOBILE</span>
        </div>
      </div>
      
      <!-- Selection Comparison -->
      <div class="selection-comparison">
        <div class="selection-box system">
          <span class="selection-box-label">System Selection</span>
          <div class="selection-ef-name" id="systemEFName">Diesel (100% mineral)</div>
          <div class="selection-ef-source" id="systemEFSource">DEFRA 2024</div>
          <div class="selection-ef-value" id="systemEFValue">3.29 kg COe/L</div>
          <div class="selection-specificity">
            <span class="selection-specificity-label">Specificity:</span>
            <span class="selection-specificity-score high" id="systemSpecificity">78</span>
          </div>
        </div>
        
        <div class="selection-arrow">
          <i class="fa-light fa-arrow-right"></i>
          <button class="selection-arrow-btn" id="useSystemBtn" onclick="useSystemSelection()">Use This</button>
        </div>
        
        <div class="selection-box override empty" id="overrideBox">
          <span class="selection-box-label">Your Override</span>
          <div class="override-placeholder" id="overridePlaceholder">
            <i class="fa-light fa-hand-pointer"></i>
            Select an alternative below<br>or enter a custom factor
          </div>
          <div id="overrideContent" style="display: none;">
            <div class="selection-ef-name" id="overrideEFName"></div>
            <div class="selection-ef-source" id="overrideEFSource"></div>
            <div class="selection-ef-value" id="overrideEFValue"></div>
            <div class="selection-specificity">
              <span class="selection-specificity-label">Specificity:</span>
              <span class="selection-specificity-score" id="overrideSpecificity"></span>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Alternative Options -->
      <div class="alternatives-section">
        <div class="alternatives-title">Alternative Emission Factors</div>
        <div class="alternatives-grid">
          <div class="alternative-card" onclick="selectAlternative('alt1', 'Diesel - France', 'ADEME 2024', '3.16 kg COe/L', 82)">
            <div class="alternative-ef-name">Diesel - France</div>
            <div class="alternative-ef-source">ADEME 2024</div>
            <div class="alternative-ef-value">3.16 kg COe/L</div>
            <div class="alternative-specificity">
              <span>Specificity: 82</span>
              <span class="improvement">+4 </span>
            </div>
          </div>
          <div class="alternative-card" onclick="selectAlternative('alt2', 'Diesel (B7 blend)', 'DEFRA 2024', '3.17 kg COe/L', 75)">
            <div class="alternative-ef-name">Diesel (B7 blend)</div>
            <div class="alternative-ef-source">DEFRA 2024</div>
            <div class="alternative-ef-value">3.17 kg COe/L</div>
            <div class="alternative-specificity">
              <span>Specificity: 75</span>
            </div>
          </div>
          <div class="alternative-card" onclick="selectAlternative('alt3', 'Diesel - EU Average', 'EEA 2024', '3.21 kg COe/L', 70)">
            <div class="alternative-ef-name">Diesel - EU Average</div>
            <div class="alternative-ef-source">EEA 2024</div>
            <div class="alternative-ef-value">3.21 kg COe/L</div>
            <div class="alternative-specificity">
              <span>Specificity: 70</span>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Override Reason -->
      <div class="override-reason-section" id="overrideReasonSection" style="display: none;">
        <label>Override Reason (required for audit)</label>
        <select class="override-reason-select" id="overrideReasonSelect">
          <option value="">Select a reason...</option>
          <option value="supplier">Supplier-provided data (higher specificity)</option>
          <option value="geographic">More geographically accurate factor available</option>
          <option value="study">LCA study / custom calculation</option>
          <option value="regulatory">Regulatory requirement</option>
          <option value="correction">System selection was incorrect</option>
          <option value="other">Other (specify below)</option>
        </select>
        <textarea class="override-reason-textarea" id="overrideReasonText" placeholder="Provide additional context for the audit trail..."></textarea>
      </div>
      
      <!-- Override Level -->
      <div class="override-level-section" id="overrideLevelSection" style="display: none;">
        <div class="override-level-title">
          <i class="fa-light fa-layer-group"></i> Apply Override To
        </div>
        <div class="override-level-options">
          <label class="override-level-option">
            <input type="radio" name="overrideLevel" value="record" checked>
            <div>
              <div class="override-level-option-label">This record only</div>
              <div class="override-level-option-desc">Override applies to this specific activity record</div>
            </div>
          </label>
          <label class="override-level-option">
            <input type="radio" name="overrideLevel" value="entity">
            <div>
              <div class="override-level-option-label">All records for this entity</div>
              <div class="override-level-option-desc">Override applies to all matching records at this entity</div>
            </div>
          </label>
          <label class="override-level-option">
            <input type="radio" name="overrideLevel" value="global">
            <div>
              <div class="override-level-option-label">All matching records globally</div>
              <div class="override-level-option-desc">Override applies globally as a new selection rule</div>
            </div>
          </label>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeOverrideModal()">Cancel</button>
      <button class="btn btn-primary" id="confirmOverrideBtn" onclick="confirmOverride()" disabled>
        <i class="fa-light fa-check"></i> Confirm Override
      </button>
    </div>
  </div>
  
  <!-- EF Assignment Modal -->
  <div class="modal-backdrop" id="efAssignModalBackdrop" onclick="closeEFAssignModal()"></div>
  <div class="modal" id="efAssignModal" style="max-width: 600px;">
    <div class="modal-header">
      <h2>Assign Emission Factor Mapping</h2>
      <button class="modal-close" onclick="closeEFAssignModal()">
        <i class="fa-light fa-xmark"></i>
      </button>
    </div>
    <div class="modal-body">
      <!-- Activity Context -->
      <div class="assign-activity-context">
        <div class="assign-context-label">Mapping for activity:</div>
        <div class="assign-context-title" id="assignModalActivity">Office Supplies Q4</div>
        <div class="assign-context-meta" id="assignModalMeta">$85,000 | Various vendors | Q4 2025</div>
      </div>
      
      <!-- Search EF_ActivityID -->
      <div class="assign-search-section">
        <label class="assign-section-label">Search EF_ActivityID Registry</label>
        <div class="assign-search-input">
          <input type="text" id="efRegistrySearch" placeholder="Type to search (e.g., 'office', 'supplies', 'goods')...">
        </div>
      </div>
      
      <!-- EF Registry Results -->
      <div class="assign-options-section">
        <label class="assign-section-label">Select EF_ActivityID</label>
        <div class="assign-options-list" id="efRegistryOptions">
          <div class="assign-option" onclick="selectEFActivityID('GOODS_OFFICE_PAPER', this)">
            <div class="assign-option-main">
              <div class="assign-option-id">GOODS_OFFICE_PAPER</div>
              <div class="assign-option-desc">Office Paper & Stationery</div>
            </div>
            <div class="assign-option-meta">
              <span class="assign-datapath-badge spend">Spend</span>
              <span class="assign-option-ef">EPA EEIO  0.89 kg/$</span>
            </div>
          </div>
          <div class="assign-option" onclick="selectEFActivityID('GOODS_OFFICE_EQUIP', this)">
            <div class="assign-option-main">
              <div class="assign-option-id">GOODS_OFFICE_EQUIP</div>
              <div class="assign-option-desc">Office Equipment & Furniture</div>
            </div>
            <div class="assign-option-meta">
              <span class="assign-datapath-badge spend">Spend</span>
              <span class="assign-option-ef">EPA EEIO  1.12 kg/$</span>
            </div>
          </div>
          <div class="assign-option selected" onclick="selectEFActivityID('GOODS_OFFICE_MIXED', this)">
            <div class="assign-option-main">
              <div class="assign-option-id">GOODS_OFFICE_MIXED</div>
              <div class="assign-option-desc">Office Supplies - Mixed Category</div>
            </div>
            <div class="assign-option-meta">
              <span class="assign-datapath-badge spend">Spend</span>
              <span class="assign-option-ef">EPA EEIO  0.76 kg/$</span>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Method Constraints Info Box -->
      <div class="assign-constraints-box">
        <div class="assign-constraints-header">
          <i class="fa-light fa-info-circle"></i>
          Method Constraints (GHG Protocol v3.1)
        </div>
        <ul class="assign-constraints-list">
          <li>Eligible data paths: Direct, Hybrid, Activity-based, Proxy, Spend-based</li>
          <li>Spend-based factors have lower specificity priority per method config</li>
          <li>Lifecycle: WTW decomposed (where available)</li>
        </ul>
      </div>
      
      <!-- Save to Match Memory -->
      <div class="assign-memory-checkbox">
        <input type="checkbox" id="saveToMatchMemory" checked>
        <label for="saveToMatchMemory">Save this mapping to Match Memory for future activities with similar labels</label>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeEFAssignModal()">Cancel</button>
      <button class="btn btn-primary" onclick="confirmEFAssignment()">
        Assign Mapping
      </button>
    </div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container" id="toast-container"></div>
  
  <!-- App Shell JavaScript -->
  <script src="app-shell.js"></script>
  
  <!-- Prototype JavaScript -->
  <script>
    // ============================================
    // View Switching
    // ============================================
    
    function switchView(viewId) {
      document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
      document.getElementById('view-' + viewId).classList.add('active');
      
      document.querySelectorAll('.submenu-item[data-view]').forEach(item => {
        item.classList.remove('active');
        if (item.dataset.view === viewId) {
          item.classList.add('active');
        }
      });
      
      // Initialize full page EF table when switching to EF Selection & Review view
      if (viewId === 'ef-selection-review') {
        initEFEntityTableFull();
      }
    }
    
    document.querySelectorAll('.submenu-item[data-view]').forEach(item => {
      item.addEventListener('click', (e) => {
        e.preventDefault();
        switchView(item.dataset.view);
      });
    });
    
    // Handle URL hash for cross-prototype navigation
    function handleHashNavigation() {
      const hash = window.location.hash.replace('#', '');
      const hashToView = {
        'ef-library': 'ef-library',
        'ef-selection': 'ef-selection-review'
      };
      if (hash && hashToView[hash]) {
        switchView(hashToView[hash]);
      }
    }
    handleHashNavigation();
    window.addEventListener('hashchange', handleHashNavigation);
    
    function viewInventoryResults(id) {
      switchView('inventory-results');
    }
    
    // ============================================
    // Quality Card Toggle
    // ============================================
    
    function toggleQualityCard() {
      const details = document.getElementById('quality-card-details');
      const toggle = document.getElementById('quality-card-toggle');
      
      if (details.style.display === 'none') {
        details.style.display = 'grid';
        toggle.style.transform = 'rotate(0deg)';
      } else {
        details.style.display = 'none';
        toggle.style.transform = 'rotate(-90deg)';
      }
    }
    
    // ============================================
    // Period Comparison Updates
    // ============================================
    
    const comparisonData = {
      'none': {
        total: { current: 1061.9, previous: null, change: null },
        scope1: { current: 124.6, previous: null, change: null },
        scope2: { current: 45.2, previous: null, change: null },
        scope3: { current: 892.1, previous: null, change: null }
      },
      'q3-2025': {
        total: { current: 1061.9, previous: 1007.6, change: 5.4 },
        scope1: { current: 124.6, previous: 118.3, change: 5.3 },
        scope2: { current: 45.2, previous: 43.1, change: 4.9 },
        scope3: { current: 892.1, previous: 847.2, change: 5.3 }
      },
      'q4-2024': {
        total: { current: 1061.9, previous: 1134.2, change: -6.4 },
        scope1: { current: 124.6, previous: 138.9, change: -10.3 },
        scope2: { current: 45.2, previous: 51.8, change: -12.7 },
        scope3: { current: 892.1, previous: 943.5, change: -5.4 }
      },
      'q3-2024': {
        total: { current: 1061.9, previous: 1089.3, change: -2.5 },
        scope1: { current: 124.6, previous: 131.2, change: -5.0 },
        scope2: { current: 45.2, previous: 48.6, change: -7.0 },
        scope3: { current: 892.1, previous: 909.5, change: -1.9 }
      }
    };
    
    function updateComparisonDeltas(period) {
      const data = comparisonData[period];
      if (!data) return;
      
      const periodLabels = {
        'none': '',
        'q3-2025': 'from Q3 2025',
        'q4-2024': 'from Q4 2024',
        'q3-2024': 'from Q3 2024'
      };
      
      // Update Total stat
      const totalChange = document.getElementById('stat-total-change');
      if (totalChange) {
        if (data.total.change === null) {
          totalChange.innerHTML = '<i class="fa-light fa-minus"></i> No comparison selected';
          totalChange.className = 'stat-change';
        } else {
          const isPositive = data.total.change < 0;
          const arrow = isPositive ? 'arrow-down' : 'arrow-up';
          const sign = isPositive ? '' : '+';
          totalChange.innerHTML = `<i class="fa-light fa-${arrow}"></i> ${sign}${data.total.change.toFixed(1)}% ${periodLabels[period]}`;
          totalChange.className = isPositive ? 'stat-change positive' : 'stat-change negative';
        }
      }
      
      // Update Scope stats
      const scopes = ['scope1', 'scope2', 'scope3'];
      scopes.forEach((scope, index) => {
        const changeEl = document.getElementById(`stat-${scope}-change`);
        if (changeEl) {
          const scopeNum = index + 1;
          const percentage = ((data[scope].current / data.total.current) * 100).toFixed(1);
          
          if (data[scope].change === null) {
            changeEl.innerHTML = `<span style="color: var(--ghg-text-muted);">${percentage}% of total</span>`;
          } else {
            const isIncrease = data[scope].change > 0;
            const arrow = isIncrease ? '' : '';
            const color = isIncrease ? '#DC2626' : '#059669';
            const sign = isIncrease ? '+' : '';
            changeEl.innerHTML = `<span style="color: var(--ghg-text-muted);">${percentage}% of total</span>  <span style="color: ${color};">${arrow} ${sign}${data[scope].change.toFixed(1)}%</span>`;
          }
        }
      });
    }
    
    // Initialize comparison selector
    document.addEventListener('DOMContentLoaded', () => {
      const comparisonSelect = document.getElementById('period-comparison-select');
      if (comparisonSelect) {
        comparisonSelect.addEventListener('change', (e) => {
          updateComparisonDeltas(e.target.value);
        });
        // Initialize with default selection
        updateComparisonDeltas(comparisonSelect.value);
      }
    });
    
    // ============================================
    // Tab Switching
    // ============================================
    
    document.querySelectorAll('.tabs-container .tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const container = tab.closest('.tabs-container');
        container.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        
        container.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        container.querySelector('#tab-' + tab.dataset.tab).classList.add('active');
        
        // Initialize breakdown view when tab is activated
        if (tab.dataset.tab === 'breakdown' && breakdownData.length === 0) {
          setTimeout(() => {
            initBreakdownView();
          }, 100);
        }
      });
    });
    
    // ============================================
    // Detailed Breakdown View - Data & State
    // ============================================
    
    let breakdownData = [];
    let filteredData = [];
    let sortedData = [];
    let groupedData = [];
    let paginatedData = [];
    
    let breakdownState = {
      search: '',
      entityFilter: 'all',
      scopeFilter: 'all',
      categoryFilter: 'all',
      emissionFilter: 'all',
      qualityFilter: 'all',
      groupBy: 'none',
      sortColumn: 'tco2e',
      sortDirection: 'desc',
      currentPage: 1,
      pageSize: 50,
      collapsedGroups: {}
    };
    
    // Helper function to generate lineage HTML
    function generateLineageHTML(record) {
      const scopeColors = {
        1: { bg: 'var(--ghg-scope-1-light)', border: 'var(--ghg-scope-1)' },
        2: { bg: 'var(--ghg-scope-2-light)', border: 'var(--ghg-scope-2)' },
        3: { bg: 'var(--ghg-scope-3-light)', border: 'var(--ghg-scope-3)' }
      };
      const color = scopeColors[record.scope] || { bg: 'var(--ghg-surface-elevated)', border: 'var(--ghg-border)' };
      
      return `
        <div class="expanded-inner">
          <div class="lineage-panel">
            <div class="lineage-header">
              <h4><i class="fa-light fa-route"></i> Calculation Lineage</h4>
              <p>${record.entity}  ${record.activity}  Scope ${record.scope}${record.category ? ` (Category ${record.category})` : ''}</p>
            </div>
            <div class="lineage-section" style="background: ${color.bg}; border: 1px solid ${color.border}; border-radius: 8px; padding: 12px; margin-bottom: 16px;">
              <div class="lineage-section-title" style="margin-bottom: 12px;"><i class="fa-light fa-sliders"></i> Methodology & Decisions</div>
              <div class="lineage-grid" style="grid-template-columns: repeat(4, 1fr);">
                <div class="lineage-item">
                  <div class="lineage-item-label">Calculation Method</div>
                  <div class="lineage-item-value">Activity-Based</div>
                </div>
                <div class="lineage-item">
                  <div class="lineage-item-label">EF Source</div>
                  <div class="lineage-item-value">${record.efSource}</div>
                </div>
                <div class="lineage-item">
                  <div class="lineage-item-label">Quality</div>
                  <div class="lineage-item-value">${record.quality}</div>
                </div>
                <div class="lineage-item">
                  <div class="lineage-item-label">Scope</div>
                  <div class="lineage-item-value">Scope ${record.scope}</div>
                </div>
              </div>
            </div>
            <div class="lineage-section">
              <div class="lineage-section-title"><i class="fa-light fa-database"></i> Input Data</div>
              <div class="lineage-grid">
                <div class="lineage-item">
                  <div class="lineage-item-label">Activity Value</div>
                  <div class="lineage-item-value mono">${formatActivityData(record.activityData)}</div>
                </div>
                <div class="lineage-item">
                  <div class="lineage-item-label">Period</div>
                  <div class="lineage-item-value">Oct - Dec 2025</div>
                </div>
                <div class="lineage-item">
                  <div class="lineage-item-label">Data Source</div>
                  <div class="lineage-item-value">${record.dataSource || 'Upload'}</div>
                </div>
                <div class="lineage-item">
                  <div class="lineage-item-label">Specificity Score</div>
                  <div class="lineage-item-value mono">${record.specificityScore || '85'}/100</div>
                </div>
              </div>
              <a href="../../platform/prototypes/activity-data-upload/index.html?view=records&highlight=record-${record.id}" 
                 target="_blank"
                 class="view-activity-link"
                 style="display: inline-flex; align-items: center; gap: 6px; margin-top: 12px; padding: 8px 12px; background: var(--ghg-primary-light); color: var(--ghg-primary); border-radius: 6px; text-decoration: none; font-size: 13px; font-weight: 500; transition: all 0.15s ease;">
                <i class="fa-light fa-arrow-up-right-from-square"></i>
                View Source Activity Record
              </a>
            </div>
            <div class="lineage-section">
              <div class="lineage-section-title"><i class="fa-light fa-bolt"></i> Emission Factor</div>
              <div class="lineage-grid">
                <div class="lineage-item">
                  <div class="lineage-item-label">Factor Value</div>
                  <div class="lineage-item-value mono">${record.efValue || 'N/A'}</div>
                </div>
                <div class="lineage-item">
                  <div class="lineage-item-label">Source</div>
                  <div class="lineage-item-value">${record.efSource}</div>
                </div>
                <div class="lineage-item">
                  <div class="lineage-item-label">Gases Covered</div>
                  <div class="lineage-item-value">CO, CH, NO</div>
                </div>
                <div class="lineage-item">
                  <div class="lineage-item-label">GWP Version</div>
                  <div class="lineage-item-value">AR5 (100-year)</div>
                </div>
              </div>
            </div>
            <div class="lineage-section">
              <div class="lineage-section-title"><i class="fa-light fa-calculator"></i> Calculation</div>
              <div class="lineage-calculation">
                ${formatActivityData(record.activityData)}  EF = <strong>${record.tco2e.toFixed(1)} tCOe</strong>
              </div>
            </div>
            <div class="lineage-section">
              <div class="lineage-section-title"><i class="fa-light fa-shield-check"></i> Validation</div>
              <div class="lineage-validation">
                <div class="lineage-check"><i class="fa-solid fa-check-circle"></i> Scope attribution verified</div>
                <div class="lineage-check"><i class="fa-solid fa-check-circle"></i> No double-counting detected</div>
                <div class="lineage-check"><i class="fa-solid fa-check-circle"></i> Boundary: Operational Control applied</div>
              </div>
            </div>
          </div>
        </div>
      `;
    }
    
    // Initialize sample data
    function initBreakdownData() {
      breakdownData = [
        { id: '1', entity: 'HQ Building', entityId: 'hq-building', activity: 'Electricity', scope: 2, category: null, activityData: { value: 245000, unit: 'kWh' }, tco2e: 89.2, efSource: 'eGRID 2024', quality: 'High', dataSource: 'Utility Invoice', specificityScore: 92, efValue: '0.364 kg COe/kWh' },
        { id: '2', entity: 'HQ Building', entityId: 'hq-building', activity: 'Natural Gas', scope: 1, category: null, activityData: { value: 12450, unit: 'therms' }, tco2e: 66.1, efSource: 'EPA 2024', quality: 'High', dataSource: 'Utility Invoice', specificityScore: 95, efValue: '5.31 kg COe/therm' },
        { id: '3', entity: 'Manufacturing', entityId: 'manufacturing', activity: 'Electricity', scope: 2, category: null, activityData: { value: 890000, unit: 'kWh' }, tco2e: 323.9, efSource: 'eGRID 2024', quality: 'High', dataSource: 'Smart Meter', specificityScore: 98, efValue: '0.661 kg COe/kWh' },
        { id: '4', entity: 'Distribution', entityId: 'distribution', activity: 'Fleet Vehicles', scope: 1, category: null, activityData: { value: 15200, unit: 'gallons' }, tco2e: 135.1, efSource: 'EPA 2024', quality: 'High', dataSource: 'Fleet Fuel Cards', specificityScore: 94, efValue: '8.89 kg COe/gal' },
        { id: '5', entity: 'All Entities', entityId: 'all-entities', activity: 'Purchased Goods', scope: 3, category: 1, activityData: { value: 2400000, unit: '$' }, tco2e: 412.0, efSource: 'EEIO 2024', quality: 'Medium', dataSource: 'AP/Procurement', specificityScore: 62, efValue: '0.172 kg COe/$' },
        { id: '6', entity: 'Manufacturing', entityId: 'manufacturing', activity: 'Natural Gas', scope: 1, category: null, activityData: { value: 45000, unit: 'therms' }, tco2e: 238.9, efSource: 'EPA 2024', quality: 'High', dataSource: 'Utility Invoice', specificityScore: 96, efValue: '5.31 kg COe/therm' },
        { id: '7', entity: 'HQ Building', entityId: 'hq-building', activity: 'Business Travel', scope: 3, category: 6, activityData: { value: 125000, unit: 'miles' }, tco2e: 28.5, efSource: 'DEFRA 2024', quality: 'High', dataSource: 'Travel System', specificityScore: 88, efValue: '0.228 kg COe/mile' },
        { id: '8', entity: 'Distribution', entityId: 'distribution', activity: 'Waste Disposal', scope: 3, category: 5, activityData: { value: 450, unit: 'tons' }, tco2e: 67.2, efSource: 'EPA 2024', quality: 'Medium', dataSource: 'Waste Vendor', specificityScore: 75, efValue: '0.149 tCOe/ton' },
        { id: '9', entity: 'Manufacturing', entityId: 'manufacturing', activity: 'Employee Commuting', scope: 3, category: 7, activityData: { value: 89000, unit: 'miles' }, tco2e: 18.3, efSource: 'DEFRA 2024', quality: 'Medium', dataSource: 'Survey', specificityScore: 70, efValue: '0.206 kg COe/mile' },
        { id: '10', entity: 'HQ Building', entityId: 'hq-building', activity: 'Capital Goods', scope: 3, category: 2, activityData: { value: 850000, unit: '$' }, tco2e: 145.2, efSource: 'EEIO 2024', quality: 'Medium', dataSource: 'Finance', specificityScore: 65, efValue: '0.171 kg COe/$' },
        { id: '11', entity: 'Distribution', entityId: 'distribution', activity: 'Electricity', scope: 2, category: null, activityData: { value: 125000, unit: 'kWh' }, tco2e: 45.5, efSource: 'eGRID 2024', quality: 'High', dataSource: 'Utility Invoice', specificityScore: 91, efValue: '0.364 kg COe/kWh' },
        { id: '12', entity: 'All Entities', entityId: 'all-entities', activity: 'Upstream Transport', scope: 3, category: 4, activityData: { value: 320000, unit: 'ton-miles' }, tco2e: 89.6, efSource: 'EPA 2024', quality: 'Medium', dataSource: 'Logistics', specificityScore: 78, efValue: '0.280 kg COe/ton-mile' },
        { id: '13', entity: 'Manufacturing', entityId: 'manufacturing', activity: 'Refrigerants', scope: 1, category: null, activityData: { value: 125, unit: 'kg' }, tco2e: 156.3, efSource: 'EPA 2024', quality: 'High', dataSource: 'Maintenance Records', specificityScore: 93, efValue: '1250 kg COe/kg' },
        { id: '14', entity: 'HQ Building', entityId: 'hq-building', activity: 'T&D Losses', scope: 3, category: 3, activityData: { value: 24500, unit: 'kWh' }, tco2e: 8.9, efSource: 'eGRID 2024', quality: 'High', dataSource: 'Calculated', specificityScore: 85, efValue: '0.364 kg COe/kWh' },
        { id: '15', entity: 'Distribution', entityId: 'distribution', activity: 'Downstream Transport', scope: 3, category: 9, activityData: { value: 180000, unit: 'ton-miles' }, tco2e: 50.4, efSource: 'EPA 2024', quality: 'Medium', dataSource: 'Logistics', specificityScore: 72, efValue: '0.280 kg COe/ton-mile' },
        { id: '16', entity: 'Manufacturing', entityId: 'manufacturing', activity: 'Waste Disposal', scope: 3, category: 5, activityData: { value: 320, unit: 'tons' }, tco2e: 47.7, efSource: 'EPA 2024', quality: 'Medium', dataSource: 'Waste Vendor', specificityScore: 76, efValue: '0.149 tCOe/ton' },
        { id: '17', entity: 'All Entities', entityId: 'all-entities', activity: 'Use of Products', scope: 3, category: 11, activityData: { value: 1500000, unit: '$' }, tco2e: 255.0, efSource: 'EEIO 2024', quality: 'Low', dataSource: 'Estimated', specificityScore: 55, efValue: '0.170 kg COe/$' },
        { id: '18', entity: 'HQ Building', entityId: 'hq-building', activity: 'Employee Commuting', scope: 3, category: 7, activityData: { value: 45000, unit: 'miles' }, tco2e: 9.3, efSource: 'DEFRA 2024', quality: 'Medium', dataSource: 'Survey', specificityScore: 68, efValue: '0.206 kg COe/mile' },
        { id: '19', entity: 'Distribution', entityId: 'distribution', activity: 'Natural Gas', scope: 1, category: null, activityData: { value: 8500, unit: 'therms' }, tco2e: 45.1, efSource: 'EPA 2024', quality: 'High', dataSource: 'Utility Invoice', specificityScore: 92, efValue: '5.31 kg COe/therm' },
        { id: '20', entity: 'Manufacturing', entityId: 'manufacturing', activity: 'Business Travel', scope: 3, category: 6, activityData: { value: 98000, unit: 'miles' }, tco2e: 22.3, efSource: 'DEFRA 2024', quality: 'High', dataSource: 'Travel System', specificityScore: 87, efValue: '0.228 kg COe/mile' },
        { id: '21', entity: 'All Entities', entityId: 'all-entities', activity: 'End-of-Life', scope: 3, category: 12, activityData: { value: 280, unit: 'tons' }, tco2e: 41.7, efSource: 'EPA 2024', quality: 'Medium', dataSource: 'Waste Vendor', specificityScore: 73, efValue: '0.149 tCOe/ton' },
        { id: '22', entity: 'HQ Building', entityId: 'hq-building', activity: 'Upstream Leased Assets', scope: 3, category: 8, activityData: { value: 125000, unit: 'kWh' }, tco2e: 45.5, efSource: 'eGRID 2024', quality: 'High', dataSource: 'Lease Agreement', specificityScore: 90, efValue: '0.364 kg COe/kWh' },
        { id: '23', entity: 'Distribution', entityId: 'distribution', activity: 'Processing of Products', scope: 3, category: 10, activityData: { value: 650000, unit: '$' }, tco2e: 110.5, efSource: 'EEIO 2024', quality: 'Medium', dataSource: 'Finance', specificityScore: 67, efValue: '0.170 kg COe/$' },
        { id: '24', entity: 'Manufacturing', entityId: 'manufacturing', activity: 'Capital Goods', scope: 3, category: 2, activityData: { value: 1200000, unit: '$' }, tco2e: 205.2, efSource: 'EEIO 2024', quality: 'Medium', dataSource: 'Finance', specificityScore: 64, efValue: '0.171 kg COe/$' },
        { id: '25', entity: 'All Entities', entityId: 'all-entities', activity: 'Franchises', scope: 3, category: 14, activityData: { value: 450000, unit: '$' }, tco2e: 76.5, efSource: 'EEIO 2024', quality: 'Low', dataSource: 'Estimated', specificityScore: 58, efValue: '0.170 kg COe/$' },
        { id: '26', entity: 'HQ Building', entityId: 'hq-building', activity: 'Downstream Leased Assets', scope: 3, category: 13, activityData: { value: 95000, unit: 'kWh' }, tco2e: 34.6, efSource: 'eGRID 2024', quality: 'High', dataSource: 'Lease Agreement', specificityScore: 89, efValue: '0.364 kg COe/kWh' },
        { id: '27', entity: 'Distribution', entityId: 'distribution', activity: 'Investments', scope: 3, category: 15, activityData: { value: 320000, unit: '$' }, tco2e: 54.4, efSource: 'EEIO 2024', quality: 'Low', dataSource: 'Finance', specificityScore: 60, efValue: '0.170 kg COe/$' },
        { id: '28', entity: 'Manufacturing', entityId: 'manufacturing', activity: 'Refrigerants', scope: 1, category: null, activityData: { value: 85, unit: 'kg' }, tco2e: 106.3, efSource: 'EPA 2024', quality: 'High', dataSource: 'Maintenance Records', specificityScore: 94, efValue: '1250 kg COe/kg' },
        { id: '29', entity: 'All Entities', entityId: 'all-entities', activity: 'Purchased Goods', scope: 3, category: 1, activityData: { value: 1800000, unit: '$' }, tco2e: 309.0, efSource: 'EEIO 2024', quality: 'Medium', dataSource: 'AP/Procurement', specificityScore: 63, efValue: '0.172 kg COe/$' },
        { id: '30', entity: 'HQ Building', entityId: 'hq-building', activity: 'Electricity', scope: 2, category: null, activityData: { value: 98000, unit: 'kWh' }, tco2e: 35.7, efSource: 'eGRID 2024', quality: 'High', dataSource: 'Utility Invoice', specificityScore: 93, efValue: '0.364 kg COe/kWh' }
      ];
      
      applyBreakdownFilters();
    }
    
    // Format activity data
    function formatActivityData(activityData) {
      if (activityData.unit === '$') {
        if (activityData.value >= 1000000) {
          return `$${(activityData.value / 1000000).toFixed(1)}M`;
        } else if (activityData.value >= 1000) {
          return `$${(activityData.value / 1000).toFixed(0)}k`;
        }
        return `$${activityData.value.toLocaleString()}`;
      }
      
      if (activityData.value >= 1000000) {
        return `${(activityData.value / 1000000).toFixed(1)}M ${activityData.unit}`;
      } else if (activityData.value >= 1000) {
        return `${(activityData.value / 1000).toFixed(1)}k ${activityData.unit}`;
      }
      return `${activityData.value.toLocaleString()} ${activityData.unit}`;
    }
    
    // Apply filters
    function applyBreakdownFilters() {
      let filtered = [...breakdownData];
      
      if (breakdownState.search) {
        const searchLower = breakdownState.search.toLowerCase();
        filtered = filtered.filter(record => 
          record.entity.toLowerCase().includes(searchLower) ||
          record.activity.toLowerCase().includes(searchLower) ||
          record.efSource.toLowerCase().includes(searchLower)
        );
      }
      
      if (breakdownState.entityFilter !== 'all') {
        filtered = filtered.filter(r => r.entityId === breakdownState.entityFilter);
      }
      
      if (breakdownState.scopeFilter !== 'all') {
        filtered = filtered.filter(r => r.scope === parseInt(breakdownState.scopeFilter));
      }
      
      if (breakdownState.scopeFilter === '3' && breakdownState.categoryFilter !== 'all') {
        filtered = filtered.filter(r => r.category === parseInt(breakdownState.categoryFilter));
      }
      
      if (breakdownState.emissionFilter !== 'all') {
        switch(breakdownState.emissionFilter) {
          case 'high':
            filtered = filtered.filter(r => r.tco2e > 100);
            break;
          case 'medium':
            filtered = filtered.filter(r => r.tco2e >= 10 && r.tco2e <= 100);
            break;
          case 'low':
            filtered = filtered.filter(r => r.tco2e < 10);
            break;
        }
      }
      
      if (breakdownState.qualityFilter !== 'all') {
        filtered = filtered.filter(r => r.quality === breakdownState.qualityFilter);
      }
      
      filteredData = filtered;
      applyBreakdownSorting();
    }
    
    // Apply sorting
    function applyBreakdownSorting() {
      sortedData = [...filteredData].sort((a, b) => {
        let aVal = a[breakdownState.sortColumn];
        let bVal = b[breakdownState.sortColumn];
        
        if (breakdownState.sortColumn === 'activityData') {
          aVal = a.activityData.value;
          bVal = b.activityData.value;
        }
        
        if (typeof aVal === 'number' && typeof bVal === 'number') {
          return breakdownState.sortDirection === 'asc' ? aVal - bVal : bVal - aVal;
        }
        
        if (typeof aVal === 'string') {
          aVal = aVal.toLowerCase();
          bVal = bVal.toLowerCase();
        }
        
        if (aVal < bVal) return breakdownState.sortDirection === 'asc' ? -1 : 1;
        if (aVal > bVal) return breakdownState.sortDirection === 'asc' ? 1 : -1;
        return 0;
      });
      
      applyBreakdownGrouping();
    }
    
    function sortBreakdownTable(column) {
      if (breakdownState.sortColumn === column) {
        breakdownState.sortDirection = breakdownState.sortDirection === 'asc' ? 'desc' : 'asc';
      } else {
        breakdownState.sortColumn = column;
        breakdownState.sortDirection = 'asc';
      }
      
      document.querySelectorAll('#breakdown-table th.sortable').forEach(th => {
        th.classList.remove('sorted-asc', 'sorted-desc');
        if (th.dataset.sort === column) {
          th.classList.add(`sorted-${breakdownState.sortDirection}`);
        }
      });
      
      applyBreakdownSorting();
    }
    
    // Apply grouping
    function applyBreakdownGrouping() {
      if (breakdownState.groupBy === 'none') {
        groupedData = sortedData.map(r => ({ type: 'row', data: r }));
      } else {
        const groups = {};
        
        sortedData.forEach(record => {
          let groupKey;
          switch(breakdownState.groupBy) {
            case 'entity':
              groupKey = record.entity;
              break;
            case 'scope':
              groupKey = `Scope ${record.scope}`;
              break;
            case 'category':
              groupKey = record.category ? `3.${record.category}` : `Scope ${record.scope}`;
              break;
          }
          
          if (!groups[groupKey]) {
            groups[groupKey] = [];
          }
          groups[groupKey].push(record);
        });
        
        groupedData = [];
        Object.keys(groups).sort().forEach(groupKey => {
          const groupRecords = groups[groupKey];
          const groupTotal = groupRecords.reduce((sum, r) => sum + r.tco2e, 0);
          
          groupedData.push({
            type: 'group-header',
            key: groupKey,
            count: groupRecords.length,
            total: groupTotal,
            collapsed: breakdownState.collapsedGroups[groupKey] || false
          });
          
          groupRecords.forEach(record => {
            groupedData.push({ type: 'row', data: record, groupKey });
          });
        });
      }
      
      applyBreakdownPagination();
    }
    
    function toggleBreakdownGroup(groupKey) {
      breakdownState.collapsedGroups[groupKey] = !breakdownState.collapsedGroups[groupKey];
      applyBreakdownGrouping();
    }
    
    // Apply pagination
    function applyBreakdownPagination() {
      const start = (breakdownState.currentPage - 1) * breakdownState.pageSize;
      const end = start + breakdownState.pageSize;
      paginatedData = groupedData.slice(start, end);
      
      updateBreakdownPaginationUI();
      renderBreakdownTable();
    }
    
    function changeBreakdownPage(direction) {
      const totalPages = Math.ceil(groupedData.length / breakdownState.pageSize);
      
      if (direction === 'next' && breakdownState.currentPage < totalPages) {
        breakdownState.currentPage++;
      } else if (direction === 'prev' && breakdownState.currentPage > 1) {
        breakdownState.currentPage--;
      }
      
      applyBreakdownPagination();
    }
    
    function updateBreakdownPaginationUI() {
      const totalPages = Math.ceil(groupedData.length / breakdownState.pageSize);
      const totalRecords = groupedData.filter(g => g.type === 'row').length;
      
      const currentPageEl = document.getElementById('breakdown-current-page');
      const totalPagesEl = document.getElementById('breakdown-total-pages');
      const prevBtn = document.getElementById('breakdown-prev-page');
      const nextBtn = document.getElementById('breakdown-next-page');
      
      if (currentPageEl) currentPageEl.textContent = breakdownState.currentPage;
      if (totalPagesEl) totalPagesEl.textContent = totalPages;
      if (prevBtn) prevBtn.disabled = breakdownState.currentPage === 1;
      if (nextBtn) nextBtn.disabled = breakdownState.currentPage >= totalPages;
      
      const showingCountEl = document.getElementById('breakdown-showing-count');
      const totalCountEl = document.getElementById('breakdown-total-count');
      const totalEmissionsEl = document.getElementById('breakdown-total-emissions');
      const avgEmissionsEl = document.getElementById('breakdown-avg-emissions');
      
      if (showingCountEl) {
        showingCountEl.textContent = Math.min(breakdownState.pageSize, totalRecords - (breakdownState.currentPage - 1) * breakdownState.pageSize);
      }
      if (totalCountEl) totalCountEl.textContent = totalRecords;
      
      const visibleTotal = filteredData.reduce((sum, r) => sum + r.tco2e, 0);
      const visibleAvg = filteredData.length > 0 ? visibleTotal / filteredData.length : 0;
      
      if (totalEmissionsEl) totalEmissionsEl.textContent = visibleTotal.toFixed(1);
      if (avgEmissionsEl) avgEmissionsEl.textContent = visibleAvg.toFixed(2);
    }
    
    // Render table
    function renderBreakdownTable() {
      const tbody = document.getElementById('breakdown-tbody');
      if (!tbody) return;
      
      if (paginatedData.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="8" class="breakdown-loading">
              <i class="fa-light fa-inbox"></i>
              <div>No emission records match your filters</div>
            </td>
          </tr>
        `;
        return;
      }
      
      tbody.innerHTML = paginatedData.map(item => {
        if (item.type === 'group-header') {
          return `
            <tr class="breakdown-group-header ${item.collapsed ? 'collapsed' : ''}" 
                onclick="toggleBreakdownGroup('${item.key.replace(/'/g, "\\'")}')">
              <td colspan="8" style="padding: 12px 16px;">
                <i class="fa-light fa-chevron-down group-toggle"></i>
                <strong>${item.key}</strong>
                <span style="color: var(--ghg-text-muted); margin-left: 12px;">
                  ${item.count} records  ${item.total.toFixed(1)} tCOe
                </span>
              </td>
            </tr>
          `;
        }
        
        if (item.groupKey && breakdownState.collapsedGroups[item.groupKey]) {
          return '';
        }
        
        const record = item.data;
        const indentClass = item.groupKey ? 'breakdown-group-row' : '';
        const scopeBadgeClass = `badge-scope-${record.scope}`;
        const qualityBadgeClass = record.quality === 'High' ? 'badge-success' : record.quality === 'Medium' ? 'badge-warning' : 'badge-danger';
        
        return `
          <tr class="expandable-row ${indentClass}" 
              onclick="toggleRow(this)" 
              data-record-id="${record.id}">
            <td><i class="fa-light fa-chevron-right expand-icon"></i></td>
            <td>${record.entity}</td>
            <td>${record.activity}</td>
            <td><span class="badge ${scopeBadgeClass}">Scope ${record.scope}</span></td>
            <td class="numeric">${formatActivityData(record.activityData)}</td>
            <td class="numeric">${record.tco2e.toFixed(1)}</td>
            <td>${record.efSource}</td>
            <td><span class="badge ${qualityBadgeClass}">${record.quality}</span></td>
          </tr>
          <tr class="expanded-content" style="display: none;">
            <td colspan="8">
              ${generateLineageHTML(record)}
            </td>
          </tr>
        `;
      }).join('');
    }
    
    // Initialize breakdown view
    function initBreakdownView() {
      if (breakdownData.length === 0) {
        initBreakdownData();
      }
      
      // Search
      const searchInput = document.getElementById('breakdown-search');
      if (searchInput) {
        let searchTimeout;
        searchInput.addEventListener('input', (e) => {
          clearTimeout(searchTimeout);
          searchTimeout = setTimeout(() => {
            breakdownState.search = e.target.value;
            breakdownState.currentPage = 1;
            applyBreakdownFilters();
          }, 300);
        });
      }
      
      // Filters
      ['entity', 'scope', 'category', 'emission', 'quality'].forEach(filterType => {
        const filterEl = document.getElementById(`breakdown-${filterType}-filter`);
        if (filterEl) {
          filterEl.addEventListener('change', (e) => {
            breakdownState[`${filterType}Filter`] = e.target.value;
            breakdownState.currentPage = 1;
            
            if (filterType === 'scope') {
              const categoryFilter = document.getElementById('breakdown-category-filter');
              if (categoryFilter) {
                categoryFilter.style.display = e.target.value === '3' ? 'block' : 'none';
              }
            }
            
            applyBreakdownFilters();
          });
        }
      });
      
      // Clear filters
      const clearBtn = document.getElementById('breakdown-clear-filters');
      if (clearBtn) {
        clearBtn.addEventListener('click', () => {
          breakdownState.search = '';
          breakdownState.entityFilter = 'all';
          breakdownState.scopeFilter = 'all';
          breakdownState.categoryFilter = 'all';
          breakdownState.emissionFilter = 'all';
          breakdownState.qualityFilter = 'all';
          breakdownState.currentPage = 1;
          
          document.getElementById('breakdown-search').value = '';
          document.getElementById('breakdown-entity-filter').value = 'all';
          document.getElementById('breakdown-scope-filter').value = 'all';
          document.getElementById('breakdown-category-filter').value = 'all';
          document.getElementById('breakdown-emission-filter').value = 'all';
          document.getElementById('breakdown-quality-filter').value = 'all';
          document.getElementById('breakdown-category-filter').style.display = 'none';
          
          applyBreakdownFilters();
        });
      }
      
      // Group by
      const groupBySelect = document.getElementById('breakdown-group-by');
      if (groupBySelect) {
        groupBySelect.addEventListener('change', (e) => {
          breakdownState.groupBy = e.target.value;
          breakdownState.currentPage = 1;
          applyBreakdownGrouping();
        });
      }
      
      // Sortable columns
      document.querySelectorAll('#breakdown-table th.sortable').forEach(th => {
        th.addEventListener('click', () => {
          sortBreakdownTable(th.dataset.sort);
        });
      });
      
      // Pagination
      document.getElementById('breakdown-prev-page')?.addEventListener('click', () => {
        changeBreakdownPage('prev');
      });
      document.getElementById('breakdown-next-page')?.addEventListener('click', () => {
        changeBreakdownPage('next');
      });
    }
    
    // Initialize when breakdown tab is shown
    document.addEventListener('DOMContentLoaded', () => {
      initEfDraggableTables();
    });

    document.addEventListener('DOMContentLoaded', () => {
      // Hook into existing tab switching
      const breakdownTab = document.querySelector('[data-tab="breakdown"]');
      if (breakdownTab) {
        breakdownTab.addEventListener('click', () => {
          setTimeout(() => {
            if (breakdownData.length === 0) {
              initBreakdownView();
            }
          }, 100);
        });
      }
      
      // Also initialize if breakdown tab is already active on load
      const breakdownContent = document.getElementById('tab-breakdown');
      if (breakdownContent && breakdownContent.classList.contains('active')) {
        setTimeout(() => {
          if (breakdownData.length === 0) {
            initBreakdownView();
          }
        }, 100);
      }
    });
    
    // ============================================
    // Expandable Rows
    // ============================================
    
    function toggleRow(row) {
      row.classList.toggle('expanded');
    }
    
    // ============================================
    // Create Inventory Wizard
    // ============================================
    
    let currentWizardStep = 1;
    let inventoryIsLocked = false;
    const totalWizardSteps = 5;
    
    function openCreateInventoryModal() {
      switchView('create-inventory');
      currentWizardStep = 1;
      updateWizardUI();
    }
    
    function closeCreateInventoryModal() {
      switchView('inventory-results');
      currentWizardStep = 1;
      updateWizardUI();
    }

    var _efVendorsTooltipProgrammatic = false;
    var _efVendorsTooltipHideTimeout = null;

    function showEfVendorsTooltip(wrap) {
      var el = document.getElementById('ef-vendors-global-tooltip');
      if (!el || !wrap) return;
      var r = wrap.getBoundingClientRect();
      var gapAbove = 24;
      el.style.left = (r.left + r.width / 2) + 'px';
      el.style.top = (r.top - gapAbove) + 'px';
      el.style.transform = 'translate(-50%, -100%)';
      el.classList.add('visible');
    }

    function hideEfVendorsTooltip() {
      var el = document.getElementById('ef-vendors-global-tooltip');
      if (el) el.classList.remove('visible');
    }

    function toggleEfSet(labelEl, e) {
      if (e) { e.preventDefault(); e.stopPropagation(); }
      const input = labelEl.querySelector('.toggle-switch-input');
      if (!input) return;
      const table = labelEl.closest('.ef-prefs-table-vendors');
      if (table) {
        // Vendors published: only one toggle can be on; both can be off
        const willBeOn = !input.checked;
        if (willBeOn) {
          table.querySelectorAll('.toggle-switch').forEach((other) => {
            if (other !== labelEl) {
              const otherInput = other.querySelector('.toggle-switch-input');
              if (otherInput) { otherInput.checked = false; }
              other.classList.remove('on');
              const wrap = other.closest('.ef-vendors-toggle-wrap');
              if (wrap) {
                _efVendorsTooltipProgrammatic = true;
                showEfVendorsTooltip(wrap);
                clearTimeout(_efVendorsTooltipHideTimeout);
                _efVendorsTooltipHideTimeout = setTimeout(function() {
                  hideEfVendorsTooltip();
                  _efVendorsTooltipProgrammatic = false;
                }, 4000);
              }
            }
          });
        }
      }
      input.checked = !input.checked;
      labelEl.classList.toggle('on', input.checked);
    }

    function efVendorsToggleWrapEnter(wrap) {
      if (!wrap) return;
      const label = wrap.querySelector('.toggle-switch');
      if (label && !label.classList.contains('on')) {
        clearTimeout(wrap._efTooltipTimeout);
        wrap._efTooltipTimeout = null;
        showEfVendorsTooltip(wrap);
      }
    }

    function efVendorsToggleWrapLeave(wrap) {
      if (!wrap) return;
      hideEfVendorsTooltip();
      clearTimeout(_efVendorsTooltipHideTimeout);
      _efVendorsTooltipHideTimeout = null;
      _efVendorsTooltipProgrammatic = false;
    }

    function revertEfPrefsToDefault() {
      const vendorTable = document.querySelector('#view-create-inventory .ef-prefs-table-vendors');
      if (vendorTable) {
        vendorTable.querySelectorAll('.toggle-switch').forEach((label, index) => {
          const input = label.querySelector('.toggle-switch-input');
          if (input) {
            input.checked = index === 0;
            label.classList.toggle('on', index === 0);
          }
        });
      }
      document.querySelectorAll('#view-create-inventory .ef-prefs-table:not(.ef-prefs-table-vendors) .toggle-switch').forEach((label) => {
        const input = label.querySelector('.toggle-switch-input');
        if (input) {
          input.checked = true;
          label.classList.add('on');
        }
      });
      document.getElementById('ef-prefs-category').value = 'electric';
      switchEfPrefsCategory('electric');
    }

    function switchEfPrefsCategory(value) {
      const electric = document.getElementById('ef-prefs-content-electric');
      const stationary = document.getElementById('ef-prefs-content-stationary');
      if (!electric || !stationary) return;
      if (value === 'stationary') {
        electric.classList.add('hidden');
        stationary.classList.remove('hidden');
        stationary.style.display = 'block';
      } else {
        stationary.style.display = 'none';
        stationary.classList.add('hidden');
        electric.classList.remove('hidden');
      }
    }

    function initEfDraggableTables() {
      function attachDragDrop(container, rowSelector, isGrid) {
        let draggedRow = null;
        let draggedGeography = null;
        container.addEventListener('dragstart', function(e) {
          const row = e.target.closest(rowSelector);
          if (!row) return;
          if (isGrid) {
            if (!row.querySelector('.ef-prefs-grid-cell-draggable') || !row.getAttribute('data-geography')) return;
          } else {
            if (!row.draggable) return;
          }
          draggedRow = row;
          draggedGeography = row.getAttribute('data-geography');
          e.dataTransfer.effectAllowed = 'move';
          e.dataTransfer.setData('text/plain', '');
          if (isGrid) {
            var wrapper = document.createElement('div');
            wrapper.className = 'ef-drag-image-row';
            for (var i = 1; i <= 3; i++) {
              var cell = row.children[i];
              if (cell) {
                var clone = cell.cloneNode(true);
                wrapper.appendChild(clone);
              }
            }
            document.body.appendChild(wrapper);
            e.dataTransfer.setDragImage(wrapper, 0, 0);
            setTimeout(function() { wrapper.remove(); }, 0);
          } else {
            var dragImage = row.querySelector('.ef-prefs-grid-cell') || row;
            if (dragImage) e.dataTransfer.setDragImage(dragImage, 0, 0);
          }
          setTimeout(function() { row.style.opacity = '0.4'; }, 0);
        });
        container.addEventListener('dragend', function(e) {
          const row = e.target.closest(rowSelector);
          if (row) row.style.opacity = '';
          draggedRow = null;
          draggedGeography = null;
          container.querySelectorAll(rowSelector + '.drag-over').forEach((r) => r.classList.remove('drag-over'));
        });
        container.addEventListener('dragover', function(e) {
          e.preventDefault();
          const row = e.target.closest(rowSelector);
          if (!row || row === draggedRow) return;
          const rowDraggable = isGrid ? row.getAttribute('data-geography') : row.draggable;
          if (!rowDraggable || row.getAttribute('data-geography') !== draggedGeography) {
            e.dataTransfer.dropEffect = 'none';
            row.classList.remove('drag-over');
            return;
          }
          e.dataTransfer.dropEffect = 'move';
          row.classList.add('drag-over');
        });
        container.addEventListener('dragleave', function(e) {
          const row = e.target.closest(rowSelector);
          if (row) row.classList.remove('drag-over');
        });
        container.addEventListener('drop', function(e) {
          e.preventDefault();
          const targetRow = e.target.closest(rowSelector);
          const targetValid = isGrid ? (targetRow && targetRow.getAttribute('data-geography')) : (targetRow && targetRow.draggable);
          if (!targetValid || !draggedRow || targetRow === draggedRow) return;
          if (targetRow.getAttribute('data-geography') !== draggedGeography) {
            targetRow.classList.remove('drag-over');
            return;
          }
          targetRow.classList.remove('drag-over');
          const allRows = Array.from(container.querySelectorAll(rowSelector));
          const dragIndex = allRows.indexOf(draggedRow);
          const targetIndex = allRows.indexOf(targetRow);
          if (dragIndex === -1 || targetIndex === -1) return;
          if (targetIndex < dragIndex) {
            container.insertBefore(draggedRow, targetRow);
          } else {
            container.insertBefore(draggedRow, targetRow.nextSibling);
          }
          normalizeEfGeoCells(container, rowSelector);
        });
      }
      document.querySelectorAll('.ef-prefs-table-draggable tbody').forEach((tbody) => {
        attachDragDrop(tbody, 'tr', false);
      });
      const gridBody = document.getElementById('ef-prefs-grid-body');
      if (gridBody) {
        attachDragDrop(gridBody, '.ef-prefs-grid-row', true);
      }
    }

    function normalizeEfGeoCells(container, rowSelector) {
      const rowSel = rowSelector || 'tr[draggable="true"]';
      const rows = Array.from(container.querySelectorAll(rowSel));
      const firstCellSelector = rowSelector === '.ef-prefs-grid-row' ? '.ef-prefs-grid-cell:first-child' : 'td:first-child';
      let prevGeo = null;
      rows.forEach((row) => {
        const geo = row.getAttribute('data-geography');
        const firstCell = row.querySelector ? row.querySelector(firstCellSelector) : row.children[0];
        if (!firstCell) return;
        if (geo !== prevGeo) {
          firstCell.textContent = geo;
          firstCell.classList.remove('ef-geo-merged');
          prevGeo = geo;
        } else {
          firstCell.textContent = '';
          firstCell.classList.add('ef-geo-merged');
        }
      });
    }

    // ============================================
    // Activity Hierarchy - Decoupled Architecture
    // ============================================
    
    function toggleActivityExpand(element) {
      const activityRow = element.closest('.activity-row');
      if (activityRow) {
        activityRow.classList.toggle('expanded');
      }
    }
    
    function navigateToCalcMethodModule() {
      // In a real app, this would navigate to the calculation method module
      // For prototype, show an alert explaining the decoupled behavior
      alert('Navigation to Calculation Method Module\n\n' +
            'In the decoupled architecture:\n' +
            ' EF assignments are managed in the Calc Method module\n' +
            ' Changes made there apply to all inventories using this method\n' +
            ' This ensures consistency and auditability across inventories\n\n' +
            'This would open: /platform/calculation-methods/ra-standard-v2.1');
    }
    
    function wizardNextStep() {
      if (currentWizardStep < totalWizardSteps) {
        currentWizardStep++;
        updateWizardUI();
      }
    }
    
    function wizardPrevStep() {
      if (currentWizardStep > 1) {
        currentWizardStep--;
        updateWizardUI();
      }
    }
    
    function updateWizardUI() {
      // Update stepper indicators
      const steps = document.querySelectorAll('#inventory-wizard-stepper .wizard-step');
      steps.forEach((step, index) => {
        const stepNum = index + 1;
        step.classList.remove('active', 'completed');
        if (stepNum === currentWizardStep) {
          step.classList.add('active');
        } else if (stepNum < currentWizardStep) {
          step.classList.add('completed');
        }
      });
      
      // Update step content visibility
      const contents = document.querySelectorAll('#view-create-inventory .wizard-step-content');
      contents.forEach((content) => {
        const stepNum = parseInt(content.dataset.step);
        content.classList.toggle('active', stepNum === currentWizardStep);
      });
      
      // Update navigation buttons
      const backBtn = document.getElementById('wizard-back-btn');
      const nextBtn = document.getElementById('wizard-next-btn');
      const createBtn = document.getElementById('wizard-create-btn');
      
      backBtn.style.display = currentWizardStep > 1 ? 'inline-flex' : 'none';
      nextBtn.style.display = currentWizardStep < totalWizardSteps ? 'inline-flex' : 'none';
      createBtn.style.display = currentWizardStep === totalWizardSteps ? 'inline-flex' : 'none';
      
      // Update review section if on step 5
      if (currentWizardStep === 5) {
        updateReviewSection();
      }
    }
    
    function updateReviewSection() {
      // Update inventory name
      const nameInput = document.getElementById('inventory-name');
      if (nameInput) {
        document.getElementById('review-inventory-name').textContent = nameInput.value || 'Untitled Inventory';
      }
      
      // Update consolidation approach
      const consolidation = document.querySelector('input[name="consolidation"]:checked');
      if (consolidation) {
        const labels = { 'operational': 'Operational Control', 'financial': 'Financial Control', 'equity': 'Equity Share' };
        document.getElementById('review-consolidation').textContent = labels[consolidation.value] || consolidation.value;
      }
      
      // Update GWP version
      const gwpSelect = document.getElementById('inventory-gwp');
      if (gwpSelect) {
        const selectedGwp = gwpSelect.options[gwpSelect.selectedIndex];
        document.getElementById('review-gwp').textContent = selectedGwp.text;
      }
      
      // Update gases covered
      const gasesSelect = document.getElementById('inventory-gases');
      if (gasesSelect) {
        const selectedGases = gasesSelect.options[gasesSelect.selectedIndex];
        document.getElementById('review-gases').textContent = selectedGases.text;
      }
      
      // Update calculation method from dropdown selector
      const methodSelect = document.getElementById('calc-method-select');
      if (methodSelect) {
        const selectedOption = methodSelect.options[methodSelect.selectedIndex];
        // The calculation method name is now shown in the new review card, 
        // no need to update old element that was removed
      }
    }

    // Activity Flyout functions
    function openActivityFlyout(activityId, btnEl) {
      const flyout = document.getElementById('activity-flyout');
      if (!flyout) return;

      // Get data from the row
      const row = btnEl.closest('tr');
      const activityName = row.querySelector('.activity-name')?.textContent || 'Activity';
      const scopeBadge = row.querySelector('.scope-badge');
      const scopeClass = scopeBadge?.classList.contains('scope-1') ? 'scope-1' : 
                         scopeBadge?.classList.contains('scope-2') ? 'scope-2' : 'scope-3';
      const scopeText = scopeBadge?.textContent || 'S1';

      // Update flyout header
      document.getElementById('flyout-title').textContent = activityName;
      const flyoutBadge = document.getElementById('flyout-scope');
      flyoutBadge.textContent = scopeText;
      flyoutBadge.className = 'flyout-scope-badge ' + scopeClass;

      // Update stats based on row data
      const entityCell = row.querySelector('.entity-count');
      if (entityCell) {
        const entityText = entityCell.childNodes[0].textContent.trim();
        const gapMatch = entityCell.querySelector('.gap-count')?.textContent.match(/\d+/);
        document.getElementById('flyout-entities').textContent = entityText;
        document.getElementById('flyout-gaps').textContent = gapMatch ? gapMatch[0] : '0';
      }

      const recordsCell = row.querySelectorAll('td.numeric')[1];
      if (recordsCell) {
        document.getElementById('flyout-records').textContent = recordsCell.textContent.trim();
      }

      const coveragePct = row.querySelector('.coverage-pct');
      if (coveragePct) {
        document.getElementById('flyout-coverage').textContent = coveragePct.textContent.trim();
      }

      // Show flyout
      flyout.classList.add('open');
      document.body.style.overflow = 'hidden';
    }

    function closeActivityFlyout() {
      const flyout = document.getElementById('activity-flyout');
      if (flyout) {
        flyout.classList.remove('open');
        document.body.style.overflow = '';
      }
    }

    // Close flyout on escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeActivityFlyout();
      }
    });

    function initMethodSelector() {
      const methodOptions = document.querySelectorAll('.method-option');
      methodOptions.forEach(option => {
        option.addEventListener('click', () => {
          methodOptions.forEach(o => o.classList.remove('selected'));
          option.classList.add('selected');
          
          // Update method summary based on selection
          const methodName = option.querySelector('.method-name')?.textContent || '';
          const summaryEl = document.querySelector('.method-summary');
          
          if (methodName.includes('CSRD')) {
            summaryEl.innerHTML = `
              <span class="summary-item"><i class="fa-light fa-layer-group"></i> GHG Protocol + ESRS E1</span>
              <span class="summary-item"><i class="fa-light fa-molecule"></i> CO, CH, NO</span>
              <span class="summary-item"><i class="fa-light fa-recycle"></i> TTW only</span>
              <span class="summary-item"><i class="fa-light fa-calendar"></i> AR6 100-year GWP</span>
            `;
          } else {
            summaryEl.innerHTML = `
              <span class="summary-item"><i class="fa-light fa-layer-group"></i> GHG Protocol</span>
              <span class="summary-item"><i class="fa-light fa-molecule"></i> Kyoto GHGs</span>
              <span class="summary-item"><i class="fa-light fa-recycle"></i> WTT + TTW</span>
              <span class="summary-item"><i class="fa-light fa-calendar"></i> AR5 100-year GWP</span>
            `;
          }
        });
      });
    }

    function initOperationalBoundaryTable() {
      const table = document.querySelector('.op-activities-table');
      if (!table) return;

      const updateSelectionSummary = () => {
        const allRows = table.querySelectorAll('tbody tr.scope-row');
        let total = 0, scope1 = 0, scope2 = 0, scope3 = 0;

        allRows.forEach(row => {
          const checkbox = row.querySelector('.activity-checkbox');
          if (checkbox && checkbox.checked) {
            total++;
            row.classList.remove('inactive');
            // Enable override select
            const overrideSelect = row.querySelector('.override-select');
            if (overrideSelect) {
              overrideSelect.disabled = inventoryIsLocked;
            }
            
            if (row.classList.contains('scope-1-row')) scope1++;
            else if (row.classList.contains('scope-2-row')) scope2++;
            else if (row.classList.contains('scope-3-row')) scope3++;
          } else {
            row.classList.add('inactive');
            // Disable override select
            const overrideSelect = row.querySelector('.override-select');
            if (overrideSelect) {
              overrideSelect.disabled = true;
            }
          }
        });

        // Update summary
        const countEl = document.querySelector('.op-selection-summary .selected-count strong');
        if (countEl) countEl.textContent = total;

        const scope1Chip = document.querySelector('.op-selection-summary .scope-chip.scope-1');
        const scope2Chip = document.querySelector('.op-selection-summary .scope-chip.scope-2');
        const scope3Chip = document.querySelector('.op-selection-summary .scope-chip.scope-3');
        
        if (scope1Chip) scope1Chip.textContent = `${scope1} Scope 1`;
        if (scope2Chip) scope2Chip.textContent = `${scope2} Scope 2`;
        if (scope3Chip) scope3Chip.textContent = `${scope3} Scope 3`;
      };

      // Attach event listeners to checkboxes
      const checkboxes = table.querySelectorAll('.activity-checkbox');
      checkboxes.forEach(cb => {
        cb.addEventListener('change', updateSelectionSummary);
      });

      // Initial update
      updateSelectionSummary();
    }

    function initEFOverrides() {
      const overrideSelects = document.querySelectorAll('.op-activities-table .ef-override-select');
      overrideSelects.forEach((select) => {
        select.addEventListener('change', () => {
          const activity = select.dataset.activity || 'activity';
          if (select.value === 'Default') {
            showToast(`Using default EF for ${activity}`, 'info');
          } else {
            showToast(`Override EF selected for ${activity}`, 'info');
          }
        });
      });
    }

    function setEFOverrideLockState(isLocked) {
      document.querySelectorAll('.op-activities-table .override-select').forEach((el) => {
        // Only lock selects for checked (selected) activities
        const row = el.closest('tr');
        const checkbox = row ? row.querySelector('.activity-checkbox') : null;
        if (checkbox && checkbox.checked) {
          el.disabled = isLocked;
        }
      });
    }

    function selectEntityGroup(groupId) {
      // Handle both old and new filter tabs
      document.querySelectorAll('.entity-group-btn').forEach(btn => btn.classList.remove('selected'));
      document.querySelectorAll('.filter-tab').forEach(tab => tab.classList.remove('active'));
      
      const targetBtn = document.querySelector(`.entity-group-btn[onclick*="'${groupId}'"]`);
      const targetTab = document.querySelector(`.filter-tab[onclick*="'${groupId}'"]`);
      
      if (targetBtn) {
        targetBtn.classList.add('selected');
      }
      if (targetTab) {
        targetTab.classList.add('active');
      }
      showToast(`Applied entity group: ${groupId}`, 'info');
    }

    function toggleHierarchy(headerEl) {
      // Handle new region cards
      const regionCard = headerEl.closest('.region-card');
      if (regionCard) {
        const children = regionCard.querySelector('.region-children');
        if (children) {
          const isExpanded = regionCard.classList.toggle('expanded');
          children.style.display = isExpanded ? 'block' : 'none';
        }
        return;
      }
      
      // Handle old hierarchy nodes
      const node = headerEl.closest('.hierarchy-node');
      if (!node) return;
      const children = node.querySelector('.hierarchy-children');
      if (!children) return;
      const isCollapsed = node.classList.toggle('collapsed');
      children.style.display = isCollapsed ? 'none' : 'block';
      const icon = headerEl.querySelector('.toggle-icon');
      if (icon) {
        icon.style.transform = isCollapsed ? 'rotate(0deg)' : 'rotate(90deg)';
      }
    }

    function toggleRegion(checkboxEl) {
      const node = checkboxEl.closest('.hierarchy-node');
      if (!node) return;
      node.querySelectorAll('.hierarchy-children .node-checkbox').forEach(cb => {
        cb.checked = checkboxEl.checked;
      });
    }

    function openEntityDetailsModal() {
      openModal('entity-details-modal');
    }

    function closeEntityDetailsModal() {
      closeModal('entity-details-modal');
    }

    function openCoverageDetailModal(activityId) {
      openModal('coverage-detail-modal');
      const title = document.querySelector('#coverage-detail-modal .modal-title');
      if (title && activityId) {
        title.textContent = `Coverage Details: ${activityId.replace(/-/g, ' ')}`;
      }
    }

    function closeCoverageDetailModal() {
      closeModal('coverage-detail-modal');
    }

    function openGapsModal() {
      openModal('gaps-modal');
    }

    function closeGapsModal() {
      closeModal('gaps-modal');
    }

    function openEFEntityModal(activityId, regionId) {
      openModal('ef-entity-modal');
      const title = document.querySelector('#ef-entity-modal .modal-title');
      if (title) {
        const regionLabel = regionId ? regionId.replace(/-/g, ' ') : 'all regions';
        const activityLabel = activityId ? activityId.replace(/-/g, ' ') : 'activity';
        title.textContent = `EF Assignment Details: ${activityLabel} (${regionLabel})`;
      }
    }

    function closeEFEntityModal() {
      closeModal('ef-entity-modal');
    }

    function openModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.classList.add('open');
      }
    }

    function closeModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.classList.remove('open');
      }
    }

    function filterModalList(modalId, query) {
      const modal = document.getElementById(modalId);
      if (!modal) return;
      const rows = modal.querySelectorAll('.list-body .list-row');
      rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(query.toLowerCase()) ? 'grid' : 'none';
      });
    }

    document.querySelectorAll('.modal-search input').forEach(input => {
      input.addEventListener('input', (event) => {
        const modal = event.target.closest('.modal-backdrop');
        if (modal) {
          filterModalList(modal.id, event.target.value.trim());
        }
      });
    });
    
    function toggleAllEntities(checkbox) {
      const entityCheckboxes = document.querySelectorAll('.entity-checkbox');
      entityCheckboxes.forEach(cb => {
        cb.checked = checkbox.checked;
      });
    }
    
    // ============================================
    // Lock Inventory Modal
    // ============================================
    
    function openLockModal() {
      document.getElementById('lock-inventory-modal').classList.add('open');
      document.getElementById('lock-confirm-checkbox').checked = false;
      updateLockButton();
    }
    
    function closeLockModal() {
      document.getElementById('lock-inventory-modal').classList.remove('open');
    }
    
    function updateLockButton() {
      const checkbox = document.getElementById('lock-confirm-checkbox');
      const button = document.getElementById('btn-confirm-lock');
      button.disabled = !checkbox.checked;
    }
    
    function lockInventory() {
      closeLockModal();
      inventoryIsLocked = true;
      setEFOverrideLockState(true);
      showToast('Inventory locked successfully for assurance', 'success');
    }
    
    // ============================================
    // Calculation Progress
    // ============================================
    
    function runCalculation() {
      closeCreateInventoryModal();
      document.getElementById('calc-progress-modal').classList.add('open');
      
      // Simulate progress
      let progress = 0;
      const steps = ['Normalizing activity data...', 'Mapping emission factors...', 'Executing calculations...', 'Applying boundary logic...', 'Aggregating results...', 'Generating audit logs...'];
      let currentStep = 0;
      
      const interval = setInterval(() => {
        progress += 5;
        const offset = 283 - (283 * progress / 100);
        document.getElementById('progress-circle').style.strokeDashoffset = offset;
        document.getElementById('progress-percent').textContent = progress + '%';
        
        if (progress % 17 === 0 && currentStep < steps.length) {
          document.getElementById('progress-step').textContent = steps[currentStep];
          
          // Update step indicators
          for (let i = 1; i <= 6; i++) {
            const stepEl = document.getElementById('step-' + i);
            if (i <= currentStep + 1) {
              stepEl.classList.remove('active');
              stepEl.classList.add('completed');
              stepEl.querySelector('i').className = 'fa-solid fa-check-circle';
            } else if (i === currentStep + 2) {
              stepEl.classList.add('active');
              stepEl.querySelector('i').className = 'fa-solid fa-spinner fa-spin';
            }
          }
          currentStep++;
        }
        
        if (progress >= 100) {
          clearInterval(interval);
          setTimeout(() => {
            document.getElementById('calc-progress-modal').classList.remove('open');
            showToast('Calculation completed - 628 emission records generated', 'success');
            switchView('inventory-results');
          }, 500);
        }
      }, 100);
    }
    
    // ============================================
    // Toast Notifications
    // ============================================
    
    function showToast(message, type = 'default') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = 'toast ' + type;
      toast.innerHTML = `
        <i class="fa-light fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
        <span>${message}</span>
      `;
      container.appendChild(toast);
      
      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(100%)';
        setTimeout(() => toast.remove(), 300);
      }, 4000);
    }

    // ============================================
    // Activity Filter & Management
    // ============================================
    
    let currentActivityFilter = 'all';
    let currentSearchTerm = '';
    let pendingRemoveActivity = null;

    function filterActivitiesByStatus(status) {
      currentActivityFilter = status;
      
      // Update pill states
      document.querySelectorAll('.activity-filter-bar .filter-pill').forEach(pill => {
        pill.classList.toggle('active', pill.dataset.filter === status);
      });
      
      applyActivityFilters();
    }

    function searchActivities(term) {
      currentSearchTerm = term.toLowerCase();
      applyActivityFilters();
    }

    function applyActivityFilters() {
      const rows = document.querySelectorAll('.activity-hierarchy .activity-row:not(.removed)');
      let visibleCount = 0;
      let totalCount = 0;
      
      rows.forEach(row => {
        // Skip permanently removed rows
        if (row.classList.contains('removed')) return;
        totalCount++;
        
        const rowStatus = row.dataset.status || '';
        const activityName = row.querySelector('.activity-name')?.textContent.toLowerCase() || '';
        
        // Treat 'pending' same as 'needs-data' for filtering
        let statusMatch = currentActivityFilter === 'all' || 
          rowStatus === currentActivityFilter ||
          (currentActivityFilter === 'needs-data' && rowStatus === 'pending');
        let searchMatch = !currentSearchTerm || activityName.includes(currentSearchTerm);
        
        if (statusMatch && searchMatch) {
          row.style.display = '';
          visibleCount++;
        } else {
          row.style.display = 'none';
        }
      });
      
      // Update filter status
      const statusEl = document.getElementById('activity-filter-status');
      const statusTextEl = document.getElementById('filter-status-text');
      
      if (currentActivityFilter !== 'all' || currentSearchTerm) {
        statusEl.style.display = 'flex';
        const hiddenCount = totalCount - visibleCount;
        statusTextEl.textContent = `Showing ${visibleCount} of ${totalCount} activities` + (hiddenCount > 0 ? `  ${hiddenCount} hidden by filter` : '');
      } else {
        statusEl.style.display = 'none';
      }
    }

    // ============================================
    // Add Activity Modal
    // ============================================

    function openAddActivityModal() {
      document.getElementById('add-activity-modal').classList.add('active');
      updateCatalogSelectionSummary();
    }

    function closeAddActivityModal() {
      document.getElementById('add-activity-modal').classList.remove('active');
    }

    function toggleCatalogCard(card) {
      card.classList.toggle('selected');
      updateCatalogSelectionSummary();
    }

    function filterCatalogByScope(scope) {
      document.querySelectorAll('.add-activity-scope-filter .scope-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.scope === scope);
      });
      
      document.querySelectorAll('.activity-catalog-section').forEach(section => {
        if (scope === 'all' || section.dataset.scope === scope) {
          section.style.display = '';
        } else {
          section.style.display = 'none';
        }
      });
    }

    function filterActivityCatalog(term) {
      const searchTerm = term.toLowerCase();
      document.querySelectorAll('.activity-catalog-card').forEach(card => {
        const title = card.querySelector('.card-title')?.textContent.toLowerCase() || '';
        const desc = card.querySelector('.card-description')?.textContent.toLowerCase() || '';
        
        if (title.includes(searchTerm) || desc.includes(searchTerm)) {
          card.style.display = '';
        } else {
          card.style.display = 'none';
        }
      });
    }

    function updateCatalogSelectionSummary() {
      const selected = document.querySelectorAll('.activity-catalog-card.selected');
      const withData = document.querySelectorAll('.activity-catalog-card.selected.has-data');
      const noData = selected.length - withData.length;
      
      document.getElementById('catalog-selected-count').textContent = selected.length;
      document.getElementById('catalog-with-data-count').textContent = withData.length;
      document.getElementById('catalog-no-data-count').textContent = noData;
    }

    function confirmAddActivities() {
      const selectedCards = document.querySelectorAll('.activity-catalog-card.selected');
      const count = selectedCards.length;
      let newlyAdded = 0;
      
      // Sync selection state back to activity rows
      selectedCards.forEach(card => {
        const activityId = card.dataset.activity;
        const hasData = card.classList.contains('has-data');
        let row = document.querySelector(`.activity-row[data-activity="${activityId}"]`);
        
        if (row) {
          // Existing row - show it
          const wasHidden = row.classList.contains('removed') || row.style.display === 'none';
          row.classList.remove('inactive', 'removed');
          row.style.display = '';
          if (wasHidden) {
            row.classList.add('newly-added');
            newlyAdded++;
            setTimeout(() => row.classList.remove('newly-added'), 500);
          }
        } else {
          // Create new row for activities not yet in the table
          row = createPendingActivityRow(activityId, card);
          if (row) {
            document.querySelector('.activity-hierarchy').appendChild(row);
            newlyAdded++;
          }
        }
        
        // Handle pending data state
        if (!hasData) {
          row?.classList.add('pending-data');
          row?.setAttribute('data-status', 'pending');
        }
      });
      
      // Hide unselected activities
      document.querySelectorAll('.activity-catalog-card:not(.selected)').forEach(card => {
        const activityId = card.dataset.activity;
        const row = document.querySelector(`.activity-row[data-activity="${activityId}"]`);
        if (row) {
          row.classList.add('removed');
          row.style.display = 'none';
        }
      });
      
      closeAddActivityModal();
      if (newlyAdded > 0) {
        showToast(`${newlyAdded} new activities added to boundary`, 'success');
      } else {
        showToast(`${count} activities configured for inventory boundary`, 'success');
      }
      updateFilterCounts();
    }

    function createPendingActivityRow(activityId, catalogCard) {
      const title = catalogCard.querySelector('.card-title')?.textContent || activityId;
      const description = catalogCard.querySelector('.card-description')?.textContent || '';
      const hasData = catalogCard.classList.contains('has-data');
      const scope = catalogCard.closest('.activity-catalog-section')?.dataset.scope || '3';
      
      const row = document.createElement('div');
      row.className = 'activity-row pending-data newly-added';
      row.dataset.activity = activityId;
      row.dataset.status = hasData ? 'needs-data' : 'pending';
      
      row.innerHTML = `
        <div class="activity-row-main" onclick="toggleActivityExpand(this)">
          <div class="expand-toggle"><i class="fa-light fa-chevron-right"></i></div>
          <div class="activity-info">
            <span class="activity-name">${title}</span>
            <span class="activity-path">Pending Configuration</span>
          </div>
          <span class="status-badge pending"><i class="fa-light fa-clock"></i> Pending</span>
          <span class="scope-badge scope-${scope}">S${scope}</span>
          <span class="col-value right"></span>
          <span class="col-value right"></span>
          <span class="col-value"></span>
          <div class="ef-readonly">
            <div class="pending-data-indicator">
              <span class="pending-tag"><i class="fa-light fa-hourglass"></i> Awaiting data</span>
            </div>
          </div>
          <span class="col-value">0 / 1,247</span>
          <button class="btn-remove-activity" onclick="event.stopPropagation(); removeActivity('${activityId}', 0)" title="Remove from inventory">
            <i class="fa-light fa-times"></i>
          </button>
        </div>
        <div class="activity-regions"></div>
      `;
      
      setTimeout(() => row.classList.remove('newly-added'), 500);
      return row;
    }

    // ============================================
    // Remove Activity
    // ============================================

    function removeActivity(activityId, recordCount) {
      pendingRemoveActivity = { id: activityId, records: recordCount };
      
      // Get activity name
      const row = document.querySelector(`.activity-row[data-activity="${activityId}"]`);
      const activityName = row?.querySelector('.activity-name')?.textContent || activityId;
      
      // Update modal text
      document.getElementById('remove-confirm-text').innerHTML = 
        `Are you sure you want to remove <strong>${activityName}</strong> from this inventory?`;
      document.getElementById('remove-warning-text').textContent = 
        `This will exclude ${recordCount.toLocaleString()} records from calculation. The data will remain in the system and can be added back later.`;
      
      // Show modal
      document.getElementById('remove-confirm-modal').classList.add('active');
    }

    function closeRemoveConfirmModal() {
      document.getElementById('remove-confirm-modal').classList.remove('active');
      pendingRemoveActivity = null;
    }

    function confirmRemoveActivity() {
      if (!pendingRemoveActivity) return;
      
      const { id, records } = pendingRemoveActivity;
      
      // Hide the activity row
      const row = document.querySelector(`.activity-row[data-activity="${id}"]`);
      if (row) {
        row.style.display = 'none';
        row.classList.add('removed');
      }
      
      // Unselect in catalog
      const catalogCard = document.querySelector(`.activity-catalog-card[data-activity="${id}"]`);
      if (catalogCard) {
        catalogCard.classList.remove('selected');
      }
      
      closeRemoveConfirmModal();
      showToast(`Activity removed from inventory (${records.toLocaleString()} records excluded)`, 'success');
      updateFilterCounts();
    }

    function updateFilterCounts() {
      const allRows = document.querySelectorAll('.activity-hierarchy .activity-row:not(.removed):not([style*="display: none"])');
      const readyRows = document.querySelectorAll('.activity-hierarchy .activity-row:not(.removed)[data-status="ready"]');
      const issuesRows = document.querySelectorAll('.activity-hierarchy .activity-row:not(.removed)[data-status="issues"]');
      const needsDataRows = document.querySelectorAll('.activity-hierarchy .activity-row:not(.removed)[data-status="needs-data"]');
      const pendingRows = document.querySelectorAll('.activity-hierarchy .activity-row:not(.removed)[data-status="pending"]');
      
      // Combine needs-data and pending for the filter
      const needsDataTotal = needsDataRows.length + pendingRows.length;
      
      document.querySelector('.filter-pill[data-filter="all"] .pill-count').textContent = allRows.length;
      document.querySelector('.filter-pill[data-filter="ready"] .pill-count').textContent = readyRows.length;
      document.querySelector('.filter-pill[data-filter="issues"] .pill-count').textContent = issuesRows.length;
      document.querySelector('.filter-pill[data-filter="needs-data"] .pill-count').textContent = needsDataTotal;
    }

    // ============================================
    // Org Boundary View Toggle & Controls
    // ============================================

    let currentOrgView = 'summary';

    function toggleOrgView(view) {
      currentOrgView = view;
      
      // Update toggle buttons
      document.querySelectorAll('.org-view-toggle .view-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.view === view);
      });
      
      // Switch views
      document.getElementById('org-summary-view').classList.toggle('active', view === 'summary');
      document.getElementById('org-detail-view').classList.toggle('active', view === 'detail');
    }

    // ========================================
    // Operational Boundary View Functions
    // ========================================
    
    function toggleOpView(view) {
      // Update toggle buttons
      document.querySelectorAll('.op-view-toggle .view-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.view === view);
      });
      
      // Switch views
      document.getElementById('op-config-view').classList.toggle('active', view === 'config');
      document.getElementById('op-matrix-view').classList.toggle('active', view === 'matrix');
    }

    function toggleActivityConfig(checkbox) {
      const row = checkbox.closest('.activity-config-row');
      row.classList.toggle('excluded', !checkbox.checked);
      const methodSelect = row.querySelector('.calc-method-select');
      if (methodSelect) {
        methodSelect.disabled = !checkbox.checked;
      }
      updateOpSummary();
    }

    function updateActivityMethod(select) {
      const row = select.closest('.activity-config-row');
      const activityName = row.dataset.activity;
      console.log(`Updated ${activityName} to method: ${select.value}`);
      // In production, this would trigger recalculation
    }

    function removeActivityConfig(activityId) {
      const row = document.querySelector(`.activity-config-row[data-activity="${activityId}"]`);
      if (row) {
        row.style.display = 'none';
        updateOpSummary();
      }
    }

    function openMatrixDrilldown(activity, region) {
      const overlay = document.getElementById('matrix-drilldown-overlay');
      const panel = document.getElementById('matrix-drilldown-panel');
      
      // Update title
      const activityNames = {
        'stationary-combustion': 'Stationary Combustion',
        'mobile-combustion': 'Mobile Combustion',
        'purchased-electricity': 'Purchased Electricity',
        'purchased-steam': 'Purchased Steam & Heat',
        'business-travel': 'Business Travel',
        'employee-commuting': 'Employee Commuting'
      };
      const regionNames = {
        'americas': 'Americas',
        'emea': 'EMEA',
        'apac': 'APAC'
      };
      
      document.getElementById('drilldown-title').textContent = 
        `${activityNames[activity] || activity}  ${regionNames[region] || region}`;
      
      overlay.classList.add('active');
      panel.classList.add('active');
    }

    function closeMatrixDrilldown() {
      document.getElementById('matrix-drilldown-overlay').classList.remove('active');
      document.getElementById('matrix-drilldown-panel').classList.remove('active');
    }

    function toggleDrilldownGroup(header) {
      const group = header.closest('.drilldown-group');
      group.classList.toggle('expanded');
    }

    function toggleDrilldownGroupSelect(checkbox) {
      const group = checkbox.closest('.drilldown-group');
      const entities = group.querySelectorAll('.entity-checkbox');
      entities.forEach(cb => cb.checked = checkbox.checked);
      updateDrilldownSummary();
    }

    function drilldownSelectAll() {
      document.querySelectorAll('#matrix-drilldown-panel .entity-checkbox').forEach(cb => cb.checked = true);
      document.querySelectorAll('#matrix-drilldown-panel .group-checkbox').forEach(cb => cb.checked = true);
      updateDrilldownSummary();
    }

    function drilldownDeselectAll() {
      document.querySelectorAll('#matrix-drilldown-panel .entity-checkbox').forEach(cb => cb.checked = false);
      document.querySelectorAll('#matrix-drilldown-panel .group-checkbox').forEach(cb => cb.checked = false);
      updateDrilldownSummary();
    }

    function updateDrilldownSummary() {
      const total = document.querySelectorAll('#matrix-drilldown-panel .entity-checkbox').length;
      const selected = document.querySelectorAll('#matrix-drilldown-panel .entity-checkbox:checked').length;
      document.querySelector('.drilldown-footer .selection-summary').innerHTML = 
        `<strong>${selected}</strong> of <strong>${total}</strong> entities selected`;
      document.getElementById('drilldown-subtitle').textContent = `${selected} of ${total} entities selected`;
    }

    function applyDrilldownSelection() {
      // In production, this would update the matrix cell counts
      closeMatrixDrilldown();
    }

    function updateOpSummary() {
      const activeRows = document.querySelectorAll('.activity-config-row:not([style*="display: none"]):not(.excluded)');
      const totalActivities = activeRows.length;
      
      let scope1 = 0, scope2 = 0, scope3 = 0;
      activeRows.forEach(row => {
        const scopeBadge = row.querySelector('.scope-badge');
        if (scopeBadge) {
          if (scopeBadge.classList.contains('scope-1')) scope1++;
          else if (scopeBadge.classList.contains('scope-2')) scope2++;
          else if (scopeBadge.classList.contains('scope-3')) scope3++;
        }
      });
      
      const summary = document.querySelector('.op-selection-summary .selected-count');
      if (summary) {
        summary.innerHTML = `<strong>6,666</strong> entities  <strong>${totalActivities}</strong> activities = <strong>${6666 * totalActivities}</strong> combinations`;
      }
      
      const scope1Chip = document.querySelector('.op-selection-summary .scope-chip.scope-1');
      const scope2Chip = document.querySelector('.op-selection-summary .scope-chip.scope-2');
      const scope3Chip = document.querySelector('.op-selection-summary .scope-chip.scope-3');
      
      if (scope1Chip) scope1Chip.textContent = `${scope1} Scope 1`;
      if (scope2Chip) scope2Chip.textContent = `${scope2} Scope 2`;
      if (scope3Chip) scope3Chip.textContent = `${scope3} Scope 3`;
    }

    // Entity-Activity Matrix Functions
    function toggleMatrixGroup(header) {
      header.classList.toggle('expanded');
      const rows = header.nextElementSibling;
      if (rows && rows.classList.contains('matrix-group-rows')) {
        rows.classList.toggle('expanded');
      }
    }

    function toggleMatrixGroupSelect(checkbox) {
      const header = checkbox.closest('.matrix-group-header');
      const rows = header.nextElementSibling;
      const isChecked = checkbox.checked;
      
      if (rows && rows.classList.contains('matrix-group-rows')) {
        rows.querySelectorAll('.row-checkbox input').forEach(cb => {
          cb.checked = isChecked;
        });
        rows.querySelectorAll('.activity-cell input:not([disabled])').forEach(cb => {
          cb.checked = isChecked;
        });
      }
    }

    function toggleAllMatrixRows(checkbox) {
      const isChecked = checkbox.checked;
      document.querySelectorAll('.matrix-body .row-checkbox input').forEach(cb => {
        cb.checked = isChecked;
      });
      document.querySelectorAll('.matrix-body .activity-cell input:not([disabled])').forEach(cb => {
        cb.checked = isChecked;
      });
      document.querySelectorAll('.matrix-group-header .group-checkbox input').forEach(cb => {
        cb.checked = isChecked;
      });
    }

    function filterMatrixEntities(searchTerm) {
      const term = searchTerm.toLowerCase();
      document.querySelectorAll('.matrix-row').forEach(row => {
        const entityName = row.querySelector('.entity-name');
        if (entityName) {
          const matches = entityName.textContent.toLowerCase().includes(term);
          row.style.display = matches || term === '' ? '' : 'none';
        }
      });
    }

    function filterMatrixByType(type) {
      // Update button states
      document.querySelectorAll('.matrix-filter-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.closest('.matrix-filter-btn').classList.add('active');
      
      // Filter rows
      document.querySelectorAll('.matrix-row').forEach(row => {
        if (type === 'all') {
          row.style.display = '';
        } else {
          const matches = row.dataset.type === type;
          row.style.display = matches ? '' : 'none';
        }
      });
    }

    function toggleDetailRegion(el) {
      const row = el.closest('.detail-region-row');
      row.classList.toggle('expanded');
    }

    function toggleDetailType(el) {
      const row = el.closest('.detail-type-row');
      row.classList.toggle('expanded');
    }

    function toggleDetailRegionSelect(checkbox) {
      const row = checkbox.closest('.detail-region-row');
      const isChecked = checkbox.checked;
      
      // Update all type and entity checkboxes in this region
      row.querySelectorAll('.type-checkbox input, .entity-checkbox input').forEach(cb => {
        cb.checked = isChecked;
      });
      
      // Update entity row visual state
      row.querySelectorAll('.detail-entity-row').forEach(entityRow => {
        entityRow.classList.toggle('excluded', !isChecked);
      });
      
      updateOrgSelectionSummary();
      syncOrgSelectionToSummaryView();
    }

    function toggleDetailTypeSelect(checkbox) {
      const row = checkbox.closest('.detail-type-row');
      const isChecked = checkbox.checked;
      
      // Update all entity checkboxes in this type group
      row.querySelectorAll('.entity-checkbox input').forEach(cb => {
        cb.checked = isChecked;
      });
      
      // Update entity row visual state
      row.querySelectorAll('.detail-entity-row').forEach(entityRow => {
        entityRow.classList.toggle('excluded', !isChecked);
      });
      
      // Update parent region checkbox
      updateParentRegionCheckbox(row);
      updateOrgSelectionSummary();
      syncOrgSelectionToSummaryView();
    }

    function toggleDetailEntitySelect(checkbox) {
      const entityRow = checkbox.closest('.detail-entity-row');
      entityRow.classList.toggle('excluded', !checkbox.checked);
      
      // Update parent type checkbox
      const typeRow = checkbox.closest('.detail-type-row');
      updateParentTypeCheckbox(typeRow);
      
      // Update parent region checkbox
      const regionRow = checkbox.closest('.detail-region-row');
      updateParentRegionCheckbox(regionRow);
      
      updateOrgSelectionSummary();
      syncOrgSelectionToSummaryView();
    }

    function updateParentTypeCheckbox(typeRow) {
      if (!typeRow) return;
      const entityCheckboxes = typeRow.querySelectorAll('.entity-checkbox input');
      const checkedCount = Array.from(entityCheckboxes).filter(cb => cb.checked).length;
      const typeCheckbox = typeRow.querySelector('.type-checkbox input');
      
      if (typeCheckbox) {
        typeCheckbox.checked = checkedCount > 0;
        typeCheckbox.indeterminate = checkedCount > 0 && checkedCount < entityCheckboxes.length;
      }
      
      // Update selected count display
      const selectedSpan = typeRow.querySelector('.type-selected');
      if (selectedSpan && entityCheckboxes.length > 0) {
        selectedSpan.textContent = `${checkedCount} / ${entityCheckboxes.length}`;
      }
    }

    function updateParentRegionCheckbox(regionRow) {
      if (!regionRow) return;
      const typeCheckboxes = regionRow.querySelectorAll('.type-checkbox input');
      const checkedCount = Array.from(typeCheckboxes).filter(cb => cb.checked).length;
      const regionCheckbox = regionRow.querySelector('.region-checkbox input');
      
      if (regionCheckbox) {
        regionCheckbox.checked = checkedCount > 0;
        regionCheckbox.indeterminate = checkedCount > 0 && checkedCount < typeCheckboxes.length;
      }
    }

    function updateOrgSelectionSummary() {
      const allEntities = document.querySelectorAll('#org-detail-view .detail-entity-row');
      const selectedEntities = document.querySelectorAll('#org-detail-view .detail-entity-row:not(.excluded)');
      const excludedCount = allEntities.length - selectedEntities.length;
      
      // Update the detail view summary footer
      const summaryDiv = document.querySelector('.org-detail-summary div');
      if (summaryDiv) {
        summaryDiv.innerHTML = `
          Selected: <strong>${selectedEntities.length}</strong> of <strong>${allEntities.length}</strong> entities
          <span style="margin-left: 12px;">|</span>
          <span class="excluded-count" style="margin-left: 12px;">${excludedCount} excluded</span>
          <span style="margin-left: 12px;">|</span>
          <span style="margin-left: 12px;">96% have activity data</span>
        `;
      }
      
      // Update the main selection summary
      const mainCountEl = document.getElementById('selected-entity-count');
      if (mainCountEl) {
        mainCountEl.textContent = selectedEntities.length.toLocaleString();
      }
    }

    function syncOrgSelectionToSummaryView() {
      // Sync detailed view selection state back to summary region cards
      document.querySelectorAll('#org-detail-view .detail-region-row').forEach(detailRegion => {
        const regionName = detailRegion.dataset.region;
        const regionCheckbox = detailRegion.querySelector('.detail-region-main .region-checkbox input');
        
        // Find matching summary card
        const summaryCard = document.querySelector(`.org-region-list .region-card[data-region="${regionName}"]`);
        if (summaryCard && regionCheckbox) {
          const summaryCheckbox = summaryCard.querySelector('.region-checkbox');
          if (summaryCheckbox) {
            summaryCheckbox.checked = regionCheckbox.checked;
            summaryCheckbox.indeterminate = regionCheckbox.indeterminate;
          }
        }
      });
    }

    function searchOrgEntities(term) {
      const searchTerm = term.toLowerCase();
      
      if (currentOrgView === 'detail') {
        // Search in detailed view
        document.querySelectorAll('#org-detail-view .detail-entity-row').forEach(row => {
          const name = row.querySelector('.entity-name')?.textContent.toLowerCase() || '';
          const code = row.querySelector('.entity-code')?.textContent.toLowerCase() || '';
          
          if (searchTerm === '' || name.includes(searchTerm) || code.includes(searchTerm)) {
            row.style.display = '';
          } else {
            row.style.display = 'none';
          }
        });
      } else {
        // Search in summary view
        document.querySelectorAll('.org-region-list .region-card').forEach(card => {
          const name = card.querySelector('.region-name')?.textContent.toLowerCase() || '';
          const breakdown = card.querySelector('.region-breakdown')?.textContent.toLowerCase() || '';
          
          if (searchTerm === '' || name.includes(searchTerm) || breakdown.includes(searchTerm)) {
            card.style.display = '';
          } else {
            card.style.display = 'none';
          }
        });
      }
    }

    // ============================================
    // Bulk Actions
    // ============================================

    function toggleBulkActionsMenu() {
      const menu = document.getElementById('bulk-actions-menu');
      menu.classList.toggle('open');
      
      // Close on outside click
      if (menu.classList.contains('open')) {
        setTimeout(() => {
          document.addEventListener('click', closeBulkActionsOnOutsideClick);
        }, 0);
      }
    }

    function closeBulkActionsOnOutsideClick(e) {
      const menu = document.getElementById('bulk-actions-menu');
      const btn = document.querySelector('.bulk-actions-btn');
      
      if (!menu.contains(e.target) && !btn.contains(e.target)) {
        menu.classList.remove('open');
        document.removeEventListener('click', closeBulkActionsOnOutsideClick);
      }
    }

    function bulkSelectAll() {
      document.querySelectorAll('#org-detail-view .entity-checkbox input').forEach(cb => {
        if (cb.closest('.detail-entity-row').style.display !== 'none') {
          cb.checked = true;
          cb.closest('.detail-entity-row').classList.remove('excluded');
        }
      });
      
      // Update parent checkboxes
      document.querySelectorAll('#org-detail-view .detail-type-row').forEach(row => updateParentTypeCheckbox(row));
      document.querySelectorAll('#org-detail-view .detail-region-row').forEach(row => updateParentRegionCheckbox(row));
      
      updateOrgSelectionSummary();
      syncOrgSelectionToSummaryView();
      toggleBulkActionsMenu();
      showToast('All visible entities selected', 'success');
    }

    function bulkDeselectAll() {
      document.querySelectorAll('#org-detail-view .entity-checkbox input').forEach(cb => {
        if (cb.closest('.detail-entity-row').style.display !== 'none') {
          cb.checked = false;
          cb.closest('.detail-entity-row').classList.add('excluded');
        }
      });
      
      // Update parent checkboxes
      document.querySelectorAll('#org-detail-view .detail-type-row').forEach(row => updateParentTypeCheckbox(row));
      document.querySelectorAll('#org-detail-view .detail-region-row').forEach(row => updateParentRegionCheckbox(row));
      
      updateOrgSelectionSummary();
      syncOrgSelectionToSummaryView();
      toggleBulkActionsMenu();
      showToast('All visible entities deselected', 'success');
    }

    function bulkSelectByType(type) {
      // First deselect all
      document.querySelectorAll('#org-detail-view .entity-checkbox input').forEach(cb => {
        cb.checked = false;
        cb.closest('.detail-entity-row').classList.add('excluded');
      });
      
      // Then select only the specified type
      document.querySelectorAll(`#org-detail-view .detail-type-row[data-type="${type}"] .entity-checkbox input`).forEach(cb => {
        cb.checked = true;
        cb.closest('.detail-entity-row').classList.remove('excluded');
      });
      
      // Update parent checkboxes
      document.querySelectorAll('#org-detail-view .detail-type-row').forEach(row => updateParentTypeCheckbox(row));
      document.querySelectorAll('#org-detail-view .detail-region-row').forEach(row => updateParentRegionCheckbox(row));
      
      updateOrgSelectionSummary();
      syncOrgSelectionToSummaryView();
      toggleBulkActionsMenu();
      
      const typeNames = { offices: 'Offices', warehouses: 'Warehouses', factories: 'Factories' };
      showToast(`Only ${typeNames[type]} selected`, 'success');
    }

    function bulkInvertSelection() {
      document.querySelectorAll('#org-detail-view .entity-checkbox input').forEach(cb => {
        if (cb.closest('.detail-entity-row').style.display !== 'none') {
          cb.checked = !cb.checked;
          cb.closest('.detail-entity-row').classList.toggle('excluded', !cb.checked);
        }
      });
      
      // Update parent checkboxes
      document.querySelectorAll('#org-detail-view .detail-type-row').forEach(row => updateParentTypeCheckbox(row));
      document.querySelectorAll('#org-detail-view .detail-region-row').forEach(row => updateParentRegionCheckbox(row));
      
      updateOrgSelectionSummary();
      syncOrgSelectionToSummaryView();
      toggleBulkActionsMenu();
      showToast('Selection inverted', 'success');
    }

    function exportEntitySelection() {
      showToast('Entity selection exported to CSV', 'success');
    }
    
    // ============================================
    // Search Filtering
    // ============================================
    
    document.getElementById('inventory-search')?.addEventListener('input', (e) => {
      const query = e.target.value.toLowerCase();
      document.querySelectorAll('.inventory-card').forEach(card => {
        const text = card.textContent.toLowerCase();
        card.style.display = text.includes(query) ? '' : 'none';
      });
    });
    
    // ============================================
    // Close modals on backdrop click
    // ============================================
    
    document.querySelectorAll('.modal-backdrop').forEach(backdrop => {
      backdrop.addEventListener('click', (e) => {
        if (e.target === backdrop) {
          backdrop.classList.remove('open');
        }
      });
    });
    
    // ============================================
    // EF SELECTION & REVIEW FUNCTIONS
    // ============================================
    
    // Entity data for the EF table
    const efEntityData = [
      { id: 'paris-hq', name: 'Paris HQ', flag: '', region: 'EU', type: 'Headquarters', activities: 12, records: 45230, coverage: 96, issues: [], status: 'complete' },
      { id: 'london', name: 'London Office', flag: '', region: 'EU', type: 'Regional Office', activities: 8, records: 23100, coverage: 89, issues: [{ type: 'geographic', count: 120 }], status: 'complete' },
      { id: 'berlin', name: 'Berlin Factory', flag: '', region: 'EU', type: 'Manufacturing', activities: 15, records: 312000, coverage: 72, issues: [{ type: 'outdated', count: 8400 }, { type: 'specificity', count: 2100 }], status: 'needs-attention' },
      { id: 'nyc', name: 'NYC Branch', flag: '', region: 'Americas', type: 'Regional Office', activities: 10, records: 18500, coverage: 100, issues: [], status: 'complete' },
      { id: 'tokyo', name: 'Tokyo Office', flag: '', region: 'Asia-Pacific', type: 'Regional Office', activities: 6, records: 12400, coverage: 91, issues: [], status: 'complete' },
      { id: 'sydney', name: 'Sydney Office', flag: '', region: 'Asia-Pacific', type: 'Regional Office', activities: 5, records: 8900, coverage: 94, issues: [], status: 'complete' },
      { id: 'shanghai', name: 'Shanghai Plant', flag: '', region: 'Asia-Pacific', type: 'Manufacturing', activities: 14, records: 156000, coverage: 78, issues: [{ type: 'geographic', count: 3200 }], status: 'in-progress' },
      { id: 'dubai', name: 'Dubai Office', flag: '', region: 'MEA', type: 'Regional Office', activities: 4, records: 5600, coverage: 85, issues: [], status: 'complete' },
      { id: 'sao-paulo', name: 'So Paulo Office', flag: '', region: 'Americas', type: 'Regional Office', activities: 7, records: 14200, coverage: 88, issues: [], status: 'complete' },
      { id: 'amsterdam', name: 'Amsterdam Warehouse', flag: '', region: 'EU', type: 'Warehouse', activities: 9, records: 67800, coverage: 82, issues: [{ type: 'specificity', count: 890 }], status: 'in-progress' }
    ];
    
    let efSortColumn = 'name';
    let efSortDirection = 'asc';
    let currentRecordId = null;
    
    // Entity records sample data
    const sampleRecords = [
      { id: 'rec-1', title: 'Diesel - Fleet Vehicles', entity: 'Paris HQ', period: 'Jan 2026', value: '2,450 L', status: 'mapped', flag: null, 
        activityId: 'FUEL_DIESEL_MOBILE', scope: 'Scope 1 - Direct Emissions', source: 'Fleet_Data_Q1.xlsx',
        selectedFactor: 'Diesel (100% mineral)', datasetSource: 'DEFRA 2024', efValue: '3.29 kg COe/L', lifecycle: 'WTT: 0.61 + TTW: 2.68 = 3.29',
        specificity: 78, dataPath: 'Activity-based' },
      { id: 'rec-2', title: 'Natural Gas - Heating', entity: 'Paris HQ', period: 'Jan 2026', value: '1,200 m', status: 'mapped', flag: 'geographic',
        activityId: 'FUEL_NG_STATIONARY', scope: 'Scope 1 - Direct Emissions', source: 'Utilities_Jan.xlsx',
        selectedFactor: 'Natural Gas', datasetSource: 'DEFRA 2024', efValue: '2.02 kg COe/m', lifecycle: 'WTT: 0.34 + TTW: 1.68 = 2.02',
        specificity: 72, dataPath: 'Activity-based' },
      { id: 'rec-3', title: 'Electricity - Grid', entity: 'Paris HQ', period: 'Jan 2026', value: '45,000 kWh', status: 'mapped', flag: null,
        activityId: 'ELEC_GRID_FR', scope: 'Scope 2 - Indirect Energy', source: 'Utilities_Jan.xlsx',
        selectedFactor: 'France Grid Mix', datasetSource: 'AIB 2024', efValue: '0.056 kg COe/kWh', lifecycle: 'Location-based',
        specificity: 92, dataPath: 'Activity-based' },
      { id: 'rec-4', title: 'Business Travel - Air', entity: 'Paris HQ', period: 'Jan 2026', value: '$12,500', status: 'flagged', flag: 'outdated',
        activityId: 'TRAVEL_AIR_SHORT', scope: 'Scope 3.6 - Business Travel', source: 'Expense_Report.xlsx',
        selectedFactor: 'Short-haul Air', datasetSource: 'DEFRA 2022', efValue: '0.255 kg COe/km', lifecycle: 'Full lifecycle',
        specificity: 58, dataPath: 'Spend-based' },
      { id: 'rec-5', title: 'Office Supplies', entity: 'Paris HQ', period: 'Q4 2025', value: '$8,200', status: 'flagged', flag: 'specificity',
        activityId: 'GOODS_OFFICE_MIXED', scope: 'Scope 3.1 - Purchased Goods', source: 'Procurement_Q4.xlsx',
        selectedFactor: 'Office Equipment (Avg)', datasetSource: 'EPA EEIO', efValue: '0.76 kg COe/$', lifecycle: 'Cradle-to-gate',
        specificity: 45, dataPath: 'Spend-based' },
      { id: 'rec-6', title: 'Water Usage', entity: 'Paris HQ', period: 'Jan 2026', value: '520 m', status: 'mapped', flag: null,
        activityId: 'WATER_SUPPLY', scope: 'Scope 3.1 - Purchased Goods', source: 'Utilities_Jan.xlsx',
        selectedFactor: 'Municipal Water Supply', datasetSource: 'DEFRA 2024', efValue: '0.149 kg COe/m', lifecycle: 'Supply only',
        specificity: 85, dataPath: 'Activity-based' },
      { id: 'rec-7', title: 'Waste - Recycling', entity: 'Paris HQ', period: 'Jan 2026', value: '2.4 tonnes', status: 'mapped', flag: null,
        activityId: 'WASTE_RECYCLE_MIXED', scope: 'Scope 3.5 - Waste', source: 'Waste_Report.xlsx',
        selectedFactor: 'Mixed Recycling', datasetSource: 'DEFRA 2024', efValue: '21.3 kg COe/tonne', lifecycle: 'End-of-life',
        specificity: 76, dataPath: 'Activity-based' },
      { id: 'rec-8', title: 'Employee Commute', entity: 'Paris HQ', period: 'Jan 2026', value: '15,200 km', status: 'mapped', flag: null,
        activityId: 'COMMUTE_AVG', scope: 'Scope 3.7 - Employee Commute', source: 'HR_Survey.xlsx',
        selectedFactor: 'Average Commute', datasetSource: 'DEFRA 2024', efValue: '0.171 kg COe/km', lifecycle: 'WTT + TTW',
        specificity: 68, dataPath: 'Distance-based' }
    ];
    
    function initEFEntityTable() {
      renderEFEntityTable();
    }
    
    function renderEFEntityTable() {
      const tbody = document.getElementById('efEntityTableBody');
      if (!tbody) return;
      
      const filteredData = getFilteredEFEntityData();
      const sortedData = sortEFEntityData(filteredData);
      
      tbody.innerHTML = sortedData.map(entity => `
        <tr onclick="drillDownToEntity('${entity.id}')">
          <td>
            <div class="entity-name-cell">
              <span class="entity-flag">${entity.flag}</span>
              <div class="entity-name-info">
                <h5>${entity.name}</h5>
                <span>${entity.type}</span>
              </div>
            </div>
          </td>
          <td>${entity.region}</td>
          <td>${entity.type}</td>
          <td>${entity.activities}</td>
          <td>${entity.records.toLocaleString()}</td>
          <td>
            <div class="coverage-cell">
              <div class="coverage-bar-mini">
                <div class="coverage-bar-mini-fill ${entity.coverage >= 90 ? 'high' : entity.coverage >= 75 ? 'medium' : 'low'}" style="width: ${entity.coverage}%;"></div>
              </div>
              <span class="coverage-percent ${entity.coverage >= 90 ? 'high' : entity.coverage >= 75 ? 'medium' : 'low'}">${entity.coverage}%</span>
            </div>
          </td>
          <td>
            ${entity.issues.length > 0 ? `
              <div class="issue-pills-cell">
                ${entity.issues.map(issue => `<span class="issue-pill ${issue.type}">${issue.type === 'geographic' ? 'Geo' : issue.type === 'outdated' ? 'Old' : 'Spec'} (${(issue.count / 1000).toFixed(1)}K)</span>`).join('')}
              </div>
            ` : '<span style="color: var(--ghg-text-muted);"></span>'}
          </td>
          <td>
            <span class="status-icon ${entity.status}">
              <i class="fa-light ${entity.status === 'complete' ? 'fa-check' : entity.status === 'in-progress' ? 'fa-hourglass-half' : 'fa-triangle-exclamation'}"></i>
            </span>
          </td>
        </tr>
      `).join('');
      
      document.getElementById('efTableInfo').textContent = `Showing ${sortedData.length} of ${efEntityData.length} entities`;
    }
    
    function getFilteredEFEntityData() {
      const searchTerm = document.getElementById('efEntitySearch')?.value?.toLowerCase() || '';
      const regionFilter = document.getElementById('efRegionFilter')?.value || '';
      const typeFilter = document.getElementById('efTypeFilter')?.value || '';
      const statusFilter = document.getElementById('efStatusFilter')?.value || '';
      
      return efEntityData.filter(entity => {
        if (searchTerm && !entity.name.toLowerCase().includes(searchTerm)) return false;
        if (regionFilter && entity.region !== regionFilter) return false;
        if (typeFilter && entity.type !== typeFilter) return false;
        if (statusFilter && entity.status !== statusFilter) return false;
        return true;
      });
    }
    
    function sortEFEntityData(data) {
      return [...data].sort((a, b) => {
        let aVal = a[efSortColumn];
        let bVal = b[efSortColumn];
        
        if (typeof aVal === 'string') {
          aVal = aVal.toLowerCase();
          bVal = bVal.toLowerCase();
        }
        
        if (aVal < bVal) return efSortDirection === 'asc' ? -1 : 1;
        if (aVal > bVal) return efSortDirection === 'asc' ? 1 : -1;
        return 0;
      });
    }
    
    function sortEntityTable(column) {
      if (efSortColumn === column) {
        efSortDirection = efSortDirection === 'asc' ? 'desc' : 'asc';
      } else {
        efSortColumn = column;
        efSortDirection = 'asc';
      }
      
      document.querySelectorAll('.ef-dense-table th').forEach(th => {
        th.classList.remove('sorted');
      });
      
      renderEFEntityTable();
    }
    
    function filterEntityTable() {
      renderEFEntityTable();
    }
    
    function switchEFContentTab(tab) {
      const tabs = document.querySelectorAll('.ef-content-tab');
      tabs.forEach(t => t.classList.remove('active'));
      event.target.closest('.ef-content-tab').classList.add('active');
      
      // Handle both tab views (summary tab and full page)
      const entityView = document.getElementById('ef-entity-table-view');
      const categoryView = document.getElementById('ef-category-table-view');
      const entityViewFull = document.getElementById('ef-entity-table-view-full');
      const categoryViewFull = document.getElementById('ef-category-table-view-full');
      const reviewViewFull = document.getElementById('ef-review-queue-view-full');
      
      if (entityView) entityView.classList.toggle('active', tab === 'entity');
      if (categoryView) categoryView.classList.toggle('active', tab === 'category');
      if (entityViewFull) entityViewFull.classList.toggle('active', tab === 'entity');
      if (categoryViewFull) categoryViewFull.classList.toggle('active', tab === 'category');
      if (reviewViewFull) reviewViewFull.classList.remove('active');
    }
    
    // Initialize the full page entity table
    function initEFEntityTableFull() {
      renderEFEntityTableFull();
    }
    
    function renderEFEntityTableFull() {
      const tbody = document.getElementById('efEntityTableBodyFull');
      if (!tbody) return;
      
      const filteredData = getFilteredEntityDataFull();
      
      tbody.innerHTML = filteredData.map(entity => {
        const issuesList = entity.issues.length > 0 
          ? entity.issues.map(i => `<span class="issue-pill ${i.type.toLowerCase()}">${i.type.slice(0,3)} (${(i.count/1000).toFixed(1)}K)</span>`).join('')
          : '<span style="color: var(--ghg-text-muted);"></span>';
        
        return `
          <tr onclick="drillDownToEntity('${entity.id}')">
            <td>
              <div class="entity-name-cell">
                <span class="entity-flag">${entity.flag}</span>
                <div class="entity-name-info">
                  <h5>${entity.name}</h5>
                  <span>${entity.type}  ${entity.country}</span>
                </div>
              </div>
            </td>
            <td>${entity.region}</td>
            <td>${entity.type}</td>
            <td class="numeric">${entity.activities}</td>
            <td class="numeric">${entity.records.toLocaleString()}</td>
            <td>
              <div class="coverage-cell">
                <div class="coverage-bar-mini">
                  <div class="coverage-bar-mini-fill ${entity.coverage >= 95 ? 'high' : entity.coverage >= 80 ? 'medium' : 'low'}" style="width: ${entity.coverage}%;"></div>
                </div>
                <span class="coverage-percent ${entity.coverage >= 95 ? 'high' : entity.coverage >= 80 ? 'medium' : 'low'}">${entity.coverage}%</span>
              </div>
            </td>
            <td>
              <div class="issue-pills-cell">${issuesList}</div>
            </td>
            <td><span class="status-icon ${entity.status}"><i class="fa-light ${entity.status === 'complete' ? 'fa-check' : entity.status === 'in-progress' ? 'fa-hourglass-half' : 'fa-triangle-exclamation'}"></i></span></td>
          </tr>
        `;
      }).join('');
      
      const infoEl = document.getElementById('efTableInfoFull');
      if (infoEl) {
        infoEl.textContent = `Showing ${filteredData.length} of ${efEntityData.length} entities`;
      }
    }
    
    function getFilteredEntityDataFull() {
      const search = document.getElementById('efEntitySearchFull')?.value.toLowerCase() || '';
      const region = document.getElementById('efRegionFilterFull')?.value || '';
      const type = document.getElementById('efTypeFilterFull')?.value || '';
      const status = document.getElementById('efStatusFilterFull')?.value || '';
      
      return efEntityData.filter(entity => {
        if (search && !entity.name.toLowerCase().includes(search) && !entity.country.toLowerCase().includes(search)) return false;
        if (region && entity.region !== region) return false;
        if (type && entity.type !== type) return false;
        if (status && entity.status !== status) return false;
        return true;
      });
    }
    
    function filterEntityTableFull() {
      renderEFEntityTableFull();
    }
    
    function sortEntityTableFull(column) {
      // Placeholder for sorting logic
      renderEFEntityTableFull();
    }
    
    function showEFFullPageView(viewId) {
      const tabs = document.querySelectorAll('#view-ef-selection-review .ef-content-tab');
      tabs.forEach(t => t.classList.remove('active'));
      
      const entityView = document.getElementById('ef-entity-table-view-full');
      const categoryView = document.getElementById('ef-category-table-view-full');
      const reviewView = document.getElementById('ef-review-queue-view-full');
      
      if (viewId === 'rules') {
        // For now just switch to the full page and show entity view
        switchView('ef-selection-review');
      } else if (viewId === 'review-queue') {
        if (entityView) entityView.classList.remove('active');
        if (categoryView) categoryView.classList.remove('active');
        if (reviewView) reviewView.classList.add('active');
        tabs.forEach(t => {
          if (t.textContent.includes('Review Queue')) t.classList.add('active');
        });
      }
    }
    
    function showOldEFView(viewId) {
      document.getElementById('efRedesignView').style.display = 'none';
      document.getElementById('efOldLayout').style.display = 'flex';
      
      document.querySelectorAll('.ef-mapping-view').forEach(v => v.classList.remove('active'));
      document.getElementById('ef-view-' + viewId)?.classList.add('active');
    }
    
    function backToEFMain() {
      document.getElementById('efOldLayout').style.display = 'none';
      document.getElementById('efRedesignView').style.display = 'block';
    }
    
    function drillDownToEntity(entityId) {
      const entity = efEntityData.find(e => e.id === entityId);
      if (!entity) return;
      
      // Update drawer header
      document.getElementById('entityDrawerFlag').textContent = entity.flag;
      document.getElementById('entityDrawerTitle').textContent = entity.name;
      document.getElementById('entityDrawerSubtitle').textContent = `${entity.region}  ${entity.type}  ${entity.records.toLocaleString()} records`;
      document.getElementById('entityDrawerCoverage').textContent = entity.coverage + '%';
      document.getElementById('entityDrawerMapped').textContent = Math.round(entity.records * entity.coverage / 100).toLocaleString();
      document.getElementById('entityDrawerFlagged').textContent = entity.issues.reduce((sum, i) => sum + i.count, 0).toLocaleString();
      document.getElementById('entityDrawerUnmapped').textContent = Math.round(entity.records * (100 - entity.coverage) / 100).toLocaleString();
      
      // Populate records list
      populateRecordsList(entityId);
      
      // Show drawer
      document.getElementById('entityRecordsBackdrop').classList.add('visible');
      document.getElementById('entityRecordsDrawer').classList.add('open');
      
      // Reset detail view
      document.getElementById('recordDetailEmpty').style.display = 'flex';
      document.getElementById('recordDetailContent').style.display = 'none';
    }
    
    function populateRecordsList(entityId) {
      const container = document.getElementById('recordsListContent');
      container.innerHTML = sampleRecords.map(record => {
        let badgeClass = 'record-badge ';
        let badgeText = '';
        if (record.status === 'mapped' && !record.flag) {
          badgeClass += 'mapped';
          badgeText = 'Mapped';
        } else if (record.flag === 'geographic') {
          badgeClass += 'flagged';
          badgeText = 'Geo';
        } else if (record.flag === 'outdated') {
          badgeClass += 'flagged';
          badgeText = 'Old';
        } else if (record.flag === 'specificity') {
          badgeClass += 'flagged';
          badgeText = 'Spec';
        } else if (record.status === 'unmapped') {
          badgeClass += 'unmapped';
          badgeText = 'Unmapped';
        } else {
          badgeClass += 'mapped';
          badgeText = 'Mapped';
        }
        return `
          <div class="record-list-item" onclick="selectRecord('${record.id}')">
            <div class="record-list-item-title">${record.title}</div>
            <div class="record-list-item-meta">${record.value}  ${record.period}</div>
            <span class="${badgeClass}">${badgeText}</span>
          </div>
        `;
      }).join('');
    }
    
    function selectRecord(recordId) {
      currentRecordId = recordId;
      const record = sampleRecords.find(r => r.id === recordId);
      if (!record) return;
      
      // Update selection state
      document.querySelectorAll('.record-list-item').forEach(item => item.classList.remove('selected'));
      event.target.closest('.record-list-item').classList.add('selected');
      
      // Show detail content
      document.getElementById('recordDetailEmpty').style.display = 'none';
      document.getElementById('recordDetailContent').style.display = 'flex';
      
      // Update header
      document.getElementById('recordDetailTitle').textContent = record.title;
      document.getElementById('recordDetailEntity').textContent = record.entity;
      document.getElementById('recordDetailPeriod').textContent = record.period;
      document.getElementById('recordDetailSource').textContent = record.source || 'Manual Entry';
      
      // Update status badge
      const statusBadge = document.getElementById('recordDetailStatus');
      statusBadge.className = `status-badge ${record.status}`;
      statusBadge.textContent = record.status === 'mapped' ? 'Mapped' : record.status === 'flagged' ? 'Flagged' : 'Unmapped';
      
      // Update data path badge
      document.getElementById('recordDetailDataPath').textContent = record.dataPath || 'Activity-based';
      
      // Update Stage 1 fields
      document.getElementById('detailRawLabel').textContent = record.title;
      document.getElementById('detailSanitizedValue').textContent = record.value;
      document.getElementById('detailActivityId').textContent = record.activityId || 'UNMAPPED';
      document.getElementById('detailScope').textContent = record.scope || 'Unclassified';
      
      // Update Stage 2 fields
      document.getElementById('detailSelectedFactor').textContent = record.selectedFactor || '';
      document.getElementById('detailDatasetSource').textContent = record.datasetSource || '';
      document.getElementById('detailEFValue').textContent = record.efValue || '';
      document.getElementById('detailLifecycle').textContent = record.lifecycle || '';
      
      // Update specificity gauge
      const specificity = record.specificity || 0;
      document.getElementById('specificityGaugeFill').style.width = specificity + '%';
      document.getElementById('specificityGaugeValue').textContent = specificity + ' / 100';
      
      // Close audit trail when switching records
      document.getElementById('auditTrailContent').style.display = 'none';
      document.querySelector('.audit-trail-mini')?.classList.remove('open');
    }
    
    function closeEntityRecordsDrawer() {
      document.getElementById('entityRecordsBackdrop').classList.remove('visible');
      document.getElementById('entityRecordsDrawer').classList.remove('open');
    }
    
    function toggleAuditTrail() {
      const container = document.querySelector('.audit-trail-mini');
      const content = document.getElementById('auditTrailContent');
      if (content.style.display === 'none') {
        content.style.display = 'block';
        container.classList.add('open');
      } else {
        content.style.display = 'none';
        container.classList.remove('open');
      }
    }
    
    function filterRecordsList() {
      const searchTerm = document.getElementById('recordsListSearch').value.toLowerCase();
      document.querySelectorAll('.record-list-item').forEach(item => {
        const title = item.querySelector('.record-list-item-title').textContent.toLowerCase();
        item.style.display = title.includes(searchTerm) ? '' : 'none';
      });
    }
    
    function drillDownToCategory(categoryId) {
      showToast(`Category drill-down for ${categoryId} - Coming soon`, 'info');
    }
    
    function navigateToReviewQueue(flagType) {
      showOldEFView('exceptions');
      showToast(`Filtered to ${flagType} issues`, 'info');
    }
    
    function viewCurrentMethod() {
      showToast('Method configuration viewer - Coming soon', 'info');
    }
    
    function switchActiveMethod(methodId) {
      showToast(`Switched to method: ${methodId}`, 'success');
    }
    
    function switchEFInventory(inventoryId) {
      const inventoryNames = {
        'inv-q4-2025': 'Q4 2025 Corporate Inventory',
        'inv-q3-2025': 'Q3 2025 Corporate Inventory',
        'inv-fy-2024': 'FY 2024 Annual Report',
        'inv-csrd-2024': 'CSRD 2024 Disclosure'
      };
      showToast(`Loading EF data for: ${inventoryNames[inventoryId] || inventoryId}`, 'info');
      // In production, this would reload the EF data for the selected inventory
      renderEFEntityTableFull();
    }
    
    // Override Modal Functions
    let selectedOverride = null;
    
    function openOverrideModal(selectionId, activityName, activityId, systemEF) {
      document.getElementById('overrideActivityName').textContent = activityName;
      document.getElementById('overrideActivityId').textContent = activityId;
      document.getElementById('systemEFValue').textContent = systemEF;
      
      // Reset state
      selectedOverride = null;
      document.getElementById('overridePlaceholder').style.display = 'block';
      document.getElementById('overrideContent').style.display = 'none';
      document.getElementById('overrideBox').classList.add('empty');
      document.getElementById('overrideReasonSection').style.display = 'none';
      document.getElementById('overrideLevelSection').style.display = 'none';
      document.getElementById('confirmOverrideBtn').disabled = true;
      
      document.querySelectorAll('.alternative-card').forEach(c => c.classList.remove('selected'));
      
      document.getElementById('overrideModalBackdrop').classList.remove('hidden');
      document.getElementById('overrideModal').classList.remove('hidden');
    }
    
    function closeOverrideModal() {
      document.getElementById('overrideModalBackdrop').classList.add('hidden');
      document.getElementById('overrideModal').classList.add('hidden');
    }
    
    function selectAlternative(altId, name, source, value, specificity) {
      selectedOverride = { id: altId, name, source, value, specificity };
      
      // Update visual selection
      document.querySelectorAll('.alternative-card').forEach(c => c.classList.remove('selected'));
      event.target.closest('.alternative-card').classList.add('selected');
      
      // Update override box
      document.getElementById('overridePlaceholder').style.display = 'none';
      document.getElementById('overrideContent').style.display = 'block';
      document.getElementById('overrideBox').classList.remove('empty');
      
      document.getElementById('overrideEFName').textContent = name;
      document.getElementById('overrideEFSource').textContent = source;
      document.getElementById('overrideEFValue').textContent = value;
      document.getElementById('overrideSpecificity').textContent = specificity;
      document.getElementById('overrideSpecificity').className = 'selection-specificity-score ' + (specificity >= 80 ? 'high' : specificity >= 60 ? 'medium' : 'low');
      
      // Show reason and level sections
      document.getElementById('overrideReasonSection').style.display = 'block';
      document.getElementById('overrideLevelSection').style.display = 'block';
      document.getElementById('confirmOverrideBtn').disabled = false;
    }
    
    function useSystemSelection() {
      closeOverrideModal();
      showToast('Using system selection - no changes made', 'info');
    }
    
    function confirmOverride() {
      if (!selectedOverride) return;
      
      closeOverrideModal();
      showToast(`Override applied: ${selectedOverride.name}`, 'success');
    }
    
    function openOverrideFromSelection(recordId) {
      // Use the EF Assignment modal for overriding EF
      openEFAssignModal(recordId);
    }
    
    // EF Assignment Modal Functions
    function openEFAssignModal(recordId) {
      // Find the record to populate the modal
      const record = sampleRecords.find(r => r.id === recordId) || {
        title: 'Office Supplies Q4',
        value: '$85,000',
        entity: 'Various vendors',
        period: 'Q4 2025'
      };
      
      // Populate modal with record data
      document.getElementById('assignModalActivity').textContent = record.title;
      document.getElementById('assignModalMeta').textContent = `${record.value} | ${record.entity} | ${record.period}`;
      
      // Show modal - use 'open' class to match CSS
      document.getElementById('efAssignModalBackdrop').classList.add('open');
      document.getElementById('efAssignModal').classList.add('open');
    }
    
    function closeEFAssignModal() {
      document.getElementById('efAssignModalBackdrop').classList.remove('open');
      document.getElementById('efAssignModal').classList.remove('open');
    }
    
    let selectedActivityId = 'GOODS_OFFICE_MIXED';
    
    function selectEFActivityID(activityId, element) {
      selectedActivityId = activityId;
      document.querySelectorAll('.assign-option').forEach(opt => {
        opt.classList.remove('selected');
      });
      element.classList.add('selected');
    }
    
    function confirmEFAssignment() {
      const saveToMemory = document.getElementById('saveToMatchMemory').checked;
      closeEFAssignModal();
      showToast(`Mapping updated to ${selectedActivityId}${saveToMemory ? ' and saved to Match Memory' : ''}`, 'success');
    }
    
    function openOverrideRuleBuilder() {
      showToast('Override Rule Builder - Coming soon', 'info');
    }
    
    function editOverrideRule(ruleId) {
      showToast(`Editing rule: ${ruleId}`, 'info');
    }
    
    // ============================================
    // Initialize
    // ============================================
    
    initMethodSelector();
    initEFOverrides();
    initOperationalBoundaryTable();
    setEFOverrideLockState(inventoryIsLocked);
    initEFEntityTable();
    console.log('GHG Calculation Engine prototype initialized');
  </script>
  <div id="ef-vendors-global-tooltip" aria-hidden="true">Only one of the options can be active at a time in this section.</div>
</body>
</html>
